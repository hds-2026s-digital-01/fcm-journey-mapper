<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FCM Journey Mapper Â· HDS 2026</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body { margin: 0; padding: 0; background: #F9FAFB; -webkit-font-smoothing: antialiased; }
    textarea:focus, select:focus, button:focus-visible { outline: 2px solid #10B981; outline-offset: 2px; }
    @media (max-width: 600px) {
      h1 { font-size: 22px !important; }
      .emotion-buttons { display: grid !important; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)) !important; }
      .yield-card-interventions { word-break: break-word; }
      .yield-card-actions { flex-direction: column !important; }
      .yield-card-actions button { width: 100% !important; }
      .perspective-tabs { overflow-x: auto !important; -webkit-overflow-scrolling: touch; flex-wrap: nowrap !important; }
      .perspective-tabs button { flex-shrink: 0; }
      .admin-card { min-width: 0 !important; }
      .pl-evidence-grid { grid-template-columns: 1fr !important; }
      .pl-builder-grid { grid-template-columns: 1fr !important; }
    }
  </style>
  <script src="sessions-data.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useCallback, useEffect, useMemo, useRef, createContext, useContext } = React;

    const ThemeContext = createContext(null);
    function useTheme() { return useContext(ThemeContext) || BRAND; }

    /* â”€â”€ Brand tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const BRAND = {
      black: "#1A1A1A",
      darkGray: "#2D2D2D",
      medGray: "#6B7280",
      lightGray: "#E5E7EB",
      offWhite: "#F9FAFB",
      white: "#FFFFFF",
      emerald: "#10B981",
      emeraldLight: "#D1FAE5",
      amber: "#F59E0B",
      amberLight: "#FEF3C7",
      red: "#EF4444",
      redLight: "#FEE2E2",
      blue: "#3B82F6",
      blueLight: "#DBEAFE",
    };

    const BRAND_DARK = {
      black: "#F9FAFB",
      darkGray: "#E5E7EB",
      medGray: "#6B7280",
      lightGray: "#374151",
      offWhite: "#1A1A1A",
      white: "#2D2D2D",
      emerald: "#10B981",
      emeraldLight: "#064E3B",
      amber: "#F59E0B",
      amberLight: "#78350F",
      red: "#EF4444",
      redLight: "#7F1D1D",
      blue: "#3B82F6",
      blueLight: "#1E3A5F",
    };

    const MONO = "'JetBrains Mono', 'Consolas', monospace";
    const SANS = "Inter, -apple-system, sans-serif";

    /* â”€â”€ Emotions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const EMOTIONS = [
      { emoji: "ğŸ˜°", label: "Anxious", color: BRAND.red },
      { emoji: "ğŸ˜Ÿ", label: "Uncertain", color: BRAND.amber },
      { emoji: "ğŸ˜", label: "Going through motions", color: BRAND.medGray },
      { emoji: "ğŸ¤”", label: "Engaged", color: BRAND.blue },
      { emoji: "ğŸ˜Š", label: "Confident", color: BRAND.emerald },
      { emoji: "ğŸ˜", label: "Energized", color: "#059669" },
      { emoji: "ğŸ˜¤", label: "Frustrated", color: BRAND.red },
    ];

    /* â”€â”€ Default steps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const DEFAULT_STEPS = [
      { id: "1", title: "Get the Assignment", official: 'Receive one-line chief concern (e.g., "43 y/o male, 1-week worsening SOB")', artifact: "Posted to VMED", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
      { id: "2", title: "Build Your Differential", official: "Broad differential using anatomical/systems reasoning. Rank top 3. Select 5 history Qs, 3-5 PE maneuvers with likelihood ratios.", artifact: "Pre-Class Differential Worksheet", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
      { id: "gap1", title: "â³ The Gap", official: "Days or a week pass. You study other things. The case goes cold.", artifact: "No artifact â€” this gap is real", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: true },
      { id: "3", title: "Small Group Session", official: "4-hour session with coach and ~6 students. You present or observe peers presenting.", artifact: "In-person, coach-led", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
      { id: "4", title: "Patient Encounter", official: "Interview standardized patient: setting stage â†’ open-ended Qs â†’ focusing â†’ HPI (7 components) â†’ PMH/PSH/Meds/Allergies/FH/SH/ROS â†’ PE â†’ assessment & plan.", artifact: "Communication Checklist", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
      { id: "5", title: "Coach Feedback", official: "Verbal feedback during/after encounter. Quality varies.", artifact: "Verbal, sometimes noted", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
      { id: "6", title: "Write the Note", official: "Synthesize encounter: pertinent history, PE findings, up to 3 ranked diagnoses with evidence, diagnostic studies.", artifact: "Illness Script Template", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
      { id: "7", title: "Get Written Feedback", official: "Coach reviews illness script in LMS. Feedback may be detailed or cursory. Often delayed.", artifact: "VMED comments", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
      { id: "gap2", title: "â³ The Fade", official: "You may never revisit this case. Learning from feedback is self-directed. No structured follow-up.", artifact: "Nothing", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: true },
      { id: "8", title: "Next Case", official: "Cycle repeats with a new chief concern.", artifact: "New worksheet posted", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
    ];

    /* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const SESSION_DATA = window.FCM_SESSION_DATA || null;

    function getSessionById(id) {
      if (!SESSION_DATA) return null;
      return SESSION_DATA.sessions.find(s => s.id === id) || null;
    }

    function perspectiveKey(perspective) {
      if (perspective === "Student") return "student";
      if (perspective === "Coach / Faculty") return "coach";
      if (perspective === "Administrator") return "administrator";
      return "student";
    }

    function loadAnnotations(sessionId) {
      try {
        const raw = localStorage.getItem(`fcm-annotations-${sessionId || "blank"}`);
        return raw ? JSON.parse(raw) : {};
      } catch { return {}; }
    }

    function saveAnnotations(sessionId, annotations) {
      try {
        localStorage.setItem(`fcm-annotations-${sessionId || "blank"}`, JSON.stringify(annotations));
      } catch {}
    }

    function loadYieldApprovals(sessionId) {
      try {
        const raw = localStorage.getItem(`fcm-yield-${sessionId || "blank"}`);
        return raw ? JSON.parse(raw) : {};
      } catch { return {}; }
    }

    function saveYieldApprovals(sessionId, approvals) {
      try {
        localStorage.setItem(`fcm-yield-${sessionId || "blank"}`, JSON.stringify(approvals));
      } catch {}
    }

    /* â”€â”€ SessionSelector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function SessionSelector({ selectedSession, onSelect }) {
      const theme = useTheme();
      const sessions = SESSION_DATA ? SESSION_DATA.sessions : [];

      return (
        <div style={{ marginBottom: 20 }}>
          <label style={{ fontSize: 12, fontWeight: 700, color: theme.darkGray, display: "block", marginBottom: 6, fontFamily: MONO }}>Session Progression &mdash; see how focus sharpened day to day</label>
          <select
            value={selectedSession || ""}
            onChange={e => onSelect(e.target.value || null)}
            style={{ width: "100%", padding: "10px 14px", borderRadius: 8, border: `1px solid ${theme.lightGray}`, fontSize: 14, fontFamily: SANS, background: theme.white, color: theme.black, cursor: "pointer", appearance: "auto" }}
          >
            {sessions.map(s => (
              <option key={s.id} value={s.id}>{s.label} ({s.date})</option>
            ))}
            <option value="">Blank Template (start from scratch)</option>
          </select>
          {selectedSession && (() => {
            const session = getSessionById(selectedSession);
            if (!session) return null;
            return (
              <div style={{ marginTop: 8, padding: "10px 14px", background: theme.blueLight, borderRadius: 8, fontSize: 13, color: theme.darkGray, lineHeight: 1.5 }}>
                {session.description} &middot; {session.participantCount} participants
              </div>
            );
          })()}
        </div>
      );
    }

    /* â”€â”€ StabilityBadge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function StabilityBadge({ stability, prevStability }) {
      const theme = useTheme();
      if (!stability) return null;
      const config = {
        stable: { bg: theme.emeraldLight, color: theme.emerald, label: "Stable" },
        emerging: { bg: theme.amberLight, color: theme.amber, label: "Emerging" },
        tentative: { bg: theme.lightGray, color: theme.medGray, label: "Tentative" },
      };
      const c = config[stability.level] || config.tentative;
      const showArrow = prevStability && prevStability.level !== stability.level;
      const prevLabel = showArrow ? (config[prevStability.level] || config.tentative).label : null;
      return (
        <span
          title={`${stability.evidence} (${stability.supportCount} participants)`}
          style={{ padding: "2px 10px", borderRadius: 12, background: c.bg, color: c.color, fontSize: 11, fontWeight: 700, fontFamily: MONO, cursor: "help", whiteSpace: "nowrap" }}
        >
          {showArrow ? `${prevLabel} â†’ ${c.label}` : c.label}
        </span>
      );
    }

    /* â”€â”€ HighYieldBadge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function HighYieldBadge({ yieldOpps, stepId }) {
      const theme = useTheme();
      const opp = yieldOpps && yieldOpps.find(o => o.stepId === stepId && o.yieldScore >= 7);
      if (!opp) return null;
      return (
        <span
          title={`High yield (${opp.yieldScore}/10): ${opp.title}`}
          style={{ padding: "2px 10px", borderRadius: 12, background: theme.redLight, color: theme.red, fontSize: 11, fontWeight: 700, fontFamily: MONO, cursor: "help", whiteSpace: "nowrap" }}
        >
          High Yield
        </span>
      );
    }

    /* â”€â”€ DiffBadge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function DiffBadge({ type }) {
      const theme = useTheme();
      const config = {
        new: { bg: theme.emeraldLight, color: theme.emerald, label: "New" },
        changed: { bg: theme.amberLight, color: theme.amber, label: "Changed" },
        upgraded: { bg: theme.blueLight, color: theme.blue, label: "Upgraded" },
      };
      const c = config[type] || config.changed;
      return (
        <span style={{ padding: "1px 8px", borderRadius: 10, background: c.bg, color: c.color, fontSize: 10, fontWeight: 700, fontFamily: MONO, marginLeft: 4 }}>{c.label}</span>
      );
    }

    /* â”€â”€ PrefilledInsights â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function PrefilledInsights({ stepData, diffData }) {
      const theme = useTheme();
      if (!stepData) return null;
      const { summary, themes, keyQuotes, contextNotes } = stepData;
      if (!summary && (!themes || themes.length === 0) && (!keyQuotes || keyQuotes.length === 0)) return null;

      return (
        <div style={{ marginBottom: 16, padding: "14px 16px", background: theme.blueLight, borderRadius: 8, borderLeft: `3px solid ${theme.blue}` }}>
          <div style={{ fontSize: 11, textTransform: "uppercase", color: theme.blue, fontWeight: 700, marginBottom: 8, fontFamily: MONO }}>Session Insights</div>
          {summary && <p style={{ fontSize: 13, color: theme.darkGray, lineHeight: 1.6, margin: "0 0 10px 0" }}>{summary}</p>}
          {themes && themes.length > 0 && (
            <div style={{ display: "flex", flexWrap: "wrap", gap: 6, marginBottom: 10 }}>
              {themes.map((t, i) => (
                <span key={i} style={{ padding: "3px 10px", borderRadius: 12, background: theme.blueLight, color: theme.blue, fontSize: 11, fontWeight: 600, fontFamily: MONO }}>
                  {t}
                  {diffData && diffData.newThemes && diffData.newThemes.includes(t) && <DiffBadge type="new" />}
                </span>
              ))}
            </div>
          )}
          {keyQuotes && keyQuotes.length > 0 && (
            <div style={{ marginBottom: contextNotes ? 10 : 0 }}>
              {keyQuotes.map((q, i) => {
                const isNew = diffData && diffData.newQuotes && diffData.newQuotes.includes(q.text);
                return (
                  <div key={i} style={{ padding: "8px 12px", background: theme.white, borderRadius: 6, marginBottom: i < keyQuotes.length - 1 ? 6 : 0, borderLeft: `2px solid ${isNew ? theme.emerald : theme.blue}` }}>
                    <div style={{ fontSize: 13, color: theme.darkGray, fontStyle: "italic", lineHeight: 1.5 }}>
                      "{q.text}"
                      {isNew && <DiffBadge type="new" />}
                    </div>
                    <div style={{ fontSize: 11, color: theme.medGray, marginTop: 4 }}>â€” {q.speaker}{q.context ? ` Â· ${q.context}` : ""}</div>
                  </div>
                );
              })}
            </div>
          )}
          {contextNotes && <p style={{ fontSize: 12, color: theme.medGray, lineHeight: 1.5, margin: 0, fontStyle: "italic" }}>{contextNotes}</p>}
        </div>
      );
    }

    /* â”€â”€ Field â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function Field({ label, value, onChange, placeholder, borderColor, labelColor, fromSession }) {
      const theme = useTheme();
      return (
        <div style={{ marginBottom: 14 }}>
          <label style={{ fontSize: 12, fontWeight: 700, color: labelColor || theme.darkGray, display: "flex", alignItems: "center", gap: 6, marginBottom: 4, fontFamily: MONO }}>
            {label}
            {fromSession && <span style={{ fontSize: 10, fontWeight: 500, color: theme.blue, fontStyle: "italic" }}>(from session)</span>}
          </label>
          <textarea value={value} onChange={(e) => onChange(e.target.value)} placeholder={placeholder} rows={2} style={{ width: "100%", padding: "8px 12px", borderRadius: 8, border: `1px solid ${borderColor || theme.lightGray}`, fontSize: 14, fontFamily: SANS, resize: "vertical", boxSizing: "border-box", background: theme.white, color: theme.black }} />
        </div>
      );
    }

    /* â”€â”€ StepCard (enhanced) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function StepCard({ step, index, onUpdate, onAddInvisibleAfter, sessionStepData, stability, yieldOpps, expandSignal, diffData, prevStability }) {
      const theme = useTheme();
      const [expanded, setExpanded] = useState(false);
      const isFirstRender = useRef(true);
      useEffect(() => {
        if (isFirstRender.current) { isFirstRender.current = false; return; }
        setExpanded(expandSignal % 2 === 1);
      }, [expandSignal]);
      const borderColor = step.isInvisible ? theme.amber : step.starred ? theme.emerald : theme.lightGray;
      const bgColor = step.isInvisible ? theme.amberLight : theme.white;

      const isFromSession = (field) => {
        if (!sessionStepData) return false;
        const suggested = sessionStepData[`suggested${field.charAt(0).toUpperCase() + field.slice(1)}`];
        return suggested && step[field] === suggested;
      };

      return (
        <div style={{ border: `2px solid ${borderColor}`, borderRadius: 12, background: bgColor, marginBottom: 16, boxShadow: "0 2px 8px rgba(0,0,0,0.06)", overflow: "hidden" }}>
          <div
            style={{ background: step.isInvisible ? theme.amber : theme.black, color: step.isInvisible ? theme.offWhite : theme.white, padding: "12px 16px", display: "flex", alignItems: "center", justifyContent: "space-between", cursor: "pointer", fontFamily: MONO }}
            onClick={() => setExpanded(!expanded)}
          >
            <div style={{ display: "flex", alignItems: "center", gap: 8, flexWrap: "wrap" }}>
              <span style={{ fontSize: 13, opacity: 0.7 }}>{step.isInvisible ? "ğŸ‘»" : `${index}.`}</span>
              <span style={{ fontWeight: 700, fontSize: 15 }}>{step.title}</span>
              {step.emotion !== null && <span style={{ fontSize: 20 }}>{EMOTIONS[step.emotion]?.emoji}</span>}
              {step.starred && <span style={{ fontSize: 18 }}>â­</span>}
              <StabilityBadge stability={stability} prevStability={prevStability} />
              <HighYieldBadge yieldOpps={yieldOpps} stepId={step.id} />
            </div>
            <span style={{ fontSize: 18, opacity: 0.6 }}>{expanded ? "â–²" : "â–¼"}</span>
          </div>
          {expanded && (
            <div style={{ padding: "16px 20px" }}>
              <div style={{ marginBottom: 16, padding: "10px 14px", background: theme.offWhite, borderRadius: 8, borderLeft: `3px solid ${theme.medGray}` }}>
                <div style={{ fontSize: 11, textTransform: "uppercase", color: theme.medGray, fontWeight: 700, marginBottom: 4, fontFamily: MONO }}>Official Version</div>
                <div style={{ fontSize: 13, color: theme.darkGray, lineHeight: 1.5 }}>{step.official}</div>
                <div style={{ fontSize: 11, color: theme.medGray, marginTop: 4 }}>ğŸ“„ {step.artifact}</div>
              </div>
              <PrefilledInsights stepData={sessionStepData} diffData={diffData} />
              <Field label="What ACTUALLY happens?" value={step.actual} onChange={(v) => onUpdate({ actual: v })} placeholder="Not what you're supposed to do â€” what you actually did..." fromSession={isFromSession("actual")} />
              <Field label="What were you thinking?" value={step.thinking} onChange={(v) => onUpdate({ thinking: v })} placeholder="The internal monologue â€” about the case, your grade, what the coach thinks..." />
              <div style={{ marginBottom: 14 }}>
                <label style={{ fontSize: 12, fontWeight: 700, color: theme.darkGray, display: "flex", alignItems: "center", gap: 6, marginBottom: 8, fontFamily: MONO }}>
                  How did this feel?
                  {sessionStepData && sessionStepData.suggestedEmotion !== undefined && step.emotion === sessionStepData.suggestedEmotion && (
                    <span style={{ fontSize: 10, fontWeight: 500, color: theme.blue, fontStyle: "italic" }}>(from session)</span>
                  )}
                </label>
                <div className="emotion-buttons" style={{ display: "flex", flexWrap: "wrap", gap: 8 }}>
                  {EMOTIONS.map((em, i) => (
                    <button key={i} onClick={() => onUpdate({ emotion: step.emotion === i ? null : i })} style={{ padding: "6px 12px", borderRadius: 20, border: step.emotion === i ? `2px solid ${em.color}` : `1px solid ${theme.lightGray}`, background: step.emotion === i ? em.color + "18" : theme.white, cursor: "pointer", fontSize: 13, display: "flex", alignItems: "center", gap: 4 }}>
                      <span style={{ fontSize: 18 }}>{em.emoji}</span>
                      <span style={{ color: theme.darkGray }}>{em.label}</span>
                    </button>
                  ))}
                </div>
              </div>
              <Field label="ğŸ”´ Friction / Pain" value={step.friction} onChange={(v) => onUpdate({ friction: v })} placeholder="What went wrong? What was hard? What took too long?" borderColor={theme.redLight} labelColor={theme.red} fromSession={isFromSession("friction")} />
              <Field label="â­ Wishlist â€” I wish a tool existed that..." value={step.wish} onChange={(v) => onUpdate({ wish: v })} placeholder="Don't worry if it's possible â€” just describe the help you'd want..." borderColor={theme.emeraldLight} labelColor={theme.emerald} fromSession={isFromSession("wish")} />
              <div style={{ display: "flex", gap: 12, flexWrap: "wrap" }}>
                <button onClick={() => onUpdate({ starred: !step.starred })} style={{ padding: "8px 16px", borderRadius: 8, border: "none", background: step.starred ? theme.emerald : theme.lightGray, color: step.starred ? theme.white : theme.darkGray, cursor: "pointer", fontWeight: 700, fontSize: 13, fontFamily: MONO }}>
                  {step.starred ? "â­ Starred" : "â˜† Star This"}
                </button>
                <button onClick={onAddInvisibleAfter} style={{ padding: "8px 16px", borderRadius: 8, border: `1px solid ${theme.amber}`, background: theme.amberLight, color: theme.darkGray, cursor: "pointer", fontWeight: 600, fontSize: 13, fontFamily: MONO }}>
                  ğŸ‘» Add Invisible Step After
                </button>
              </div>
            </div>
          )}
        </div>
      );
    }

    /* â”€â”€ AdminDashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function AdminDashboard({ session, allSessions }) {
      const theme = useTheme();
      if (!session) {
        return (
          <div style={{ padding: 24, background: theme.offWhite, borderRadius: 12, textAlign: "center", color: theme.medGray }}>
            <p style={{ fontFamily: MONO, fontSize: 14 }}>Select a session to view administrator insights.</p>
            <p style={{ fontSize: 13 }}>The Administrator view shows macro jobs-to-be-done rather than the step-by-step journey.</p>
          </div>
        );
      }

      const adminData = session.perspectives?.administrator;
      if (!adminData || !adminData.macroJobs) return null;

      const statusColor = (status) => {
        if (status.toLowerCase().includes("functional")) return theme.amber;
        if (status.toLowerCase().includes("invisible") || status.toLowerCase().includes("aspirational")) return theme.red;
        return theme.emerald;
      };

      return (
        <div>
          <div style={{ marginBottom: 20, padding: "12px 16px", background: theme.blueLight, borderRadius: 8, borderLeft: `3px solid ${theme.blue}` }}>
            <div style={{ fontSize: 12, fontWeight: 700, color: theme.blue, fontFamily: MONO }}>ADMINISTRATOR VIEW</div>
            <div style={{ fontSize: 13, color: theme.darkGray, marginTop: 4 }}>Macro jobs-to-be-done â€” how well does the system support administrative needs?</div>
          </div>

          {adminData.macroJobs.map(job => (
            <div key={job.id} className="admin-card" style={{ background: theme.white, borderRadius: 12, border: `2px solid ${theme.lightGray}`, marginBottom: 16, overflow: "hidden", boxShadow: "0 2px 8px rgba(0,0,0,0.06)" }}>
              <div style={{ background: theme.black, color: theme.white, padding: "12px 16px", display: "flex", alignItems: "center", justifyContent: "space-between", fontFamily: MONO }}>
                <span style={{ fontWeight: 700, fontSize: 15 }}>{job.title}</span>
                <span style={{ padding: "3px 12px", borderRadius: 12, background: statusColor(job.status) + "30", color: statusColor(job.status), fontSize: 11, fontWeight: 700 }}>{job.status}</span>
              </div>
              <div style={{ padding: "16px 20px" }}>
                {job.keyInsights && job.keyInsights.length > 0 && (
                  <div style={{ marginBottom: 14 }}>
                    <div style={{ fontSize: 11, textTransform: "uppercase", color: theme.emerald, fontWeight: 700, marginBottom: 6, fontFamily: MONO }}>Key Insights</div>
                    {job.keyInsights.map((insight, i) => (
                      <div key={i} style={{ fontSize: 13, color: theme.darkGray, lineHeight: 1.6, paddingLeft: 12, borderLeft: `2px solid ${theme.emeraldLight}`, marginBottom: 6 }}>{insight}</div>
                    ))}
                  </div>
                )}
                {job.keyQuotes && job.keyQuotes.length > 0 && (
                  <div style={{ marginBottom: 14 }}>
                    {job.keyQuotes.map((q, i) => (
                      <div key={i} style={{ padding: "8px 12px", background: theme.offWhite, borderRadius: 6, marginBottom: 4, borderLeft: `2px solid ${theme.blue}` }}>
                        <div style={{ fontSize: 13, color: theme.darkGray, fontStyle: "italic" }}>"{q.text}"</div>
                        <div style={{ fontSize: 11, color: theme.medGray, marginTop: 2 }}>â€” {q.speaker}{q.context ? ` Â· ${q.context}` : ""}</div>
                      </div>
                    ))}
                  </div>
                )}
                {job.frictionPoints && job.frictionPoints.length > 0 && (
                  <div>
                    <div style={{ fontSize: 11, textTransform: "uppercase", color: theme.red, fontWeight: 700, marginBottom: 6, fontFamily: MONO }}>Friction Points</div>
                    {job.frictionPoints.map((fp, i) => (
                      <div key={i} style={{ fontSize: 13, color: theme.darkGray, lineHeight: 1.6, paddingLeft: 12, borderLeft: `2px solid ${theme.redLight}`, marginBottom: 6 }}>{fp}</div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          ))}

          {allSessions && allSessions.length >= 2 && SESSION_DATA?.cumulative?.trendNotes && (
            <div style={{ background: theme.amberLight, borderRadius: 12, padding: 20, marginTop: 8, border: `1px solid ${theme.amber}` }}>
              <h3 style={{ margin: "0 0 8px 0", fontFamily: MONO, fontSize: 14, color: theme.darkGray }}>Cross-Session Trends</h3>
              <p style={{ fontSize: 13, color: theme.darkGray, margin: 0, lineHeight: 1.6 }}>{SESSION_DATA.cumulative.trendNotes}</p>
            </div>
          )}
        </div>
      );
    }

    /* â”€â”€ YieldAnalysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function YieldAnalysis({ opportunities, approvals, onApprovalChange, steps, diffYield }) {
      const theme = useTheme();
      if (!opportunities || opportunities.length === 0) return null;

      const sorted = [...opportunities].sort((a, b) => b.yieldScore - a.yieldScore);

      const stepTitle = (stepId) => {
        const s = steps.find(st => st.id === stepId);
        return s ? s.title : stepId;
      };

      const approvalStyles = {
        approved: { bg: theme.emeraldLight, border: theme.emerald, label: "Approved" },
        discuss: { bg: theme.amberLight, border: theme.amber, label: "Needs Discussion" },
        dismissed: { bg: theme.lightGray, border: theme.medGray, label: "Dismissed" },
      };

      return (
        <div style={{ background: theme.white, borderRadius: 12, padding: 20, marginTop: 24, border: `1px solid ${theme.lightGray}` }}>
          <h3 style={{ margin: "0 0 4px 0", fontFamily: MONO, color: theme.black, fontSize: 16 }}>Yield Analysis</h3>
          <p style={{ fontSize: 13, color: theme.medGray, margin: "0 0 16px 0" }}>Ranked improvement opportunities from session data. Review and triage.</p>
          {sorted.map((opp, i) => {
            const status = approvals[`${opp.stepId}-${i}`];
            const style = status ? approvalStyles[status] : null;
            return (
              <div key={i} style={{ border: `1px solid ${style ? style.border : theme.lightGray}`, borderRadius: 10, padding: "14px 16px", marginBottom: 12, background: style ? style.bg : theme.offWhite }}>
                <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", flexWrap: "wrap", gap: 8, marginBottom: 8 }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                    <span style={{ fontFamily: MONO, fontWeight: 800, fontSize: 22, color: opp.yieldScore >= 8 ? theme.red : opp.yieldScore >= 6 ? theme.amber : theme.medGray }}>
                      {opp.yieldScore}
                      {diffYield && diffYield.scoreChanges[opp.title] && (
                        <span style={{ fontSize: 11, fontWeight: 600, color: diffYield.scoreChanges[opp.title] > 0 ? theme.emerald : theme.red, marginLeft: 4 }}>
                          {diffYield.scoreChanges[opp.title] > 0 ? "+" : ""}{diffYield.scoreChanges[opp.title]}
                        </span>
                      )}
                    </span>
                    <div>
                      <div style={{ fontWeight: 700, fontSize: 14, color: theme.darkGray }}>
                        {opp.title}
                        {diffYield && diffYield.newTitles.includes(opp.title) && <DiffBadge type="new" />}
                      </div>
                      <div style={{ fontSize: 11, color: theme.medGray, fontFamily: MONO }}>at: {stepTitle(opp.stepId)}</div>
                    </div>
                  </div>
                  {status && <span style={{ padding: "3px 10px", borderRadius: 12, background: style.border + "20", color: style.border, fontSize: 11, fontWeight: 700, fontFamily: MONO }}>{style.label}</span>}
                </div>
                <p style={{ fontSize: 13, color: theme.darkGray, lineHeight: 1.6, margin: "0 0 10px 0" }}>{opp.rationale}</p>
                {opp.suggestedInterventions && opp.suggestedInterventions.length > 0 && (
                  <div className="yield-card-interventions" style={{ marginBottom: 12 }}>
                    <div style={{ fontSize: 11, textTransform: "uppercase", color: theme.medGray, fontWeight: 700, marginBottom: 4, fontFamily: MONO }}>Suggested Interventions</div>
                    {opp.suggestedInterventions.map((int, j) => (
                      <div key={j} style={{ fontSize: 12, color: theme.darkGray, padding: "4px 0 4px 12px", borderLeft: `2px solid ${theme.lightGray}` }}>{int}</div>
                    ))}
                  </div>
                )}
                <div className="yield-card-actions" style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
                  {[
                    { key: "approved", label: "âœ… Approve", bg: theme.emerald },
                    { key: "discuss", label: "ğŸ’¬ Needs Discussion", bg: theme.amber },
                    { key: "dismissed", label: "âœ• Dismiss", bg: theme.medGray },
                  ].map(btn => (
                    <button
                      key={btn.key}
                      onClick={() => onApprovalChange(`${opp.stepId}-${i}`, status === btn.key ? null : btn.key)}
                      style={{
                        padding: "6px 14px", borderRadius: 6, border: status === btn.key ? `2px solid ${btn.bg}` : `1px solid ${theme.lightGray}`,
                        background: status === btn.key ? btn.bg + "18" : theme.white, color: theme.darkGray,
                        cursor: "pointer", fontSize: 12, fontWeight: status === btn.key ? 700 : 500, fontFamily: MONO
                      }}
                    >
                      {btn.label}
                    </button>
                  ))}
                </div>
              </div>
            );
          })}
        </div>
      );
    }

    /* â”€â”€ EmotionalArc â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function EmotionalArc({ steps }) {
      const theme = useTheme();
      const withEmotions = steps.filter((s) => s.emotion !== null);
      if (withEmotions.length < 2) return null;
      const valMap = { 0: 1, 6: 1, 1: 2, 2: 3, 3: 4, 4: 5, 5: 6 };
      const points = withEmotions.map((s, i) => ({ x: (i / (withEmotions.length - 1)) * 100, y: 100 - ((valMap[s.emotion] ?? 3) / 6) * 100, step: s }));
      const pathD = points.map((p, i) => `${i === 0 ? "M" : "L"} ${p.x} ${p.y}`).join(" ");

      return (
        <div style={{ background: theme.white, borderRadius: 12, padding: 20, marginTop: 24, border: `1px solid ${theme.lightGray}` }}>
          <h3 style={{ margin: "0 0 16px 0", fontFamily: MONO, color: theme.black }}>ğŸ“ˆ Emotional Arc</h3>
          <svg viewBox="-5 -10 110 120" style={{ width: "100%", height: 160 }}>
            <line x1="0" y1="50" x2="100" y2="50" stroke={theme.lightGray} strokeWidth="0.3" strokeDasharray="2" />
            <path d={pathD} fill="none" stroke={theme.emerald} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
            {points.map((p, i) => (
              <g key={i}>
                <circle cx={p.x} cy={p.y} r="3" fill={EMOTIONS[p.step.emotion]?.color || theme.medGray} />
                <text x={p.x} y={p.y - 8} textAnchor="middle" fontSize="8">{EMOTIONS[p.step.emotion]?.emoji}</text>
                <text x={p.x} y={p.y + 14} textAnchor="middle" fontSize="3.5" fill={theme.medGray}>{p.step.title.length > 12 ? p.step.title.slice(0, 12) + "â€¦" : p.step.title}</text>
              </g>
            ))}
            <text x="0" y="-4" fontSize="3.5" fill={theme.emerald}>ğŸ˜ Energized</text>
            <text x="0" y="108" fontSize="3.5" fill={theme.red}>ğŸ˜° Anxious</text>
          </svg>
        </div>
      );
    }

    /* â”€â”€ WishlistSummary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function WishlistSummary({ steps }) {
      const theme = useTheme();
      const starred = steps.filter((s) => s.starred && s.wish);
      if (starred.length === 0) return null;
      return (
        <div style={{ background: theme.emeraldLight, borderRadius: 12, padding: 20, marginTop: 24, border: `2px solid ${theme.emerald}` }}>
          <h3 style={{ margin: "0 0 12px 0", fontFamily: MONO, color: theme.black }}>â­ Feature Seeds ({starred.length})</h3>
          <p style={{ fontSize: 13, color: theme.medGray, margin: "0 0 16px 0" }}>Starred wishes â†’ features for your app. Copy into your PRD.</p>
          {starred.map((s) => (
            <div key={s.id} style={{ background: theme.white, borderRadius: 8, padding: "12px 16px", marginBottom: 8, borderLeft: `3px solid ${theme.emerald}` }}>
              <div style={{ fontSize: 12, color: theme.emerald, fontWeight: 700, fontFamily: MONO }}>At: {s.title}</div>
              <div style={{ fontSize: 14, color: theme.darkGray, marginTop: 4 }}>{s.wish}</div>
            </div>
          ))}
        </div>
      );
    }

    /* â”€â”€ CumulativeAnalysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function CumulativeAnalysis({ sessionCount }) {
      const theme = useTheme();
      if (!SESSION_DATA?.cumulative || sessionCount < 2) return null;
      const { trendNotes, yieldOpportunities } = SESSION_DATA.cumulative;

      return (
        <div style={{ background: theme.amberLight, borderRadius: 12, padding: 20, marginTop: 24, border: `1px solid ${theme.amber}` }}>
          <h3 style={{ margin: "0 0 8px 0", fontFamily: MONO, fontSize: 14, color: theme.darkGray }}>Cumulative Analysis ({sessionCount} sessions)</h3>
          {trendNotes && <p style={{ fontSize: 13, color: theme.darkGray, margin: "0 0 12px 0", lineHeight: 1.6 }}>{trendNotes}</p>}
          {yieldOpportunities && yieldOpportunities.length > 0 && (
            <div>
              <div style={{ fontSize: 11, textTransform: "uppercase", color: theme.amber, fontWeight: 700, marginBottom: 6, fontFamily: MONO }}>Top Opportunities Across Sessions</div>
              {yieldOpportunities.slice(0, 3).map((opp, i) => (
                <div key={i} style={{ fontSize: 13, color: theme.darkGray, padding: "4px 0 4px 12px", borderLeft: `2px solid ${theme.amber}`, marginBottom: 4 }}>
                  <strong>{opp.yieldScore}/10</strong> â€” {opp.title} ({opp.sessions.length} session{opp.sessions.length > 1 ? "s" : ""})
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    /* â”€â”€ LeadingOpportunities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function LeadingOpportunities() {
      const theme = useTheme();
      const opps = SESSION_DATA?.cumulative?.yieldOpportunities;
      if (!opps || opps.length === 0) return null;

      const [collapsed, setCollapsed] = useState(() => {
        try { return localStorage.getItem("fcm-leading-collapsed") === "true"; } catch { return false; }
      });

      const toggleCollapse = () => {
        const next = !collapsed;
        setCollapsed(next);
        try { localStorage.setItem("fcm-leading-collapsed", String(next)); } catch {}
      };

      const top3 = opps.slice(0, 3);
      const scoreColor = (s) => s >= 9 ? theme.red : s >= 7 ? theme.amber : theme.medGray;

      return (
        <div style={{ marginBottom: 20, background: theme.white, borderRadius: 12, border: `1px solid ${theme.lightGray}`, overflow: "hidden" }}>
          <div onClick={toggleCollapse} style={{ padding: "12px 16px", display: "flex", alignItems: "center", justifyContent: "space-between", cursor: "pointer", background: theme.offWhite }}>
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              <span style={{ fontSize: 11, textTransform: "uppercase", fontWeight: 700, color: theme.red, fontFamily: MONO }}>Leading Opportunities</span>
              <span style={{ fontSize: 11, color: theme.medGray, fontFamily: MONO }}>Top 3 across all sessions</span>
            </div>
            <span style={{ fontSize: 14, color: theme.medGray }}>{collapsed ? "â–¼" : "â–²"}</span>
          </div>
          {!collapsed && (
            <div style={{ padding: "12px 16px", display: "flex", flexDirection: "column", gap: 10 }}>
              {top3.map((opp, i) => (
                <div key={i} style={{ display: "flex", alignItems: "flex-start", gap: 12 }}>
                  <span style={{ fontFamily: MONO, fontWeight: 800, fontSize: 20, color: scoreColor(opp.yieldScore), minWidth: 32, textAlign: "center" }}>{opp.yieldScore}</span>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontWeight: 700, fontSize: 14, color: theme.darkGray }}>{opp.title}</div>
                    <div style={{ fontSize: 12, color: theme.medGray, marginTop: 2 }}>
                      {opp.sessions.length} session{opp.sessions.length > 1 ? "s" : ""}
                      {opp.rationale ? ` Â· ${opp.rationale}` : ""}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    /* â”€â”€ Product Lab: Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    const PL_EVIDENCE = {
      student: {
        label: "M1 Student", emoji: "ğŸ“",
        painPoints: [
          { id: "s1", text: "Week-long gap between submitting differential and FCM session â€” lose your thinking" },
          { id: "s2", text: "Passive observation when another student interviews â€” no way to actively participate" },
          { id: "s3", text: "No individual feedback on knowledge gaps vs strengths across cases" },
          { id: "s4", text: "Differential list feels like busywork without understanding why you're wrong" },
          { id: "s5", text: "No way to practice illness scripts between sessions" },
          { id: "s6", text: "Group discussion dominated by confident voices â€” quieter students don't get reps" },
          { id: "s7", text: "Walking into session cold â€” forgot what you were thinking a week ago" },
        ],
        wishes: [
          { id: "sw1", text: "Quick pre-session recap that reignites my thinking in 10 minutes" },
          { id: "sw2", text: "See where my reasoning diverged from the actual diagnosis path" },
          { id: "sw3", text: "Gamified confidence calibration â€” am I getting better over time?" },
          { id: "sw4", text: "Signal to instructor what I want to discuss without raising hand in group" },
          { id: "sw5", text: "Practice chief complaint exploration at my own pace" },
        ],
      },
      instructor: {
        label: "FCM Coach", emoji: "ğŸ©º",
        painPoints: [
          { id: "i1", text: "Can't see student prep quality before session â€” flying blind on who's ready" },
          { id: "i2", text: "Hard to tailor discussion to group's actual gaps vs assumed curriculum sequence" },
          { id: "i3", text: "No longitudinal view of individual student progress across cases" },
          { id: "i4", text: "Session time wasted on students who didn't prepare" },
          { id: "i5", text: "Want to focus on clinical reasoning but get pulled into logistics" },
        ],
        wishes: [
          { id: "iw1", text: "Dashboard showing student prep status + areas of confusion before I walk in" },
          { id: "iw2", text: "See aggregated 'what the group got wrong' to target my teaching" },
          { id: "iw3", text: "Quick feedback tool â€” annotate student reasoning in real-time or post-session" },
          { id: "iw4", text: "Student signals: 'I want to discuss this' flags I can see before session" },
        ],
      },
      admin: {
        label: "Curriculum Admin", emoji: "ğŸ›ï¸",
        painPoints: [
          { id: "a1", text: "No standardized data on whether FCM is meeting AAMC competency standards" },
          { id: "a2", text: "Coach quality varies enormously â€” no visibility into session consistency" },
          { id: "a3", text: "Can't identify struggling students until exam performance drops" },
          { id: "a4", text: "FCM compliance logging is manual and incomplete" },
        ],
        wishes: [
          { id: "aw1", text: "Automated competency mapping â€” which skills are each student developing?" },
          { id: "aw2", text: "Early warning system for students falling behind" },
          { id: "aw3", text: "Aggregate analytics across all FCM sections for curriculum improvement" },
        ],
      },
    };

    const PL_FEATURES = [
      { id: "gap-refresh", name: "Gamified Case Refresh", icon: "ğŸ®", description: "10-15 min mobile experience before FCM. Quick-fire differential review, confidence check, 'here's what to listen for.'", cost: 2, requires: ["mobile-ui", "case-content"], stakeholders: ["student"] },
      { id: "reasoning-capture", name: "Reasoning Capture", icon: "ğŸ§ ", description: "Replace VINDICATE worksheet. Capture WHY students think each diagnosis â€” structured reasoning prompts, not checkboxes.", cost: 3, requires: ["database", "case-content"], stakeholders: ["student", "instructor"] },
      { id: "confidence-cal", name: "Confidence Calibration", icon: "ğŸ¯", description: "Rank differentials by likelihood + confidence. After session, see how calibrated you were. Track improvement over time.", cost: 2, requires: ["database"], stakeholders: ["student"] },
      { id: "student-signal", name: "Student â†’ Instructor Signal", icon: "ğŸ“¡", description: "Before session: flag confusion areas, discussion topics. Instructor sees aggregate + individual. Quiet students get a voice.", cost: 3, requires: ["database", "auth", "instructor-view"], stakeholders: ["student", "instructor"] },
      { id: "instructor-dashboard", name: "Instructor Prep Dashboard", icon: "ğŸ‘ï¸", description: "Pre-session view: who prepared, common errors, areas of confusion. Target teaching to actual gaps.", cost: 3, requires: ["database", "auth", "instructor-view"], stakeholders: ["instructor"] },
      { id: "ai-patient", name: "AI Patient Encounter", icon: "ğŸ¤–", description: "Voice/chat AI standardized patient. Unlimited history-taking practice. Real-time differential adjustment feedback.", cost: 4, requires: ["ai-llm", "case-content", "mobile-ui"], stakeholders: ["student"] },
      { id: "progress-tracker", name: "Longitudinal Progress Tracker", icon: "ğŸ“ˆ", description: "Track reasoning quality across cases over a semester. Growth patterns, persistent gaps. Student + coach view.", cost: 3, requires: ["database", "auth", "analytics"], stakeholders: ["student", "instructor", "admin"] },
      { id: "spaced-review", name: "Spaced Repetition Review", icon: "ğŸ”", description: "Post-session review cards. 'What would you do differently?' Builds cumulative knowledge case-over-case.", cost: 2, requires: ["database", "case-content"], stakeholders: ["student"] },
      { id: "compliance-dash", name: "Compliance & Analytics", icon: "ğŸ›ï¸", description: "Admin dashboard: AAMC competency mapping, session quality metrics, coach consistency, early warning for struggling students.", cost: 2, requires: ["database", "auth", "admin-view", "analytics"], stakeholders: ["admin"] },
      { id: "peer-compare", name: "Anonymous Peer Comparison", icon: "ğŸ‘¥", description: "See how your differential compares to anonymized group. 'Most students identified PE â€” you focused on anxiety.'", cost: 1, requires: ["database"], stakeholders: ["student"] },
    ];

    const PL_TECH_REQS = {
      "database": { label: "Database", icon: "ğŸ—„ï¸", description: "Persistent storage â€” Supabase or similar. User data, case content, reasoning logs." },
      "auth": { label: "User Auth", icon: "ğŸ”", description: "Login system with roles (student/instructor/admin). UVA SSO or email." },
      "mobile-ui": { label: "Mobile-First UI", icon: "ğŸ“±", description: "Touch-optimized, works on phone screens. PWA or responsive web." },
      "case-content": { label: "Case Content", icon: "ğŸ“š", description: "Structured clinical cases â€” chief complaints, differentials, findings. Need content pipeline." },
      "ai-llm": { label: "AI / LLM", icon: "ğŸ¤–", description: "Anthropic API for AI patient simulation, reasoning feedback. Usage costs." },
      "instructor-view": { label: "Instructor View", icon: "ğŸ‘ï¸", description: "Separate interface for coaches. Role-based access. Dashboard design." },
      "admin-view": { label: "Admin Portal", icon: "ğŸ›ï¸", description: "Curriculum-level analytics and compliance reporting." },
      "analytics": { label: "Analytics Engine", icon: "ğŸ“Š", description: "Aggregation, trends, cohort comparison. Charts and reports." },
    };

    const PL_SYNERGIES = [
      { id: "reasoning-loop", name: "The Reasoning Loop", icon: "ğŸ”„", description: "Student reasoning â†’ coach visibility â†’ targeted feedback. The core two-sided value.", features: ["reasoning-capture", "student-signal", "instructor-dashboard"] },
      { id: "engagement-loop", name: "The Engagement Loop", icon: "ğŸ”¥", description: "Keep the case alive before and after sessions. Fight the fade.", features: ["gap-refresh", "spaced-review"] },
      { id: "growth-loop", name: "The Growth Loop", icon: "ğŸ“ˆ", description: "Track metacognition and development over time. Make learning visible.", features: ["confidence-cal", "progress-tracker"] },
    ];

    const PL_BUDGET = 10;

    const PL_ARCHETYPES = [
      {
        id: "ai-tutor",
        name: "The AI Tutor",
        quadrant: { xMin: 0, xMax: 0.5, yMin: 0, yMax: 0.5 },
        tagline: "Your personal clinical reasoning coach",
        description: "Deep, AI-powered practice encounters. Simulate patient interviews, get real-time feedback on your reasoning, explore cases at your own pace with unlimited reps.",
        bestFor: "Building clinical reasoning skills through deliberate practice with AI feedback",
        tradeoff: "Expensive to build (needs AI/LLM). Solo experience. Quality depends on case content.",
        color: "#7C3AED",
        bgLight: "#F5F3FF", bgDark: "#1a1a2e",
        referenceApps: [
          { name: "ChatGPT", icon: "ğŸ¤–", trait: "Conversational AI" },
          { name: "Amboss", icon: "ğŸ“š", trait: "Clinical depth" },
          { name: "Khan Academy", icon: "ğŸ“", trait: "Guided learning" },
        ],
      },
      {
        id: "two-sided-bridge",
        name: "The Two-Sided Bridge",
        quadrant: { xMin: 0.5, xMax: 1, yMin: 0, yMax: 0.5 },
        tagline: "Student signals up, instructor feedback down",
        description: "A teaching platform that creates a feedback loop. Students share their prep and reasoning; instructors see where the class is before walking in. Both sides get more from every session.",
        bestFor: "Fixing the instructor-student information gap â€” coaches fly blind, students can't signal confusion",
        tradeoff: "Requires adoption from both sides. If instructors don't check it, the loop breaks.",
        color: "#10B981",
        bgLight: "#F0FDF4", bgDark: "#0a2a1a",
        referenceApps: [
          { name: "Piazza", icon: "ğŸ’¬", trait: "Q&A + instructor visibility" },
          { name: "Slack", icon: "ğŸ’¡", trait: "Async communication" },
          { name: "Canvas", icon: "ğŸ“‹", trait: "Course integration" },
        ],
      },
      {
        id: "practice-coach",
        name: "The Practice Coach",
        quadrant: { xMin: 0, xMax: 0.5, yMin: 0.5, yMax: 1 },
        tagline: "Gamified daily reps that fit in your pocket",
        description: "Like a language learning app for clinical reasoning. Bite-sized practice sessions, spaced repetition, streaks, and instant feedback. The app you open for 5-10 minutes on the walk to class.",
        bestFor: "Solving 'The Gap' and 'The Fade' â€” keeping cases alive between sessions",
        tradeoff: "Solo experience. Doesn't connect students to instructors or create teaching insights.",
        color: "#F59E0B",
        bgLight: "#FFF7ED", bgDark: "#1a2332",
        referenceApps: [
          { name: "Duolingo", icon: "ğŸ¦‰", trait: "Gamified daily practice" },
          { name: "Anki", icon: "ğŸ“‡", trait: "Spaced repetition" },
          { name: "Quizlet", icon: "ğŸƒ", trait: "Quick-fire review" },
        ],
      },
      {
        id: "growth-tracker",
        name: "The Growth Tracker",
        quadrant: { xMin: 0.5, xMax: 1, yMin: 0.5, yMax: 1 },
        tagline: "Make learning visible â€” to yourself and your peers",
        description: "Quick check-ins with social context. See how your reasoning compares to anonymized peers. Track your calibration and growth over a semester. Light daily engagement with longitudinal value.",
        bestFor: "Metacognition and motivation â€” students don't know if they're improving",
        tradeoff: "Lightweight interactions may not build deep clinical reasoning skills directly.",
        color: "#EF4444",
        bgLight: "#FEF2F2", bgDark: "#2a1a1a",
        referenceApps: [
          { name: "Strava", icon: "ğŸƒ", trait: "Personal + peer tracking" },
          { name: "Kahoot", icon: "ğŸ¯", trait: "Competitive engagement" },
          { name: "Wordle", icon: "ğŸŸ©", trait: "Daily habit, social sharing" },
        ],
      },
    ];

    /* â”€â”€ Product Lab: Components â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    function PLVoteItem({ item, active, onClick, isWish, custom }) {
      const theme = useTheme();
      const isDark = theme.offWhite === "#1A1A1A";
      const activeBg = isWish ? theme.blueLight : (isDark ? "#78350F" : "#FFF7ED");
      const activeBorder = isWish ? theme.blue : "#EA580C";
      return (
        <button onClick={onClick} style={{ display: "flex", alignItems: "flex-start", gap: 8, width: "100%", padding: "8px 10px", marginBottom: 6, fontSize: 12, fontFamily: SANS, lineHeight: 1.5, textAlign: "left", background: active ? activeBg : theme.offWhite, border: `1px solid ${active ? activeBorder : theme.lightGray}`, borderRadius: 6, cursor: "pointer", color: theme.black, transition: "all 0.15s" }}>
          <span style={{ fontSize: 14, flexShrink: 0, marginTop: -1 }}>{active ? (isWish ? "â­" : "ğŸ”¥") : "â—‹"}</span>
          <span>{custom && <span style={{ fontSize: 10, color: theme.blue, fontWeight: 600 }}>ADDED </span>}{item.text}</span>
        </button>
      );
    }

    function PLStakeholderColumn({ sKey, data, customPoints, newPoint, setNewPoint, votes, toggleVote, addPoint, setCustomPoints, sc }) {
      const theme = useTheme();
      return (
        <div style={{ background: theme.white, border: `1px solid ${theme.lightGray}`, borderRadius: 10, overflow: "hidden" }}>
          <div style={{ background: sc.bg, padding: "14px 16px", borderBottom: `1px solid ${theme.lightGray}` }}>
            <div style={{ fontSize: 18, marginBottom: 2 }}>{data.emoji}</div>
            <div style={{ fontSize: 14, fontWeight: 700, color: sc.color, fontFamily: MONO }}>{data.label}</div>
          </div>
          <div style={{ padding: 16 }}>
            <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 10, fontFamily: MONO }}>Pain Points</div>
            {data.painPoints.map(item => (
              <PLVoteItem key={item.id} item={item} active={!!votes[item.id]} onClick={() => toggleVote(item.id)} />
            ))}
            {customPoints.map(item => (
              <PLVoteItem key={item.id} item={item} active={!!votes[item.id]} onClick={() => toggleVote(item.id)} custom />
            ))}
            <div style={{ display: "flex", gap: 6, marginTop: 8, marginBottom: 16 }}>
              <input type="text" value={newPoint} onChange={e => setNewPoint(e.target.value)} onKeyDown={e => e.key === "Enter" && addPoint()} placeholder="Add pain point..." style={{ flex: 1, padding: "6px 10px", fontSize: 12, fontFamily: MONO, border: `1px solid ${theme.lightGray}`, borderRadius: 6, background: theme.offWhite, color: theme.black, outline: "none" }} />
              <button onClick={addPoint} style={{ padding: "6px 12px", fontSize: 12, fontFamily: MONO, fontWeight: 700, background: theme.black, color: theme.white, border: "none", borderRadius: 6, cursor: "pointer" }}>+</button>
            </div>
            <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 10, fontFamily: MONO }}>Wishes</div>
            {data.wishes.map(item => (
              <PLVoteItem key={item.id} item={item} active={!!votes[item.id]} onClick={() => toggleVote(item.id)} isWish />
            ))}
          </div>
        </div>
      );
    }

    function PLEvidenceWall({ votes, toggleVote, customPainPoints, setCustomPainPoints, newPainPoint, setNewPainPoint, addPainPoint, stColors }) {
      const theme = useTheme();
      return (
        <div>
          <p style={{ fontSize: 13, color: theme.medGray, lineHeight: 1.6, margin: "0 0 20px 0" }}>
            Everything your team has surfaced across two days of journey mapping, brainstorming, and building.{" "}
            <strong style={{ color: theme.black }}>Click items to prioritize them</strong> â€” your votes flow directly into the PRD.
          </p>
          <div className="pl-evidence-grid" style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(300px, 1fr))", gap: 16 }}>
            {Object.entries(PL_EVIDENCE).map(([key, data]) => (
              <PLStakeholderColumn key={key} sKey={key} data={data} customPoints={customPainPoints[key]} newPoint={newPainPoint[key]} setNewPoint={val => setNewPainPoint(prev => ({ ...prev, [key]: val }))} votes={votes} toggleVote={toggleVote} addPoint={() => addPainPoint(key)} setCustomPoints={pts => setCustomPainPoints(prev => ({ ...prev, [key]: pts }))} sc={stColors[key]} />
            ))}
          </div>
        </div>
      );
    }

    function PLProductDNA({ dnaPosition, setDnaPosition, confirmedArchetype, setConfirmedArchetype }) {
      const theme = useTheme();
      const isDark = theme.offWhite === "#1A1A1A";
      const mapRef = useRef(null);
      const [dragging, setDragging] = useState(false);

      const updatePosition = useCallback((clientX, clientY) => {
        if (!mapRef.current) return;
        const rect = mapRef.current.getBoundingClientRect();
        const x = Math.max(0.02, Math.min(0.98, (clientX - rect.left) / rect.width));
        const y = Math.max(0.02, Math.min(0.98, (clientY - rect.top) / rect.height));
        setDnaPosition({ x, y });
      }, [setDnaPosition]);

      const handleMouseDown = (e) => { e.preventDefault(); setDragging(true); updatePosition(e.clientX, e.clientY); };
      const handleTouchStart = (e) => { setDragging(true); updatePosition(e.touches[0].clientX, e.touches[0].clientY); };

      useEffect(() => {
        if (!dragging) return;
        const onMove = (e) => { e.preventDefault(); const pt = e.touches ? e.touches[0] : e; updatePosition(pt.clientX, pt.clientY); };
        const onUp = () => setDragging(false);
        window.addEventListener("mousemove", onMove);
        window.addEventListener("mouseup", onUp);
        window.addEventListener("touchmove", onMove, { passive: false });
        window.addEventListener("touchend", onUp);
        return () => { window.removeEventListener("mousemove", onMove); window.removeEventListener("mouseup", onUp); window.removeEventListener("touchmove", onMove); window.removeEventListener("touchend", onUp); };
      }, [dragging, updatePosition]);

      const activeArchetype = PL_ARCHETYPES.find(a =>
        dnaPosition.x >= a.quadrant.xMin && dnaPosition.x < a.quadrant.xMax &&
        dnaPosition.y >= a.quadrant.yMin && dnaPosition.y < a.quadrant.yMax
      ) || PL_ARCHETYPES[0];

      return (
        <div>
          <p style={{ fontSize: 13, color: theme.medGray, lineHeight: 1.6, margin: "0 0 20px 0" }}>
            What kind of product are you building? <strong style={{ color: theme.black }}>Drag the pin</strong> on the map to explore four product archetypes.
            Each quadrant shows well-known apps that share that DNA.
          </p>

          <div style={{ maxWidth: 520, margin: "0 auto 24px" }}>
            <div style={{ display: "flex", justifyContent: "center", marginBottom: 6 }}>
              <span style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: theme.medGray, letterSpacing: "0.05em" }}>DEEP ENGAGEMENT</span>
            </div>
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              <span style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: theme.medGray, writingMode: "vertical-rl", transform: "rotate(180deg)", letterSpacing: "0.05em" }}>SOLO PRACTICE</span>
              <div ref={mapRef} onMouseDown={handleMouseDown} onTouchStart={handleTouchStart}
                style={{ flex: 1, position: "relative", aspectRatio: "1", borderRadius: 12, overflow: "hidden", cursor: "crosshair", border: `2px solid ${theme.lightGray}`, touchAction: "none", userSelect: "none" }}>
                {PL_ARCHETYPES.map(arch => {
                  const isActive = activeArchetype.id === arch.id;
                  return (
                    <div key={arch.id} style={{
                      position: "absolute",
                      left: `${arch.quadrant.xMin * 100}%`, top: `${arch.quadrant.yMin * 100}%`,
                      width: "50%", height: "50%",
                      background: isDark ? arch.bgDark : arch.bgLight,
                      display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center",
                      padding: 10, boxSizing: "border-box",
                      outline: isActive ? `2px solid ${arch.color}` : "none", outlineOffset: -2,
                      transition: "outline 0.15s",
                    }}>
                      <div style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: isActive ? arch.color : theme.medGray, marginBottom: 8, textAlign: "center", transition: "color 0.15s" }}>{arch.name}</div>
                      <div style={{ display: "flex", gap: 4, flexWrap: "wrap", justifyContent: "center" }}>
                        {arch.referenceApps.map(app => (
                          <div key={app.name} style={{
                            display: "flex", alignItems: "center", gap: 3, padding: "2px 7px", borderRadius: 10,
                            background: isDark ? "rgba(255,255,255,0.08)" : "rgba(255,255,255,0.85)",
                            border: `1px solid ${isActive ? arch.color + "44" : theme.lightGray}`,
                            fontSize: 9, fontFamily: MONO, color: theme.black, whiteSpace: "nowrap",
                          }}>
                            <span style={{ fontSize: 11 }}>{app.icon}</span> {app.name}
                          </div>
                        ))}
                      </div>
                    </div>
                  );
                })}
                <div style={{ position: "absolute", left: "50%", top: 0, bottom: 0, width: 1, background: theme.lightGray, pointerEvents: "none", opacity: 0.6 }} />
                <div style={{ position: "absolute", top: "50%", left: 0, right: 0, height: 1, background: theme.lightGray, pointerEvents: "none", opacity: 0.6 }} />
                <div style={{
                  position: "absolute",
                  left: `${dnaPosition.x * 100}%`, top: `${dnaPosition.y * 100}%`,
                  width: 28, height: 28, borderRadius: "50%",
                  background: activeArchetype.color, border: `3px solid ${theme.white}`,
                  boxShadow: "0 2px 10px rgba(0,0,0,0.3)",
                  transform: "translate(-50%, -50%)",
                  pointerEvents: "none",
                  transition: dragging ? "none" : "left 0.15s, top 0.15s",
                  zIndex: 10,
                }} />
              </div>
              <span style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: theme.medGray, writingMode: "vertical-rl", letterSpacing: "0.05em" }}>SOCIAL LEARNING</span>
            </div>
            <div style={{ display: "flex", justifyContent: "center", marginTop: 6 }}>
              <span style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: theme.medGray, letterSpacing: "0.05em" }}>QUICK & LIGHT</span>
            </div>
          </div>

          <div style={{ background: isDark ? activeArchetype.bgDark : activeArchetype.bgLight, border: `2px solid ${activeArchetype.color}`, borderRadius: 12, padding: 20, marginBottom: 16, transition: "all 0.2s" }}>
            <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 8 }}>
              <div style={{ width: 8, height: 8, borderRadius: "50%", background: activeArchetype.color, flexShrink: 0 }} />
              <div style={{ fontSize: 18, fontWeight: 700, fontFamily: MONO, color: theme.black }}>{activeArchetype.name}</div>
            </div>
            <div style={{ fontSize: 13, fontStyle: "italic", color: theme.medGray, marginBottom: 12, fontFamily: SANS }}>{activeArchetype.tagline}</div>
            <div style={{ fontSize: 12, color: theme.black, lineHeight: 1.6, marginBottom: 16 }}>{activeArchetype.description}</div>
            <div style={{ display: "flex", gap: 6, flexWrap: "wrap", marginBottom: 16 }}>
              {activeArchetype.referenceApps.map(app => (
                <div key={app.name} style={{ display: "flex", alignItems: "center", gap: 6, padding: "6px 12px", borderRadius: 8, background: theme.white, border: `1px solid ${theme.lightGray}`, fontSize: 12, fontFamily: MONO }}>
                  <span style={{ fontSize: 16 }}>{app.icon}</span>
                  <div>
                    <div style={{ fontWeight: 700, color: theme.black }}>{app.name}</div>
                    <div style={{ fontSize: 10, color: theme.medGray }}>{app.trait}</div>
                  </div>
                </div>
              ))}
            </div>
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
              <div style={{ padding: 12, borderRadius: 8, background: isDark ? "rgba(255,255,255,0.05)" : "rgba(0,0,0,0.02)" }}>
                <div style={{ fontSize: 10, fontWeight: 700, fontFamily: MONO, color: theme.emerald, marginBottom: 4 }}>BEST FOR</div>
                <div style={{ fontSize: 11, color: theme.black, lineHeight: 1.5 }}>{activeArchetype.bestFor}</div>
              </div>
              <div style={{ padding: 12, borderRadius: 8, background: isDark ? "rgba(255,255,255,0.05)" : "rgba(0,0,0,0.02)" }}>
                <div style={{ fontSize: 10, fontWeight: 700, fontFamily: MONO, color: theme.amber, marginBottom: 4 }}>TRADEOFF</div>
                <div style={{ fontSize: 11, color: theme.black, lineHeight: 1.5 }}>{activeArchetype.tradeoff}</div>
              </div>
            </div>
          </div>

          <button onClick={() => setConfirmedArchetype(activeArchetype.id)} style={{
            width: "100%", maxWidth: 520, display: "block", margin: "0 auto",
            padding: "14px 24px", borderRadius: 10, border: "none", fontSize: 14, fontWeight: 700, fontFamily: MONO, cursor: "pointer", transition: "all 0.15s",
            background: confirmedArchetype === activeArchetype.id ? theme.emerald : theme.black,
            color: theme.white,
          }}>
            {confirmedArchetype === activeArchetype.id ? "Locked In" : `Lock In: ${activeArchetype.name}`}
          </button>
          {confirmedArchetype && confirmedArchetype !== activeArchetype.id && (
            <div style={{ textAlign: "center", fontSize: 11, color: theme.amber, fontFamily: MONO, marginTop: 8 }}>
              Currently locked: {PL_ARCHETYPES.find(a => a.id === confirmedArchetype)?.name} â€” click to switch
            </div>
          )}
        </div>
      );
    }

    function PLFeatureCard({ feature, selected, onToggle, overBudget }) {
      const theme = useTheme();
      const isDark = theme.offWhite === "#1A1A1A";
      const stColors = { student: theme.emerald, instructor: isDark ? "#A78BFA" : "#7C3AED", admin: theme.red };
      return (
        <button onClick={onToggle} style={{ display: "flex", alignItems: "flex-start", gap: 10, width: "100%", padding: "12px 14px", marginBottom: 8, textAlign: "left", fontFamily: SANS, background: selected ? (isDark ? "#374151" : "#F0FDF4") : theme.white, border: `2px solid ${selected ? theme.emerald : theme.lightGray}`, borderRadius: 8, cursor: overBudget && !selected ? "not-allowed" : "pointer", opacity: overBudget && !selected ? 0.5 : 1, transition: "all 0.15s" }}>
          <span style={{ fontSize: 22, flexShrink: 0 }}>{feature.icon}</span>
          <div style={{ flex: 1, minWidth: 0 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 4, flexWrap: "wrap" }}>
              <span style={{ fontSize: 13, fontWeight: 700, color: theme.black, fontFamily: MONO }}>{feature.name}</span>
              <span style={{ fontSize: 10, fontWeight: 700, padding: "2px 8px", borderRadius: 10, background: isDark ? "#78350F" : "#FFF7ED", color: isDark ? "#F59E0B" : "#EA580C", fontFamily: MONO }}>{feature.cost} pt{feature.cost !== 1 ? "s" : ""}</span>
            </div>
            <div style={{ fontSize: 11, color: theme.medGray, lineHeight: 1.5, marginBottom: 6 }}>{feature.description}</div>
            <div style={{ display: "flex", gap: 4, flexWrap: "wrap" }}>
              {feature.stakeholders.map(s => (
                <span key={s} style={{ fontSize: 9, fontWeight: 600, padding: "1px 6px", borderRadius: 3, color: stColors[s], background: s === "student" ? theme.emeraldLight : s === "instructor" ? (isDark ? "#4C1D95" : "#F5F3FF") : theme.redLight, fontFamily: MONO, textTransform: "uppercase" }}>{s}</span>
              ))}
            </div>
          </div>
          <span style={{ fontSize: 16, flexShrink: 0, marginTop: 2 }}>{selected ? "âœ…" : "â—‹"}</span>
        </button>
      );
    }

    function PLBudgetLens({ selectedFeatures }) {
      const theme = useTheme();
      const totalCost = selectedFeatures.reduce((sum, f) => sum + f.cost, 0);
      const overBudget = totalCost > PL_BUDGET;
      const pct = Math.min(100, (totalCost / PL_BUDGET) * 100);
      return (
        <div>
          <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 16, fontFamily: MONO }}>Budget Lens</div>
          <div style={{ background: theme.offWhite, borderRadius: 8, padding: 16, marginBottom: 16 }}>
            <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 8 }}>
              <span style={{ fontSize: 28, fontWeight: 800, fontFamily: MONO, color: overBudget ? theme.red : theme.emerald }}>{totalCost}</span>
              <span style={{ fontSize: 28, fontWeight: 800, fontFamily: MONO, color: theme.medGray }}>/ {PL_BUDGET}</span>
            </div>
            <div style={{ height: 8, background: theme.lightGray, borderRadius: 4, overflow: "hidden", marginBottom: 8 }}>
              <div style={{ height: "100%", width: `${pct}%`, background: overBudget ? theme.red : pct > 80 ? theme.amber : theme.emerald, borderRadius: 4, transition: "all 0.3s" }} />
            </div>
            {overBudget && <div style={{ fontSize: 12, color: theme.red, fontWeight: 600, fontFamily: MONO }}>Over budget by {totalCost - PL_BUDGET} points! Remove features to ship.</div>}
            {!overBudget && totalCost > 0 && <div style={{ fontSize: 12, color: theme.emerald, fontFamily: MONO }}>{PL_BUDGET - totalCost} points remaining</div>}
          </div>
          {selectedFeatures.length > 0 && (
            <div>
              <div style={{ fontSize: 11, fontWeight: 700, color: theme.medGray, marginBottom: 8, fontFamily: MONO }}>COST BREAKDOWN</div>
              {[...selectedFeatures].sort((a, b) => b.cost - a.cost).map(f => (
                <div key={f.id} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "6px 0", borderBottom: `1px solid ${theme.lightGray}` }}>
                  <span style={{ fontSize: 12, color: theme.black }}>{f.icon} {f.name}</span>
                  <span style={{ fontSize: 12, fontWeight: 700, fontFamily: MONO, color: theme.black }}>{f.cost} pt{f.cost !== 1 ? "s" : ""}</span>
                </div>
              ))}
            </div>
          )}
          {selectedFeatures.length === 0 && <div style={{ fontSize: 12, color: theme.medGray, fontStyle: "italic", textAlign: "center", padding: 20 }}>Select features on the left to see budget impact</div>}
        </div>
      );
    }

    function PLTechLens({ selectedFeatures }) {
      const theme = useTheme();
      const isDark = theme.offWhite === "#1A1A1A";
      const reqCounts = {};
      selectedFeatures.forEach(f => { (f.requires || []).forEach(r => { reqCounts[r] = (reqCounts[r] || 0) + 1; }); });
      const activeReqs = Object.entries(reqCounts).sort((a, b) => b[1] - a[1]);
      return (
        <div>
          <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 16, fontFamily: MONO }}>Tech Stack Lens</div>
          {activeReqs.length > 0 ? (
            <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
              {activeReqs.map(([reqId, count]) => {
                const req = PL_TECH_REQS[reqId];
                if (!req) return null;
                const featsUsing = selectedFeatures.filter(f => (f.requires || []).includes(reqId));
                return (
                  <div key={reqId} style={{ background: theme.offWhite, borderRadius: 8, padding: 14, border: `1px solid ${theme.lightGray}` }}>
                    <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 6 }}>
                      <span style={{ fontSize: 13, fontWeight: 700, fontFamily: MONO, color: theme.black }}>{req.icon} {req.label}</span>
                      <span style={{ fontSize: 10, fontWeight: 700, padding: "2px 8px", borderRadius: 10, background: count >= 3 ? theme.emeraldLight : (isDark ? "#1E3A5F" : theme.blueLight), color: count >= 3 ? theme.emerald : theme.blue, fontFamily: MONO }}>used by {count}</span>
                    </div>
                    <div style={{ fontSize: 11, color: theme.medGray, lineHeight: 1.5, marginBottom: 6 }}>{req.description}</div>
                    <div style={{ display: "flex", gap: 4, flexWrap: "wrap" }}>
                      {featsUsing.map(f => (
                        <span key={f.id} style={{ fontSize: 9, padding: "2px 6px", borderRadius: 3, background: theme.white, border: `1px solid ${theme.lightGray}`, color: theme.black, fontFamily: MONO }}>{f.icon} {f.name}</span>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
          ) : (
            <div style={{ fontSize: 12, color: theme.medGray, fontStyle: "italic", textAlign: "center", padding: 20 }}>Select features on the left to see tech requirements</div>
          )}
        </div>
      );
    }

    function PLProductLens({ selectedFeatures }) {
      const theme = useTheme();
      const isDark = theme.offWhite === "#1A1A1A";
      const activeSynergies = PL_SYNERGIES.filter(s => s.features.filter(fId => selectedFeatures.some(f => f.id === fId)).length >= 2);
      const completeSynergies = activeSynergies.filter(s => s.features.every(fId => selectedFeatures.some(f => f.id === fId)));

      const hasInstructor = selectedFeatures.some(f => f.stakeholders.includes("instructor"));
      const hasAdmin = selectedFeatures.some(f => f.stakeholders.includes("admin"));
      const hasAI = selectedFeatures.some(f => f.requires.includes("ai-llm"));
      const studentCount = selectedFeatures.filter(f => f.stakeholders.includes("student")).length;

      let archetype = "Select features to see your product take shape";
      let archetypeDesc = "";
      if (selectedFeatures.length >= 2) {
        if (hasAI && studentCount >= 3) { archetype = "AI-Powered Learning Companion"; archetypeDesc = "A technology-forward tool that uses AI to create practice opportunities and personalized feedback at scale."; }
        else if (hasInstructor && studentCount >= 2) { archetype = "Two-Sided Teaching Platform"; archetypeDesc = "A system that creates a feedback loop between student preparation and instructor teaching. Value multiplies when both sides engage."; }
        else if (hasAdmin) { archetype = "Institutional Learning System"; archetypeDesc = "An enterprise tool with compliance tracking and institutional analytics. More complex to build, but addresses program-level needs."; }
        else if (studentCount >= 3) { archetype = "Student Practice Tool"; archetypeDesc = "A focused student-facing app for clinical reasoning practice. Simpler to build, highest adoption potential, but misses the instructor feedback loop."; }
        else { archetype = "Focused Experiment"; archetypeDesc = "A lightweight tool testing a specific hypothesis about the FCM experience."; }
      }

      return (
        <div>
          <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 16, fontFamily: MONO }}>Product Shape Lens</div>
          <div style={{ background: isDark ? "#064E3B" : "#F0FDF4", border: `1px solid ${theme.emerald}`, borderRadius: 10, padding: 18, marginBottom: 16 }}>
            <div style={{ fontSize: 16, fontWeight: 700, fontFamily: MONO, color: theme.black, marginBottom: 6 }}>{archetype}</div>
            {archetypeDesc && <div style={{ fontSize: 12, color: theme.medGray, lineHeight: 1.6 }}>{archetypeDesc}</div>}
          </div>
          {activeSynergies.length > 0 && (
            <div style={{ marginBottom: 16 }}>
              <div style={{ fontSize: 11, fontWeight: 700, color: theme.medGray, marginBottom: 8, fontFamily: MONO }}>DETECTED SYNERGIES</div>
              {activeSynergies.map(s => {
                const complete = completeSynergies.includes(s);
                const matched = s.features.filter(fId => selectedFeatures.some(f => f.id === fId));
                return (
                  <div key={s.id} style={{ background: complete ? (isDark ? "#064E3B" : "#F0FDF4") : theme.offWhite, border: `1px solid ${complete ? theme.emerald : theme.lightGray}`, borderRadius: 8, padding: 14, marginBottom: 8 }}>
                    <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 4 }}>
                      <span style={{ fontSize: 13, fontWeight: 700, fontFamily: MONO, color: theme.black }}>{s.icon} {s.name}</span>
                      <span style={{ fontSize: 10, fontWeight: 700, fontFamily: MONO, color: complete ? theme.emerald : theme.amber }}>{complete ? "Complete" : `${matched.length}/${s.features.length}`}</span>
                    </div>
                    <div style={{ fontSize: 11, color: theme.medGray, lineHeight: 1.5, marginBottom: 6 }}>{s.description}</div>
                    <div style={{ display: "flex", gap: 4, flexWrap: "wrap" }}>
                      {s.features.map(fId => {
                        const feat = PL_FEATURES.find(f => f.id === fId);
                        const has = selectedFeatures.some(f => f.id === fId);
                        return feat ? (
                          <span key={fId} style={{ fontSize: 9, padding: "2px 6px", borderRadius: 3, background: has ? theme.emeraldLight : theme.white, border: `1px solid ${has ? theme.emerald : theme.lightGray}`, color: has ? theme.emerald : theme.medGray, fontFamily: MONO }}>{has ? "âœ“" : "â—‹"} {feat.name}</span>
                        ) : null;
                      })}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
          {selectedFeatures.length >= 2 && (
            <div>
              <div style={{ fontSize: 11, fontWeight: 700, color: theme.medGray, marginBottom: 8, fontFamily: MONO }}>SUGGESTED BUILD ORDER</div>
              {[...selectedFeatures].sort((a, b) => {
                const aShared = selectedFeatures.filter(f => f.id !== a.id && f.requires.some(r => a.requires.includes(r))).length;
                const bShared = selectedFeatures.filter(f => f.id !== b.id && f.requires.some(r => b.requires.includes(r))).length;
                return bShared - aShared || a.cost - b.cost;
              }).map((f, i) => (
                <div key={f.id} style={{ display: "flex", alignItems: "center", gap: 10, padding: "8px 0", borderBottom: `1px solid ${theme.lightGray}` }}>
                  <span style={{ fontSize: 12, fontWeight: 700, fontFamily: MONO, color: theme.medGray, width: 24 }}>#{i + 1}</span>
                  <span style={{ fontSize: 12, color: theme.black }}>{f.icon} {f.name}</span>
                  <span style={{ fontSize: 10, color: theme.medGray, fontFamily: MONO, marginLeft: "auto" }}>{f.cost}pt</span>
                </div>
              ))}
            </div>
          )}
          {selectedFeatures.length === 0 && <div style={{ fontSize: 12, color: theme.medGray, fontStyle: "italic", textAlign: "center", padding: 20 }}>Select features on the left to see your product take shape</div>}
        </div>
      );
    }

    function PLProductBuilder({ selectedIds, toggleFeature }) {
      const theme = useTheme();
      const [activeLens, setActiveLens] = useState("budget");
      const selectedFeatures = PL_FEATURES.filter(f => selectedIds.includes(f.id));
      const totalCost = selectedFeatures.reduce((sum, f) => sum + f.cost, 0);
      const overBudget = totalCost > PL_BUDGET;

      const lenses = [
        { id: "budget", label: "Budget", icon: "ğŸ’°" },
        { id: "tech", label: "Tech Stack", icon: "ğŸ”§" },
        { id: "product", label: "Product Shape", icon: "ğŸ—ï¸" },
      ];

      return (
        <div>
          <p style={{ fontSize: 13, color: theme.medGray, lineHeight: 1.6, margin: "0 0 20px 0" }}>
            You have <strong style={{ color: theme.black }}>{PL_BUDGET} build points</strong>. Choose features that address the pain points you prioritized.{" "}
            <strong style={{ color: theme.black }}>Toggle lenses on the right</strong> to see how your choices shape the product.
          </p>
          <div className="pl-builder-grid" style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 20 }}>
            <div>
              <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 12, fontFamily: MONO }}>
                Feature Wishlist â€” {totalCost}/{PL_BUDGET} pts used
              </div>
              {PL_FEATURES.map(f => (
                <PLFeatureCard key={f.id} feature={f} selected={selectedIds.includes(f.id)} onToggle={() => toggleFeature(f.id)} overBudget={overBudget} />
              ))}
            </div>
            <div>
              <div style={{ display: "flex", gap: 0, borderBottom: `1px solid ${theme.lightGray}`, marginBottom: 16 }}>
                {lenses.map(lens => (
                  <button key={lens.id} onClick={() => setActiveLens(lens.id)} style={{ padding: "6px 12px", fontSize: 11, fontWeight: activeLens === lens.id ? 700 : 500, fontFamily: MONO, color: activeLens === lens.id ? theme.black : theme.medGray, background: "none", border: "none", borderBottom: activeLens === lens.id ? `2px solid ${theme.blue}` : "2px solid transparent", cursor: "pointer", marginBottom: -1 }}>
                    {lens.icon} {lens.label}
                  </button>
                ))}
              </div>
              <div style={{ background: theme.white, border: `1px solid ${theme.lightGray}`, borderRadius: 10, padding: 18, minHeight: 300, position: "sticky", top: 20 }}>
                {activeLens === "budget" && <PLBudgetLens selectedFeatures={selectedFeatures} />}
                {activeLens === "tech" && <PLTechLens selectedFeatures={selectedFeatures} />}
                {activeLens === "product" && <PLProductLens selectedFeatures={selectedFeatures} />}
              </div>
            </div>
          </div>
        </div>
      );
    }

    function PLPRDDraft({ voted, selectedFeatureIds, confirmedArchetype, notBuilding, setNotBuilding, newNotBuilding, setNewNotBuilding, prdNotes, setPrdNotes, generatePRDMarkdown, stColors }) {
      const theme = useTheme();
      const isDark = theme.offWhite === "#1A1A1A";
      const [copied, setCopied] = useState(false);
      const [showPreview, setShowPreview] = useState(false);
      const selectedFeatures = PL_FEATURES.filter(f => selectedFeatureIds.includes(f.id));
      const totalCost = selectedFeatures.reduce((sum, f) => sum + f.cost, 0);
      const overBudget = totalCost > PL_BUDGET;
      const reqSet = new Set();
      selectedFeatures.forEach(f => (f.requires || []).forEach(r => reqSet.add(r)));
      const activeSynergies = PL_SYNERGIES.filter(s => s.features.every(fId => selectedFeatures.some(f => f.id === fId)));
      const handleCopy = () => {
        navigator.clipboard.writeText(generatePRDMarkdown()).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); });
      };
      const handleDownload = () => {
        const blob = new Blob([generatePRDMarkdown()], { type: "text/markdown" });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `fcm-prd-draft-${new Date().toISOString().slice(0,10)}.md`; a.click();
      };
      return (
        <div>
          <p style={{ fontSize: 13, color: theme.medGray, lineHeight: 1.6, margin: "0 0 20px 0" }}>
            Your feature selections and priorities assembled into a draft PRD.{" "}
            <strong style={{ color: theme.black }}>Copy to Claude</strong> for refinement, or export as markdown for your repo.
          </p>
          <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(300px, 1fr))", gap: 16, marginBottom: 20 }}>
            <div style={{ background: theme.white, border: `1px solid ${theme.lightGray}`, borderRadius: 10, padding: 18 }}>
              <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 12, fontFamily: MONO }}>Prioritized Pain Points ({voted.painPoints.length})</div>
              {voted.painPoints.length === 0 ? (
                <div style={{ fontSize: 12, color: theme.medGray, fontStyle: "italic" }}>Go to Evidence Wall and click items to prioritize</div>
              ) : voted.painPoints.map(p => (
                <div key={p.id} style={{ fontSize: 12, lineHeight: 1.5, marginBottom: 6, display: "flex", gap: 8 }}>
                  <span style={{ fontSize: 10, fontWeight: 600, padding: "1px 6px", borderRadius: 3, flexShrink: 0, background: stColors[p.stakeholder]?.bg, color: stColors[p.stakeholder]?.color, fontFamily: MONO }}>{p.stakeholderLabel}</span>
                  <span style={{ color: theme.black }}>{p.text}</span>
                </div>
              ))}
            </div>
            <div style={{ background: theme.white, border: `1px solid ${theme.lightGray}`, borderRadius: 10, padding: 18 }}>
              <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 12, fontFamily: MONO }}>Prioritized Wishes ({voted.wishes.length})</div>
              {voted.wishes.length === 0 ? (
                <div style={{ fontSize: 12, color: theme.medGray, fontStyle: "italic" }}>Go to Evidence Wall and click wish items to prioritize</div>
              ) : voted.wishes.map(w => (
                <div key={w.id} style={{ fontSize: 12, lineHeight: 1.5, marginBottom: 6, display: "flex", gap: 8 }}>
                  <span style={{ fontSize: 10, fontWeight: 600, padding: "1px 6px", borderRadius: 3, flexShrink: 0, background: stColors[w.stakeholder]?.bg, color: stColors[w.stakeholder]?.color, fontFamily: MONO }}>{w.stakeholderLabel}</span>
                  <span style={{ color: theme.black }}>{w.text}</span>
                </div>
              ))}
            </div>
          </div>
          {confirmedArchetype && (() => {
            const arch = PL_ARCHETYPES.find(a => a.id === confirmedArchetype);
            return arch ? (
              <div style={{ background: isDark ? arch.bgDark : arch.bgLight, border: `2px solid ${arch.color}`, borderRadius: 10, padding: 18, marginBottom: 20 }}>
                <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: arch.color, marginBottom: 8, fontFamily: MONO }}>Product Archetype</div>
                <div style={{ fontSize: 16, fontWeight: 700, fontFamily: MONO, color: theme.black, marginBottom: 4 }}>{arch.name}</div>
                <div style={{ fontSize: 12, color: theme.medGray, lineHeight: 1.5, marginBottom: 8 }}>{arch.tagline} â€” {arch.description}</div>
                <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                  {arch.referenceApps.map(app => (
                    <span key={app.name} style={{ fontSize: 11, padding: "3px 8px", borderRadius: 6, background: theme.white, border: `1px solid ${theme.lightGray}`, fontFamily: MONO, color: theme.black }}>{app.icon} {app.name}</span>
                  ))}
                </div>
              </div>
            ) : null;
          })()}
          <div style={{ background: theme.white, border: `1px solid ${theme.lightGray}`, borderRadius: 10, padding: 18, marginBottom: 20 }}>
            <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 12, fontFamily: MONO }}>Selected Features ({selectedFeatures.length}) â€” {totalCost}/{PL_BUDGET} pts</div>
            {selectedFeatures.length === 0 ? (
              <div style={{ fontSize: 12, color: theme.medGray, fontStyle: "italic" }}>Go to Product Builder and select features</div>
            ) : (
              <div>
                {overBudget && <div style={{ fontSize: 12, color: theme.red, fontWeight: 600, fontFamily: MONO, marginBottom: 12, padding: "8px 12px", background: theme.redLight, borderRadius: 6 }}>Over budget by {totalCost - PL_BUDGET} points â€” trim features before building</div>}
                <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(200px, 1fr))", gap: 10 }}>
                  {selectedFeatures.map(f => (
                    <div key={f.id} style={{ padding: "10px 12px", borderRadius: 6, background: theme.offWhite, border: `1px solid ${theme.lightGray}` }}>
                      <div style={{ fontSize: 13, fontWeight: 700, color: theme.black, fontFamily: MONO, marginBottom: 2 }}>{f.icon} {f.name}</div>
                      <div style={{ fontSize: 10, color: theme.medGray, fontFamily: MONO }}>{f.cost} pt{f.cost !== 1 ? "s" : ""} Â· {f.stakeholders.join(", ")}</div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
          {reqSet.size > 0 && (
            <div style={{ background: theme.white, border: `1px solid ${theme.lightGray}`, borderRadius: 10, padding: 18, marginBottom: 20 }}>
              <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 12, fontFamily: MONO }}>Required Tech Stack ({reqSet.size})</div>
              <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
                {[...reqSet].map(rId => {
                  const req = PL_TECH_REQS[rId];
                  return req ? <span key={rId} style={{ fontSize: 11, padding: "4px 10px", borderRadius: 6, background: theme.offWhite, border: `1px solid ${theme.lightGray}`, color: theme.black, fontFamily: MONO }}>{req.icon} {req.label}</span> : null;
                })}
              </div>
            </div>
          )}
          {activeSynergies.length > 0 && (
            <div style={{ background: isDark ? "#064E3B" : "#F0FDF4", border: `1px solid ${theme.emerald}`, borderRadius: 10, padding: 18, marginBottom: 20 }}>
              <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.emerald, marginBottom: 8, fontFamily: MONO }}>Active Synergy Loops ({activeSynergies.length})</div>
              {activeSynergies.map(s => (
                <div key={s.id} style={{ fontSize: 12, color: theme.black, marginBottom: 4 }}>{s.icon} <strong>{s.name}</strong> â€” {s.description}</div>
              ))}
            </div>
          )}
          <div style={{ background: theme.white, border: `1px solid ${theme.lightGray}`, borderRadius: 10, padding: 18, marginBottom: 20 }}>
            <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 10, fontFamily: MONO }}>What We're NOT Building</div>
            <p style={{ fontSize: 12, color: theme.medGray, lineHeight: 1.5, margin: "0 0 10px 0" }}>Just as important as what you build. Saying "no" to good ideas keeps scope tight.</p>
            {notBuilding.map((item, idx) => (
              <div key={idx} style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 6 }}>
                <span style={{ fontSize: 12, lineHeight: 1.5, flex: 1, color: theme.black }}>â€¢ {item}</span>
                <button onClick={() => setNotBuilding(prev => prev.filter((_, i) => i !== idx))} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 12, color: theme.medGray, padding: "2px 6px" }}>Ã—</button>
              </div>
            ))}
            <div style={{ display: "flex", gap: 6, marginTop: 10 }}>
              <input type="text" value={newNotBuilding} onChange={e => setNewNotBuilding(e.target.value)} onKeyDown={e => { if (e.key === "Enter" && newNotBuilding.trim()) { setNotBuilding(prev => [...prev, newNotBuilding.trim()]); setNewNotBuilding(""); } }} placeholder="Add scope exclusion..." style={{ flex: 1, padding: "6px 10px", fontSize: 12, fontFamily: MONO, border: `1px solid ${theme.lightGray}`, borderRadius: 6, background: theme.offWhite, color: theme.black, outline: "none" }} />
            </div>
          </div>
          <div style={{ background: theme.white, border: `1px solid ${theme.lightGray}`, borderRadius: 10, padding: 18, marginBottom: 20 }}>
            <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 10, fontFamily: MONO }}>Additional Notes</div>
            <textarea value={prdNotes} onChange={e => setPrdNotes(e.target.value)} placeholder="Anything else the PRD should capture? Design preferences, technical constraints, questions for the team..." style={{ width: "100%", minHeight: 80, padding: 12, fontSize: 12, fontFamily: SANS, border: `1px solid ${theme.lightGray}`, borderRadius: 6, background: theme.offWhite, color: theme.black, outline: "none", resize: "vertical", lineHeight: 1.6, boxSizing: "border-box" }} />
          </div>
          <div style={{ display: "flex", gap: 12, flexWrap: "wrap" }}>
            <button onClick={handleCopy} style={{ padding: "12px 24px", borderRadius: 8, border: "none", background: theme.black, color: theme.white, cursor: "pointer", fontWeight: 700, fontSize: 13, fontFamily: MONO }}>{copied ? "Copied!" : "Copy PRD to Clipboard"}</button>
            <button onClick={() => setShowPreview(!showPreview)} style={{ padding: "12px 24px", borderRadius: 8, border: `1px solid ${theme.lightGray}`, background: theme.white, color: theme.black, cursor: "pointer", fontWeight: 600, fontSize: 13, fontFamily: MONO }}>{showPreview ? "Hide Preview" : "Preview Markdown"}</button>
            <button onClick={handleDownload} style={{ padding: "12px 24px", borderRadius: 8, border: `1px solid ${theme.lightGray}`, background: theme.white, color: theme.black, cursor: "pointer", fontWeight: 600, fontSize: 13, fontFamily: MONO }}>Download .md</button>
          </div>
          {showPreview && (
            <div style={{ marginTop: 16, padding: 20, background: isDark ? "#111" : "#1a1a1a", borderRadius: 8, fontFamily: MONO, fontSize: 11, color: "#e0e0e0", lineHeight: 1.7, whiteSpace: "pre-wrap", overflow: "auto", maxHeight: 500 }}>
              {generatePRDMarkdown()}
            </div>
          )}
        </div>
      );
    }

    function ProductLab() {
      const theme = useTheme();
      const isDark = theme.offWhite === "#1A1A1A";
      const stColors = useMemo(() => ({
        student: { color: theme.emerald, bg: theme.emeraldLight },
        instructor: { color: isDark ? "#A78BFA" : "#7C3AED", bg: isDark ? "#4C1D95" : "#F5F3FF" },
        admin: { color: theme.red, bg: theme.redLight },
      }), [theme, isDark]);

      const saved = useMemo(() => {
        try { return JSON.parse(localStorage.getItem("fcm-product-lab")) || {}; } catch { return {}; }
      }, []);

      const [plTab, setPlTab] = useState("evidence");
      const [votes, setVotes] = useState(saved.votes || {});
      const [selectedFeatures, setSelectedFeatures] = useState(saved.selectedFeatures || []);
      const [dnaPosition, setDnaPosition] = useState(saved.dnaPosition || { x: 0.5, y: 0.5 });
      const [confirmedArchetype, setConfirmedArchetype] = useState(saved.confirmedArchetype || null);
      const [customPainPoints, setCustomPainPoints] = useState(saved.customPainPoints || { student: [], instructor: [], admin: [] });
      const [notBuilding, setNotBuilding] = useState(saved.notBuilding || ["Full EMR integration", "Graded assessments (this is practice, not evaluation)", "Replacing FCM sessions entirely"]);
      const [prdNotes, setPrdNotes] = useState(saved.prdNotes || "");
      const [newPainPoint, setNewPainPoint] = useState({ student: "", instructor: "", admin: "" });
      const [newNotBuilding, setNewNotBuilding] = useState("");

      useEffect(() => {
        try { localStorage.setItem("fcm-product-lab", JSON.stringify({ votes, selectedFeatures, dnaPosition, confirmedArchetype, customPainPoints, notBuilding, prdNotes })); } catch {}
      }, [votes, selectedFeatures, dnaPosition, confirmedArchetype, customPainPoints, notBuilding, prdNotes]);

      const toggleVote = useCallback((id) => { setVotes(prev => ({ ...prev, [id]: prev[id] ? 0 : 1 })); }, []);

      const toggleFeature = useCallback((id) => {
        setSelectedFeatures(prev => prev.includes(id) ? prev.filter(f => f !== id) : [...prev, id]);
      }, []);

      const addPainPoint = useCallback((stakeholder) => {
        if (!newPainPoint[stakeholder].trim()) return;
        setCustomPainPoints(prev => ({ ...prev, [stakeholder]: [...prev[stakeholder], { id: `custom-${Date.now()}`, text: newPainPoint[stakeholder].trim(), custom: true }] }));
        setNewPainPoint(prev => ({ ...prev, [stakeholder]: "" }));
      }, [newPainPoint]);

      const getVotedItems = useCallback(() => {
        const result = { painPoints: [], wishes: [] };
        Object.entries(PL_EVIDENCE).forEach(([key, data]) => {
          data.painPoints.filter(p => votes[p.id]).forEach(p => result.painPoints.push({ ...p, stakeholder: key, stakeholderLabel: data.label }));
          data.wishes.filter(w => votes[w.id]).forEach(w => result.wishes.push({ ...w, stakeholder: key, stakeholderLabel: data.label }));
        });
        Object.entries(customPainPoints).forEach(([key, points]) => {
          points.filter(p => votes[p.id]).forEach(p => result.painPoints.push({ ...p, stakeholder: key, stakeholderLabel: PL_EVIDENCE[key].label }));
        });
        return result;
      }, [votes, customPainPoints]);

      const generatePRDMarkdown = useCallback(() => {
        const v = getVotedItems();
        const selFeats = PL_FEATURES.filter(f => selectedFeatures.includes(f.id));
        const notSelFeats = PL_FEATURES.filter(f => !selectedFeatures.includes(f.id));
        const totalCost = selFeats.reduce((sum, f) => sum + f.cost, 0);
        const reqSet = new Set();
        selFeats.forEach(f => (f.requires || []).forEach(r => reqSet.add(r)));
        const synergies = PL_SYNERGIES.filter(s => s.features.every(fId => selFeats.some(f => f.id === fId)));
        const arch = confirmedArchetype ? PL_ARCHETYPES.find(a => a.id === confirmedArchetype) : null;

        const featMd = selFeats.length > 0
          ? selFeats.map(f => `- **${f.name}** ${f.icon} (${f.cost}pt) â€” ${f.description}\n  - Stakeholders: ${f.stakeholders.join(", ")}\n  - Requires: ${f.requires.join(", ")}`).join("\n")
          : "*No features selected yet*";
        const notFeatMd = notSelFeats.map(f => `- ~~${f.name}~~ (${f.cost}pt) â€” ${f.description}`).join("\n");
        const techMd = reqSet.size > 0
          ? [...reqSet].map(rId => { const r = PL_TECH_REQS[rId]; return r ? `- ${r.icon} **${r.label}** â€” ${r.description}` : null; }).filter(Boolean).join("\n")
          : "*No tech requirements (select features first)*";
        const synMd = synergies.length > 0
          ? synergies.map(s => `- ${s.icon} **${s.name}** â€” ${s.description}\n  - Features: ${s.features.map(fId => PL_FEATURES.find(f => f.id === fId)?.name || fId).join(", ")}`).join("\n")
          : "";
        const painMd = v.painPoints.length > 0 ? v.painPoints.map(p => `- [${p.stakeholderLabel}] ${p.text}`).join("\n") : "*No pain points prioritized yet*";
        const wishMd = v.wishes.length > 0 ? v.wishes.map(w => `- [${w.stakeholderLabel}] ${w.text}`).join("\n") : "*No wishes prioritized yet*";

        const archMd = arch
          ? `## 5. Product Archetype: ${arch.name}\n*"${arch.tagline}"*\n\n${arch.description}\n\n**Reference products:** ${arch.referenceApps.map(a => `${a.name} (${a.trait})`).join(", ")}\n\n**Best for:** ${arch.bestFor}\n\n**Key tradeoff:** ${arch.tradeoff}\n`
          : "## 5. Product Archetype\n*Not yet selected â€” go to Product DNA tab*\n";

        let sec = 6;
        let md = `# FCM Companion App â€” Product Requirements Document\n\n`;
        md += `*Generated by Product Lab â€” Health Design Sprint 2026*\n`;
        md += `*University of Virginia School of Medicine*\n`;
        md += `*Date: ${new Date().toLocaleDateString()}*\n\n`;
        md += `---\n\n`;

        // Section 1: Background & Context
        md += `## 1. Background & Context\n\n`;
        md += `### What is FCM?\n`;
        md += `Foundations of Clinical Medicine (FCM) is a longitudinal first-year course at the University of Virginia School of Medicine. Students learn clinical reasoning â€” how to take a patient history, build a differential diagnosis, perform a physical exam, and synthesize findings into a clinical assessment.\n\n`;
        md += `### The FCM Case Cycle\n`;
        md += `Each week, students go through a repeating cycle:\n\n`;
        md += `1. **Case Assignment** â€” Receive a one-line chief concern (e.g., "43 y/o male, 1-week worsening SOB") posted to the LMS\n`;
        md += `2. **Pre-Session Prep** â€” Build a broad differential diagnosis. Select history questions and PE maneuvers. Complete a pre-class worksheet (VINDICATE framework)\n`;
        md += `3. **The Gap** â€” Days pass between receiving the case and the session. Students study other subjects. The case goes cold in memory\n`;
        md += `4. **Small Group Session** â€” 4-hour in-person session with a clinical coach and ~6 students. Students present cases, discuss reasoning, observe peers\n`;
        md += `5. **Patient Encounter** â€” Interview a standardized patient. Full history, targeted physical exam, present assessment and plan\n`;
        md += `6. **Coach Feedback** â€” Verbal feedback during/after encounter. Quality and depth vary significantly by coach\n`;
        md += `7. **Write the Note** â€” Synthesize encounter into an illness script with ranked diagnoses and supporting evidence\n`;
        md += `8. **Written Feedback** â€” Coach reviews illness script in LMS. Often delayed, sometimes cursory\n`;
        md += `9. **The Fade** â€” No structured follow-up. Student may never revisit this case. Learning is entirely self-directed\n\n`;
        md += `### The Core Problems\n`;
        md += `- Students prepare in isolation with no feedback on whether their reasoning is sound\n`;
        md += `- Instructors walk into sessions "flying blind" â€” they don't know what students prepared or where they're confused\n`;
        md += `- The gap between case assignment and session causes knowledge decay\n`;
        md += `- After sessions, there is no structured mechanism to close the learning loop\n`;
        md += `- The current cycle rewards completion over quality of reasoning\n\n`;

        // Section 2: Users
        md += `## 2. Users & Stakeholders\n\n`;
        md += `| Role | Count | Description |\n`;
        md += `|------|-------|-------------|\n`;
        md += `| **M1 Students** | ~180/year (groups of ~6) | Primary users. Cycle through weekly cases. Need better prep tools and feedback loops |\n`;
        md += `| **FCM Coaches** | ~30 instructors | Lead small group sessions. Want visibility into student readiness. Need fast, lightweight tools |\n`;
        md += `| **Curriculum Admins** | 3-5 | Track AAMC competency alignment, student progress at scale, coach consistency |\n\n`;

        // Section 3: User Research
        md += `## 3. User Research Findings\n\n`;
        md += `This PRD is based on structured user research conducted during the Health Design Sprint at UVA (February 2026), including journey mapping of the FCM case cycle, stakeholder interviews, pain point prioritization, and feature tradeoff analysis with medical students.\n\n`;
        md += `### Prioritized Pain Points\n${painMd}\n\n`;
        md += `### Prioritized Wishes\n${wishMd}\n\n`;

        // Section 4: Vision
        md += `## 4. Vision\n\n`;
        md += `A digital companion for the FCM case cycle that transforms passive preparation into active clinical reasoning practice, makes student thinking visible to instructors before sessions, and creates structured feedback loops that close the gap between preparation and learning.\n\n`;

        // Section 5: Archetype
        md += `${archMd}\n`;

        // Section 6: Features
        md += `## ${sec}. Selected Features (${totalCost}/${PL_BUDGET} build points)\n${featMd}\n\n`;
        sec++;

        // Section: Not Selected
        if (notSelFeats.length > 0) {
          md += `## ${sec}. Features Considered but Not Selected\nThese were evaluated during the design sprint but cut due to budget constraints:\n${notFeatMd}\n\n`;
          sec++;
        }

        // Section: Tech Stack
        md += `## ${sec}. Required Tech Stack\n${techMd}\n\n`;
        sec++;

        // Section: Synergies
        if (synMd) {
          md += `## ${sec}. Synergy Loops\nThese feature combinations create reinforcing product loops:\n${synMd}\n\n`;
          sec++;
        }

        // Section: Not Building
        md += `## ${sec}. What We're NOT Building\n${notBuilding.map(n => `- ${n}`).join("\n")}\n\n`;
        sec++;

        // Section: Notes
        md += `## ${sec}. Additional Notes\n${prdNotes || "*None yet*"}\n\n`;
        sec++;

        // Section: Build Instructions
        md += `---\n\n`;
        md += `## Build Instructions\n\n`;
        md += `This app should be built as a responsive web application (mobile-friendly, works on phones and laptops). The target users are medical students and clinical instructors at UVA School of Medicine.\n\n`;
        md += `**Recommended stack:** Next.js or similar React framework, Supabase for database/auth, Tailwind CSS for styling, deployed to Vercel or similar.\n\n`;
        md += `**MVP scope:** Focus on the selected features above within the ${PL_BUDGET}-point build budget. Start with features that share the most tech requirements (to maximize infrastructure reuse) and build outward.\n\n`;
        md += `**To start building:** Paste this entire PRD into Claude Code or your preferred AI coding assistant. All context needed to understand the domain, users, and product decisions is included above.\n`;

        return md;
      }, [selectedFeatures, confirmedArchetype, notBuilding, prdNotes, getVotedItems]);

      const voted = getVotedItems();
      const totalVoted = voted.painPoints.length + voted.wishes.length;
      const featCost = PL_FEATURES.filter(f => selectedFeatures.includes(f.id)).reduce((s, f) => s + f.cost, 0);
      const overBudget = featCost > PL_BUDGET;
      const plTabs = [
        { id: "evidence", label: "Evidence Wall", icon: "ğŸ“Œ" },
        { id: "dna", label: "Product DNA", icon: "ğŸ§¬" },
        { id: "builder", label: "Product Builder", icon: "ğŸ”§" },
        { id: "prd", label: "PRD Draft", icon: "ğŸ“„" },
      ];

      return (
        <div>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 20, flexWrap: "wrap", gap: 12 }}>
            <div style={{ display: "flex", gap: 0, borderBottom: `1px solid ${theme.lightGray}` }}>
              {plTabs.map(tab => (
                <button key={tab.id} onClick={() => setPlTab(tab.id)} style={{ padding: "8px 16px", fontSize: 13, fontWeight: plTab === tab.id ? 700 : 500, fontFamily: MONO, color: plTab === tab.id ? theme.black : theme.medGray, background: "none", border: "none", borderBottom: plTab === tab.id ? `2px solid ${theme.blue}` : "2px solid transparent", cursor: "pointer", marginBottom: -1 }}>
                  {tab.icon} {tab.label}
                </button>
              ))}
            </div>
            <div style={{ display: "flex", gap: 16, alignItems: "center" }}>
              <div style={{ textAlign: "center" }}>
                <div style={{ fontSize: 20, fontWeight: 700, fontFamily: MONO, color: theme.black }}>{totalVoted}</div>
                <div style={{ fontSize: 10, color: theme.medGray, textTransform: "uppercase", letterSpacing: "0.08em", fontFamily: MONO }}>prioritized</div>
              </div>
              <div style={{ width: 1, height: 28, background: theme.lightGray }} />
              <div style={{ textAlign: "center" }}>
                <div style={{ fontSize: 20, fontWeight: 700, fontFamily: MONO, color: overBudget ? theme.red : theme.black }}>{featCost}/{PL_BUDGET}</div>
                <div style={{ fontSize: 10, color: theme.medGray, textTransform: "uppercase", letterSpacing: "0.08em", fontFamily: MONO }}>build pts</div>
              </div>
            </div>
          </div>
          {plTab === "evidence" && <PLEvidenceWall votes={votes} toggleVote={toggleVote} customPainPoints={customPainPoints} setCustomPainPoints={setCustomPainPoints} newPainPoint={newPainPoint} setNewPainPoint={setNewPainPoint} addPainPoint={addPainPoint} stColors={stColors} />}
          {plTab === "dna" && <PLProductDNA dnaPosition={dnaPosition} setDnaPosition={setDnaPosition} confirmedArchetype={confirmedArchetype} setConfirmedArchetype={setConfirmedArchetype} />}
          {plTab === "builder" && <PLProductBuilder selectedIds={selectedFeatures} toggleFeature={toggleFeature} />}
          {plTab === "prd" && <PLPRDDraft voted={voted} selectedFeatureIds={selectedFeatures} confirmedArchetype={confirmedArchetype} notBuilding={notBuilding} setNotBuilding={setNotBuilding} newNotBuilding={newNotBuilding} setNewNotBuilding={setNewNotBuilding} prdNotes={prdNotes} setPrdNotes={setPrdNotes} generatePRDMarkdown={generatePRDMarkdown} stColors={stColors} />}
        </div>
      );
    }

    /* â”€â”€ FCMJourneyMapper (main) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function getDefaultSession() {
      if (!SESSION_DATA || !SESSION_DATA.sessions.length) return null;
      return SESSION_DATA.sessions[SESSION_DATA.sessions.length - 1].id;
    }

    function FCMJourneyMapper() {
      const [selectedSession, setSelectedSession] = useState(getDefaultSession);
      const [steps, setSteps] = useState(DEFAULT_STEPS);
      const [perspective, setPerspective] = useState("Student");
      const [showIntro, setShowIntro] = useState(true);
      const [yieldApprovals, setYieldApprovals] = useState({});
      const [expandSignal, setExpandSignal] = useState(0);
      const [showDiff, setShowDiff] = useState(false);
      const [darkMode, setDarkMode] = useState(() => {
        try { return localStorage.getItem("fcm-dark-mode") === "true"; } catch { return false; }
      });
      const [mainTab, setMainTab] = useState("journey");
      const theme = darkMode ? BRAND_DARK : BRAND;
      useEffect(() => { document.body.style.background = theme.offWhite; }, [theme.offWhite]);
      const toggleDarkMode = () => {
        setDarkMode(prev => {
          const next = !prev;
          try { localStorage.setItem("fcm-dark-mode", String(next)); } catch {}
          return next;
        });
      };

      const session = useMemo(() => getSessionById(selectedSession), [selectedSession]);
      const pKey = perspectiveKey(perspective);
      const isAdmin = perspective === "Administrator";
      const allSessions = SESSION_DATA ? SESSION_DATA.sessions : [];

      // Load session data into steps when session or perspective changes
      useEffect(() => {
        if (!selectedSession || !session) {
          // Blank template â€” restore annotations from localStorage
          const saved = loadAnnotations(null);
          const fresh = DEFAULT_STEPS.map(s => {
            const ann = saved[s.id];
            return ann ? { ...s, ...ann } : { ...s };
          });
          setSteps(fresh);
          setYieldApprovals(loadYieldApprovals(null));
          return;
        }

        const perspData = session.perspectives?.[pKey];
        const stepsData = perspData?.steps;
        const saved = loadAnnotations(selectedSession);

        const merged = DEFAULT_STEPS.map(s => {
          const sd = stepsData?.[s.id];
          const ann = saved[s.id] || {};
          if (!sd) return { ...s, ...ann };
          return {
            ...s,
            actual: ann.actual ?? sd.suggestedActual ?? s.actual,
            emotion: ann.emotion !== undefined ? ann.emotion : (sd.suggestedEmotion !== undefined ? sd.suggestedEmotion : s.emotion),
            friction: ann.friction ?? sd.suggestedFriction ?? s.friction,
            wish: ann.wish ?? sd.suggestedWish ?? s.wish,
            thinking: ann.thinking ?? s.thinking,
            starred: ann.starred !== undefined ? ann.starred : s.starred,
          };
        });
        setSteps(merged);
        setYieldApprovals(loadYieldApprovals(selectedSession));
      }, [selectedSession, pKey]);

      // Persist annotations on change
      const updateStep = useCallback((id, updates) => {
        setSteps(prev => {
          const next = prev.map(s => (s.id === id ? { ...s, ...updates } : s));
          // Save annotations
          const annotations = {};
          next.forEach(s => {
            const def = DEFAULT_STEPS.find(d => d.id === s.id);
            if (!def) return;
            const ann = {};
            if (s.actual !== def.actual) ann.actual = s.actual;
            if (s.thinking !== def.thinking) ann.thinking = s.thinking;
            if (s.emotion !== def.emotion) ann.emotion = s.emotion;
            if (s.friction !== def.friction) ann.friction = s.friction;
            if (s.wish !== def.wish) ann.wish = s.wish;
            if (s.starred !== def.starred) ann.starred = s.starred;
            if (Object.keys(ann).length > 0) annotations[s.id] = ann;
          });
          saveAnnotations(selectedSession, annotations);
          return next;
        });
      }, [selectedSession]);

      const addInvisibleAfter = useCallback((afterId) => {
        setSteps((prev) => {
          const idx = prev.findIndex((s) => s.id === afterId);
          const newStep = { id: `inv-${Date.now()}`, title: "ğŸ‘» [Name this step]", official: "You discovered this â€” it's not in any official document.", artifact: "None", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: true };
          const next = [...prev];
          next.splice(idx + 1, 0, newStep);
          return next;
        });
      }, []);

      const handleYieldApproval = useCallback((key, value) => {
        setYieldApprovals(prev => {
          const next = { ...prev };
          if (value === null) { delete next[key]; } else { next[key] = value; }
          saveYieldApprovals(selectedSession, next);
          return next;
        });
      }, [selectedSession]);

      const getStepSessionData = (stepId) => {
        if (!session) return null;
        return session.perspectives?.[pKey]?.steps?.[stepId] || null;
      };

      const getStability = (stepId) => {
        if (!session) return null;
        return session.analysis?.stability?.[stepId] || null;
      };

      const getYieldOpps = () => {
        if (!session) return null;
        return session.analysis?.yieldOpportunities || null;
      };

      // Diff computation
      const prevSession = useMemo(() => {
        if (!selectedSession || !SESSION_DATA) return null;
        const idx = allSessions.findIndex(s => s.id === selectedSession);
        if (idx <= 0) return null;
        return getSessionById(allSessions[idx - 1].id);
      }, [selectedSession]);

      const canShowDiff = prevSession !== null;

      const getDiffData = (stepId) => {
        if (!showDiff || !prevSession || !session) return null;
        const currStepData = session.perspectives?.[pKey]?.steps?.[stepId];
        const prevStepData = prevSession.perspectives?.[pKey]?.steps?.[stepId];
        if (!currStepData) return null;

        const diff = {};
        // New themes
        const prevThemes = prevStepData?.themes || [];
        const currThemes = currStepData.themes || [];
        diff.newThemes = currThemes.filter(t => !prevThemes.includes(t));
        // New quotes
        const prevQuoteTexts = (prevStepData?.keyQuotes || []).map(q => q.text);
        const currQuotes = currStepData.keyQuotes || [];
        diff.newQuotes = currQuotes.filter(q => !prevQuoteTexts.includes(q.text)).map(q => q.text);
        // Emotion change
        if (prevStepData && currStepData.suggestedEmotion !== undefined && prevStepData.suggestedEmotion !== undefined && currStepData.suggestedEmotion !== prevStepData.suggestedEmotion) {
          diff.emotionChanged = true;
        }
        return diff;
      };

      const getPrevStability = (stepId) => {
        if (!showDiff || !prevSession) return null;
        return prevSession.analysis?.stability?.[stepId] || null;
      };

      const getDiffYieldOpps = () => {
        if (!showDiff || !prevSession || !session) return null;
        const currOpps = session.analysis?.yieldOpportunities || [];
        const prevOpps = prevSession.analysis?.yieldOpportunities || [];
        const prevTitles = prevOpps.map(o => o.title);
        const prevScores = {};
        prevOpps.forEach(o => { prevScores[o.title] = o.yieldScore; });
        return {
          newTitles: currOpps.filter(o => !prevTitles.includes(o.title)).map(o => o.title),
          scoreChanges: currOpps.reduce((acc, o) => {
            if (prevScores[o.title] !== undefined && prevScores[o.title] !== o.yieldScore) {
              acc[o.title] = o.yieldScore - prevScores[o.title];
            }
            return acc;
          }, {}),
        };
      };

      const handleExport = () => {
        const starred = steps.filter((s) => s.starred && s.wish);
        let md = `# FCM Journey Map â€” ${perspective} Perspective\n`;
        md += `*Generated ${new Date().toLocaleDateString()} Â· HDS 2026*\n`;
        if (session) {
          md += `*Session: ${session.label} (${session.date}) Â· ${session.participantCount} participants*\n`;
        }
        md += `\n`;
        md += `## Context\n\n`;
        md += `This journey map was produced as part of the UVA Health Design Sprint (HDS) 2026, where medical students are designing an AI-native tool to improve the Foundations of Clinical Medicine (FCM) case cycle. `;
        md += `FCM is a multi-year pre-clerkship program where students receive clinical cases, build differentials, attend small-group sessions with standardized patients, and receive coach feedback.\n\n`;
        md += `**How to use this document:** This journey map captures real student/coach/administrator experiences and friction points from group discussion sessions. `;
        md += `It should be integrated with the team's Product Requirements Document (PRD) and other design artifacts. `;
        md += `When used with Claude or another AI assistant, combine this with the PRD to ground feature decisions in actual user evidence. `;
        md += `The friction points and wishes below are direct inputs for user stories, job stories, and feature specifications.\n\n`;
        md += `---\n\n`;
        md += `## Journey Steps\n\n`;
        md += `| # | Step | Emotion | What Actually Happens | Friction | Wish |\n|---|------|---------|----------------------|---------|------|\n`;
        let vi = 0;
        steps.forEach((s) => {
          if (!s.isInvisible) vi++;
          const em = s.emotion !== null ? EMOTIONS[s.emotion].emoji + " " + EMOTIONS[s.emotion].label : "â€”";
          md += `| ${s.isInvisible ? "ğŸ‘»" : vi} | ${s.title} | ${em} | ${s.actual || "â€”"} | ${s.friction || "â€”"} | ${s.wish || "â€”"} |\n`;
        });
        if (session) {
          const yieldOpps = getYieldOpps();
          if (yieldOpps && yieldOpps.length > 0) {
            md += `\n## Yield Analysis\n\n`;
            md += `Ranked improvement opportunities from session data, scored 1â€“10.\n\n`;
            yieldOpps.forEach((opp, i) => {
              const status = yieldApprovals[`${opp.stepId}-${i}`] || "pending";
              md += `- **${opp.yieldScore}/10** ${opp.title} [${status}]: ${opp.rationale}\n`;
            });
          }
        }
        if (starred.length > 0) {
          md += `\n## â­ Feature Seeds\n\n`;
          starred.forEach((s, i) => { md += `${i + 1}. **"${s.title}":** ${s.wish}\n`; });
          md += `\n## PRD User Perspective Block\n\`\`\`\n### Job Stories (fill in outcomes)\n`;
          starred.forEach((s) => { md += `- When [at "${s.title}"], I want to [${s.wish}], so I can [___].\n`; });
          md += `\`\`\`\n`;
        }
        md += `\n---\n\n`;
        md += `## Instructions for Claude\n\n`;
        md += `When a student pastes this journey map into a conversation, use the Socratic method to deepen their thinking. Do not immediately generate PRD text or solutions. Instead:\n\n`;
        md += `1. **Acknowledge what they've captured.** Briefly reflect back the 2â€“3 strongest friction points and wishes you see in their data.\n`;
        md += `2. **Ask probing questions.** For each high-yield friction point, ask one question that pushes the student to think more specifically:\n`;
        md += `   - "You noted [friction]. Walk me through the last time that happened â€” what was the exact moment it broke down?"\n`;
        md += `   - "Your wish for [wish] is interesting. Who else besides you would benefit from that? How would a coach use it differently than a student?"\n`;
        md += `   - "I see [step] scored high on friction but you didn't star it. Is that a pain you've accepted, or one worth solving?"\n`;
        md += `3. **Surface hidden assumptions.** If a wish implies a specific technical solution, ask whether the underlying *need* could be met differently: "You wished for [X]. What if instead of [X], you could [alternative framing]?"\n`;
        md += `4. **Connect to the PRD.** Once the student has refined their thinking through 2â€“3 rounds of questions, help them translate frictionâ†’job storiesâ†’features. Use the format: *When [situation], I want to [action], so I can [outcome].*\n`;
        md += `5. **Challenge scope.** Ask: "If you could only ship ONE feature from this journey map for the first version, which friction point would you attack? Why that one over the others?"\n\n`;
        md += `The goal is to help the student develop design judgment, not just generate a feature list. Push them to prioritize ruthlessly and justify their choices with evidence from the journey map.\n`;
        const blob = new Blob([md], { type: "text/markdown" });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
        a.download = `fcm-journey-${perspective.toLowerCase().replace(/\s/g, "-")}${session ? `-${session.id}` : ""}.md`; a.click();
      };

      const handleCopy = () => {
        const starred = steps.filter((s) => s.starred && s.wish);
        let t = `FCM Journey â€” ${perspective} Perspective (HDS 2026)\n`;
        if (session) t += `Session: ${session.label} (${session.date})\n`;
        t += "\n";
        t += "CONTEXT: This journey map captures real experiences from group discussions in the UVA Health Design Sprint. ";
        t += "Students are designing an AI-native tool to improve the FCM (Foundations of Clinical Medicine) case cycle. ";
        t += "Use this alongside the team PRD to ground feature decisions in user evidence.\n\n";
        let vi = 0;
        steps.forEach((s) => {
          if (!s.isInvisible) vi++;
          if (s.actual || s.emotion !== null || s.friction || s.wish) {
            const em = s.emotion !== null ? EMOTIONS[s.emotion].emoji : "";
            t += `${s.isInvisible ? "ğŸ‘»" : vi}. ${s.title} ${em}\n`;
            if (s.actual) t += `  What happens: ${s.actual}\n`;
            if (s.thinking) t += `  Thinking: ${s.thinking}\n`;
            if (s.friction) t += `  Friction: ${s.friction}\n`;
            if (s.wish) t += `  Wish: ${s.wish}${s.starred ? " â­" : ""}\n`;
            t += "\n";
          }
        });
        if (starred.length > 0) { t += "FEATURE SEEDS:\n"; starred.forEach((s, i) => { t += `${i + 1}. "${s.title}": ${s.wish}\n`; }); t += "\n"; }
        t += "---\nINSTRUCTIONS FOR CLAUDE: Do not jump to solutions. Use the Socratic method:\n";
        t += "1. Reflect back the 2-3 strongest friction points you see.\n";
        t += "2. Ask probing questions: 'Walk me through the last time [friction] happened. What was the exact moment it broke down?'\n";
        t += "3. Challenge wishes: 'Who else besides you would benefit? How would a coach use this differently?'\n";
        t += "4. Surface hidden assumptions: 'What if instead of [wish], you could [alternative]?'\n";
        t += "5. After 2-3 rounds of questions, help translate friction into job stories: When [situation], I want to [action], so I can [outcome].\n";
        t += "6. Push for ruthless prioritization: 'If you ship ONE feature, which friction point do you attack? Why?'\n";
        navigator.clipboard.writeText(t).then(() => {
          alert("Copied to clipboard! Paste into Claude.");
        });
      };

      const handleExportAnnotations = () => {
        const annotations = {};
        const yieldApprovalData = {};
        // Gather all localStorage keys for annotations and yield approvals
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith("fcm-annotations-")) {
            const sessionKey = key.replace("fcm-annotations-", "");
            try { annotations[sessionKey] = JSON.parse(localStorage.getItem(key)); } catch {}
          }
          if (key.startsWith("fcm-yield-")) {
            const sessionKey = key.replace("fcm-yield-", "");
            try { yieldApprovalData[sessionKey] = JSON.parse(localStorage.getItem(key)); } catch {}
          }
        }
        const payload = {
          meta: { exportedAt: new Date().toISOString(), tool: "FCM Journey Mapper" },
          annotations,
          yieldApprovals: yieldApprovalData,
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `fcm-annotations-${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
      };

      const fileInputRef = useRef(null);
      const handleImportAnnotations = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const data = JSON.parse(ev.target.result);
            if (!data.meta || data.meta.tool !== "FCM Journey Mapper") {
              alert("Invalid file â€” not an FCM Journey Mapper export.");
              return;
            }
            let count = 0;
            if (data.annotations) {
              Object.entries(data.annotations).forEach(([sessionKey, ann]) => {
                localStorage.setItem(`fcm-annotations-${sessionKey}`, JSON.stringify(ann));
                count += Object.keys(ann).length;
              });
            }
            if (data.yieldApprovals) {
              Object.entries(data.yieldApprovals).forEach(([sessionKey, approvals]) => {
                localStorage.setItem(`fcm-yield-${sessionKey}`, JSON.stringify(approvals));
              });
            }
            // Reload current session state from localStorage
            const saved = loadAnnotations(selectedSession);
            const perspData = session?.perspectives?.[pKey];
            const stepsData = perspData?.steps;
            const merged = DEFAULT_STEPS.map(s => {
              const sd = stepsData?.[s.id];
              const ann = saved[s.id] || {};
              if (!sd) return { ...s, ...ann };
              return {
                ...s,
                actual: ann.actual ?? sd.suggestedActual ?? s.actual,
                emotion: ann.emotion !== undefined ? ann.emotion : (sd.suggestedEmotion !== undefined ? sd.suggestedEmotion : s.emotion),
                friction: ann.friction ?? sd.suggestedFriction ?? s.friction,
                wish: ann.wish ?? sd.suggestedWish ?? s.wish,
                thinking: ann.thinking ?? s.thinking,
                starred: ann.starred !== undefined ? ann.starred : s.starred,
              };
            });
            setSteps(merged);
            setYieldApprovals(loadYieldApprovals(selectedSession));
            alert(`Imported ${count} annotations successfully.`);
          } catch (err) {
            alert("Failed to parse import file: " + err.message);
          }
          // Reset file input so the same file can be re-imported
          e.target.value = "";
        };
        reader.readAsText(file);
      };

      const filledCount = steps.filter((s) => s.actual || s.emotion !== null || s.friction || s.wish).length;
      const starredCount = steps.filter((s) => s.starred).length;
      let visibleIdx = 0;
      const yieldOpps = getYieldOpps();

      return (
        <ThemeContext.Provider value={theme}>
        <div style={{ maxWidth: mainTab === "productlab" ? 1100 : 720, margin: "0 auto", padding: "24px 16px", fontFamily: SANS, background: theme.offWhite, minHeight: "100vh", transition: "max-width 0.3s" }}>
          <div style={{ textAlign: "center", marginBottom: 32, position: "relative" }}>
            <button onClick={toggleDarkMode} style={{ position: "absolute", top: 0, right: 0, background: theme.white, border: `1px solid ${theme.lightGray}`, borderRadius: 8, padding: "6px 12px", cursor: "pointer", fontSize: 18, lineHeight: 1 }} title={darkMode ? "Switch to light mode" : "Switch to dark mode"}>{darkMode ? "â˜€ï¸" : "ğŸŒ™"}</button>
            <div style={{ fontFamily: MONO, fontSize: 13, color: theme.emerald, fontWeight: 700, letterSpacing: 1 }}>&lt;mdp&gt; HEALTH DESIGN SPRINT 2026</div>
            <h1 style={{ margin: "8px 0", fontSize: 28, fontWeight: 800, color: theme.black, fontFamily: MONO }}>FCM Journey Mapper</h1>
            <p style={{ color: theme.medGray, fontSize: 15, margin: 0 }}>
              {mainTab === "productlab"
                ? "Evidence â†’ Build Points â†’ PRD. Choose what ships."
                : <>Map the <em>real</em> experience &mdash; not the official version.</>}
            </p>
          </div>

          <div style={{ display: "flex", gap: 0, marginBottom: 24, borderBottom: `1px solid ${theme.lightGray}` }}>
            {[{ id: "journey", label: "Journey Map", icon: "ğŸ—ºï¸" }, { id: "productlab", label: "Product Lab", icon: "âš—ï¸" }].map(tab => (
              <button key={tab.id} onClick={() => setMainTab(tab.id)} style={{ padding: "10px 20px", fontSize: 14, fontWeight: mainTab === tab.id ? 700 : 500, fontFamily: MONO, color: mainTab === tab.id ? theme.black : theme.medGray, background: "none", border: "none", borderBottom: mainTab === tab.id ? `2px solid ${theme.emerald}` : "2px solid transparent", cursor: "pointer", marginBottom: -1 }}>
                {tab.icon} {tab.label}
              </button>
            ))}
          </div>

          {mainTab === "journey" && <>
          {showIntro && (
            <div style={{ background: theme.blueLight, borderRadius: 12, padding: 20, marginBottom: 24, border: `1px solid ${theme.blue}`, position: "relative" }}>
              <button onClick={() => setShowIntro(false)} style={{ position: "absolute", top: 8, right: 12, border: "none", background: "none", fontSize: 18, cursor: "pointer", color: theme.medGray }}>âœ•</button>
              <h3 style={{ margin: "0 0 8px 0", fontFamily: MONO, fontSize: 15, color: theme.black }}>How this works</h3>
              <p style={{ fontSize: 14, color: theme.darkGray, margin: 0, lineHeight: 1.6 }}>
                We synthesized your Day 1 and Day 2 group discussions into a step-by-step FCM journey map. Each step is pre-populated with real insights from the cohort. Your job: review each step, rate the emotional experience, note friction points, and â­ star the wishes that matter most â€” those become your app's features. See a gap the official process misses? Hit ğŸ‘» to add invisible steps that nobody documents. When done, export and paste into Claude for job stories and PRD specs.
              </p>
            </div>
          )}

          {SESSION_DATA && <SessionSelector selectedSession={selectedSession} onSelect={setSelectedSession} />}

          {canShowDiff && (
            <div style={{ marginBottom: 12, display: "flex", alignItems: "center", gap: 10 }}>
              <label style={{ fontSize: 12, fontWeight: 600, color: theme.medGray, fontFamily: MONO, cursor: "pointer", display: "flex", alignItems: "center", gap: 6 }}>
                <span onClick={() => setShowDiff(!showDiff)} style={{ display: "inline-block", width: 36, height: 20, borderRadius: 10, background: showDiff ? theme.emerald : theme.lightGray, position: "relative", cursor: "pointer", transition: "background 0.2s" }}>
                  <span style={{ display: "inline-block", width: 16, height: 16, borderRadius: 8, background: theme.white, position: "absolute", top: 2, left: showDiff ? 18 : 2, transition: "left 0.2s", boxShadow: "0 1px 3px rgba(0,0,0,0.2)" }} />
                </span>
                Show changes from {prevSession?.label?.replace(/â€”.*/, "").trim() || "previous session"}
              </label>
            </div>
          )}

          {SESSION_DATA && allSessions.length >= 2 && <LeadingOpportunities />}

          <div className="perspective-tabs" style={{ display: "flex", gap: 8, marginBottom: 24, flexWrap: "wrap" }}>
            {["Student", "Coach / Faculty", "Administrator"].map((p) => (
              <button key={p} onClick={() => setPerspective(p)} style={{ padding: "8px 20px", borderRadius: 8, border: perspective === p ? `2px solid ${theme.emerald}` : `1px solid ${theme.lightGray}`, background: perspective === p ? theme.emeraldLight : theme.white, color: theme.darkGray, cursor: "pointer", fontWeight: perspective === p ? 700 : 500, fontSize: 14, fontFamily: MONO }}>
                {p}
              </button>
            ))}
          </div>

          {!isAdmin && (
            <>
              <div style={{ display: "flex", gap: 16, marginBottom: 24, flexWrap: "wrap", alignItems: "center" }}>
                <div style={{ background: theme.offWhite, borderRadius: 8, padding: "8px 16px", fontSize: 13, fontFamily: MONO, color: theme.darkGray }}>ğŸ“ {filledCount}/{steps.length} annotated</div>
                <div style={{ background: starredCount > 0 ? theme.emeraldLight : theme.offWhite, borderRadius: 8, padding: "8px 16px", fontSize: 13, fontFamily: MONO, color: theme.darkGray }}>â­ {starredCount} seeds</div>
                <div style={{ background: theme.amberLight, borderRadius: 8, padding: "8px 16px", fontSize: 13, fontFamily: MONO, color: theme.darkGray }}>ğŸ‘» {steps.filter((s) => s.isInvisible).length} invisible</div>
                {selectedSession && session && <div style={{ background: theme.blueLight, borderRadius: 8, padding: "8px 16px", fontSize: 13, fontFamily: MONO, color: theme.darkGray }}>ğŸ“ Viewing: {session.label.replace(/â€”.*/, "").trim()} ({new Date(session.date + "T12:00:00").toLocaleDateString("en-US", { month: "short", day: "numeric" })})</div>}
                <button onClick={() => setExpandSignal(s => s + 1)} style={{ background: theme.offWhite, borderRadius: 8, padding: "8px 16px", fontSize: 13, fontFamily: MONO, border: `1px solid ${theme.lightGray}`, cursor: "pointer", fontWeight: 600, color: theme.darkGray }}>{expandSignal % 2 === 1 ? "â–² Collapse All" : "â–¼ Expand All"}</button>
              </div>

              {steps.map((step) => {
                if (!step.isInvisible) visibleIdx++;
                return (
                  <StepCard
                    key={step.id}
                    step={step}
                    index={visibleIdx}
                    onUpdate={(u) => updateStep(step.id, u)}
                    onAddInvisibleAfter={() => addInvisibleAfter(step.id)}
                    sessionStepData={getStepSessionData(step.id)}
                    stability={getStability(step.id)}
                    yieldOpps={yieldOpps}
                    expandSignal={expandSignal}
                    diffData={getDiffData(step.id)}
                    prevStability={getPrevStability(step.id)}
                  />
                );
              })}

              <EmotionalArc steps={steps} />
              <WishlistSummary steps={steps} />

              {yieldOpps && (
                <YieldAnalysis
                  opportunities={yieldOpps}
                  approvals={yieldApprovals}
                  onApprovalChange={handleYieldApproval}
                  steps={steps}
                  diffYield={getDiffYieldOpps()}
                />
              )}

              {allSessions.length >= 2 && <CumulativeAnalysis sessionCount={allSessions.length} />}
            </>
          )}

          {isAdmin && (
            <AdminDashboard session={session} allSessions={allSessions} />
          )}

          <div style={{ display: "flex", gap: 12, marginTop: 24, flexWrap: "wrap" }}>
            <button onClick={handleExport} style={{ padding: "12px 24px", borderRadius: 10, border: "none", background: theme.black, color: theme.white, cursor: "pointer", fontWeight: 700, fontSize: 14, fontFamily: MONO }}>ğŸ“‹ Export Markdown</button>
            <button onClick={handleCopy} style={{ padding: "12px 24px", borderRadius: 10, border: `1px solid ${theme.lightGray}`, background: theme.white, color: theme.darkGray, cursor: "pointer", fontWeight: 600, fontSize: 14, fontFamily: MONO }}>ğŸ“ Copy for Claude</button>
            <button onClick={handleExportAnnotations} style={{ padding: "12px 24px", borderRadius: 10, border: `1px solid ${theme.emerald}`, background: theme.emeraldLight, color: theme.darkGray, cursor: "pointer", fontWeight: 600, fontSize: 14, fontFamily: MONO }}>ğŸ’¾ Export Annotations</button>
            <button onClick={() => fileInputRef.current?.click()} style={{ padding: "12px 24px", borderRadius: 10, border: `1px solid ${theme.blue}`, background: theme.blueLight, color: theme.darkGray, cursor: "pointer", fontWeight: 600, fontSize: 14, fontFamily: MONO }}>ğŸ“‚ Import Annotations</button>
            <input ref={fileInputRef} type="file" accept=".json" onChange={handleImportAnnotations} style={{ display: "none" }} />
          </div>
          </>}

          {mainTab === "productlab" && <ProductLab />}

          <div style={{ textAlign: "center", marginTop: 32, padding: "16px 0", borderTop: `1px solid ${theme.lightGray}` }}>
            <p style={{ fontSize: 12, color: theme.medGray, fontFamily: MONO }}>&lt;mdp&gt; UVA Medical Design Program &middot; HDS 2026</p>
          </div>
        </div>
        </ThemeContext.Provider>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<FCMJourneyMapper />);
  </script>
</body>
</html>
