<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FCM Journey Mapper Â· HDS 2026</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body { margin: 0; padding: 0; background: #F9FAFB; -webkit-font-smoothing: antialiased; }
    textarea:focus, select:focus, button:focus-visible { outline: 2px solid #10B981; outline-offset: 2px; }
    @media (max-width: 600px) {
      h1 { font-size: 22px !important; }
      .emotion-buttons { display: grid !important; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)) !important; }
      .yield-card-interventions { word-break: break-word; }
      .yield-card-actions { flex-direction: column !important; }
      .yield-card-actions button { width: 100% !important; }
      .perspective-tabs { overflow-x: auto !important; -webkit-overflow-scrolling: touch; flex-wrap: nowrap !important; }
      .perspective-tabs button { flex-shrink: 0; }
      .admin-card { min-width: 0 !important; }
    }
  </style>
  <script src="sessions-data.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useCallback, useEffect, useMemo, useRef } = React;

    /* â”€â”€ Brand tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const BRAND = {
      black: "#1A1A1A",
      darkGray: "#2D2D2D",
      medGray: "#6B7280",
      lightGray: "#E5E7EB",
      offWhite: "#F9FAFB",
      white: "#FFFFFF",
      emerald: "#10B981",
      emeraldLight: "#D1FAE5",
      amber: "#F59E0B",
      amberLight: "#FEF3C7",
      red: "#EF4444",
      redLight: "#FEE2E2",
      blue: "#3B82F6",
      blueLight: "#DBEAFE",
    };

    const MONO = "'JetBrains Mono', 'Consolas', monospace";
    const SANS = "Inter, -apple-system, sans-serif";

    /* â”€â”€ Emotions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const EMOTIONS = [
      { emoji: "ğŸ˜°", label: "Anxious", color: BRAND.red },
      { emoji: "ğŸ˜Ÿ", label: "Uncertain", color: BRAND.amber },
      { emoji: "ğŸ˜", label: "Going through motions", color: BRAND.medGray },
      { emoji: "ğŸ¤”", label: "Engaged", color: BRAND.blue },
      { emoji: "ğŸ˜Š", label: "Confident", color: BRAND.emerald },
      { emoji: "ğŸ˜", label: "Energized", color: "#059669" },
      { emoji: "ğŸ˜¤", label: "Frustrated", color: BRAND.red },
    ];

    /* â”€â”€ Default steps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const DEFAULT_STEPS = [
      { id: "1", title: "Get the Assignment", official: 'Receive one-line chief concern (e.g., "43 y/o male, 1-week worsening SOB")', artifact: "Posted to VMED", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
      { id: "2", title: "Build Your Differential", official: "Broad differential using anatomical/systems reasoning. Rank top 3. Select 5 history Qs, 3-5 PE maneuvers with likelihood ratios.", artifact: "Pre-Class Differential Worksheet", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
      { id: "gap1", title: "â³ The Gap", official: "Days or a week pass. You study other things. The case goes cold.", artifact: "No artifact â€” this gap is real", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: true },
      { id: "3", title: "Small Group Session", official: "4-hour session with coach and ~6 students. You present or observe peers presenting.", artifact: "In-person, coach-led", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
      { id: "4", title: "Patient Encounter", official: "Interview standardized patient: setting stage â†’ open-ended Qs â†’ focusing â†’ HPI (7 components) â†’ PMH/PSH/Meds/Allergies/FH/SH/ROS â†’ PE â†’ assessment & plan.", artifact: "Communication Checklist", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
      { id: "5", title: "Coach Feedback", official: "Verbal feedback during/after encounter. Quality varies.", artifact: "Verbal, sometimes noted", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
      { id: "6", title: "Write the Note", official: "Synthesize encounter: pertinent history, PE findings, up to 3 ranked diagnoses with evidence, diagnostic studies.", artifact: "Illness Script Template", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
      { id: "7", title: "Get Written Feedback", official: "Coach reviews illness script in LMS. Feedback may be detailed or cursory. Often delayed.", artifact: "VMED comments", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
      { id: "gap2", title: "â³ The Fade", official: "You may never revisit this case. Learning from feedback is self-directed. No structured follow-up.", artifact: "Nothing", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: true },
      { id: "8", title: "Next Case", official: "Cycle repeats with a new chief concern.", artifact: "New worksheet posted", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
    ];

    /* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const SESSION_DATA = window.FCM_SESSION_DATA || null;

    function getSessionById(id) {
      if (!SESSION_DATA) return null;
      return SESSION_DATA.sessions.find(s => s.id === id) || null;
    }

    function perspectiveKey(perspective) {
      if (perspective === "Student") return "student";
      if (perspective === "Coach / Faculty") return "coach";
      if (perspective === "Administrator") return "administrator";
      return "student";
    }

    function loadAnnotations(sessionId) {
      try {
        const raw = localStorage.getItem(`fcm-annotations-${sessionId || "blank"}`);
        return raw ? JSON.parse(raw) : {};
      } catch { return {}; }
    }

    function saveAnnotations(sessionId, annotations) {
      try {
        localStorage.setItem(`fcm-annotations-${sessionId || "blank"}`, JSON.stringify(annotations));
      } catch {}
    }

    function loadYieldApprovals(sessionId) {
      try {
        const raw = localStorage.getItem(`fcm-yield-${sessionId || "blank"}`);
        return raw ? JSON.parse(raw) : {};
      } catch { return {}; }
    }

    function saveYieldApprovals(sessionId, approvals) {
      try {
        localStorage.setItem(`fcm-yield-${sessionId || "blank"}`, JSON.stringify(approvals));
      } catch {}
    }

    /* â”€â”€ SessionSelector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function SessionSelector({ selectedSession, onSelect }) {
      const sessions = SESSION_DATA ? SESSION_DATA.sessions : [];

      return (
        <div style={{ marginBottom: 20 }}>
          <label style={{ fontSize: 12, fontWeight: 700, color: BRAND.darkGray, display: "block", marginBottom: 6, fontFamily: MONO }}>Session Progression &mdash; see how focus sharpened day to day</label>
          <select
            value={selectedSession || ""}
            onChange={e => onSelect(e.target.value || null)}
            style={{ width: "100%", padding: "10px 14px", borderRadius: 8, border: `1px solid ${BRAND.lightGray}`, fontSize: 14, fontFamily: SANS, background: BRAND.white, cursor: "pointer", appearance: "auto" }}
          >
            {sessions.map(s => (
              <option key={s.id} value={s.id}>{s.label} ({s.date})</option>
            ))}
            <option value="">Blank Template (start from scratch)</option>
          </select>
          {selectedSession && (() => {
            const session = getSessionById(selectedSession);
            if (!session) return null;
            return (
              <div style={{ marginTop: 8, padding: "10px 14px", background: BRAND.blueLight, borderRadius: 8, fontSize: 13, color: BRAND.darkGray, lineHeight: 1.5 }}>
                {session.description} &middot; {session.participantCount} participants
              </div>
            );
          })()}
        </div>
      );
    }

    /* â”€â”€ StabilityBadge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function StabilityBadge({ stability, prevStability }) {
      if (!stability) return null;
      const config = {
        stable: { bg: BRAND.emeraldLight, color: BRAND.emerald, label: "Stable" },
        emerging: { bg: BRAND.amberLight, color: BRAND.amber, label: "Emerging" },
        tentative: { bg: "#F3F4F6", color: BRAND.medGray, label: "Tentative" },
      };
      const c = config[stability.level] || config.tentative;
      const showArrow = prevStability && prevStability.level !== stability.level;
      const prevLabel = showArrow ? (config[prevStability.level] || config.tentative).label : null;
      return (
        <span
          title={`${stability.evidence} (${stability.supportCount} participants)`}
          style={{ padding: "2px 10px", borderRadius: 12, background: c.bg, color: c.color, fontSize: 11, fontWeight: 700, fontFamily: MONO, cursor: "help", whiteSpace: "nowrap" }}
        >
          {showArrow ? `${prevLabel} â†’ ${c.label}` : c.label}
        </span>
      );
    }

    /* â”€â”€ HighYieldBadge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function HighYieldBadge({ yieldOpps, stepId }) {
      const opp = yieldOpps && yieldOpps.find(o => o.stepId === stepId && o.yieldScore >= 7);
      if (!opp) return null;
      return (
        <span
          title={`High yield (${opp.yieldScore}/10): ${opp.title}`}
          style={{ padding: "2px 10px", borderRadius: 12, background: BRAND.redLight, color: BRAND.red, fontSize: 11, fontWeight: 700, fontFamily: MONO, cursor: "help", whiteSpace: "nowrap" }}
        >
          High Yield
        </span>
      );
    }

    /* â”€â”€ DiffBadge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function DiffBadge({ type }) {
      const config = {
        new: { bg: BRAND.emeraldLight, color: BRAND.emerald, label: "New" },
        changed: { bg: BRAND.amberLight, color: BRAND.amber, label: "Changed" },
        upgraded: { bg: BRAND.blueLight, color: BRAND.blue, label: "Upgraded" },
      };
      const c = config[type] || config.changed;
      return (
        <span style={{ padding: "1px 8px", borderRadius: 10, background: c.bg, color: c.color, fontSize: 10, fontWeight: 700, fontFamily: MONO, marginLeft: 4 }}>{c.label}</span>
      );
    }

    /* â”€â”€ PrefilledInsights â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function PrefilledInsights({ stepData, diffData }) {
      if (!stepData) return null;
      const { summary, themes, keyQuotes, contextNotes } = stepData;
      if (!summary && (!themes || themes.length === 0) && (!keyQuotes || keyQuotes.length === 0)) return null;

      return (
        <div style={{ marginBottom: 16, padding: "14px 16px", background: "#EFF6FF", borderRadius: 8, borderLeft: `3px solid ${BRAND.blue}` }}>
          <div style={{ fontSize: 11, textTransform: "uppercase", color: BRAND.blue, fontWeight: 700, marginBottom: 8, fontFamily: MONO }}>Session Insights</div>
          {summary && <p style={{ fontSize: 13, color: BRAND.darkGray, lineHeight: 1.6, margin: "0 0 10px 0" }}>{summary}</p>}
          {themes && themes.length > 0 && (
            <div style={{ display: "flex", flexWrap: "wrap", gap: 6, marginBottom: 10 }}>
              {themes.map((t, i) => (
                <span key={i} style={{ padding: "3px 10px", borderRadius: 12, background: BRAND.blueLight, color: BRAND.blue, fontSize: 11, fontWeight: 600, fontFamily: MONO }}>
                  {t}
                  {diffData && diffData.newThemes && diffData.newThemes.includes(t) && <DiffBadge type="new" />}
                </span>
              ))}
            </div>
          )}
          {keyQuotes && keyQuotes.length > 0 && (
            <div style={{ marginBottom: contextNotes ? 10 : 0 }}>
              {keyQuotes.map((q, i) => {
                const isNew = diffData && diffData.newQuotes && diffData.newQuotes.includes(q.text);
                return (
                  <div key={i} style={{ padding: "8px 12px", background: BRAND.white, borderRadius: 6, marginBottom: i < keyQuotes.length - 1 ? 6 : 0, borderLeft: `2px solid ${isNew ? BRAND.emerald : BRAND.blue}` }}>
                    <div style={{ fontSize: 13, color: BRAND.darkGray, fontStyle: "italic", lineHeight: 1.5 }}>
                      "{q.text}"
                      {isNew && <DiffBadge type="new" />}
                    </div>
                    <div style={{ fontSize: 11, color: BRAND.medGray, marginTop: 4 }}>â€” {q.speaker}{q.context ? ` Â· ${q.context}` : ""}</div>
                  </div>
                );
              })}
            </div>
          )}
          {contextNotes && <p style={{ fontSize: 12, color: BRAND.medGray, lineHeight: 1.5, margin: 0, fontStyle: "italic" }}>{contextNotes}</p>}
        </div>
      );
    }

    /* â”€â”€ Field â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function Field({ label, value, onChange, placeholder, borderColor, labelColor, fromSession }) {
      return (
        <div style={{ marginBottom: 14 }}>
          <label style={{ fontSize: 12, fontWeight: 700, color: labelColor || BRAND.darkGray, display: "flex", alignItems: "center", gap: 6, marginBottom: 4, fontFamily: MONO }}>
            {label}
            {fromSession && <span style={{ fontSize: 10, fontWeight: 500, color: BRAND.blue, fontStyle: "italic" }}>(from session)</span>}
          </label>
          <textarea value={value} onChange={(e) => onChange(e.target.value)} placeholder={placeholder} rows={2} style={{ width: "100%", padding: "8px 12px", borderRadius: 8, border: `1px solid ${borderColor || BRAND.lightGray}`, fontSize: 14, fontFamily: SANS, resize: "vertical", boxSizing: "border-box" }} />
        </div>
      );
    }

    /* â”€â”€ StepCard (enhanced) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function StepCard({ step, index, onUpdate, onAddInvisibleAfter, sessionStepData, stability, yieldOpps, expandSignal, diffData, prevStability }) {
      const [expanded, setExpanded] = useState(false);
      const isFirstRender = useRef(true);
      useEffect(() => {
        if (isFirstRender.current) { isFirstRender.current = false; return; }
        setExpanded(expandSignal % 2 === 1);
      }, [expandSignal]);
      const borderColor = step.isInvisible ? BRAND.amber : step.starred ? BRAND.emerald : BRAND.lightGray;
      const bgColor = step.isInvisible ? BRAND.amberLight : BRAND.white;

      const isFromSession = (field) => {
        if (!sessionStepData) return false;
        const suggested = sessionStepData[`suggested${field.charAt(0).toUpperCase() + field.slice(1)}`];
        return suggested && step[field] === suggested;
      };

      return (
        <div style={{ border: `2px solid ${borderColor}`, borderRadius: 12, background: bgColor, marginBottom: 16, boxShadow: "0 2px 8px rgba(0,0,0,0.06)", overflow: "hidden" }}>
          <div
            style={{ background: step.isInvisible ? BRAND.amber : BRAND.black, color: step.isInvisible ? BRAND.black : BRAND.white, padding: "12px 16px", display: "flex", alignItems: "center", justifyContent: "space-between", cursor: "pointer", fontFamily: MONO }}
            onClick={() => setExpanded(!expanded)}
          >
            <div style={{ display: "flex", alignItems: "center", gap: 8, flexWrap: "wrap" }}>
              <span style={{ fontSize: 13, opacity: 0.7 }}>{step.isInvisible ? "ğŸ‘»" : `${index}.`}</span>
              <span style={{ fontWeight: 700, fontSize: 15 }}>{step.title}</span>
              {step.emotion !== null && <span style={{ fontSize: 20 }}>{EMOTIONS[step.emotion]?.emoji}</span>}
              {step.starred && <span style={{ fontSize: 18 }}>â­</span>}
              <StabilityBadge stability={stability} prevStability={prevStability} />
              <HighYieldBadge yieldOpps={yieldOpps} stepId={step.id} />
            </div>
            <span style={{ fontSize: 18, opacity: 0.6 }}>{expanded ? "â–²" : "â–¼"}</span>
          </div>
          {expanded && (
            <div style={{ padding: "16px 20px" }}>
              <div style={{ marginBottom: 16, padding: "10px 14px", background: BRAND.offWhite, borderRadius: 8, borderLeft: `3px solid ${BRAND.medGray}` }}>
                <div style={{ fontSize: 11, textTransform: "uppercase", color: BRAND.medGray, fontWeight: 700, marginBottom: 4, fontFamily: MONO }}>Official Version</div>
                <div style={{ fontSize: 13, color: BRAND.darkGray, lineHeight: 1.5 }}>{step.official}</div>
                <div style={{ fontSize: 11, color: BRAND.medGray, marginTop: 4 }}>ğŸ“„ {step.artifact}</div>
              </div>
              <PrefilledInsights stepData={sessionStepData} diffData={diffData} />
              <Field label="What ACTUALLY happens?" value={step.actual} onChange={(v) => onUpdate({ actual: v })} placeholder="Not what you're supposed to do â€” what you actually did..." fromSession={isFromSession("actual")} />
              <Field label="What were you thinking?" value={step.thinking} onChange={(v) => onUpdate({ thinking: v })} placeholder="The internal monologue â€” about the case, your grade, what the coach thinks..." />
              <div style={{ marginBottom: 14 }}>
                <label style={{ fontSize: 12, fontWeight: 700, color: BRAND.darkGray, display: "flex", alignItems: "center", gap: 6, marginBottom: 8, fontFamily: MONO }}>
                  How did this feel?
                  {sessionStepData && sessionStepData.suggestedEmotion !== undefined && step.emotion === sessionStepData.suggestedEmotion && (
                    <span style={{ fontSize: 10, fontWeight: 500, color: BRAND.blue, fontStyle: "italic" }}>(from session)</span>
                  )}
                </label>
                <div className="emotion-buttons" style={{ display: "flex", flexWrap: "wrap", gap: 8 }}>
                  {EMOTIONS.map((em, i) => (
                    <button key={i} onClick={() => onUpdate({ emotion: step.emotion === i ? null : i })} style={{ padding: "6px 12px", borderRadius: 20, border: step.emotion === i ? `2px solid ${em.color}` : `1px solid ${BRAND.lightGray}`, background: step.emotion === i ? em.color + "18" : BRAND.white, cursor: "pointer", fontSize: 13, display: "flex", alignItems: "center", gap: 4 }}>
                      <span style={{ fontSize: 18 }}>{em.emoji}</span>
                      <span style={{ color: BRAND.darkGray }}>{em.label}</span>
                    </button>
                  ))}
                </div>
              </div>
              <Field label="ğŸ”´ Friction / Pain" value={step.friction} onChange={(v) => onUpdate({ friction: v })} placeholder="What went wrong? What was hard? What took too long?" borderColor={BRAND.redLight} labelColor={BRAND.red} fromSession={isFromSession("friction")} />
              <Field label="â­ Wishlist â€” I wish a tool existed that..." value={step.wish} onChange={(v) => onUpdate({ wish: v })} placeholder="Don't worry if it's possible â€” just describe the help you'd want..." borderColor={BRAND.emeraldLight} labelColor={BRAND.emerald} fromSession={isFromSession("wish")} />
              <div style={{ display: "flex", gap: 12, flexWrap: "wrap" }}>
                <button onClick={() => onUpdate({ starred: !step.starred })} style={{ padding: "8px 16px", borderRadius: 8, border: "none", background: step.starred ? BRAND.emerald : BRAND.lightGray, color: step.starred ? BRAND.white : BRAND.darkGray, cursor: "pointer", fontWeight: 700, fontSize: 13, fontFamily: MONO }}>
                  {step.starred ? "â­ Starred" : "â˜† Star This"}
                </button>
                <button onClick={onAddInvisibleAfter} style={{ padding: "8px 16px", borderRadius: 8, border: `1px solid ${BRAND.amber}`, background: BRAND.amberLight, color: BRAND.darkGray, cursor: "pointer", fontWeight: 600, fontSize: 13, fontFamily: MONO }}>
                  ğŸ‘» Add Invisible Step After
                </button>
              </div>
            </div>
          )}
        </div>
      );
    }

    /* â”€â”€ AdminDashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function AdminDashboard({ session, allSessions }) {
      if (!session) {
        return (
          <div style={{ padding: 24, background: BRAND.offWhite, borderRadius: 12, textAlign: "center", color: BRAND.medGray }}>
            <p style={{ fontFamily: MONO, fontSize: 14 }}>Select a session to view administrator insights.</p>
            <p style={{ fontSize: 13 }}>The Administrator view shows macro jobs-to-be-done rather than the step-by-step journey.</p>
          </div>
        );
      }

      const adminData = session.perspectives?.administrator;
      if (!adminData || !adminData.macroJobs) return null;

      const statusColor = (status) => {
        if (status.toLowerCase().includes("functional")) return BRAND.amber;
        if (status.toLowerCase().includes("invisible") || status.toLowerCase().includes("aspirational")) return BRAND.red;
        return BRAND.emerald;
      };

      return (
        <div>
          <div style={{ marginBottom: 20, padding: "12px 16px", background: BRAND.blueLight, borderRadius: 8, borderLeft: `3px solid ${BRAND.blue}` }}>
            <div style={{ fontSize: 12, fontWeight: 700, color: BRAND.blue, fontFamily: MONO }}>ADMINISTRATOR VIEW</div>
            <div style={{ fontSize: 13, color: BRAND.darkGray, marginTop: 4 }}>Macro jobs-to-be-done â€” how well does the system support administrative needs?</div>
          </div>

          {adminData.macroJobs.map(job => (
            <div key={job.id} className="admin-card" style={{ background: BRAND.white, borderRadius: 12, border: `2px solid ${BRAND.lightGray}`, marginBottom: 16, overflow: "hidden", boxShadow: "0 2px 8px rgba(0,0,0,0.06)" }}>
              <div style={{ background: BRAND.black, color: BRAND.white, padding: "12px 16px", display: "flex", alignItems: "center", justifyContent: "space-between", fontFamily: MONO }}>
                <span style={{ fontWeight: 700, fontSize: 15 }}>{job.title}</span>
                <span style={{ padding: "3px 12px", borderRadius: 12, background: statusColor(job.status) + "30", color: statusColor(job.status), fontSize: 11, fontWeight: 700 }}>{job.status}</span>
              </div>
              <div style={{ padding: "16px 20px" }}>
                {job.keyInsights && job.keyInsights.length > 0 && (
                  <div style={{ marginBottom: 14 }}>
                    <div style={{ fontSize: 11, textTransform: "uppercase", color: BRAND.emerald, fontWeight: 700, marginBottom: 6, fontFamily: MONO }}>Key Insights</div>
                    {job.keyInsights.map((insight, i) => (
                      <div key={i} style={{ fontSize: 13, color: BRAND.darkGray, lineHeight: 1.6, paddingLeft: 12, borderLeft: `2px solid ${BRAND.emeraldLight}`, marginBottom: 6 }}>{insight}</div>
                    ))}
                  </div>
                )}
                {job.keyQuotes && job.keyQuotes.length > 0 && (
                  <div style={{ marginBottom: 14 }}>
                    {job.keyQuotes.map((q, i) => (
                      <div key={i} style={{ padding: "8px 12px", background: BRAND.offWhite, borderRadius: 6, marginBottom: 4, borderLeft: `2px solid ${BRAND.blue}` }}>
                        <div style={{ fontSize: 13, color: BRAND.darkGray, fontStyle: "italic" }}>"{q.text}"</div>
                        <div style={{ fontSize: 11, color: BRAND.medGray, marginTop: 2 }}>â€” {q.speaker}{q.context ? ` Â· ${q.context}` : ""}</div>
                      </div>
                    ))}
                  </div>
                )}
                {job.frictionPoints && job.frictionPoints.length > 0 && (
                  <div>
                    <div style={{ fontSize: 11, textTransform: "uppercase", color: BRAND.red, fontWeight: 700, marginBottom: 6, fontFamily: MONO }}>Friction Points</div>
                    {job.frictionPoints.map((fp, i) => (
                      <div key={i} style={{ fontSize: 13, color: BRAND.darkGray, lineHeight: 1.6, paddingLeft: 12, borderLeft: `2px solid ${BRAND.redLight}`, marginBottom: 6 }}>{fp}</div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          ))}

          {allSessions && allSessions.length >= 2 && SESSION_DATA?.cumulative?.trendNotes && (
            <div style={{ background: BRAND.amberLight, borderRadius: 12, padding: 20, marginTop: 8, border: `1px solid ${BRAND.amber}` }}>
              <h3 style={{ margin: "0 0 8px 0", fontFamily: MONO, fontSize: 14, color: BRAND.darkGray }}>Cross-Session Trends</h3>
              <p style={{ fontSize: 13, color: BRAND.darkGray, margin: 0, lineHeight: 1.6 }}>{SESSION_DATA.cumulative.trendNotes}</p>
            </div>
          )}
        </div>
      );
    }

    /* â”€â”€ YieldAnalysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function YieldAnalysis({ opportunities, approvals, onApprovalChange, steps, diffYield }) {
      if (!opportunities || opportunities.length === 0) return null;

      const sorted = [...opportunities].sort((a, b) => b.yieldScore - a.yieldScore);

      const stepTitle = (stepId) => {
        const s = steps.find(st => st.id === stepId);
        return s ? s.title : stepId;
      };

      const approvalStyles = {
        approved: { bg: BRAND.emeraldLight, border: BRAND.emerald, label: "Approved" },
        discuss: { bg: BRAND.amberLight, border: BRAND.amber, label: "Needs Discussion" },
        dismissed: { bg: "#F3F4F6", border: BRAND.medGray, label: "Dismissed" },
      };

      return (
        <div style={{ background: BRAND.white, borderRadius: 12, padding: 20, marginTop: 24, border: `1px solid ${BRAND.lightGray}` }}>
          <h3 style={{ margin: "0 0 4px 0", fontFamily: MONO, color: BRAND.black, fontSize: 16 }}>Yield Analysis</h3>
          <p style={{ fontSize: 13, color: BRAND.medGray, margin: "0 0 16px 0" }}>Ranked improvement opportunities from session data. Review and triage.</p>
          {sorted.map((opp, i) => {
            const status = approvals[`${opp.stepId}-${i}`];
            const style = status ? approvalStyles[status] : null;
            return (
              <div key={i} style={{ border: `1px solid ${style ? style.border : BRAND.lightGray}`, borderRadius: 10, padding: "14px 16px", marginBottom: 12, background: style ? style.bg : BRAND.offWhite }}>
                <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", flexWrap: "wrap", gap: 8, marginBottom: 8 }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                    <span style={{ fontFamily: MONO, fontWeight: 800, fontSize: 22, color: opp.yieldScore >= 8 ? BRAND.red : opp.yieldScore >= 6 ? BRAND.amber : BRAND.medGray }}>
                      {opp.yieldScore}
                      {diffYield && diffYield.scoreChanges[opp.title] && (
                        <span style={{ fontSize: 11, fontWeight: 600, color: diffYield.scoreChanges[opp.title] > 0 ? BRAND.emerald : BRAND.red, marginLeft: 4 }}>
                          {diffYield.scoreChanges[opp.title] > 0 ? "+" : ""}{diffYield.scoreChanges[opp.title]}
                        </span>
                      )}
                    </span>
                    <div>
                      <div style={{ fontWeight: 700, fontSize: 14, color: BRAND.darkGray }}>
                        {opp.title}
                        {diffYield && diffYield.newTitles.includes(opp.title) && <DiffBadge type="new" />}
                      </div>
                      <div style={{ fontSize: 11, color: BRAND.medGray, fontFamily: MONO }}>at: {stepTitle(opp.stepId)}</div>
                    </div>
                  </div>
                  {status && <span style={{ padding: "3px 10px", borderRadius: 12, background: style.border + "20", color: style.border, fontSize: 11, fontWeight: 700, fontFamily: MONO }}>{style.label}</span>}
                </div>
                <p style={{ fontSize: 13, color: BRAND.darkGray, lineHeight: 1.6, margin: "0 0 10px 0" }}>{opp.rationale}</p>
                {opp.suggestedInterventions && opp.suggestedInterventions.length > 0 && (
                  <div className="yield-card-interventions" style={{ marginBottom: 12 }}>
                    <div style={{ fontSize: 11, textTransform: "uppercase", color: BRAND.medGray, fontWeight: 700, marginBottom: 4, fontFamily: MONO }}>Suggested Interventions</div>
                    {opp.suggestedInterventions.map((int, j) => (
                      <div key={j} style={{ fontSize: 12, color: BRAND.darkGray, padding: "4px 0 4px 12px", borderLeft: `2px solid ${BRAND.lightGray}` }}>{int}</div>
                    ))}
                  </div>
                )}
                <div className="yield-card-actions" style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
                  {[
                    { key: "approved", label: "âœ… Approve", bg: BRAND.emerald },
                    { key: "discuss", label: "ğŸ’¬ Needs Discussion", bg: BRAND.amber },
                    { key: "dismissed", label: "âœ• Dismiss", bg: BRAND.medGray },
                  ].map(btn => (
                    <button
                      key={btn.key}
                      onClick={() => onApprovalChange(`${opp.stepId}-${i}`, status === btn.key ? null : btn.key)}
                      style={{
                        padding: "6px 14px", borderRadius: 6, border: status === btn.key ? `2px solid ${btn.bg}` : `1px solid ${BRAND.lightGray}`,
                        background: status === btn.key ? btn.bg + "18" : BRAND.white, color: BRAND.darkGray,
                        cursor: "pointer", fontSize: 12, fontWeight: status === btn.key ? 700 : 500, fontFamily: MONO
                      }}
                    >
                      {btn.label}
                    </button>
                  ))}
                </div>
              </div>
            );
          })}
        </div>
      );
    }

    /* â”€â”€ EmotionalArc â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function EmotionalArc({ steps }) {
      const withEmotions = steps.filter((s) => s.emotion !== null);
      if (withEmotions.length < 2) return null;
      const valMap = { 0: 1, 6: 1, 1: 2, 2: 3, 3: 4, 4: 5, 5: 6 };
      const points = withEmotions.map((s, i) => ({ x: (i / (withEmotions.length - 1)) * 100, y: 100 - ((valMap[s.emotion] ?? 3) / 6) * 100, step: s }));
      const pathD = points.map((p, i) => `${i === 0 ? "M" : "L"} ${p.x} ${p.y}`).join(" ");

      return (
        <div style={{ background: BRAND.white, borderRadius: 12, padding: 20, marginTop: 24, border: `1px solid ${BRAND.lightGray}` }}>
          <h3 style={{ margin: "0 0 16px 0", fontFamily: MONO, color: BRAND.black }}>ğŸ“ˆ Emotional Arc</h3>
          <svg viewBox="-5 -10 110 120" style={{ width: "100%", height: 160 }}>
            <line x1="0" y1="50" x2="100" y2="50" stroke={BRAND.lightGray} strokeWidth="0.3" strokeDasharray="2" />
            <path d={pathD} fill="none" stroke={BRAND.emerald} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
            {points.map((p, i) => (
              <g key={i}>
                <circle cx={p.x} cy={p.y} r="3" fill={EMOTIONS[p.step.emotion]?.color || BRAND.medGray} />
                <text x={p.x} y={p.y - 8} textAnchor="middle" fontSize="8">{EMOTIONS[p.step.emotion]?.emoji}</text>
                <text x={p.x} y={p.y + 14} textAnchor="middle" fontSize="3.5" fill={BRAND.medGray}>{p.step.title.length > 12 ? p.step.title.slice(0, 12) + "â€¦" : p.step.title}</text>
              </g>
            ))}
            <text x="0" y="-4" fontSize="3.5" fill={BRAND.emerald}>ğŸ˜ Energized</text>
            <text x="0" y="108" fontSize="3.5" fill={BRAND.red}>ğŸ˜° Anxious</text>
          </svg>
        </div>
      );
    }

    /* â”€â”€ WishlistSummary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function WishlistSummary({ steps }) {
      const starred = steps.filter((s) => s.starred && s.wish);
      if (starred.length === 0) return null;
      return (
        <div style={{ background: BRAND.emeraldLight, borderRadius: 12, padding: 20, marginTop: 24, border: `2px solid ${BRAND.emerald}` }}>
          <h3 style={{ margin: "0 0 12px 0", fontFamily: MONO }}>â­ Feature Seeds ({starred.length})</h3>
          <p style={{ fontSize: 13, color: BRAND.medGray, margin: "0 0 16px 0" }}>Starred wishes â†’ features for your app. Copy into your PRD.</p>
          {starred.map((s) => (
            <div key={s.id} style={{ background: BRAND.white, borderRadius: 8, padding: "12px 16px", marginBottom: 8, borderLeft: `3px solid ${BRAND.emerald}` }}>
              <div style={{ fontSize: 12, color: BRAND.emerald, fontWeight: 700, fontFamily: MONO }}>At: {s.title}</div>
              <div style={{ fontSize: 14, color: BRAND.darkGray, marginTop: 4 }}>{s.wish}</div>
            </div>
          ))}
        </div>
      );
    }

    /* â”€â”€ CumulativeAnalysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function CumulativeAnalysis({ sessionCount }) {
      if (!SESSION_DATA?.cumulative || sessionCount < 2) return null;
      const { trendNotes, yieldOpportunities } = SESSION_DATA.cumulative;

      return (
        <div style={{ background: BRAND.amberLight, borderRadius: 12, padding: 20, marginTop: 24, border: `1px solid ${BRAND.amber}` }}>
          <h3 style={{ margin: "0 0 8px 0", fontFamily: MONO, fontSize: 14, color: BRAND.darkGray }}>Cumulative Analysis ({sessionCount} sessions)</h3>
          {trendNotes && <p style={{ fontSize: 13, color: BRAND.darkGray, margin: "0 0 12px 0", lineHeight: 1.6 }}>{trendNotes}</p>}
          {yieldOpportunities && yieldOpportunities.length > 0 && (
            <div>
              <div style={{ fontSize: 11, textTransform: "uppercase", color: BRAND.amber, fontWeight: 700, marginBottom: 6, fontFamily: MONO }}>Top Opportunities Across Sessions</div>
              {yieldOpportunities.slice(0, 3).map((opp, i) => (
                <div key={i} style={{ fontSize: 13, color: BRAND.darkGray, padding: "4px 0 4px 12px", borderLeft: `2px solid ${BRAND.amber}`, marginBottom: 4 }}>
                  <strong>{opp.yieldScore}/10</strong> â€” {opp.title} ({opp.sessions.length} session{opp.sessions.length > 1 ? "s" : ""})
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    /* â”€â”€ LeadingOpportunities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function LeadingOpportunities() {
      const opps = SESSION_DATA?.cumulative?.yieldOpportunities;
      if (!opps || opps.length === 0) return null;

      const [collapsed, setCollapsed] = useState(() => {
        try { return localStorage.getItem("fcm-leading-collapsed") === "true"; } catch { return false; }
      });

      const toggleCollapse = () => {
        const next = !collapsed;
        setCollapsed(next);
        try { localStorage.setItem("fcm-leading-collapsed", String(next)); } catch {}
      };

      const top3 = opps.slice(0, 3);
      const scoreColor = (s) => s >= 9 ? BRAND.red : s >= 7 ? BRAND.amber : BRAND.medGray;

      return (
        <div style={{ marginBottom: 20, background: BRAND.white, borderRadius: 12, border: `1px solid ${BRAND.lightGray}`, overflow: "hidden" }}>
          <div onClick={toggleCollapse} style={{ padding: "12px 16px", display: "flex", alignItems: "center", justifyContent: "space-between", cursor: "pointer", background: BRAND.offWhite }}>
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              <span style={{ fontSize: 11, textTransform: "uppercase", fontWeight: 700, color: BRAND.red, fontFamily: MONO }}>Leading Opportunities</span>
              <span style={{ fontSize: 11, color: BRAND.medGray, fontFamily: MONO }}>Top 3 across all sessions</span>
            </div>
            <span style={{ fontSize: 14, color: BRAND.medGray }}>{collapsed ? "â–¼" : "â–²"}</span>
          </div>
          {!collapsed && (
            <div style={{ padding: "12px 16px", display: "flex", flexDirection: "column", gap: 10 }}>
              {top3.map((opp, i) => (
                <div key={i} style={{ display: "flex", alignItems: "flex-start", gap: 12 }}>
                  <span style={{ fontFamily: MONO, fontWeight: 800, fontSize: 20, color: scoreColor(opp.yieldScore), minWidth: 32, textAlign: "center" }}>{opp.yieldScore}</span>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontWeight: 700, fontSize: 14, color: BRAND.darkGray }}>{opp.title}</div>
                    <div style={{ fontSize: 12, color: BRAND.medGray, marginTop: 2 }}>
                      {opp.sessions.length} session{opp.sessions.length > 1 ? "s" : ""}
                      {opp.rationale ? ` Â· ${opp.rationale}` : ""}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    /* â”€â”€ FCMJourneyMapper (main) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function getDefaultSession() {
      if (!SESSION_DATA || !SESSION_DATA.sessions.length) return null;
      return SESSION_DATA.sessions[SESSION_DATA.sessions.length - 1].id;
    }

    function FCMJourneyMapper() {
      const [selectedSession, setSelectedSession] = useState(getDefaultSession);
      const [steps, setSteps] = useState(DEFAULT_STEPS);
      const [perspective, setPerspective] = useState("Student");
      const [showIntro, setShowIntro] = useState(true);
      const [yieldApprovals, setYieldApprovals] = useState({});
      const [expandSignal, setExpandSignal] = useState(0);
      const [showDiff, setShowDiff] = useState(false);

      const session = useMemo(() => getSessionById(selectedSession), [selectedSession]);
      const pKey = perspectiveKey(perspective);
      const isAdmin = perspective === "Administrator";
      const allSessions = SESSION_DATA ? SESSION_DATA.sessions : [];

      // Load session data into steps when session or perspective changes
      useEffect(() => {
        if (!selectedSession || !session) {
          // Blank template â€” restore annotations from localStorage
          const saved = loadAnnotations(null);
          const fresh = DEFAULT_STEPS.map(s => {
            const ann = saved[s.id];
            return ann ? { ...s, ...ann } : { ...s };
          });
          setSteps(fresh);
          setYieldApprovals(loadYieldApprovals(null));
          return;
        }

        const perspData = session.perspectives?.[pKey];
        const stepsData = perspData?.steps;
        const saved = loadAnnotations(selectedSession);

        const merged = DEFAULT_STEPS.map(s => {
          const sd = stepsData?.[s.id];
          const ann = saved[s.id] || {};
          if (!sd) return { ...s, ...ann };
          return {
            ...s,
            actual: ann.actual ?? sd.suggestedActual ?? s.actual,
            emotion: ann.emotion !== undefined ? ann.emotion : (sd.suggestedEmotion !== undefined ? sd.suggestedEmotion : s.emotion),
            friction: ann.friction ?? sd.suggestedFriction ?? s.friction,
            wish: ann.wish ?? sd.suggestedWish ?? s.wish,
            thinking: ann.thinking ?? s.thinking,
            starred: ann.starred !== undefined ? ann.starred : s.starred,
          };
        });
        setSteps(merged);
        setYieldApprovals(loadYieldApprovals(selectedSession));
      }, [selectedSession, pKey]);

      // Persist annotations on change
      const updateStep = useCallback((id, updates) => {
        setSteps(prev => {
          const next = prev.map(s => (s.id === id ? { ...s, ...updates } : s));
          // Save annotations
          const annotations = {};
          next.forEach(s => {
            const def = DEFAULT_STEPS.find(d => d.id === s.id);
            if (!def) return;
            const ann = {};
            if (s.actual !== def.actual) ann.actual = s.actual;
            if (s.thinking !== def.thinking) ann.thinking = s.thinking;
            if (s.emotion !== def.emotion) ann.emotion = s.emotion;
            if (s.friction !== def.friction) ann.friction = s.friction;
            if (s.wish !== def.wish) ann.wish = s.wish;
            if (s.starred !== def.starred) ann.starred = s.starred;
            if (Object.keys(ann).length > 0) annotations[s.id] = ann;
          });
          saveAnnotations(selectedSession, annotations);
          return next;
        });
      }, [selectedSession]);

      const addInvisibleAfter = useCallback((afterId) => {
        setSteps((prev) => {
          const idx = prev.findIndex((s) => s.id === afterId);
          const newStep = { id: `inv-${Date.now()}`, title: "ğŸ‘» [Name this step]", official: "You discovered this â€” it's not in any official document.", artifact: "None", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: true };
          const next = [...prev];
          next.splice(idx + 1, 0, newStep);
          return next;
        });
      }, []);

      const handleYieldApproval = useCallback((key, value) => {
        setYieldApprovals(prev => {
          const next = { ...prev };
          if (value === null) { delete next[key]; } else { next[key] = value; }
          saveYieldApprovals(selectedSession, next);
          return next;
        });
      }, [selectedSession]);

      const getStepSessionData = (stepId) => {
        if (!session) return null;
        return session.perspectives?.[pKey]?.steps?.[stepId] || null;
      };

      const getStability = (stepId) => {
        if (!session) return null;
        return session.analysis?.stability?.[stepId] || null;
      };

      const getYieldOpps = () => {
        if (!session) return null;
        return session.analysis?.yieldOpportunities || null;
      };

      // Diff computation
      const prevSession = useMemo(() => {
        if (!selectedSession || !SESSION_DATA) return null;
        const idx = allSessions.findIndex(s => s.id === selectedSession);
        if (idx <= 0) return null;
        return getSessionById(allSessions[idx - 1].id);
      }, [selectedSession]);

      const canShowDiff = prevSession !== null;

      const getDiffData = (stepId) => {
        if (!showDiff || !prevSession || !session) return null;
        const currStepData = session.perspectives?.[pKey]?.steps?.[stepId];
        const prevStepData = prevSession.perspectives?.[pKey]?.steps?.[stepId];
        if (!currStepData) return null;

        const diff = {};
        // New themes
        const prevThemes = prevStepData?.themes || [];
        const currThemes = currStepData.themes || [];
        diff.newThemes = currThemes.filter(t => !prevThemes.includes(t));
        // New quotes
        const prevQuoteTexts = (prevStepData?.keyQuotes || []).map(q => q.text);
        const currQuotes = currStepData.keyQuotes || [];
        diff.newQuotes = currQuotes.filter(q => !prevQuoteTexts.includes(q.text)).map(q => q.text);
        // Emotion change
        if (prevStepData && currStepData.suggestedEmotion !== undefined && prevStepData.suggestedEmotion !== undefined && currStepData.suggestedEmotion !== prevStepData.suggestedEmotion) {
          diff.emotionChanged = true;
        }
        return diff;
      };

      const getPrevStability = (stepId) => {
        if (!showDiff || !prevSession) return null;
        return prevSession.analysis?.stability?.[stepId] || null;
      };

      const getDiffYieldOpps = () => {
        if (!showDiff || !prevSession || !session) return null;
        const currOpps = session.analysis?.yieldOpportunities || [];
        const prevOpps = prevSession.analysis?.yieldOpportunities || [];
        const prevTitles = prevOpps.map(o => o.title);
        const prevScores = {};
        prevOpps.forEach(o => { prevScores[o.title] = o.yieldScore; });
        return {
          newTitles: currOpps.filter(o => !prevTitles.includes(o.title)).map(o => o.title),
          scoreChanges: currOpps.reduce((acc, o) => {
            if (prevScores[o.title] !== undefined && prevScores[o.title] !== o.yieldScore) {
              acc[o.title] = o.yieldScore - prevScores[o.title];
            }
            return acc;
          }, {}),
        };
      };

      const handleExport = () => {
        const starred = steps.filter((s) => s.starred && s.wish);
        let md = `# FCM Journey Map â€” ${perspective} Perspective\n`;
        md += `*Generated ${new Date().toLocaleDateString()} Â· HDS 2026*\n`;
        if (session) {
          md += `*Session: ${session.label} (${session.date}) Â· ${session.participantCount} participants*\n`;
        }
        md += `\n`;
        md += `## Context\n\n`;
        md += `This journey map was produced as part of the UVA Health Design Sprint (HDS) 2026, where medical students are designing an AI-native tool to improve the Foundations of Clinical Medicine (FCM) case cycle. `;
        md += `FCM is a multi-year pre-clerkship program where students receive clinical cases, build differentials, attend small-group sessions with standardized patients, and receive coach feedback.\n\n`;
        md += `**How to use this document:** This journey map captures real student/coach/administrator experiences and friction points from group discussion sessions. `;
        md += `It should be integrated with the team's Product Requirements Document (PRD) and other design artifacts. `;
        md += `When used with Claude or another AI assistant, combine this with the PRD to ground feature decisions in actual user evidence. `;
        md += `The friction points and wishes below are direct inputs for user stories, job stories, and feature specifications.\n\n`;
        md += `---\n\n`;
        md += `## Journey Steps\n\n`;
        md += `| # | Step | Emotion | What Actually Happens | Friction | Wish |\n|---|------|---------|----------------------|---------|------|\n`;
        let vi = 0;
        steps.forEach((s) => {
          if (!s.isInvisible) vi++;
          const em = s.emotion !== null ? EMOTIONS[s.emotion].emoji + " " + EMOTIONS[s.emotion].label : "â€”";
          md += `| ${s.isInvisible ? "ğŸ‘»" : vi} | ${s.title} | ${em} | ${s.actual || "â€”"} | ${s.friction || "â€”"} | ${s.wish || "â€”"} |\n`;
        });
        if (session) {
          const yieldOpps = getYieldOpps();
          if (yieldOpps && yieldOpps.length > 0) {
            md += `\n## Yield Analysis\n\n`;
            md += `Ranked improvement opportunities from session data, scored 1â€“10.\n\n`;
            yieldOpps.forEach((opp, i) => {
              const status = yieldApprovals[`${opp.stepId}-${i}`] || "pending";
              md += `- **${opp.yieldScore}/10** ${opp.title} [${status}]: ${opp.rationale}\n`;
            });
          }
        }
        if (starred.length > 0) {
          md += `\n## â­ Feature Seeds\n\n`;
          starred.forEach((s, i) => { md += `${i + 1}. **"${s.title}":** ${s.wish}\n`; });
          md += `\n## PRD User Perspective Block\n\`\`\`\n### Job Stories (fill in outcomes)\n`;
          starred.forEach((s) => { md += `- When [at "${s.title}"], I want to [${s.wish}], so I can [___].\n`; });
          md += `\`\`\`\n`;
        }
        md += `\n---\n\n`;
        md += `## Instructions for Claude\n\n`;
        md += `When a student pastes this journey map into a conversation, use the Socratic method to deepen their thinking. Do not immediately generate PRD text or solutions. Instead:\n\n`;
        md += `1. **Acknowledge what they've captured.** Briefly reflect back the 2â€“3 strongest friction points and wishes you see in their data.\n`;
        md += `2. **Ask probing questions.** For each high-yield friction point, ask one question that pushes the student to think more specifically:\n`;
        md += `   - "You noted [friction]. Walk me through the last time that happened â€” what was the exact moment it broke down?"\n`;
        md += `   - "Your wish for [wish] is interesting. Who else besides you would benefit from that? How would a coach use it differently than a student?"\n`;
        md += `   - "I see [step] scored high on friction but you didn't star it. Is that a pain you've accepted, or one worth solving?"\n`;
        md += `3. **Surface hidden assumptions.** If a wish implies a specific technical solution, ask whether the underlying *need* could be met differently: "You wished for [X]. What if instead of [X], you could [alternative framing]?"\n`;
        md += `4. **Connect to the PRD.** Once the student has refined their thinking through 2â€“3 rounds of questions, help them translate frictionâ†’job storiesâ†’features. Use the format: *When [situation], I want to [action], so I can [outcome].*\n`;
        md += `5. **Challenge scope.** Ask: "If you could only ship ONE feature from this journey map for the first version, which friction point would you attack? Why that one over the others?"\n\n`;
        md += `The goal is to help the student develop design judgment, not just generate a feature list. Push them to prioritize ruthlessly and justify their choices with evidence from the journey map.\n`;
        const blob = new Blob([md], { type: "text/markdown" });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
        a.download = `fcm-journey-${perspective.toLowerCase().replace(/\s/g, "-")}${session ? `-${session.id}` : ""}.md`; a.click();
      };

      const handleCopy = () => {
        const starred = steps.filter((s) => s.starred && s.wish);
        let t = `FCM Journey â€” ${perspective} Perspective (HDS 2026)\n`;
        if (session) t += `Session: ${session.label} (${session.date})\n`;
        t += "\n";
        t += "CONTEXT: This journey map captures real experiences from group discussions in the UVA Health Design Sprint. ";
        t += "Students are designing an AI-native tool to improve the FCM (Foundations of Clinical Medicine) case cycle. ";
        t += "Use this alongside the team PRD to ground feature decisions in user evidence.\n\n";
        let vi = 0;
        steps.forEach((s) => {
          if (!s.isInvisible) vi++;
          if (s.actual || s.emotion !== null || s.friction || s.wish) {
            const em = s.emotion !== null ? EMOTIONS[s.emotion].emoji : "";
            t += `${s.isInvisible ? "ğŸ‘»" : vi}. ${s.title} ${em}\n`;
            if (s.actual) t += `  What happens: ${s.actual}\n`;
            if (s.thinking) t += `  Thinking: ${s.thinking}\n`;
            if (s.friction) t += `  Friction: ${s.friction}\n`;
            if (s.wish) t += `  Wish: ${s.wish}${s.starred ? " â­" : ""}\n`;
            t += "\n";
          }
        });
        if (starred.length > 0) { t += "FEATURE SEEDS:\n"; starred.forEach((s, i) => { t += `${i + 1}. "${s.title}": ${s.wish}\n`; }); t += "\n"; }
        t += "---\nINSTRUCTIONS FOR CLAUDE: Do not jump to solutions. Use the Socratic method:\n";
        t += "1. Reflect back the 2-3 strongest friction points you see.\n";
        t += "2. Ask probing questions: 'Walk me through the last time [friction] happened. What was the exact moment it broke down?'\n";
        t += "3. Challenge wishes: 'Who else besides you would benefit? How would a coach use this differently?'\n";
        t += "4. Surface hidden assumptions: 'What if instead of [wish], you could [alternative]?'\n";
        t += "5. After 2-3 rounds of questions, help translate friction into job stories: When [situation], I want to [action], so I can [outcome].\n";
        t += "6. Push for ruthless prioritization: 'If you ship ONE feature, which friction point do you attack? Why?'\n";
        navigator.clipboard.writeText(t).then(() => {
          alert("Copied to clipboard! Paste into Claude.");
        });
      };

      const handleExportAnnotations = () => {
        const annotations = {};
        const yieldApprovalData = {};
        // Gather all localStorage keys for annotations and yield approvals
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith("fcm-annotations-")) {
            const sessionKey = key.replace("fcm-annotations-", "");
            try { annotations[sessionKey] = JSON.parse(localStorage.getItem(key)); } catch {}
          }
          if (key.startsWith("fcm-yield-")) {
            const sessionKey = key.replace("fcm-yield-", "");
            try { yieldApprovalData[sessionKey] = JSON.parse(localStorage.getItem(key)); } catch {}
          }
        }
        const payload = {
          meta: { exportedAt: new Date().toISOString(), tool: "FCM Journey Mapper" },
          annotations,
          yieldApprovals: yieldApprovalData,
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `fcm-annotations-${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
      };

      const fileInputRef = useRef(null);
      const handleImportAnnotations = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const data = JSON.parse(ev.target.result);
            if (!data.meta || data.meta.tool !== "FCM Journey Mapper") {
              alert("Invalid file â€” not an FCM Journey Mapper export.");
              return;
            }
            let count = 0;
            if (data.annotations) {
              Object.entries(data.annotations).forEach(([sessionKey, ann]) => {
                localStorage.setItem(`fcm-annotations-${sessionKey}`, JSON.stringify(ann));
                count += Object.keys(ann).length;
              });
            }
            if (data.yieldApprovals) {
              Object.entries(data.yieldApprovals).forEach(([sessionKey, approvals]) => {
                localStorage.setItem(`fcm-yield-${sessionKey}`, JSON.stringify(approvals));
              });
            }
            // Reload current session state from localStorage
            const saved = loadAnnotations(selectedSession);
            const perspData = session?.perspectives?.[pKey];
            const stepsData = perspData?.steps;
            const merged = DEFAULT_STEPS.map(s => {
              const sd = stepsData?.[s.id];
              const ann = saved[s.id] || {};
              if (!sd) return { ...s, ...ann };
              return {
                ...s,
                actual: ann.actual ?? sd.suggestedActual ?? s.actual,
                emotion: ann.emotion !== undefined ? ann.emotion : (sd.suggestedEmotion !== undefined ? sd.suggestedEmotion : s.emotion),
                friction: ann.friction ?? sd.suggestedFriction ?? s.friction,
                wish: ann.wish ?? sd.suggestedWish ?? s.wish,
                thinking: ann.thinking ?? s.thinking,
                starred: ann.starred !== undefined ? ann.starred : s.starred,
              };
            });
            setSteps(merged);
            setYieldApprovals(loadYieldApprovals(selectedSession));
            alert(`Imported ${count} annotations successfully.`);
          } catch (err) {
            alert("Failed to parse import file: " + err.message);
          }
          // Reset file input so the same file can be re-imported
          e.target.value = "";
        };
        reader.readAsText(file);
      };

      const filledCount = steps.filter((s) => s.actual || s.emotion !== null || s.friction || s.wish).length;
      const starredCount = steps.filter((s) => s.starred).length;
      let visibleIdx = 0;
      const yieldOpps = getYieldOpps();

      return (
        <div style={{ maxWidth: 720, margin: "0 auto", padding: "24px 16px", fontFamily: SANS }}>
          <div style={{ textAlign: "center", marginBottom: 32 }}>
            <div style={{ fontFamily: MONO, fontSize: 13, color: BRAND.emerald, fontWeight: 700, letterSpacing: 1 }}>&lt;mdp&gt; HEALTH DESIGN SPRINT 2026</div>
            <h1 style={{ margin: "8px 0", fontSize: 28, fontWeight: 800, color: BRAND.black, fontFamily: MONO }}>FCM Journey Mapper</h1>
            <p style={{ color: BRAND.medGray, fontSize: 15, margin: 0 }}>Map the <em>real</em> experience &mdash; not the official version.</p>
          </div>

          {showIntro && (
            <div style={{ background: BRAND.blueLight, borderRadius: 12, padding: 20, marginBottom: 24, border: `1px solid ${BRAND.blue}`, position: "relative" }}>
              <button onClick={() => setShowIntro(false)} style={{ position: "absolute", top: 8, right: 12, border: "none", background: "none", fontSize: 18, cursor: "pointer", color: BRAND.medGray }}>âœ•</button>
              <h3 style={{ margin: "0 0 8px 0", fontFamily: MONO, fontSize: 15 }}>How this works</h3>
              <p style={{ fontSize: 14, color: BRAND.darkGray, margin: 0, lineHeight: 1.6 }}>
                We synthesized your Day 1 and Day 2 group discussions into a step-by-step FCM journey map. Each step is pre-populated with real insights from the cohort. Your job: review each step, rate the emotional experience, note friction points, and â­ star the wishes that matter most â€” those become your app's features. See a gap the official process misses? Hit ğŸ‘» to add invisible steps that nobody documents. When done, export and paste into Claude for job stories and PRD specs.
              </p>
            </div>
          )}

          {SESSION_DATA && <SessionSelector selectedSession={selectedSession} onSelect={setSelectedSession} />}

          {canShowDiff && (
            <div style={{ marginBottom: 12, display: "flex", alignItems: "center", gap: 10 }}>
              <label style={{ fontSize: 12, fontWeight: 600, color: BRAND.medGray, fontFamily: MONO, cursor: "pointer", display: "flex", alignItems: "center", gap: 6 }}>
                <span onClick={() => setShowDiff(!showDiff)} style={{ display: "inline-block", width: 36, height: 20, borderRadius: 10, background: showDiff ? BRAND.emerald : BRAND.lightGray, position: "relative", cursor: "pointer", transition: "background 0.2s" }}>
                  <span style={{ display: "inline-block", width: 16, height: 16, borderRadius: 8, background: BRAND.white, position: "absolute", top: 2, left: showDiff ? 18 : 2, transition: "left 0.2s", boxShadow: "0 1px 3px rgba(0,0,0,0.2)" }} />
                </span>
                Show changes from {prevSession?.label?.replace(/â€”.*/, "").trim() || "previous session"}
              </label>
            </div>
          )}

          {SESSION_DATA && allSessions.length >= 2 && <LeadingOpportunities />}

          <div className="perspective-tabs" style={{ display: "flex", gap: 8, marginBottom: 24, flexWrap: "wrap" }}>
            {["Student", "Coach / Faculty", "Administrator"].map((p) => (
              <button key={p} onClick={() => setPerspective(p)} style={{ padding: "8px 20px", borderRadius: 8, border: perspective === p ? `2px solid ${BRAND.emerald}` : `1px solid ${BRAND.lightGray}`, background: perspective === p ? BRAND.emeraldLight : BRAND.white, color: BRAND.darkGray, cursor: "pointer", fontWeight: perspective === p ? 700 : 500, fontSize: 14, fontFamily: MONO }}>
                {p}
              </button>
            ))}
          </div>

          {!isAdmin && (
            <>
              <div style={{ display: "flex", gap: 16, marginBottom: 24, flexWrap: "wrap", alignItems: "center" }}>
                <div style={{ background: BRAND.offWhite, borderRadius: 8, padding: "8px 16px", fontSize: 13, fontFamily: MONO }}>ğŸ“ {filledCount}/{steps.length} annotated</div>
                <div style={{ background: starredCount > 0 ? BRAND.emeraldLight : BRAND.offWhite, borderRadius: 8, padding: "8px 16px", fontSize: 13, fontFamily: MONO }}>â­ {starredCount} seeds</div>
                <div style={{ background: BRAND.amberLight, borderRadius: 8, padding: "8px 16px", fontSize: 13, fontFamily: MONO }}>ğŸ‘» {steps.filter((s) => s.isInvisible).length} invisible</div>
                {selectedSession && session && <div style={{ background: BRAND.blueLight, borderRadius: 8, padding: "8px 16px", fontSize: 13, fontFamily: MONO }}>ğŸ“ Viewing: {session.label.replace(/â€”.*/, "").trim()} ({new Date(session.date + "T12:00:00").toLocaleDateString("en-US", { month: "short", day: "numeric" })})</div>}
                <button onClick={() => setExpandSignal(s => s + 1)} style={{ background: BRAND.offWhite, borderRadius: 8, padding: "8px 16px", fontSize: 13, fontFamily: MONO, border: `1px solid ${BRAND.lightGray}`, cursor: "pointer", fontWeight: 600, color: BRAND.darkGray }}>{expandSignal % 2 === 1 ? "â–² Collapse All" : "â–¼ Expand All"}</button>
              </div>

              {steps.map((step) => {
                if (!step.isInvisible) visibleIdx++;
                return (
                  <StepCard
                    key={step.id}
                    step={step}
                    index={visibleIdx}
                    onUpdate={(u) => updateStep(step.id, u)}
                    onAddInvisibleAfter={() => addInvisibleAfter(step.id)}
                    sessionStepData={getStepSessionData(step.id)}
                    stability={getStability(step.id)}
                    yieldOpps={yieldOpps}
                    expandSignal={expandSignal}
                    diffData={getDiffData(step.id)}
                    prevStability={getPrevStability(step.id)}
                  />
                );
              })}

              <EmotionalArc steps={steps} />
              <WishlistSummary steps={steps} />

              {yieldOpps && (
                <YieldAnalysis
                  opportunities={yieldOpps}
                  approvals={yieldApprovals}
                  onApprovalChange={handleYieldApproval}
                  steps={steps}
                  diffYield={getDiffYieldOpps()}
                />
              )}

              {allSessions.length >= 2 && <CumulativeAnalysis sessionCount={allSessions.length} />}
            </>
          )}

          {isAdmin && (
            <AdminDashboard session={session} allSessions={allSessions} />
          )}

          <div style={{ display: "flex", gap: 12, marginTop: 24, flexWrap: "wrap" }}>
            <button onClick={handleExport} style={{ padding: "12px 24px", borderRadius: 10, border: "none", background: BRAND.black, color: BRAND.white, cursor: "pointer", fontWeight: 700, fontSize: 14, fontFamily: MONO }}>ğŸ“‹ Export Markdown</button>
            <button onClick={handleCopy} style={{ padding: "12px 24px", borderRadius: 10, border: `1px solid ${BRAND.lightGray}`, background: BRAND.white, color: BRAND.darkGray, cursor: "pointer", fontWeight: 600, fontSize: 14, fontFamily: MONO }}>ğŸ“ Copy for Claude</button>
            <button onClick={handleExportAnnotations} style={{ padding: "12px 24px", borderRadius: 10, border: `1px solid ${BRAND.emerald}`, background: BRAND.emeraldLight, color: BRAND.darkGray, cursor: "pointer", fontWeight: 600, fontSize: 14, fontFamily: MONO }}>ğŸ’¾ Export Annotations</button>
            <button onClick={() => fileInputRef.current?.click()} style={{ padding: "12px 24px", borderRadius: 10, border: `1px solid ${BRAND.blue}`, background: BRAND.blueLight, color: BRAND.darkGray, cursor: "pointer", fontWeight: 600, fontSize: 14, fontFamily: MONO }}>ğŸ“‚ Import Annotations</button>
            <input ref={fileInputRef} type="file" accept=".json" onChange={handleImportAnnotations} style={{ display: "none" }} />
          </div>

          <div style={{ textAlign: "center", marginTop: 32, padding: "16px 0", borderTop: `1px solid ${BRAND.lightGray}` }}>
            <p style={{ fontSize: 12, color: BRAND.medGray, fontFamily: MONO }}>&lt;mdp&gt; UVA Medical Design Program &middot; HDS 2026</p>
          </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<FCMJourneyMapper />);
  </script>
</body>
</html>
