<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FCM Journey Mapper Â· Health Design Sprint 2026</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600;700;800&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    body { margin: 0; padding: 0; background: #F9FAFB; -webkit-font-smoothing: antialiased; }
    textarea:focus, select:focus, button:focus-visible { outline: 2px solid #10B981; outline-offset: 2px; }
    @media (max-width: 600px) {
      h1 { font-size: 22px !important; }
      .emotion-buttons { display: grid !important; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)) !important; }
      .yield-card-interventions { word-break: break-word; }
      .yield-card-actions { flex-direction: column !important; }
      .yield-card-actions button { width: 100% !important; }
      .perspective-tabs { overflow-x: auto !important; -webkit-overflow-scrolling: touch; flex-wrap: nowrap !important; }
      .perspective-tabs button { flex-shrink: 0; }
      .admin-card { min-width: 0 !important; }
      .pl-evidence-grid { grid-template-columns: 1fr !important; }
      .pl-builder-grid { grid-template-columns: 1fr !important; }
    }
    /* â”€â”€ Story Mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .story-overlay {
      position: fixed; inset: 0; z-index: 1000;
      background: #111; color: #F9FAFB;
      overflow-y: auto; overflow-x: hidden;
    }
    .story-page {
      min-height: 100vh; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      padding: 48px 32px; max-width: 960px; margin: 0 auto;
    }
    .story-page h2 { font-family: 'JetBrains Mono', monospace; font-size: 32px; font-weight: 800; margin: 0 0 12px; text-align: center; }
    .story-page h3 { font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 700; margin: 0 0 8px; color: #10B981; }
    .story-subtitle { font-size: 16px; color: #9CA3AF; text-align: center; margin: 0 0 40px; line-height: 1.6; }
    .story-big-number { font-family: 'JetBrains Mono', monospace; font-size: 56px; font-weight: 800; color: #10B981; line-height: 1; }
    .story-big-label { font-size: 13px; color: #9CA3AF; text-transform: uppercase; letter-spacing: 0.1em; margin-top: 4px; }
    .story-stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 24px; text-align: center; width: 100%; max-width: 700px; margin-bottom: 40px; }
    .story-pull-quote { font-size: 24px; font-weight: 600; line-height: 1.5; text-align: center; max-width: 700px; margin: 0 0 16px; font-style: italic; color: #F9FAFB; }
    .story-quote-attr { font-size: 13px; color: #6B7280; text-align: center; }
    .story-nav { position: fixed; bottom: 0; left: 0; right: 0; z-index: 1001; display: flex; align-items: center; justify-content: center; gap: 16px; padding: 16px 24px; background: rgba(17,17,17,0.95); backdrop-filter: blur(8px); border-top: 1px solid #374151; }
    .story-dot { width: 10px; height: 10px; border-radius: 50%; background: #374151; cursor: pointer; transition: all 0.2s; border: none; padding: 0; }
    .story-dot.active { background: #10B981; transform: scale(1.3); }
    .story-nav-btn { padding: 8px 20px; border-radius: 8px; border: 1px solid #374151; background: transparent; color: #E5E7EB; cursor: pointer; font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 600; transition: all 0.15s; }
    .story-nav-btn:hover { background: #1F2937; }
    .story-nav-btn.primary { background: #10B981; border-color: #10B981; color: #111; }
    .story-nav-btn.primary:hover { background: #059669; }
    .story-toggle { position: fixed; top: 16px; right: 16px; z-index: 1002; }
    .story-close { position: fixed; top: 16px; left: 16px; z-index: 1002; background: none; border: 1px solid #374151; border-radius: 8px; padding: 8px 14px; color: #9CA3AF; cursor: pointer; font-family: 'JetBrains Mono', monospace; font-size: 12px; }
    .story-close:hover { color: #F9FAFB; border-color: #6B7280; }
    .story-process-step { text-align: center; padding: 24px; background: #1F2937; border-radius: 12px; flex: 1; min-width: 200px; }
    .story-process-arrow { font-size: 28px; color: #374151; align-self: center; }
    .story-moment-friction { padding: 12px 16px; border-radius: 8px; background: rgba(239,68,68,0.1); border-left: 3px solid #EF4444; margin-bottom: 12px; }
    .story-moment-wish { padding: 12px 16px; border-radius: 8px; background: rgba(16,185,129,0.1); border-left: 3px solid #10B981; margin-bottom: 12px; }
    .story-quote-card { padding: 14px 18px; background: #1F2937; border-radius: 8px; margin-bottom: 8px; border-left: 3px solid #3B82F6; }
    .story-swimlane { display: grid; gap: 2px; width: 100%; overflow-x: auto; }
    .story-swimlane-cell { padding: 8px 4px; border-radius: 6px; text-align: center; font-size: 11px; font-family: 'JetBrains Mono', monospace; cursor: pointer; transition: all 0.15s; min-height: 64px; display: flex; flex-direction: column; align-items: center; justify-content: center; line-height: 1.3; }
    .story-swimlane-cell:hover { transform: scale(1.03); }
    .story-cell-detail { position: fixed; top: 0; right: 0; bottom: 0; width: min(480px, 90vw); z-index: 1010; background: #1A1A1A; border-left: 1px solid #374151; padding: 24px; overflow-y: auto; box-shadow: -4px 0 20px rgba(0,0,0,0.5); }
    .story-yield-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 14px; border-radius: 20px; font-family: 'JetBrains Mono', monospace; font-weight: 700; }
    .story-stability-badge { display: inline-flex; align-items: center; padding: 3px 12px; border-radius: 12px; font-size: 11px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
    /* â”€â”€ Story Design Pages (9-17) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .story-discussion {
      border-left: 3px solid #10B981; padding: 14px 18px; margin: 20px 0;
      background: rgba(16,185,129,0.06); border-radius: 0 8px 8px 0;
      font-size: 14px; color: #D1FAE5; line-height: 1.6;
    }
    .story-instructor {
      font-size: 12px; color: #6B7280; font-style: italic; margin-top: 12px;
      font-family: 'JetBrains Mono', monospace;
    }
    .story-feature-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 10px; width: 100%;
    }
    .story-two-col {
      display: grid; grid-template-columns: 1fr 320px; gap: 24px; width: 100%;
    }
    @media (max-width: 800px) {
      .story-two-col { grid-template-columns: 1fr; }
      .ext-chapter-bar { overflow-x: auto; }
      .ext-chapter-label { font-size: 10px; padding: 6px 8px; }
    }
    .story-section-label {
      display: inline-block; padding: 3px 12px; border-radius: 12px;
      font-family: 'JetBrains Mono', monospace; font-size: 11px;
      font-weight: 700; letter-spacing: 0.1em; margin-bottom: 12px;
    }
    .story-prd-box {
      background: #FFFFFF; color: #1A1A1A; border-radius: 12px;
      padding: 0; overflow: hidden; max-height: 500px; overflow-y: auto;
      border: 1px solid #374151;
    }
    .story-nav-group-label {
      font-size: 9px; font-family: 'JetBrains Mono', monospace;
      color: #6B7280; text-align: center; margin-bottom: 4px;
      letter-spacing: 0.05em;
    }
    /* â”€â”€ External Present Mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ext-chapter-bar {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 1001;
      display: flex; align-items: center; justify-content: center; gap: 0;
      padding: 0 24px; height: 56px;
      background: rgba(17,17,17,0.95); backdrop-filter: blur(8px);
      border-top: 1px solid #374151;
    }
    .ext-chapter-label {
      padding: 6px 12px; font-family: 'JetBrains Mono', monospace;
      font-size: 11px; font-weight: 600; color: #6B7280;
      cursor: pointer; border: none; background: none;
      transition: all 0.15s; white-space: nowrap;
      border-bottom: 2px solid transparent;
    }
    .ext-chapter-label:hover { color: #D1D5DB; }
    .ext-chapter-label.active { color: #10B981; border-bottom-color: #10B981; }
    .ext-finding-card {
      background: #1F2937; border-radius: 12px; padding: 24px;
      border: 1px solid #374151; margin-bottom: 16px;
    }
    .ext-finding-card h4 {
      font-family: 'JetBrains Mono', monospace; font-size: 16px;
      font-weight: 700; color: #F9FAFB; margin: 0 0 8px;
    }
    .ext-anon-quote {
      font-size: 18px; font-weight: 500; line-height: 1.6;
      font-style: italic; color: #E5E7EB; margin: 16px 0 8px;
      padding-left: 16px; border-left: 3px solid #374151;
    }
    .ext-anon-attr {
      font-size: 12px; color: #6B7280; padding-left: 16px;
      font-family: 'JetBrains Mono', monospace; margin-bottom: 12px;
    }
    .ext-version-card {
      background: #1F2937; border-radius: 10px; padding: 20px 24px;
      border: 1px solid #374151; margin-bottom: 12px;
      position: relative; padding-left: 40px;
    }
    .ext-version-card::before {
      content: ''; position: absolute; left: 16px; top: 0; bottom: 0;
      width: 2px; background: #374151;
    }
    .ext-version-card::after {
      content: ''; position: absolute; left: 11px; top: 24px;
      width: 12px; height: 12px; border-radius: 50%;
      background: #10B981; border: 2px solid #111;
    }
    .ext-feedback-card {
      background: #1F2937; border-radius: 12px; padding: 24px;
      border: 1px solid #374151; margin-bottom: 16px;
    }
    .ext-feedback-question {
      font-size: 15px; color: #D1D5DB; line-height: 1.6;
      margin-bottom: 12px; padding-left: 16px;
      border-left: 2px solid #374151;
    }
    .ext-criteria-card {
      background: #1F2937; border-radius: 12px; padding: 20px;
      border: 1px solid #374151; margin-bottom: 12px;
    }
    .ext-criteria-card h4 {
      font-family: 'JetBrains Mono', monospace; font-size: 14px;
      font-weight: 700; color: #F9FAFB; margin: 0 0 6px;
    }
    /* â”€â”€ Free Browse Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .browse-tabs { display: flex; gap: 0; border-bottom: 1px solid #374151; margin-bottom: 24px; }
    .browse-tab { padding: 10px 20px; font-family: 'JetBrains Mono', monospace; font-size: 13px; color: #6B7280; background: none; border: none; border-bottom: 2px solid transparent; cursor: pointer; }
    .browse-tab.active { color: #10B981; border-bottom-color: #10B981; }
    /* â”€â”€ Rendered PRD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .rendered-prd { font-family: Inter, -apple-system, sans-serif; font-size: 14px; line-height: 1.7; color: #1A1A1A; padding: 32px; }
    .rendered-prd h1 { font-family: 'JetBrains Mono', monospace; font-size: 24px; font-weight: 800; margin: 0 0 8px; color: #1A1A1A; border-bottom: 2px solid #10B981; padding-bottom: 8px; }
    .rendered-prd h2 { font-family: 'JetBrains Mono', monospace; font-size: 18px; font-weight: 700; margin: 32px 0 12px; color: #1A1A1A; border-bottom: 1px solid #E5E7EB; padding-bottom: 6px; }
    .rendered-prd h3 { font-family: 'JetBrains Mono', monospace; font-size: 15px; font-weight: 600; margin: 20px 0 8px; color: #2D2D2D; }
    .rendered-prd p { margin: 0 0 12px; }
    .rendered-prd ul { padding-left: 20px; margin: 0 0 12px; }
    .rendered-prd li { margin-bottom: 6px; }
    .rendered-prd strong { color: #1A1A1A; }
    .rendered-prd em { color: #6B7280; }
    .rendered-prd hr { border: none; border-top: 1px solid #E5E7EB; margin: 24px 0; }
    .rendered-prd table { width: 100%; border-collapse: collapse; margin: 12px 0; }
    .rendered-prd th, .rendered-prd td { border: 1px solid #E5E7EB; padding: 8px 12px; text-align: left; font-size: 13px; }
    .rendered-prd th { background: #F9FAFB; font-weight: 600; }
    /* â”€â”€ Print Styles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    @media print {
      body { background: white !important; }
      .story-overlay { position: static; background: white; color: #1A1A1A; }
      .story-nav, .story-toggle, .story-close, .ext-chapter-bar { display: none !important; }
      .story-page { min-height: auto; page-break-after: always; padding: 24px 0; }
      .story-page:last-child { page-break-after: auto; }
      .story-big-number { color: #1A1A1A; }
      .story-pull-quote { color: #1A1A1A; }
      .rendered-prd { padding: 0; }
    }
  </style>
  <script src="sessions-data.js"></script>
  <script src="sprint-narrative.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useCallback, useEffect, useMemo, useRef, createContext, useContext } = React;

    const ThemeContext = createContext(null);
    function useTheme() { return useContext(ThemeContext) || BRAND; }

    /* â”€â”€ Brand tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const BRAND = {
      black: "#1A1A1A",
      darkGray: "#2D2D2D",
      medGray: "#6B7280",
      lightGray: "#E5E7EB",
      offWhite: "#F9FAFB",
      white: "#FFFFFF",
      emerald: "#10B981",
      emeraldLight: "#D1FAE5",
      amber: "#F59E0B",
      amberLight: "#FEF3C7",
      red: "#EF4444",
      redLight: "#FEE2E2",
      blue: "#3B82F6",
      blueLight: "#DBEAFE",
    };

    const BRAND_DARK = {
      black: "#F9FAFB",
      darkGray: "#E5E7EB",
      medGray: "#6B7280",
      lightGray: "#374151",
      offWhite: "#1A1A1A",
      white: "#2D2D2D",
      emerald: "#10B981",
      emeraldLight: "#064E3B",
      amber: "#F59E0B",
      amberLight: "#78350F",
      red: "#EF4444",
      redLight: "#7F1D1D",
      blue: "#3B82F6",
      blueLight: "#1E3A5F",
    };

    const MONO = "'JetBrains Mono', 'Consolas', monospace";
    const SANS = "Inter, -apple-system, sans-serif";

    /* â”€â”€ PROJECT_CONFIG â€” swap for future cohorts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const PROJECT_CONFIG = {
      courseName: "Foundations of Clinical Medicine (FCM)",
      courseShort: "FCM",
      institution: "University of Virginia School of Medicine",
      sprintName: "Health Design Sprint 2026",
      sprintShort: "HDS 2026",
      /* Design sprint phase labels */
      phases: {
        1: "Understand",    // Journey mapping
        2: "Define",        // Synthesis + convergence
        3: "Ideate",        // Product Lab
        4: "Prototype",     // Build
        5: "Test",          // Feedback loop
      },
      /* Key moments to feature in presentations (step IDs + page titles) */
      storyMoments: [
        { stepId: "1", title: "The Spark", subtitle: "Get the Assignment" },
        { stepId: "2", title: "Reasoning vs. Checkboxes", subtitle: "Build Differential" },
        { stepId: "gap1", title: "The Gap", subtitle: "Cognitive Decay" },
        { stepId: "3", title: "Re-Entry", subtitle: "FCM Session" },
      ],
    };

    /* â”€â”€ Emotions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const EMOTIONS = [
      { emoji: "ğŸ˜°", label: "Anxious", color: BRAND.red },
      { emoji: "ğŸ˜Ÿ", label: "Uncertain", color: BRAND.amber },
      { emoji: "ğŸ˜", label: "Going through motions", color: BRAND.medGray },
      { emoji: "ğŸ¤”", label: "Engaged", color: BRAND.blue },
      { emoji: "ğŸ˜Š", label: "Confident", color: BRAND.emerald },
      { emoji: "ğŸ˜", label: "Energized", color: "#059669" },
      { emoji: "ğŸ˜¤", label: "Frustrated", color: BRAND.red },
    ];

    /* â”€â”€ Default steps â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const DEFAULT_STEPS = [
      { id: "1", title: "Get the Assignment", official: 'Receive one-line chief concern (e.g., "43 y/o male, 1-week worsening SOB")', artifact: "Posted to VMED", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
      { id: "2", title: "Build Your Differential", official: "Broad differential using anatomical/systems reasoning. Rank top 3. Select 5 history Qs, 3-5 PE maneuvers with likelihood ratios.", artifact: "Pre-Class Differential Worksheet", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
      { id: "gap1", title: "â³ The Gap", official: "Days or a week pass. You study other things. The case goes cold.", artifact: "No artifact â€” this gap is real", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: true },
      { id: "3", title: "Small Group Session", official: "4-hour session with coach and ~6 students. You present or observe peers presenting.", artifact: "In-person, coach-led", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
      { id: "4", title: "Patient Encounter", official: "Interview standardized patient: setting stage â†’ open-ended Qs â†’ focusing â†’ HPI (7 components) â†’ PMH/PSH/Meds/Allergies/FH/SH/ROS â†’ PE â†’ assessment & plan.", artifact: "Communication Checklist", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
      { id: "5", title: "Coach Feedback", official: "Verbal feedback during/after encounter. Quality varies.", artifact: "Verbal, sometimes noted", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
      { id: "6", title: "Write the Note", official: "Synthesize encounter: pertinent history, PE findings, up to 3 ranked diagnoses with evidence, diagnostic studies.", artifact: "Illness Script Template", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
      { id: "7", title: "Get Written Feedback", official: "Coach reviews illness script in LMS. Feedback may be detailed or cursory. Often delayed.", artifact: "VMED comments", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
      { id: "gap2", title: "â³ The Fade", official: "You may never revisit this case. Learning from feedback is self-directed. No structured follow-up.", artifact: "Nothing", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: true },
      { id: "8", title: "Next Case", official: "Cycle repeats with a new chief concern.", artifact: "New worksheet posted", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: false },
    ];

    /* â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const SESSION_DATA = window.FCM_SESSION_DATA || null;

    function getSessionById(id) {
      if (!SESSION_DATA) return null;
      return SESSION_DATA.sessions.find(s => s.id === id) || null;
    }

    function perspectiveKey(perspective) {
      if (perspective === "Student") return "student";
      if (perspective === "Coach / Faculty") return "coach";
      if (perspective === "Administrator") return "administrator";
      return "student";
    }

    function loadAnnotations(sessionId) {
      try {
        const raw = localStorage.getItem(`fcm-annotations-${sessionId || "blank"}`);
        return raw ? JSON.parse(raw) : {};
      } catch { return {}; }
    }

    function saveAnnotations(sessionId, annotations) {
      try {
        localStorage.setItem(`fcm-annotations-${sessionId || "blank"}`, JSON.stringify(annotations));
      } catch {}
    }

    function loadYieldApprovals(sessionId) {
      try {
        const raw = localStorage.getItem(`fcm-yield-${sessionId || "blank"}`);
        return raw ? JSON.parse(raw) : {};
      } catch { return {}; }
    }

    function saveYieldApprovals(sessionId, approvals) {
      try {
        localStorage.setItem(`fcm-yield-${sessionId || "blank"}`, JSON.stringify(approvals));
      } catch {}
    }

    /* â”€â”€ SessionSelector â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function SessionSelector({ selectedSession, onSelect }) {
      const theme = useTheme();
      const sessions = SESSION_DATA ? SESSION_DATA.sessions : [];

      return (
        <div style={{ marginBottom: 20 }}>
          <label style={{ fontSize: 12, fontWeight: 700, color: theme.darkGray, display: "block", marginBottom: 6, fontFamily: MONO }}>Session Progression &mdash; see how focus sharpened day to day</label>
          <select
            value={selectedSession || ""}
            onChange={e => onSelect(e.target.value || null)}
            style={{ width: "100%", padding: "10px 14px", borderRadius: 8, border: `1px solid ${theme.lightGray}`, fontSize: 14, fontFamily: SANS, background: theme.white, color: theme.black, cursor: "pointer", appearance: "auto" }}
          >
            {sessions.map(s => (
              <option key={s.id} value={s.id}>{s.label} ({s.date})</option>
            ))}
            <option value="">Blank Template (start from scratch)</option>
          </select>
          {selectedSession && (() => {
            const session = getSessionById(selectedSession);
            if (!session) return null;
            return (
              <div style={{ marginTop: 8, padding: "10px 14px", background: theme.blueLight, borderRadius: 8, fontSize: 13, color: theme.darkGray, lineHeight: 1.5 }}>
                {session.description} &middot; {session.participantCount} participants
              </div>
            );
          })()}
        </div>
      );
    }

    /* â”€â”€ StabilityBadge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function StabilityBadge({ stability, prevStability }) {
      const theme = useTheme();
      if (!stability) return null;
      const config = {
        stable: { bg: theme.emeraldLight, color: theme.emerald, label: "Stable" },
        emerging: { bg: theme.amberLight, color: theme.amber, label: "Emerging" },
        tentative: { bg: theme.lightGray, color: theme.medGray, label: "Tentative" },
      };
      const c = config[stability.level] || config.tentative;
      const showArrow = prevStability && prevStability.level !== stability.level;
      const prevLabel = showArrow ? (config[prevStability.level] || config.tentative).label : null;
      return (
        <span
          title={`${stability.evidence} (${stability.supportCount} participants)`}
          style={{ padding: "2px 10px", borderRadius: 12, background: c.bg, color: c.color, fontSize: 11, fontWeight: 700, fontFamily: MONO, cursor: "help", whiteSpace: "nowrap" }}
        >
          {showArrow ? `${prevLabel} â†’ ${c.label}` : c.label}
        </span>
      );
    }

    /* â”€â”€ HighYieldBadge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function HighYieldBadge({ yieldOpps, stepId }) {
      const theme = useTheme();
      const opp = yieldOpps && yieldOpps.find(o => o.stepId === stepId && o.yieldScore >= 7);
      if (!opp) return null;
      return (
        <span
          title={`High yield (${opp.yieldScore}/10): ${opp.title}`}
          style={{ padding: "2px 10px", borderRadius: 12, background: theme.redLight, color: theme.red, fontSize: 11, fontWeight: 700, fontFamily: MONO, cursor: "help", whiteSpace: "nowrap" }}
        >
          High Yield
        </span>
      );
    }

    /* â”€â”€ DiffBadge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function DiffBadge({ type }) {
      const theme = useTheme();
      const config = {
        new: { bg: theme.emeraldLight, color: theme.emerald, label: "New" },
        changed: { bg: theme.amberLight, color: theme.amber, label: "Changed" },
        upgraded: { bg: theme.blueLight, color: theme.blue, label: "Upgraded" },
      };
      const c = config[type] || config.changed;
      return (
        <span style={{ padding: "1px 8px", borderRadius: 10, background: c.bg, color: c.color, fontSize: 10, fontWeight: 700, fontFamily: MONO, marginLeft: 4 }}>{c.label}</span>
      );
    }

    /* â”€â”€ PrefilledInsights â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function PrefilledInsights({ stepData, diffData }) {
      const theme = useTheme();
      if (!stepData) return null;
      const { summary, themes, keyQuotes, contextNotes } = stepData;
      if (!summary && (!themes || themes.length === 0) && (!keyQuotes || keyQuotes.length === 0)) return null;

      return (
        <div style={{ marginBottom: 16, padding: "14px 16px", background: theme.blueLight, borderRadius: 8, borderLeft: `3px solid ${theme.blue}` }}>
          <div style={{ fontSize: 11, textTransform: "uppercase", color: theme.blue, fontWeight: 700, marginBottom: 8, fontFamily: MONO }}>Session Insights</div>
          {summary && <p style={{ fontSize: 13, color: theme.darkGray, lineHeight: 1.6, margin: "0 0 10px 0" }}>{summary}</p>}
          {themes && themes.length > 0 && (
            <div style={{ display: "flex", flexWrap: "wrap", gap: 6, marginBottom: 10 }}>
              {themes.map((t, i) => (
                <span key={i} style={{ padding: "3px 10px", borderRadius: 12, background: theme.blueLight, color: theme.blue, fontSize: 11, fontWeight: 600, fontFamily: MONO }}>
                  {t}
                  {diffData && diffData.newThemes && diffData.newThemes.includes(t) && <DiffBadge type="new" />}
                </span>
              ))}
            </div>
          )}
          {keyQuotes && keyQuotes.length > 0 && (
            <div style={{ marginBottom: contextNotes ? 10 : 0 }}>
              {keyQuotes.map((q, i) => {
                const isNew = diffData && diffData.newQuotes && diffData.newQuotes.includes(q.text);
                return (
                  <div key={i} style={{ padding: "8px 12px", background: theme.white, borderRadius: 6, marginBottom: i < keyQuotes.length - 1 ? 6 : 0, borderLeft: `2px solid ${isNew ? theme.emerald : theme.blue}` }}>
                    <div style={{ fontSize: 13, color: theme.darkGray, fontStyle: "italic", lineHeight: 1.5 }}>
                      "{q.text}"
                      {isNew && <DiffBadge type="new" />}
                    </div>
                    <div style={{ fontSize: 11, color: theme.medGray, marginTop: 4 }}>â€” {q.speaker}{q.context ? ` Â· ${q.context}` : ""}</div>
                  </div>
                );
              })}
            </div>
          )}
          {contextNotes && <p style={{ fontSize: 12, color: theme.medGray, lineHeight: 1.5, margin: 0, fontStyle: "italic" }}>{contextNotes}</p>}
        </div>
      );
    }

    /* â”€â”€ Field â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function Field({ label, value, onChange, placeholder, borderColor, labelColor, fromSession }) {
      const theme = useTheme();
      return (
        <div style={{ marginBottom: 14 }}>
          <label style={{ fontSize: 12, fontWeight: 700, color: labelColor || theme.darkGray, display: "flex", alignItems: "center", gap: 6, marginBottom: 4, fontFamily: MONO }}>
            {label}
            {fromSession && <span style={{ fontSize: 10, fontWeight: 500, color: theme.blue, fontStyle: "italic" }}>(from session)</span>}
          </label>
          <textarea value={value} onChange={(e) => onChange(e.target.value)} placeholder={placeholder} rows={2} style={{ width: "100%", padding: "8px 12px", borderRadius: 8, border: `1px solid ${borderColor || theme.lightGray}`, fontSize: 14, fontFamily: SANS, resize: "vertical", boxSizing: "border-box", background: theme.white, color: theme.black }} />
        </div>
      );
    }

    /* â”€â”€ StepCard (enhanced) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function StepCard({ step, index, onUpdate, onAddInvisibleAfter, sessionStepData, stability, yieldOpps, expandSignal, diffData, prevStability }) {
      const theme = useTheme();
      const [expanded, setExpanded] = useState(false);
      const isFirstRender = useRef(true);
      useEffect(() => {
        if (isFirstRender.current) { isFirstRender.current = false; return; }
        setExpanded(expandSignal % 2 === 1);
      }, [expandSignal]);
      const borderColor = step.isInvisible ? theme.amber : step.starred ? theme.emerald : theme.lightGray;
      const bgColor = step.isInvisible ? theme.amberLight : theme.white;

      const isFromSession = (field) => {
        if (!sessionStepData) return false;
        const suggested = sessionStepData[`suggested${field.charAt(0).toUpperCase() + field.slice(1)}`];
        return suggested && step[field] === suggested;
      };

      return (
        <div style={{ border: `2px solid ${borderColor}`, borderRadius: 12, background: bgColor, marginBottom: 16, boxShadow: "0 2px 8px rgba(0,0,0,0.06)", overflow: "hidden" }}>
          <div
            style={{ background: step.isInvisible ? theme.amber : theme.black, color: step.isInvisible ? theme.offWhite : theme.white, padding: "12px 16px", display: "flex", alignItems: "center", justifyContent: "space-between", cursor: "pointer", fontFamily: MONO }}
            onClick={() => setExpanded(!expanded)}
          >
            <div style={{ display: "flex", alignItems: "center", gap: 8, flexWrap: "wrap" }}>
              <span style={{ fontSize: 13, opacity: 0.7 }}>{step.isInvisible ? "ğŸ‘»" : `${index}.`}</span>
              <span style={{ fontWeight: 700, fontSize: 15 }}>{step.title}</span>
              {step.emotion !== null && <span style={{ fontSize: 20 }}>{EMOTIONS[step.emotion]?.emoji}</span>}
              {step.starred && <span style={{ fontSize: 18 }}>â­</span>}
              <StabilityBadge stability={stability} prevStability={prevStability} />
              <HighYieldBadge yieldOpps={yieldOpps} stepId={step.id} />
            </div>
            <span style={{ fontSize: 18, opacity: 0.6 }}>{expanded ? "â–²" : "â–¼"}</span>
          </div>
          {expanded && (
            <div style={{ padding: "16px 20px" }}>
              <div style={{ marginBottom: 16, padding: "10px 14px", background: theme.offWhite, borderRadius: 8, borderLeft: `3px solid ${theme.medGray}` }}>
                <div style={{ fontSize: 11, textTransform: "uppercase", color: theme.medGray, fontWeight: 700, marginBottom: 4, fontFamily: MONO }}>Official Version</div>
                <div style={{ fontSize: 13, color: theme.darkGray, lineHeight: 1.5 }}>{step.official}</div>
                <div style={{ fontSize: 11, color: theme.medGray, marginTop: 4 }}>ğŸ“„ {step.artifact}</div>
              </div>
              <PrefilledInsights stepData={sessionStepData} diffData={diffData} />
              <Field label="What ACTUALLY happens?" value={step.actual} onChange={(v) => onUpdate({ actual: v })} placeholder="Not what you're supposed to do â€” what you actually did..." fromSession={isFromSession("actual")} />
              <Field label="What were you thinking?" value={step.thinking} onChange={(v) => onUpdate({ thinking: v })} placeholder="The internal monologue â€” about the case, your grade, what the coach thinks..." />
              <div style={{ marginBottom: 14 }}>
                <label style={{ fontSize: 12, fontWeight: 700, color: theme.darkGray, display: "flex", alignItems: "center", gap: 6, marginBottom: 8, fontFamily: MONO }}>
                  How did this feel?
                  {sessionStepData && sessionStepData.suggestedEmotion !== undefined && step.emotion === sessionStepData.suggestedEmotion && (
                    <span style={{ fontSize: 10, fontWeight: 500, color: theme.blue, fontStyle: "italic" }}>(from session)</span>
                  )}
                </label>
                <div className="emotion-buttons" style={{ display: "flex", flexWrap: "wrap", gap: 8 }}>
                  {EMOTIONS.map((em, i) => (
                    <button key={i} onClick={() => onUpdate({ emotion: step.emotion === i ? null : i })} style={{ padding: "6px 12px", borderRadius: 20, border: step.emotion === i ? `2px solid ${em.color}` : `1px solid ${theme.lightGray}`, background: step.emotion === i ? em.color + "18" : theme.white, cursor: "pointer", fontSize: 13, display: "flex", alignItems: "center", gap: 4 }}>
                      <span style={{ fontSize: 18 }}>{em.emoji}</span>
                      <span style={{ color: theme.darkGray }}>{em.label}</span>
                    </button>
                  ))}
                </div>
              </div>
              <Field label="ğŸ”´ Friction / Pain" value={step.friction} onChange={(v) => onUpdate({ friction: v })} placeholder="What went wrong? What was hard? What took too long?" borderColor={theme.redLight} labelColor={theme.red} fromSession={isFromSession("friction")} />
              <Field label="â­ Wishlist â€” I wish a tool existed that..." value={step.wish} onChange={(v) => onUpdate({ wish: v })} placeholder="Don't worry if it's possible â€” just describe the help you'd want..." borderColor={theme.emeraldLight} labelColor={theme.emerald} fromSession={isFromSession("wish")} />
              <div style={{ display: "flex", gap: 12, flexWrap: "wrap" }}>
                <button onClick={() => onUpdate({ starred: !step.starred })} style={{ padding: "8px 16px", borderRadius: 8, border: "none", background: step.starred ? theme.emerald : theme.lightGray, color: step.starred ? theme.white : theme.darkGray, cursor: "pointer", fontWeight: 700, fontSize: 13, fontFamily: MONO }}>
                  {step.starred ? "â­ Starred" : "â˜† Star This"}
                </button>
                <button onClick={onAddInvisibleAfter} style={{ padding: "8px 16px", borderRadius: 8, border: `1px solid ${theme.amber}`, background: theme.amberLight, color: theme.darkGray, cursor: "pointer", fontWeight: 600, fontSize: 13, fontFamily: MONO }}>
                  ğŸ‘» Add Invisible Step After
                </button>
              </div>
            </div>
          )}
        </div>
      );
    }

    /* â”€â”€ AdminDashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function AdminDashboard({ session, allSessions }) {
      const theme = useTheme();
      if (!session) {
        return (
          <div style={{ padding: 24, background: theme.offWhite, borderRadius: 12, textAlign: "center", color: theme.medGray }}>
            <p style={{ fontFamily: MONO, fontSize: 14 }}>Select a session to view administrator insights.</p>
            <p style={{ fontSize: 13 }}>The Administrator view shows macro jobs-to-be-done rather than the step-by-step journey.</p>
          </div>
        );
      }

      const adminData = session.perspectives?.administrator;
      if (!adminData || !adminData.macroJobs) return null;

      const statusColor = (status) => {
        if (status.toLowerCase().includes("functional")) return theme.amber;
        if (status.toLowerCase().includes("invisible") || status.toLowerCase().includes("aspirational")) return theme.red;
        return theme.emerald;
      };

      return (
        <div>
          <div style={{ marginBottom: 20, padding: "12px 16px", background: theme.blueLight, borderRadius: 8, borderLeft: `3px solid ${theme.blue}` }}>
            <div style={{ fontSize: 12, fontWeight: 700, color: theme.blue, fontFamily: MONO }}>ADMINISTRATOR VIEW</div>
            <div style={{ fontSize: 13, color: theme.darkGray, marginTop: 4 }}>Macro jobs-to-be-done â€” how well does the system support administrative needs?</div>
          </div>

          {adminData.macroJobs.map(job => (
            <div key={job.id} className="admin-card" style={{ background: theme.white, borderRadius: 12, border: `2px solid ${theme.lightGray}`, marginBottom: 16, overflow: "hidden", boxShadow: "0 2px 8px rgba(0,0,0,0.06)" }}>
              <div style={{ background: theme.black, color: theme.white, padding: "12px 16px", display: "flex", alignItems: "center", justifyContent: "space-between", fontFamily: MONO }}>
                <span style={{ fontWeight: 700, fontSize: 15 }}>{job.title}</span>
                <span style={{ padding: "3px 12px", borderRadius: 12, background: statusColor(job.status) + "30", color: statusColor(job.status), fontSize: 11, fontWeight: 700 }}>{job.status}</span>
              </div>
              <div style={{ padding: "16px 20px" }}>
                {job.keyInsights && job.keyInsights.length > 0 && (
                  <div style={{ marginBottom: 14 }}>
                    <div style={{ fontSize: 11, textTransform: "uppercase", color: theme.emerald, fontWeight: 700, marginBottom: 6, fontFamily: MONO }}>Key Insights</div>
                    {job.keyInsights.map((insight, i) => (
                      <div key={i} style={{ fontSize: 13, color: theme.darkGray, lineHeight: 1.6, paddingLeft: 12, borderLeft: `2px solid ${theme.emeraldLight}`, marginBottom: 6 }}>{insight}</div>
                    ))}
                  </div>
                )}
                {job.keyQuotes && job.keyQuotes.length > 0 && (
                  <div style={{ marginBottom: 14 }}>
                    {job.keyQuotes.map((q, i) => (
                      <div key={i} style={{ padding: "8px 12px", background: theme.offWhite, borderRadius: 6, marginBottom: 4, borderLeft: `2px solid ${theme.blue}` }}>
                        <div style={{ fontSize: 13, color: theme.darkGray, fontStyle: "italic" }}>"{q.text}"</div>
                        <div style={{ fontSize: 11, color: theme.medGray, marginTop: 2 }}>â€” {q.speaker}{q.context ? ` Â· ${q.context}` : ""}</div>
                      </div>
                    ))}
                  </div>
                )}
                {job.frictionPoints && job.frictionPoints.length > 0 && (
                  <div>
                    <div style={{ fontSize: 11, textTransform: "uppercase", color: theme.red, fontWeight: 700, marginBottom: 6, fontFamily: MONO }}>Friction Points</div>
                    {job.frictionPoints.map((fp, i) => (
                      <div key={i} style={{ fontSize: 13, color: theme.darkGray, lineHeight: 1.6, paddingLeft: 12, borderLeft: `2px solid ${theme.redLight}`, marginBottom: 6 }}>{fp}</div>
                    ))}
                  </div>
                )}
              </div>
            </div>
          ))}

          {allSessions && allSessions.length >= 2 && SESSION_DATA?.cumulative?.trendNotes && (
            <div style={{ background: theme.amberLight, borderRadius: 12, padding: 20, marginTop: 8, border: `1px solid ${theme.amber}` }}>
              <h3 style={{ margin: "0 0 8px 0", fontFamily: MONO, fontSize: 14, color: theme.darkGray }}>Cross-Session Trends</h3>
              <p style={{ fontSize: 13, color: theme.darkGray, margin: 0, lineHeight: 1.6 }}>{SESSION_DATA.cumulative.trendNotes}</p>
            </div>
          )}
        </div>
      );
    }

    /* â”€â”€ YieldAnalysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function YieldAnalysis({ opportunities, approvals, onApprovalChange, steps, diffYield }) {
      const theme = useTheme();
      if (!opportunities || opportunities.length === 0) return null;

      const sorted = [...opportunities].sort((a, b) => b.yieldScore - a.yieldScore);

      const stepTitle = (stepId) => {
        const s = steps.find(st => st.id === stepId);
        return s ? s.title : stepId;
      };

      const approvalStyles = {
        approved: { bg: theme.emeraldLight, border: theme.emerald, label: "Approved" },
        discuss: { bg: theme.amberLight, border: theme.amber, label: "Needs Discussion" },
        dismissed: { bg: theme.lightGray, border: theme.medGray, label: "Dismissed" },
      };

      return (
        <div style={{ background: theme.white, borderRadius: 12, padding: 20, marginTop: 24, border: `1px solid ${theme.lightGray}` }}>
          <h3 style={{ margin: "0 0 4px 0", fontFamily: MONO, color: theme.black, fontSize: 16 }}>Yield Analysis</h3>
          <p style={{ fontSize: 13, color: theme.medGray, margin: "0 0 16px 0" }}>Ranked improvement opportunities from session data. Review and triage.</p>
          {sorted.map((opp, i) => {
            const status = approvals[`${opp.stepId}-${i}`];
            const style = status ? approvalStyles[status] : null;
            return (
              <div key={i} style={{ border: `1px solid ${style ? style.border : theme.lightGray}`, borderRadius: 10, padding: "14px 16px", marginBottom: 12, background: style ? style.bg : theme.offWhite }}>
                <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", flexWrap: "wrap", gap: 8, marginBottom: 8 }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                    <span style={{ fontFamily: MONO, fontWeight: 800, fontSize: 22, color: opp.yieldScore >= 8 ? theme.red : opp.yieldScore >= 6 ? theme.amber : theme.medGray }}>
                      {opp.yieldScore}
                      {diffYield && diffYield.scoreChanges[opp.title] && (
                        <span style={{ fontSize: 11, fontWeight: 600, color: diffYield.scoreChanges[opp.title] > 0 ? theme.emerald : theme.red, marginLeft: 4 }}>
                          {diffYield.scoreChanges[opp.title] > 0 ? "+" : ""}{diffYield.scoreChanges[opp.title]}
                        </span>
                      )}
                    </span>
                    <div>
                      <div style={{ fontWeight: 700, fontSize: 14, color: theme.darkGray }}>
                        {opp.title}
                        {diffYield && diffYield.newTitles.includes(opp.title) && <DiffBadge type="new" />}
                      </div>
                      <div style={{ fontSize: 11, color: theme.medGray, fontFamily: MONO }}>at: {stepTitle(opp.stepId)}</div>
                    </div>
                  </div>
                  {status && <span style={{ padding: "3px 10px", borderRadius: 12, background: style.border + "20", color: style.border, fontSize: 11, fontWeight: 700, fontFamily: MONO }}>{style.label}</span>}
                </div>
                <p style={{ fontSize: 13, color: theme.darkGray, lineHeight: 1.6, margin: "0 0 10px 0" }}>{opp.rationale}</p>
                {opp.suggestedInterventions && opp.suggestedInterventions.length > 0 && (
                  <div className="yield-card-interventions" style={{ marginBottom: 12 }}>
                    <div style={{ fontSize: 11, textTransform: "uppercase", color: theme.medGray, fontWeight: 700, marginBottom: 4, fontFamily: MONO }}>Suggested Interventions</div>
                    {opp.suggestedInterventions.map((int, j) => (
                      <div key={j} style={{ fontSize: 12, color: theme.darkGray, padding: "4px 0 4px 12px", borderLeft: `2px solid ${theme.lightGray}` }}>{int}</div>
                    ))}
                  </div>
                )}
                <div className="yield-card-actions" style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
                  {[
                    { key: "approved", label: "âœ… Approve", bg: theme.emerald },
                    { key: "discuss", label: "ğŸ’¬ Needs Discussion", bg: theme.amber },
                    { key: "dismissed", label: "âœ• Dismiss", bg: theme.medGray },
                  ].map(btn => (
                    <button
                      key={btn.key}
                      onClick={() => onApprovalChange(`${opp.stepId}-${i}`, status === btn.key ? null : btn.key)}
                      style={{
                        padding: "6px 14px", borderRadius: 6, border: status === btn.key ? `2px solid ${btn.bg}` : `1px solid ${theme.lightGray}`,
                        background: status === btn.key ? btn.bg + "18" : theme.white, color: theme.darkGray,
                        cursor: "pointer", fontSize: 12, fontWeight: status === btn.key ? 700 : 500, fontFamily: MONO
                      }}
                    >
                      {btn.label}
                    </button>
                  ))}
                </div>
              </div>
            );
          })}
        </div>
      );
    }

    /* â”€â”€ EmotionalArc â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function EmotionalArc({ steps }) {
      const theme = useTheme();
      const withEmotions = steps.filter((s) => s.emotion !== null);
      if (withEmotions.length < 2) return null;
      const valMap = { 0: 1, 6: 1, 1: 2, 2: 3, 3: 4, 4: 5, 5: 6 };
      const points = withEmotions.map((s, i) => ({ x: (i / (withEmotions.length - 1)) * 100, y: 100 - ((valMap[s.emotion] ?? 3) / 6) * 100, step: s }));
      const pathD = points.map((p, i) => `${i === 0 ? "M" : "L"} ${p.x} ${p.y}`).join(" ");

      return (
        <div style={{ background: theme.white, borderRadius: 12, padding: 20, marginTop: 24, border: `1px solid ${theme.lightGray}` }}>
          <h3 style={{ margin: "0 0 16px 0", fontFamily: MONO, color: theme.black }}>ğŸ“ˆ Emotional Arc</h3>
          <svg viewBox="-5 -10 110 120" style={{ width: "100%", height: 160 }}>
            <line x1="0" y1="50" x2="100" y2="50" stroke={theme.lightGray} strokeWidth="0.3" strokeDasharray="2" />
            <path d={pathD} fill="none" stroke={theme.emerald} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" />
            {points.map((p, i) => (
              <g key={i}>
                <circle cx={p.x} cy={p.y} r="3" fill={EMOTIONS[p.step.emotion]?.color || theme.medGray} />
                <text x={p.x} y={p.y - 8} textAnchor="middle" fontSize="8">{EMOTIONS[p.step.emotion]?.emoji}</text>
                <text x={p.x} y={p.y + 14} textAnchor="middle" fontSize="3.5" fill={theme.medGray}>{p.step.title.length > 12 ? p.step.title.slice(0, 12) + "â€¦" : p.step.title}</text>
              </g>
            ))}
            <text x="0" y="-4" fontSize="3.5" fill={theme.emerald}>ğŸ˜ Energized</text>
            <text x="0" y="108" fontSize="3.5" fill={theme.red}>ğŸ˜° Anxious</text>
          </svg>
        </div>
      );
    }

    /* â”€â”€ WishlistSummary â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function WishlistSummary({ steps }) {
      const theme = useTheme();
      const starred = steps.filter((s) => s.starred && s.wish);
      if (starred.length === 0) return null;
      return (
        <div style={{ background: theme.emeraldLight, borderRadius: 12, padding: 20, marginTop: 24, border: `2px solid ${theme.emerald}` }}>
          <h3 style={{ margin: "0 0 12px 0", fontFamily: MONO, color: theme.black }}>â­ Feature Seeds ({starred.length})</h3>
          <p style={{ fontSize: 13, color: theme.medGray, margin: "0 0 16px 0" }}>Starred wishes â†’ features for your app. Copy into your PRD.</p>
          {starred.map((s) => (
            <div key={s.id} style={{ background: theme.white, borderRadius: 8, padding: "12px 16px", marginBottom: 8, borderLeft: `3px solid ${theme.emerald}` }}>
              <div style={{ fontSize: 12, color: theme.emerald, fontWeight: 700, fontFamily: MONO }}>At: {s.title}</div>
              <div style={{ fontSize: 14, color: theme.darkGray, marginTop: 4 }}>{s.wish}</div>
            </div>
          ))}
        </div>
      );
    }

    /* â”€â”€ CumulativeAnalysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function CumulativeAnalysis({ sessionCount }) {
      const theme = useTheme();
      if (!SESSION_DATA?.cumulative || sessionCount < 2) return null;
      const { trendNotes, yieldOpportunities } = SESSION_DATA.cumulative;

      return (
        <div style={{ background: theme.amberLight, borderRadius: 12, padding: 20, marginTop: 24, border: `1px solid ${theme.amber}` }}>
          <h3 style={{ margin: "0 0 8px 0", fontFamily: MONO, fontSize: 14, color: theme.darkGray }}>Cumulative Analysis ({sessionCount} sessions)</h3>
          {trendNotes && <p style={{ fontSize: 13, color: theme.darkGray, margin: "0 0 12px 0", lineHeight: 1.6 }}>{trendNotes}</p>}
          {yieldOpportunities && yieldOpportunities.length > 0 && (
            <div>
              <div style={{ fontSize: 11, textTransform: "uppercase", color: theme.amber, fontWeight: 700, marginBottom: 6, fontFamily: MONO }}>Top Opportunities Across Sessions</div>
              {yieldOpportunities.slice(0, 3).map((opp, i) => (
                <div key={i} style={{ fontSize: 13, color: theme.darkGray, padding: "4px 0 4px 12px", borderLeft: `2px solid ${theme.amber}`, marginBottom: 4 }}>
                  <strong>{opp.yieldScore}/10</strong> â€” {opp.title} ({opp.sessions.length} session{opp.sessions.length > 1 ? "s" : ""})
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    /* â”€â”€ LeadingOpportunities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function LeadingOpportunities() {
      const theme = useTheme();
      const opps = SESSION_DATA?.cumulative?.yieldOpportunities;
      if (!opps || opps.length === 0) return null;

      const [collapsed, setCollapsed] = useState(() => {
        try { return localStorage.getItem("fcm-leading-collapsed") === "true"; } catch { return false; }
      });

      const toggleCollapse = () => {
        const next = !collapsed;
        setCollapsed(next);
        try { localStorage.setItem("fcm-leading-collapsed", String(next)); } catch {}
      };

      const top3 = opps.slice(0, 3);
      const scoreColor = (s) => s >= 9 ? theme.red : s >= 7 ? theme.amber : theme.medGray;

      return (
        <div style={{ marginBottom: 20, background: theme.white, borderRadius: 12, border: `1px solid ${theme.lightGray}`, overflow: "hidden" }}>
          <div onClick={toggleCollapse} style={{ padding: "12px 16px", display: "flex", alignItems: "center", justifyContent: "space-between", cursor: "pointer", background: theme.offWhite }}>
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              <span style={{ fontSize: 11, textTransform: "uppercase", fontWeight: 700, color: theme.red, fontFamily: MONO }}>Leading Opportunities</span>
              <span style={{ fontSize: 11, color: theme.medGray, fontFamily: MONO }}>Top 3 across all sessions</span>
            </div>
            <span style={{ fontSize: 14, color: theme.medGray }}>{collapsed ? "â–¼" : "â–²"}</span>
          </div>
          {!collapsed && (
            <div style={{ padding: "12px 16px", display: "flex", flexDirection: "column", gap: 10 }}>
              {top3.map((opp, i) => (
                <div key={i} style={{ display: "flex", alignItems: "flex-start", gap: 12 }}>
                  <span style={{ fontFamily: MONO, fontWeight: 800, fontSize: 20, color: scoreColor(opp.yieldScore), minWidth: 32, textAlign: "center" }}>{opp.yieldScore}</span>
                  <div style={{ flex: 1 }}>
                    <div style={{ fontWeight: 700, fontSize: 14, color: theme.darkGray }}>{opp.title}</div>
                    <div style={{ fontSize: 12, color: theme.medGray, marginTop: 2 }}>
                      {opp.sessions.length} session{opp.sessions.length > 1 ? "s" : ""}
                      {opp.rationale ? ` Â· ${opp.rationale}` : ""}
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      );
    }

    /* â”€â”€ Story Mode: Computed Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function computeResearchStats() {
      if (!SESSION_DATA) return null;
      const sessions = SESSION_DATA.sessions;
      let totalQuotes = 0;
      const speakerSet = new Set();
      let stableCount = 0;
      let topYield = 0;
      const perspectives = new Set();
      sessions.forEach(s => {
        ["student", "coach", "administrator"].forEach(p => {
          const pData = s.perspectives?.[p];
          if (!pData) return;
          perspectives.add(p);
          if (pData.steps) {
            Object.values(pData.steps).forEach(step => {
              (step.keyQuotes || []).forEach(q => {
                totalQuotes++;
                if (q.speaker) speakerSet.add(q.speaker.split(" ")[0]);
              });
            });
          }
          if (pData.macroJobs) {
            pData.macroJobs.forEach(job => {
              (job.keyQuotes || []).forEach(q => {
                totalQuotes++;
                if (q.speaker) speakerSet.add(q.speaker.split(" ")[0]);
              });
            });
          }
        });
      });
      const cumStab = SESSION_DATA.cumulative?.stability || {};
      Object.values(cumStab).forEach(s => { if (s.level === "stable") stableCount++; });
      const cumYield = SESSION_DATA.cumulative?.yieldOpportunities || [];
      if (cumYield.length > 0) topYield = cumYield[0].yieldScore;
      return {
        sessionCount: sessions.length,
        totalQuotes,
        namedStudents: speakerSet.size,
        stepsCount: DEFAULT_STEPS.length,
        perspectiveCount: perspectives.size,
        stablePatterns: stableCount,
        topYield,
        speakers: [...speakerSet],
      };
    }

    function computeExternalStats() {
      const stats = computeResearchStats();
      if (!stats) return null;
      return { ...stats, speakerLabel: "Student Participants", speakers: null };
    }

    /* â”€â”€ Story Mode: Landing Page (Page 0) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function StoryLanding() {
      return (
        <div className="story-page" style={{ maxWidth: 760, textAlign: "left" }}>
          <div style={{ textAlign: "center", marginBottom: 32 }}>
            <div style={{ fontFamily: MONO, fontSize: 13, color: "#10B981", fontWeight: 700, letterSpacing: 2, marginBottom: 8 }}>PROTOTYPE</div>
            <h2 style={{ fontSize: 36, lineHeight: 1.2, textAlign: "center" }}>Team Review</h2>
            <p style={{ color: "#9CA3AF", fontSize: 16, maxWidth: 540, margin: "8px auto 0" }}>
              A narrative walkthrough of what emerged from your research â€” built by AI from your own words.
            </p>
          </div>

          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 20, marginBottom: 32 }}>
            <div style={{ background: "rgba(16,185,129,0.08)", borderRadius: 12, padding: 20, border: "1px solid rgba(16,185,129,0.2)" }}>
              <div style={{ fontFamily: MONO, fontSize: 11, color: "#10B981", fontWeight: 700, letterSpacing: 1, marginBottom: 8 }}>THE PROJECT</div>
              <div style={{ fontSize: 18, fontWeight: 700, color: "#F9FAFB", marginBottom: 8, fontFamily: MONO }}>Redesigning FCM</div>
              <p style={{ fontSize: 14, color: "#D1D5DB", lineHeight: 1.6, margin: 0 }}>
                You've spent two days mapping how Foundations of Clinical Medicine actually works â€” from a student's first glance at the chief complaint through the gap, the session, and the fade. This presentation surfaces the patterns, quotes, and opportunities that emerged from <em>your</em> conversations.
              </p>
            </div>
            <div style={{ background: "rgba(99,102,241,0.08)", borderRadius: 12, padding: 20, border: "1px solid rgba(99,102,241,0.2)" }}>
              <div style={{ fontFamily: MONO, fontSize: 11, color: "#818CF8", fontWeight: 700, letterSpacing: 1, marginBottom: 8 }}>THE EXPERIMENT</div>
              <div style={{ fontSize: 18, fontWeight: 700, color: "#F9FAFB", marginBottom: 8, fontFamily: MONO }}>Is This Useful?</div>
              <p style={{ fontSize: 14, color: "#D1D5DB", lineHeight: 1.6, margin: 0 }}>
                This tool is itself a design experiment. We're testing whether AI-organized research findings â€” presented back to you as a narrative â€” actually help a team converge on what to build. As you go through, notice: does this feel like <em>your</em> work? Does it clarify or confuse?
              </p>
            </div>
          </div>

          <div style={{ background: "rgba(255,255,255,0.04)", borderRadius: 12, padding: 20, marginBottom: 28, border: "1px solid rgba(255,255,255,0.08)" }}>
            <div style={{ fontFamily: MONO, fontSize: 11, color: "#9CA3AF", fontWeight: 700, letterSpacing: 1, marginBottom: 12 }}>WHERE WE ARE IN THE DESIGN PROCESS</div>
            <div style={{ display: "flex", gap: 0, alignItems: "stretch" }}>
              {Object.entries(PROJECT_CONFIG.phases).map(([num, label], i) => {
                const isActive = num === "2";
                const isDone = num === "1";
                return (
                  <div key={num} style={{ flex: 1, textAlign: "center", padding: "10px 4px", background: isActive ? "rgba(16,185,129,0.15)" : isDone ? "rgba(16,185,129,0.05)" : "transparent", borderRadius: 8, border: isActive ? "1px solid rgba(16,185,129,0.4)" : "1px solid transparent", position: "relative" }}>
                    <div style={{ fontFamily: MONO, fontSize: 11, color: isDone ? "#6B7280" : isActive ? "#10B981" : "#4B5563", fontWeight: 700 }}>{num}</div>
                    <div style={{ fontSize: 13, fontWeight: isActive ? 700 : 500, color: isDone ? "#6B7280" : isActive ? "#F9FAFB" : "#4B5563", fontFamily: MONO }}>{label}</div>
                    {isDone && <div style={{ fontSize: 10, color: "#6B7280" }}>Days 1â€“2</div>}
                    {isActive && <div style={{ fontSize: 10, color: "#10B981", fontWeight: 600 }}>Today</div>}
                  </div>
                );
              })}
            </div>
            <p style={{ fontSize: 13, color: "#9CA3AF", margin: "12px 0 0", lineHeight: 1.5, textAlign: "center" }}>
              Days 1â€“2 were <strong style={{ color: "#D1D5DB" }}>Understand</strong>. Today we <strong style={{ color: "#10B981" }}>Define</strong> â€” synthesize what you found and decide where to focus.
            </p>
          </div>

          <div style={{ background: "rgba(255,255,255,0.04)", borderRadius: 12, padding: 16, border: "1px solid rgba(255,255,255,0.08)" }}>
            <div style={{ fontFamily: MONO, fontSize: 11, color: "#9CA3AF", fontWeight: 700, letterSpacing: 1, marginBottom: 10 }}>HOW TO NAVIGATE</div>
            <div style={{ display: "flex", gap: 24, fontSize: 14, color: "#D1D5DB" }}>
              <div><span style={{ fontFamily: MONO, color: "#10B981", fontWeight: 700 }}>â†’</span> or <span style={{ fontFamily: MONO, color: "#10B981", fontWeight: 700 }}>Next</span> to advance</div>
              <div><span style={{ fontFamily: MONO, color: "#10B981", fontWeight: 700 }}>â†</span> or <span style={{ fontFamily: MONO, color: "#10B981", fontWeight: 700 }}>Back</span> to go back</div>
              <div><span style={{ fontFamily: MONO, color: "#10B981", fontWeight: 700 }}>Dots</span> at the bottom to jump to any page</div>
              <div><span style={{ fontFamily: MONO, color: "#10B981", fontWeight: 700 }}>Free Browse</span> to explore non-linearly</div>
            </div>
          </div>
        </div>
      );
    }

    /* â”€â”€ Story Mode: ResearchImpact (Page 1) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function ResearchImpact() {
      const stats = useMemo(() => computeResearchStats(), []);
      if (!stats) return null;
      return (
        <div className="story-page">
          <h3>REVEAL</h3>
          <h2>Your Research at a Glance</h2>
          <p className="story-subtitle">In just two days, you created this.</p>
          <div className="story-stats-grid">
            <div><div className="story-big-number">{stats.sessionCount}</div><div className="story-big-label">Sessions</div></div>
            <div><div className="story-big-number">{stats.totalQuotes}+</div><div className="story-big-label">Direct Quotes</div></div>
            <div><div className="story-big-number">{stats.namedStudents}</div><div className="story-big-label">Named Speakers</div></div>
            <div><div className="story-big-number">{stats.stepsCount}</div><div className="story-big-label">FCM Steps Mapped</div></div>
          </div>
          <div className="story-stats-grid" style={{ maxWidth: 500 }}>
            <div><div className="story-big-number">{stats.perspectiveCount}</div><div className="story-big-label">Stakeholder Views</div></div>
            <div><div className="story-big-number">{stats.stablePatterns}</div><div className="story-big-label">Stable Patterns</div></div>
            <div><div className="story-big-number" style={{ color: "#EF4444" }}>{stats.topYield}/10</div><div className="story-big-label">Top Yield Score</div></div>
          </div>
        </div>
      );
    }

    /* â”€â”€ Story Mode: ProcessChain (Page 2) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function ProcessChain() {
      return (
        <div className="story-page">
          <h3>VALIDATE</h3>
          <h2>How We Got Here</h2>
          <p className="story-subtitle">AI as amplifier, not author</p>
          <div style={{ display: "flex", gap: 16, flexWrap: "wrap", justifyContent: "center", width: "100%", maxWidth: 800, marginBottom: 32 }}>
            <div className="story-process-step">
              <div style={{ fontSize: 40, marginBottom: 12 }}>ğŸ—£ï¸</div>
              <div style={{ fontSize: 16, fontWeight: 700, fontFamily: MONO, marginBottom: 8 }}>You Talked</div>
              <div style={{ fontSize: 13, color: "#9CA3AF", lineHeight: 1.5 }}>Honest discussions about FCM. Individual reflections. No filters.</div>
            </div>
            <div className="story-process-arrow">â†’</div>
            <div className="story-process-step">
              <div style={{ fontSize: 40, marginBottom: 12 }}>ğŸ¤–</div>
              <div style={{ fontSize: 16, fontWeight: 700, fontFamily: MONO, marginBottom: 8 }}>AI Organized</div>
              <div style={{ fontSize: 13, color: "#9CA3AF", lineHeight: 1.5 }}>Transcripts processed. Patterns extracted. Quotes identified and attributed.</div>
            </div>
            <div className="story-process-arrow">â†’</div>
            <div className="story-process-step">
              <div style={{ fontSize: 40, marginBottom: 12 }}>âœ…</div>
              <div style={{ fontSize: 16, fontWeight: 700, fontFamily: MONO, marginBottom: 8 }}>You Validated</div>
              <div style={{ fontSize: 13, color: "#9CA3AF", lineHeight: 1.5 }}>Reviewed findings. Starred insights. Confirmed what resonated.</div>
            </div>
          </div>
          <div style={{ padding: "20px 24px", background: "#1F2937", borderRadius: 12, maxWidth: 700, borderLeft: "3px solid #10B981" }}>
            <p style={{ fontSize: 15, color: "#D1FAE5", lineHeight: 1.6, margin: 0, fontStyle: "italic" }}>
              "The AI didn't invent these insights. It organized YOUR expertise into a form we can act on."
            </p>
          </div>
        </div>
      );
    }

    /* â”€â”€ Story Mode: MomentCard (Pages 3-6) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function MomentCard({ momentConfig, pageNumber }) {
      const latestSession = SESSION_DATA?.sessions?.[SESSION_DATA.sessions.length - 1];
      if (!latestSession) return null;
      const stepData = latestSession.perspectives?.student?.steps?.[momentConfig.stepId];
      const coachData = latestSession.perspectives?.coach?.steps?.[momentConfig.stepId];
      const stability = SESSION_DATA.cumulative?.stability?.[momentConfig.stepId];
      const yieldOpp = (SESSION_DATA.cumulative?.yieldOpportunities || []).find(o => o.stepId === momentConfig.stepId);
      if (!stepData) return null;
      const quotes = stepData.keyQuotes || [];
      const heroQuote = quotes[0];
      const isGapPage = momentConfig.stepId === "gap1";
      const hasCoachData = coachData && (coachData.keyQuotes || []).length > 0;

      return (
        <div className="story-page" style={{ paddingBottom: 100 }}>
          <h3>KEY MOMENT {pageNumber - 2}</h3>
          <h2 style={{ fontSize: isGapPage ? 40 : 32 }}>"{momentConfig.title}"</h2>
          <p className="story-subtitle">{momentConfig.subtitle}</p>

          {/* Yield + Stability badges */}
          <div style={{ display: "flex", gap: 12, marginBottom: 32, flexWrap: "wrap", justifyContent: "center" }}>
            {yieldOpp && (
              <span className="story-yield-badge" style={{ background: yieldOpp.yieldScore >= 9 ? "rgba(239,68,68,0.15)" : "rgba(245,158,11,0.15)", color: yieldOpp.yieldScore >= 9 ? "#EF4444" : "#F59E0B", fontSize: 14 }}>
                Yield: {yieldOpp.yieldScore}/10
              </span>
            )}
            {stability && (
              <span className="story-stability-badge" style={{
                background: stability.level === "stable" ? "rgba(16,185,129,0.15)" : stability.level === "emerging" ? "rgba(245,158,11,0.15)" : "rgba(107,114,128,0.15)",
                color: stability.level === "stable" ? "#10B981" : stability.level === "emerging" ? "#F59E0B" : "#6B7280"
              }}>
                {stability.level === "stable" ? "Stable" : stability.level === "emerging" ? "Emerging" : "Tentative"} Â· {stability.supportCount}/{SESSION_DATA.sessions[SESSION_DATA.sessions.length-1].participantCount} participants
              </span>
            )}
          </div>

          {/* Hero quote */}
          {heroQuote && (
            <div style={{ marginBottom: 32 }}>
              <p className="story-pull-quote">"{heroQuote.text}"</p>
              <p className="story-quote-attr">â€” {heroQuote.speaker}{heroQuote.context ? ` Â· ${heroQuote.context}` : ""}</p>
            </div>
          )}

          {/* Two-column for session step (student vs coach) */}
          {hasCoachData ? (
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 20, width: "100%", maxWidth: 800, marginBottom: 24 }}>
              <div>
                <div style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: "#10B981", marginBottom: 12, textTransform: "uppercase" }}>Student View</div>
                {quotes.slice(1).map((q, i) => (
                  <div key={i} className="story-quote-card">
                    <div style={{ fontSize: 13, color: "#D1D5DB", fontStyle: "italic", lineHeight: 1.5 }}>"{q.text}"</div>
                    <div style={{ fontSize: 11, color: "#6B7280", marginTop: 6 }}>â€” {q.speaker}</div>
                  </div>
                ))}
              </div>
              <div>
                <div style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: "#7C3AED", marginBottom: 12, textTransform: "uppercase" }}>Coach View</div>
                {(coachData.keyQuotes || []).map((q, i) => (
                  <div key={i} className="story-quote-card" style={{ borderLeftColor: "#7C3AED" }}>
                    <div style={{ fontSize: 13, color: "#D1D5DB", fontStyle: "italic", lineHeight: 1.5 }}>"{q.text}"</div>
                    <div style={{ fontSize: 11, color: "#6B7280", marginTop: 6 }}>â€” {q.speaker}</div>
                  </div>
                ))}
              </div>
            </div>
          ) : (
            <div style={{ width: "100%", maxWidth: 700, marginBottom: 24 }}>
              {quotes.slice(1).map((q, i) => (
                <div key={i} className="story-quote-card">
                  <div style={{ fontSize: 13, color: "#D1D5DB", fontStyle: "italic", lineHeight: 1.5 }}>"{q.text}"</div>
                  <div style={{ fontSize: 11, color: "#6B7280", marginTop: 6 }}>â€” {q.speaker}</div>
                </div>
              ))}
            </div>
          )}

          {/* Friction + Wish */}
          <div style={{ width: "100%", maxWidth: 700 }}>
            {stepData.suggestedFriction && (
              <div className="story-moment-friction">
                <div style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: "#EF4444", marginBottom: 4 }}>FRICTION</div>
                <div style={{ fontSize: 13, color: "#FCA5A5", lineHeight: 1.5 }}>{stepData.suggestedFriction}</div>
              </div>
            )}
            {stepData.suggestedWish && (
              <div className="story-moment-wish">
                <div style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: "#10B981", marginBottom: 4 }}>WISH</div>
                <div style={{ fontSize: 13, color: "#6EE7B7", lineHeight: 1.5 }}>{stepData.suggestedWish}</div>
              </div>
            )}
          </div>

          {/* Extra visual weight for The Gap */}
          {isGapPage && stability && (
            <div style={{ marginTop: 24, padding: "20px 24px", background: "rgba(239,68,68,0.08)", border: "1px solid rgba(239,68,68,0.2)", borderRadius: 12, maxWidth: 700, textAlign: "center" }}>
              <div style={{ fontSize: 36, fontWeight: 800, fontFamily: MONO, color: "#EF4444" }}>{stability.supportCount}/{SESSION_DATA.sessions[SESSION_DATA.sessions.length-1].participantCount}</div>
              <div style={{ fontSize: 13, color: "#FCA5A5", marginTop: 4 }}>participants confirmed this exact pattern</div>
              <div style={{ fontSize: 14, color: "#9CA3AF", marginTop: 8, fontStyle: "italic" }}>Highest-confidence finding in the entire dataset</div>
            </div>
          )}
        </div>
      );
    }

    /* â”€â”€ Story Mode: SwimlaneMap (Page 7) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function SwimlaneMap({ onCellClick }) {
      const latestSession = SESSION_DATA?.sessions?.[SESSION_DATA.sessions.length - 1];
      const cumStab = SESSION_DATA?.cumulative?.stability || {};
      const cumYield = SESSION_DATA?.cumulative?.yieldOpportunities || [];
      if (!latestSession) return null;

      const rows = [
        { key: "student", label: "Student", color: "#10B981" },
        { key: "coach", label: "Coach", color: "#7C3AED" },
        { key: "administrator", label: "Admin", color: "#EF4444" },
      ];

      const getCellData = (perspKey, stepId) => {
        const pData = latestSession.perspectives?.[perspKey];
        if (perspKey === "administrator") {
          if (!pData?.macroJobs) return null;
          const relevant = pData.macroJobs.find(j => j.id === stepId || j.title.toLowerCase().includes(DEFAULT_STEPS.find(s => s.id === stepId)?.title?.toLowerCase() || "___"));
          return relevant ? { hasData: true, summary: relevant.title } : null;
        }
        const stepData = pData?.steps?.[stepId];
        if (!stepData || (!stepData.summary && (!stepData.keyQuotes || stepData.keyQuotes.length === 0))) return null;
        return { hasData: true, summary: stepData.summary, quoteCount: (stepData.keyQuotes || []).length };
      };

      return (
        <div className="story-page" style={{ paddingBottom: 100 }}>
          <h3>THE FULL PICTURE</h3>
          <h2>Your Journey Map</h2>
          <p className="story-subtitle">And that's just 4 of the {DEFAULT_STEPS.length} steps you mapped. Here's the complete view.</p>

          <div style={{ width: "100%", overflowX: "auto", marginBottom: 32 }}>
            {/* Header row */}
            <div className="story-swimlane" style={{ gridTemplateColumns: `100px repeat(${DEFAULT_STEPS.length}, minmax(80px, 1fr))` }}>
              <div style={{ padding: 8 }} />
              {DEFAULT_STEPS.map((step, i) => (
                <div key={step.id} style={{ padding: "6px 4px", textAlign: "center" }}>
                  <div style={{ fontSize: 10, fontWeight: 700, fontFamily: MONO, color: step.isInvisible ? "#F59E0B" : "#9CA3AF" }}>{step.isInvisible ? "ğŸ‘»" : i + 1 - DEFAULT_STEPS.slice(0, i).filter(s => s.isInvisible).length}</div>
                  <div style={{ fontSize: 9, fontFamily: MONO, color: "#6B7280", lineHeight: 1.2 }}>{step.title.replace("â³ ", "")}</div>
                  {cumYield.find(o => o.stepId === step.id) && (
                    <div style={{ fontSize: 8, fontWeight: 700, fontFamily: MONO, color: "#EF4444", marginTop: 2 }}>{cumYield.find(o => o.stepId === step.id).yieldScore}/10</div>
                  )}
                </div>
              ))}
            </div>

            {/* Data rows */}
            {rows.map(row => (
              <div key={row.key} className="story-swimlane" style={{ gridTemplateColumns: `100px repeat(${DEFAULT_STEPS.length}, minmax(80px, 1fr))` }}>
                <div style={{ padding: "8px 4px", fontSize: 11, fontWeight: 700, fontFamily: MONO, color: row.color, display: "flex", alignItems: "center" }}>{row.label}</div>
                {DEFAULT_STEPS.map(step => {
                  const cell = getCellData(row.key, step.id);
                  const stab = cumStab[step.id];
                  const isGap = step.isInvisible;
                  const bgColor = cell?.hasData
                    ? (isGap ? "rgba(239,68,68,0.12)" : "rgba(16,185,129,0.08)")
                    : (isGap ? "rgba(245,158,11,0.08)" : "rgba(55,65,81,0.3)");
                  return (
                    <div
                      key={step.id}
                      className="story-swimlane-cell"
                      style={{ background: bgColor }}
                      onClick={() => cell?.hasData && onCellClick(row.key, step.id)}
                    >
                      {cell?.hasData ? (
                        <>
                          <div style={{ fontSize: 10, color: row.color, fontWeight: 600 }}>
                            {cell.quoteCount ? `${cell.quoteCount} quotes` : "data"}
                          </div>
                          {stab && <div style={{ fontSize: 8, marginTop: 2, color: stab.level === "stable" ? "#10B981" : stab.level === "emerging" ? "#F59E0B" : "#6B7280" }}>{stab.level}</div>}
                        </>
                      ) : (
                        <div style={{ fontSize: 10, color: "#374151" }}>â€”</div>
                      )}
                    </div>
                  );
                })}
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* â”€â”€ Story Mode: CellDetail (slide-in overlay) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function CellDetail({ perspKey, stepId, onClose }) {
      const latestSession = SESSION_DATA?.sessions?.[SESSION_DATA.sessions.length - 1];
      if (!latestSession) return null;
      const step = DEFAULT_STEPS.find(s => s.id === stepId);
      const pData = latestSession.perspectives?.[perspKey];
      const stepData = pData?.steps?.[stepId];
      const stab = SESSION_DATA?.cumulative?.stability?.[stepId];
      const yieldOpp = (SESSION_DATA?.cumulative?.yieldOpportunities || []).find(o => o.stepId === stepId);

      useEffect(() => {
        const handler = (e) => { if (e.key === "Escape") onClose(); };
        window.addEventListener("keydown", handler);
        return () => window.removeEventListener("keydown", handler);
      }, [onClose]);

      return (
        <div className="story-cell-detail">
          <button onClick={onClose} style={{ float: "right", background: "none", border: "1px solid #374151", borderRadius: 6, padding: "4px 10px", color: "#9CA3AF", cursor: "pointer", fontFamily: MONO, fontSize: 12 }}>âœ•</button>
          <div style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: perspKey === "student" ? "#10B981" : perspKey === "coach" ? "#7C3AED" : "#EF4444", textTransform: "uppercase", marginBottom: 8 }}>{perspKey}</div>
          <h3 style={{ fontFamily: MONO, fontSize: 18, fontWeight: 700, color: "#F9FAFB", margin: "0 0 16px" }}>{step?.title || stepId}</h3>
          {stab && (
            <div style={{ marginBottom: 12, display: "flex", gap: 8, flexWrap: "wrap" }}>
              <span className="story-stability-badge" style={{ background: stab.level === "stable" ? "rgba(16,185,129,0.15)" : "rgba(245,158,11,0.15)", color: stab.level === "stable" ? "#10B981" : "#F59E0B" }}>{stab.level} Â· {stab.supportCount} participants</span>
              {yieldOpp && <span className="story-yield-badge" style={{ background: "rgba(239,68,68,0.15)", color: "#EF4444", fontSize: 12 }}>Yield {yieldOpp.yieldScore}/10</span>}
            </div>
          )}
          {stepData?.summary && <p style={{ fontSize: 13, color: "#D1D5DB", lineHeight: 1.6, marginBottom: 16 }}>{stepData.summary}</p>}
          {stepData?.themes && stepData.themes.length > 0 && (
            <div style={{ display: "flex", gap: 6, flexWrap: "wrap", marginBottom: 16 }}>
              {stepData.themes.map((t, i) => (
                <span key={i} style={{ padding: "3px 10px", borderRadius: 12, background: "#1F2937", color: "#9CA3AF", fontSize: 11, fontFamily: MONO }}>{t}</span>
              ))}
            </div>
          )}
          {stepData?.keyQuotes && stepData.keyQuotes.length > 0 && (
            <div>
              <div style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: "#6B7280", marginBottom: 8, textTransform: "uppercase" }}>Quotes</div>
              {stepData.keyQuotes.map((q, i) => (
                <div key={i} style={{ padding: "10px 14px", background: "#1F2937", borderRadius: 6, marginBottom: 6, borderLeft: "2px solid #3B82F6" }}>
                  <div style={{ fontSize: 13, color: "#D1D5DB", fontStyle: "italic", lineHeight: 1.5 }}>"{q.text}"</div>
                  <div style={{ fontSize: 11, color: "#6B7280", marginTop: 4 }}>â€” {q.speaker}</div>
                </div>
              ))}
            </div>
          )}
          {stepData?.suggestedFriction && (
            <div style={{ marginTop: 16 }}>
              <div style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: "#EF4444", marginBottom: 4 }}>FRICTION</div>
              <div style={{ fontSize: 12, color: "#FCA5A5", lineHeight: 1.5 }}>{stepData.suggestedFriction}</div>
            </div>
          )}
          {stepData?.suggestedWish && (
            <div style={{ marginTop: 12 }}>
              <div style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: "#10B981", marginBottom: 4 }}>WISH</div>
              <div style={{ fontSize: 12, color: "#6EE7B7", lineHeight: 1.5 }}>{stepData.suggestedWish}</div>
            </div>
          )}
        </div>
      );
    }

    /* â”€â”€ Story Mode: ConvergenceBridge (Page 8) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function ConvergenceBridge() {
      const cumYield = SESSION_DATA?.cumulative?.yieldOpportunities || [];
      const top3 = cumYield.slice(0, 3);
      return (
        <div className="story-page">
          <h3>CONVERGE</h3>
          <h2>What This Means</h2>
          <p className="story-subtitle">Your research points to a clear product opportunity. Now let's decide what to build.</p>
          <div style={{ width: "100%", maxWidth: 700, marginBottom: 40 }}>
            {top3.map((opp, i) => (
              <div key={i} style={{ display: "flex", alignItems: "flex-start", gap: 16, padding: "16px 20px", background: "#1F2937", borderRadius: 10, marginBottom: 8, border: i === 0 ? "1px solid rgba(239,68,68,0.3)" : "1px solid #374151" }}>
                <div style={{ fontFamily: MONO, fontWeight: 800, fontSize: 28, color: opp.yieldScore >= 9 ? "#EF4444" : opp.yieldScore >= 7 ? "#F59E0B" : "#6B7280", minWidth: 48, textAlign: "center" }}>{opp.yieldScore}</div>
                <div>
                  <div style={{ fontWeight: 700, fontSize: 15, color: "#F9FAFB", fontFamily: MONO }}>{opp.title}</div>
                  <div style={{ fontSize: 12, color: "#9CA3AF", marginTop: 4 }}>
                    {opp.sessions?.length || 0} session{(opp.sessions?.length || 0) !== 1 ? "s" : ""}
                    {opp.rationale ? ` â€” ${opp.rationale.slice(0, 100)}${opp.rationale.length > 100 ? "..." : ""}` : ""}
                  </div>
                </div>
              </div>
            ))}
          </div>
          <div style={{ maxWidth: 600, textAlign: "center" }}>
            <p style={{ fontSize: 15, color: "#D1D5DB", lineHeight: 1.6 }}>
              The next 9 pages walk you through the design decisions: scenarios, evidence voting, feature selection, budget tradeoffs, and your final PRD. Let's build.
            </p>
          </div>
        </div>
      );
    }

    /* â”€â”€ Story Mode: FreeBrowse â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function FreeBrowse({ onCellClick }) {
      const [browseTab, setBrowseTab] = useState("impact");
      const tabs = [
        { id: "impact", label: "Impact Summary" },
        { id: "moments", label: "Key Moments" },
        { id: "map", label: "Journey Map" },
        { id: "convergence", label: "Convergence" },
      ];
      return (
        <div style={{ padding: "24px 32px", maxWidth: 960, margin: "0 auto" }}>
          <div className="browse-tabs">
            {tabs.map(tab => (
              <button key={tab.id} className={`browse-tab ${browseTab === tab.id ? "active" : ""}`} onClick={() => setBrowseTab(tab.id)}>
                {tab.label}
              </button>
            ))}
          </div>
          {browseTab === "impact" && <ResearchImpact />}
          {browseTab === "moments" && (
            <div>
              {PROJECT_CONFIG.storyMoments.map((m, i) => (
                <MomentCard key={m.stepId} momentConfig={m} pageNumber={i + 3} />
              ))}
            </div>
          )}
          {browseTab === "map" && <SwimlaneMap onCellClick={onCellClick} />}
          {browseTab === "convergence" && <ConvergenceBridge />}
        </div>
      );
    }

    /* â”€â”€ External Present Mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    const EXT_CHAPTERS = [
      { id: 0, label: "Context" },
      { id: 1, label: "Seed" },
      { id: 2, label: "Discovery" },
      { id: 3, label: "Map" },
      { id: 4, label: "Findings" },
      { id: 5, label: "Opportunities" },
      { id: 6, label: "Criteria" },
      { id: 7, label: "Built" },
      { id: 8, label: "Demo" },
      { id: 9, label: "Feedback" },
    ];

    function ExtChapterNav({ page, setPage }) {
      return (
        <div className="ext-chapter-bar">
          <button className="story-nav-btn" onClick={() => setPage(p => Math.max(p - 1, 0))} disabled={page === 0} style={{ opacity: page === 0 ? 0.3 : 1, marginRight: 12 }}>â† Back</button>
          {EXT_CHAPTERS.map(ch => (
            <button key={ch.id} className={`ext-chapter-label ${page === ch.id ? "active" : ""}`} onClick={() => setPage(ch.id)}>{ch.label}</button>
          ))}
          <button className={`story-nav-btn ${page < 9 ? "primary" : ""}`} onClick={() => page < 9 ? setPage(p => p + 1) : null} style={{ marginLeft: 12, opacity: page === 9 ? 0.3 : 1 }} disabled={page === 9}>{page < 9 ? "Next â†’" : "Done"}</button>
        </div>
      );
    }

    function ExtCellDetail({ perspKey, stepId, onClose }) {
      const latestSession = SESSION_DATA?.sessions?.[SESSION_DATA.sessions.length - 1];
      if (!latestSession) return null;
      const step = DEFAULT_STEPS.find(s => s.id === stepId);
      const pData = latestSession.perspectives?.[perspKey];
      const stepData = pData?.steps?.[stepId];
      const stab = SESSION_DATA?.cumulative?.stability?.[stepId];
      const yieldOpp = (SESSION_DATA?.cumulative?.yieldOpportunities || []).find(o => o.stepId === stepId);

      useEffect(() => {
        const handler = (e) => { if (e.key === "Escape") onClose(); };
        window.addEventListener("keydown", handler);
        return () => window.removeEventListener("keydown", handler);
      }, [onClose]);

      return (
        <div className="story-cell-detail">
          <button onClick={onClose} style={{ float: "right", background: "none", border: "1px solid #374151", borderRadius: 6, padding: "4px 10px", color: "#9CA3AF", cursor: "pointer", fontFamily: MONO, fontSize: 12 }}>âœ•</button>
          <div style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: perspKey === "student" ? "#10B981" : perspKey === "coach" ? "#7C3AED" : "#EF4444", textTransform: "uppercase", marginBottom: 8 }}>{perspKey}</div>
          <h3 style={{ fontFamily: MONO, fontSize: 18, fontWeight: 700, color: "#F9FAFB", margin: "0 0 16px" }}>{step?.title || stepId}</h3>
          {stab && (
            <div style={{ marginBottom: 12, display: "flex", gap: 8, flexWrap: "wrap" }}>
              <span className="story-stability-badge" style={{ background: stab.level === "stable" ? "rgba(16,185,129,0.15)" : "rgba(245,158,11,0.15)", color: stab.level === "stable" ? "#10B981" : "#F59E0B" }}>{stab.level} Â· {stab.supportCount} participants</span>
              {yieldOpp && <span className="story-yield-badge" style={{ background: "rgba(239,68,68,0.15)", color: "#EF4444", fontSize: 12 }}>Yield {yieldOpp.yieldScore}/10</span>}
            </div>
          )}
          {stepData?.summary && <p style={{ fontSize: 13, color: "#D1D5DB", lineHeight: 1.6, marginBottom: 16 }}>{stepData.summary}</p>}
          {stepData?.themes && stepData.themes.length > 0 && (
            <div style={{ display: "flex", gap: 6, flexWrap: "wrap", marginBottom: 16 }}>
              {stepData.themes.map((t, i) => (
                <span key={i} style={{ padding: "3px 10px", borderRadius: 12, background: "#1F2937", color: "#9CA3AF", fontSize: 11, fontFamily: MONO }}>{t}</span>
              ))}
            </div>
          )}
          {stepData?.keyQuotes && stepData.keyQuotes.length > 0 && (
            <div>
              <div style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: "#6B7280", marginBottom: 8, textTransform: "uppercase" }}>Quotes</div>
              {stepData.keyQuotes.map((q, i) => (
                <div key={i} style={{ padding: "10px 14px", background: "#1F2937", borderRadius: 6, marginBottom: 6, borderLeft: "2px solid #3B82F6" }}>
                  <div style={{ fontSize: 13, color: "#D1D5DB", fontStyle: "italic", lineHeight: 1.5 }}>"{q.text}"</div>
                  <div style={{ fontSize: 11, color: "#6B7280", marginTop: 4 }}>â€” First-year medical student</div>
                </div>
              ))}
            </div>
          )}
          {stepData?.suggestedFriction && (
            <div style={{ marginTop: 16 }}>
              <div style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: "#EF4444", marginBottom: 4 }}>FRICTION</div>
              <div style={{ fontSize: 12, color: "#FCA5A5", lineHeight: 1.5 }}>{stepData.suggestedFriction}</div>
            </div>
          )}
          {stepData?.suggestedWish && (
            <div style={{ marginTop: 12 }}>
              <div style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: "#10B981", marginBottom: 4 }}>WISH</div>
              <div style={{ fontSize: 12, color: "#6EE7B7", lineHeight: 1.5 }}>{stepData.suggestedWish}</div>
            </div>
          )}
        </div>
      );
    }

    /* Page 0 â€” Context */
    function ExtTitlePage() {
      const narrative = window.SPRINT_NARRATIVE;
      if (!narrative) return null;
      const ctx = narrative.context;
      const timeline = narrative.sprintTimeline || [];
      return (
        <div className="story-page" style={{ maxWidth: 760, textAlign: "left" }}>
          <div style={{ textAlign: "center", marginBottom: 32 }}>
            <div style={{ fontFamily: MONO, fontSize: 13, color: "#10B981", fontWeight: 700, letterSpacing: 2, marginBottom: 8 }}>EXTERNAL PRESENTATION</div>
            <h2 style={{ fontSize: 36, lineHeight: 1.2, textAlign: "center" }}>{ctx.sprintName}</h2>
            <p style={{ color: "#9CA3AF", fontSize: 16, maxWidth: 540, margin: "8px auto 0" }}>
              {ctx.teamSize} {ctx.teamDescription} Â· {ctx.institutionShort} Â· {ctx.sprintDates}
            </p>
            <p style={{ color: "#6B7280", fontSize: 13, margin: "4px auto 0" }}>
              {ctx.instructor} Â· {ctx.instructorRole}
            </p>
          </div>

          <div style={{ background: "rgba(255,255,255,0.04)", borderRadius: 12, padding: 20, marginBottom: 28, border: "1px solid rgba(255,255,255,0.08)" }}>
            <div style={{ fontFamily: MONO, fontSize: 11, color: "#9CA3AF", fontWeight: 700, letterSpacing: 1, marginBottom: 12 }}>SPRINT TIMELINE</div>
            <div style={{ display: "flex", gap: 0, alignItems: "stretch" }}>
              {timeline.map((day, i) => (
                <div key={i} style={{ flex: 1, textAlign: "center", padding: "10px 4px", background: i === timeline.length - 1 ? "rgba(16,185,129,0.15)" : i < timeline.length - 1 ? "rgba(16,185,129,0.05)" : "transparent", borderRadius: 8, border: i === timeline.length - 1 ? "1px solid rgba(16,185,129,0.4)" : "1px solid transparent" }}>
                  <div style={{ fontFamily: MONO, fontSize: 11, color: i < timeline.length - 1 ? "#6B7280" : "#10B981", fontWeight: 700 }}>Day {day.day}</div>
                  <div style={{ fontSize: 13, fontWeight: i === timeline.length - 1 ? 700 : 500, color: i < timeline.length - 1 ? "#6B7280" : "#F9FAFB", fontFamily: MONO }}>{day.title}</div>
                  <div style={{ fontSize: 10, color: "#6B7280" }}>{day.date}</div>
                </div>
              ))}
            </div>
          </div>

          <div style={{ padding: "20px 24px", background: "#1F2937", borderRadius: 12, borderLeft: "3px solid #10B981" }}>
            <p style={{ fontSize: 15, color: "#D1FAE5", lineHeight: 1.6, margin: 0, fontStyle: "italic" }}>
              "{ctx.sprintFraming}"
            </p>
          </div>
        </div>
      );
    }

    /* Page 1 â€” Seed */
    function ExtSeedPage() {
      const narrative = window.SPRINT_NARRATIVE;
      if (!narrative) return null;
      const seed = narrative.seed;
      return (
        <div className="story-page">
          <h3>THE SEED</h3>
          <h2 style={{ fontSize: 28 }}>"{seed.prompt}"</h2>
          <p className="story-subtitle" style={{ maxWidth: 640 }}>{seed.emergenceStory}</p>

          <div style={{ marginBottom: 32 }}>
            <p className="story-pull-quote">"{seed.pullQuote.text}"</p>
            <p className="story-quote-attr">â€” {seed.pullQuote.attribution}</p>
          </div>

          <div style={{ width: "100%", maxWidth: 600 }}>
            <div style={{ fontFamily: MONO, fontSize: 11, color: "#9CA3AF", fontWeight: 700, letterSpacing: 1, marginBottom: 12 }}>WHY FCM?</div>
            {seed.whyFCM.map((reason, i) => (
              <div key={i} style={{ display: "flex", alignItems: "center", gap: 12, padding: "10px 16px", background: "#1F2937", borderRadius: 8, marginBottom: 6 }}>
                <div style={{ fontFamily: MONO, fontSize: 14, color: "#10B981", fontWeight: 700 }}>{i + 1}</div>
                <div style={{ fontSize: 14, color: "#D1D5DB" }}>{reason}</div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* Page 2 â€” Discovery */
    function ExtDiscoveryPage() {
      const stats = useMemo(() => computeExternalStats(), []);
      if (!stats) return null;
      return (
        <div className="story-page">
          <h3>DISCOVERY</h3>
          <h2>What We Found</h2>
          <p className="story-subtitle">Research methodology: structured interviews, journey mapping, and synthesis across three stakeholder perspectives.</p>
          <div className="story-stats-grid">
            <div><div className="story-big-number">{stats.sessionCount}</div><div className="story-big-label">Research Sessions</div></div>
            <div><div className="story-big-number">{stats.totalQuotes}+</div><div className="story-big-label">Direct Quotes</div></div>
            <div><div className="story-big-number">{stats.namedStudents}</div><div className="story-big-label">{stats.speakerLabel}</div></div>
            <div><div className="story-big-number">{stats.stepsCount}</div><div className="story-big-label">FCM Steps Mapped</div></div>
          </div>
          <div className="story-stats-grid" style={{ maxWidth: 500 }}>
            <div><div className="story-big-number">{stats.perspectiveCount}</div><div className="story-big-label">Stakeholder Views</div></div>
            <div><div className="story-big-number">{stats.stablePatterns}</div><div className="story-big-label">Stable Patterns</div></div>
            <div><div className="story-big-number" style={{ color: "#EF4444" }}>{stats.topYield}/10</div><div className="story-big-label">Top Yield Score</div></div>
          </div>
          <div style={{ display: "flex", gap: 16, flexWrap: "wrap", justifyContent: "center", width: "100%", maxWidth: 800, marginTop: 24 }}>
            {["Student Experience", "Coach Perspective", "Administrative Needs"].map((label, i) => (
              <div key={i} style={{ padding: "12px 20px", background: "#1F2937", borderRadius: 10, border: "1px solid #374151", textAlign: "center" }}>
                <div style={{ fontFamily: MONO, fontSize: 13, fontWeight: 700, color: ["#10B981", "#7C3AED", "#EF4444"][i] }}>{label}</div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* Page 3 â€” Journey Map */
    function ExtJourneyMapPage() {
      const [cellDetail, setCellDetail] = useState(null);
      return (
        <div style={{ position: "relative" }}>
          <SwimlaneMap onCellClick={(perspKey, stepId) => setCellDetail({ perspKey, stepId })} />
          {cellDetail && <ExtCellDetail perspKey={cellDetail.perspKey} stepId={cellDetail.stepId} onClose={() => setCellDetail(null)} />}
        </div>
      );
    }

    /* Page 4 â€” Pain Points / Findings */
    function ExtPainPointsPage() {
      const narrative = window.SPRINT_NARRATIVE;
      if (!narrative) return null;
      const findings = narrative.keyFindings || [];
      return (
        <div className="story-page" style={{ paddingBottom: 100 }}>
          <h3>KEY FINDINGS</h3>
          <h2>What's Broken</h2>
          <p className="story-subtitle">The four most significant pain points, validated across multiple participants.</p>
          <div style={{ width: "100%", maxWidth: 700 }}>
            {findings.map((f, i) => (
              <div key={f.id} className="ext-finding-card">
                <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 12 }}>
                  <h4 style={{ margin: 0 }}>{i + 1}. {f.title}</h4>
                  <span className="story-stability-badge" style={{ background: f.stability === "stable" ? "rgba(16,185,129,0.15)" : "rgba(245,158,11,0.15)", color: f.stability === "stable" ? "#10B981" : "#F59E0B", flexShrink: 0 }}>
                    {f.stability} Â· {f.supportCount}/{f.totalParticipants}
                  </span>
                </div>
                <p style={{ fontSize: 14, color: "#9CA3AF", lineHeight: 1.6, margin: "0 0 16px" }}>{f.summary}</p>
                {f.quotes.map((q, qi) => (
                  <div key={qi}>
                    <div className="ext-anon-quote">"{q.text}"</div>
                    <div className="ext-anon-attr">â€” {q.attribution}</div>
                  </div>
                ))}
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* Page 5 â€” Opportunities */
    function ExtOpportunitiesPage() {
      const narrative = window.SPRINT_NARRATIVE;
      if (!narrative) return null;
      const opps = narrative.opportunities || [];
      return (
        <div className="story-page" style={{ paddingBottom: 100 }}>
          <h3>OPPORTUNITIES</h3>
          <h2>Where to Intervene</h2>
          <p className="story-subtitle">Yield-scored interventions ranked by impact potential.</p>
          <div style={{ width: "100%", maxWidth: 700 }}>
            {opps.map((opp, i) => (
              <div key={opp.id} style={{ display: "flex", alignItems: "flex-start", gap: 16, padding: "16px 20px", background: "#1F2937", borderRadius: 10, marginBottom: 8, border: i === 0 ? "1px solid rgba(239,68,68,0.3)" : "1px solid #374151" }}>
                <div style={{ fontFamily: MONO, fontWeight: 800, fontSize: 28, color: opp.yieldScore >= 9 ? "#EF4444" : opp.yieldScore >= 7 ? "#F59E0B" : "#6B7280", minWidth: 48, textAlign: "center" }}>{opp.yieldScore}</div>
                <div style={{ flex: 1 }}>
                  <div style={{ fontWeight: 700, fontSize: 15, color: "#F9FAFB", fontFamily: MONO }}>{opp.title}</div>
                  <div style={{ fontSize: 13, color: "#9CA3AF", marginTop: 4, lineHeight: 1.5 }}>{opp.description}</div>
                  <div style={{ fontSize: 12, color: "#10B981", marginTop: 8, fontStyle: "italic" }}>{opp.impact}</div>
                </div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* Page 6 â€” Criteria + Success Metrics */
    function ExtCriteriaPage() {
      const narrative = window.SPRINT_NARRATIVE;
      if (!narrative) return null;
      const criteria = narrative.designCriteria || [];
      const metrics = narrative.successMetrics || [];
      return (
        <div className="story-page" style={{ paddingBottom: 100 }}>
          <h3>DESIGN PRINCIPLES</h3>
          <h2>How We Decided What to Build</h2>
          <p className="story-subtitle">Design criteria that guided every decision, and how we'll know it's working.</p>
          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 24, width: "100%", maxWidth: 800 }}>
            <div>
              <div style={{ fontFamily: MONO, fontSize: 11, color: "#10B981", fontWeight: 700, letterSpacing: 1, marginBottom: 12 }}>DESIGN CRITERIA</div>
              {criteria.map((c, i) => (
                <div key={i} className="ext-criteria-card">
                  <h4><span style={{ marginRight: 8 }}>{c.icon}</span>{c.title}</h4>
                  <p style={{ fontSize: 13, color: "#9CA3AF", lineHeight: 1.5, margin: 0 }}>{c.description}</p>
                </div>
              ))}
            </div>
            <div>
              <div style={{ fontFamily: MONO, fontSize: 11, color: "#F59E0B", fontWeight: 700, letterSpacing: 1, marginBottom: 12 }}>SUCCESS METRICS</div>
              {metrics.map((m, i) => (
                <div key={i} className="ext-criteria-card">
                  <h4>{m.metric}</h4>
                  <p style={{ fontSize: 13, color: "#9CA3AF", lineHeight: 1.5, margin: "0 0 6px" }}>{m.description}</p>
                  <div style={{ fontSize: 11, color: "#6B7280", fontFamily: MONO }}>{m.measurement}</div>
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    /* Page 7 â€” What We Built */
    function ExtWhatWeBuiltPage() {
      const narrative = window.SPRINT_NARRATIVE;
      if (!narrative) return null;
      const products = narrative.productEvolution || [];
      return (
        <div className="story-page" style={{ paddingBottom: 100 }}>
          <h3>WHAT WE BUILT</h3>
          <h2>From Research to Product in 5 Days</h2>
          <p className="story-subtitle">Two products evolved through the sprint â€” a research tool and a student-facing app.</p>
          <div style={{ width: "100%", maxWidth: 700 }}>
            {products.map(product => (
              <div key={product.id} style={{ marginBottom: 40 }}>
                <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 16 }}>
                  <div style={{ fontFamily: MONO, fontSize: 18, fontWeight: 800, color: "#F9FAFB" }}>{product.product}</div>
                  <span style={{ padding: "3px 10px", borderRadius: 12, background: "rgba(16,185,129,0.15)", color: "#10B981", fontSize: 11, fontFamily: MONO, fontWeight: 600 }}>{product.role}</span>
                </div>
                {product.versions.map((v, vi) => (
                  <div key={vi} className="ext-version-card">
                    <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start" }}>
                      <div>
                        <div style={{ fontFamily: MONO, fontSize: 14, fontWeight: 700, color: "#F9FAFB" }}>{v.version} â€” {v.title}</div>
                        <div style={{ fontSize: 12, color: "#6B7280", fontFamily: MONO, marginTop: 2 }}>{v.date}</div>
                      </div>
                    </div>
                    <p style={{ fontSize: 13, color: "#9CA3AF", lineHeight: 1.5, margin: "8px 0 4px" }}>{v.description}</p>
                    <div style={{ fontSize: 12, color: "#10B981", fontStyle: "italic" }}>{v.milestone}</div>
                  </div>
                ))}
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* Page 8 â€” Demo Handoff */
    function ExtDemoHandoffPage() {
      const narrative = window.SPRINT_NARRATIVE;
      if (!narrative) return null;
      return (
        <div className="story-page">
          <h3>LIVE DEMO</h3>
          <h2>See It in Action</h2>
          <p className="story-subtitle">Transitioning from slides to the live product.</p>

          <div style={{ padding: "32px 40px", background: "#1F2937", borderRadius: 16, border: "1px solid #374151", textAlign: "center", marginBottom: 32, maxWidth: 600, width: "100%" }}>
            <div style={{ fontSize: 16, color: "#9CA3AF", marginBottom: 12 }}>FCM Companion</div>
            <a href="https://fcm-companion.vercel.app" target="_blank" rel="noopener noreferrer" style={{ fontFamily: MONO, fontSize: 20, fontWeight: 700, color: "#10B981", textDecoration: "none" }}>
              fcm-companion.vercel.app â†’
            </a>
          </div>

          <div style={{ width: "100%", maxWidth: 600 }}>
            <div style={{ fontFamily: MONO, fontSize: 11, color: "#9CA3AF", fontWeight: 700, letterSpacing: 1, marginBottom: 16 }}>THINGS TO WATCH FOR</div>
            {[
              "Interactive differential diagnosis with VINDICATE grid",
              "AI-powered feedback on reasoning quality (not just correctness)",
              "324 practice cases from medical literature",
              "Faculty dashboard showing per-student reasoning data",
              "Session management with schedule integration",
              "Progressive Web App â€” works offline on any device",
            ].map((item, i) => (
              <div key={i} style={{ display: "flex", alignItems: "center", gap: 12, padding: "10px 16px", background: i % 2 === 0 ? "#1F2937" : "transparent", borderRadius: 8, marginBottom: 4 }}>
                <div style={{ fontFamily: MONO, fontSize: 12, color: "#10B981", fontWeight: 700 }}>âœ“</div>
                <div style={{ fontSize: 14, color: "#D1D5DB" }}>{item}</div>
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* Page 9 â€” Feedback */
    function ExtFeedbackPage() {
      const narrative = window.SPRINT_NARRATIVE;
      if (!narrative) return null;
      const groups = narrative.feedbackQuestions || [];
      return (
        <div className="story-page" style={{ paddingBottom: 100 }}>
          <h3>YOUR FEEDBACK</h3>
          <h2>Questions for You</h2>
          <p className="story-subtitle">These are the right questions for the prototype stage â€” not "do you like it?" but "where does this go?"</p>
          <div style={{ width: "100%", maxWidth: 700 }}>
            {groups.map((group, gi) => (
              <div key={gi} className="ext-feedback-card">
                <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 16 }}>
                  <span style={{ padding: "4px 12px", borderRadius: 12, background: `${group.levelColor}22`, color: group.levelColor, fontSize: 11, fontFamily: MONO, fontWeight: 700 }}>{group.levelLabel}</span>
                </div>
                {group.questions.map((q, qi) => (
                  <div key={qi} className="ext-feedback-question">{q}</div>
                ))}
              </div>
            ))}
          </div>
        </div>
      );
    }

    /* ExternalPresent Container */
    function ExternalPresent({ onClose }) {
      const [page, setPage] = useState(0);
      const totalPages = 10;

      useEffect(() => {
        const handler = (e) => {
          const tag = document.activeElement?.tagName;
          if (tag === "INPUT" || tag === "TEXTAREA") return;
          if (e.key === "ArrowRight" || e.key === " ") { e.preventDefault(); setPage(p => Math.min(p + 1, totalPages - 1)); }
          if (e.key === "ArrowLeft") { e.preventDefault(); setPage(p => Math.max(p - 1, 0)); }
          if (e.key === "Escape") onClose();
        };
        window.addEventListener("keydown", handler);
        return () => window.removeEventListener("keydown", handler);
      }, [onClose]);

      return (
        <div className="story-overlay">
          <button className="story-close" onClick={onClose}>âœ• Exit</button>
          {page === 0 && <ExtTitlePage />}
          {page === 1 && <ExtSeedPage />}
          {page === 2 && <ExtDiscoveryPage />}
          {page === 3 && <ExtJourneyMapPage />}
          {page === 4 && <ExtPainPointsPage />}
          {page === 5 && <ExtOpportunitiesPage />}
          {page === 6 && <ExtCriteriaPage />}
          {page === 7 && <ExtWhatWeBuiltPage />}
          {page === 8 && <ExtDemoHandoffPage />}
          {page === 9 && <ExtFeedbackPage />}
          <ExtChapterNav page={page} setPage={setPage} />
        </div>
      );
    }

    /* â”€â”€ Story Mode: Container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function ReviewMode({ onClose }) {
      const [page, setPage] = useState(0);
      const [mode, setMode] = useState("story"); // "story" or "browse"
      const [cellDetail, setCellDetail] = useState(null);
      const totalPages = 18; // 0=landing, 1-8=research, 9-17=design

      // Lifted Product Lab state
      const plSaved = useMemo(() => {
        try { return JSON.parse(localStorage.getItem("fcm-product-lab")) || {}; } catch { return {}; }
      }, []);
      const [votes, setVotes] = useState(plSaved.votes || {});
      const [selectedFeatures, setSelectedFeatures] = useState(plSaved.selectedFeatures || []);
      const [customPainPoints, setCustomPainPoints] = useState(plSaved.customPainPoints || { student: [], instructor: [], admin: [] });
      const [newPainPoint, setNewPainPoint] = useState({ student: "", instructor: "", admin: "" });
      const [confirmedArchetype, setConfirmedArchetype] = useState(plSaved.confirmedArchetype || null);
      const [confirmedPhilosophy, setConfirmedPhilosophy] = useState(plSaved.confirmedPhilosophy || null);
      const [visionStatement, setVisionStatement] = useState(plSaved.visionStatement || "");
      const [notBuilding, setNotBuilding] = useState(plSaved.notBuilding || ["Full EMR integration", "Graded assessments (this is practice, not evaluation)", "Replacing FCM sessions entirely"]);
      const [newNotBuilding, setNewNotBuilding] = useState("");
      const [prdNotes, setPrdNotes] = useState(plSaved.prdNotes || "");

      // Persist to localStorage
      useEffect(() => {
        try { localStorage.setItem("fcm-product-lab", JSON.stringify({ votes, selectedFeatures, dnaPosition: plSaved.dnaPosition || { x: 0.5, y: 0.5 }, confirmedArchetype, customPainPoints, notBuilding, prdNotes, confirmedPhilosophy, visionStatement })); } catch {}
      }, [votes, selectedFeatures, confirmedArchetype, customPainPoints, notBuilding, prdNotes, confirmedPhilosophy, visionStatement]);

      const toggleVote = useCallback((id) => { setVotes(prev => ({ ...prev, [id]: prev[id] ? 0 : 1 })); }, []);
      const toggleFeature = useCallback((id) => { setSelectedFeatures(prev => prev.includes(id) ? prev.filter(f => f !== id) : [...prev, id]); }, []);
      const addPainPoint = useCallback((stakeholder) => {
        if (!newPainPoint[stakeholder]?.trim()) return;
        setCustomPainPoints(prev => ({ ...prev, [stakeholder]: [...(prev[stakeholder] || []), { id: `custom-${Date.now()}`, text: newPainPoint[stakeholder].trim(), custom: true }] }));
        setNewPainPoint(prev => ({ ...prev, [stakeholder]: "" }));
      }, [newPainPoint]);

      const prdMarkdown = useMemo(() => {
        return generatePRDMarkdownShared({ selectedFeatures, votes, customPainPoints, confirmedArchetype, confirmedPhilosophy, visionStatement, notBuilding, prdNotes });
      }, [selectedFeatures, votes, customPainPoints, confirmedArchetype, confirmedPhilosophy, visionStatement, notBuilding, prdNotes]);

      const handleCellClick = useCallback((perspKey, stepId) => {
        setCellDetail({ perspKey, stepId });
      }, []);

      const goToPage = useCallback((p) => setPage(p), []);

      // Arrow key navigation with input/textarea guard
      useEffect(() => {
        if (mode !== "story") return;
        const handler = (e) => {
          if (cellDetail) return;
          const tag = document.activeElement?.tagName;
          if (tag === "INPUT" || tag === "TEXTAREA") return;
          if (e.key === "ArrowRight" || e.key === " ") { e.preventDefault(); setPage(p => Math.min(p + 1, totalPages - 1)); }
          if (e.key === "ArrowLeft") { e.preventDefault(); setPage(p => Math.max(p - 1, 0)); }
          if (e.key === "Escape") onClose();
        };
        window.addEventListener("keydown", handler);
        return () => window.removeEventListener("keydown", handler);
      }, [mode, onClose, cellDetail]);

      const isResearchPhase = page <= 8;

      return (
        <div className="story-overlay">
          <button className="story-close" onClick={onClose}>âœ• Exit</button>

          {page > 0 && isResearchPhase && <div className="story-toggle">
            <button
              className="story-nav-btn"
              onClick={() => setMode(mode === "story" ? "browse" : "story")}
              style={{ fontSize: 12 }}
            >
              {mode === "story" ? "Free Browse" : "Team Review"}
            </button>
            <button
              className="story-nav-btn"
              onClick={() => window.print()}
              style={{ fontSize: 12, marginLeft: 8 }}
            >
              Print / Save PDF
            </button>
          </div>}

          {mode === "story" ? (
            <>
              {page === 0 && <StoryLanding />}
              {page === 1 && <ResearchImpact />}
              {page === 2 && <ProcessChain />}
              {page >= 3 && page <= 6 && <MomentCard momentConfig={PROJECT_CONFIG.storyMoments[page - 3]} pageNumber={page} />}
              {page === 7 && <SwimlaneMap onCellClick={handleCellClick} />}
              {page === 8 && <ConvergenceBridge />}
              {page === 9 && <StoryScenarios />}
              {page === 10 && <StoryEvidence votes={votes} toggleVote={toggleVote} customPainPoints={customPainPoints} setCustomPainPoints={setCustomPainPoints} newPainPoint={newPainPoint} setNewPainPoint={setNewPainPoint} addPainPoint={addPainPoint} />}
              {page === 11 && <StoryFeatureMenu votes={votes} />}
              {page === 12 && <StoryBudgetBuild selectedFeatures={selectedFeatures} toggleFeature={toggleFeature} votes={votes} />}
              {page === 13 && <StoryQuickWins selectedFeatures={selectedFeatures} />}
              {page === 14 && <StorySynergyLoops selectedFeatures={selectedFeatures} />}
              {page === 15 && <StoryScenarioCheck selectedFeatures={selectedFeatures} goToPage={goToPage} />}
              {page === 16 && <StoryConverge selectedFeatures={selectedFeatures} votes={votes} customPainPoints={customPainPoints} visionStatement={visionStatement} setVisionStatement={setVisionStatement} notBuilding={notBuilding} setNotBuilding={setNotBuilding} newNotBuilding={newNotBuilding} setNewNotBuilding={setNewNotBuilding} prdNotes={prdNotes} setPrdNotes={setPrdNotes} />}
              {page === 17 && <StoryShipIt prdMarkdown={prdMarkdown} />}

              <div className="story-nav">
                <button className="story-nav-btn" onClick={() => setPage(p => Math.max(p - 1, 0))} disabled={page === 0} style={{ opacity: page === 0 ? 0.3 : 1 }}>â† Back</button>
                <div style={{ display: "flex", alignItems: "flex-end", gap: 16 }}>
                  <div style={{ display: "flex", flexDirection: "column", alignItems: "center" }}>
                    <div className="story-nav-group-label">Research</div>
                    <div style={{ display: "flex", gap: 4 }}>
                      {Array.from({ length: 9 }, (_, i) => (
                        <button key={i} className={`story-dot ${page === i ? "active" : ""}`} onClick={() => setPage(i)} />
                      ))}
                    </div>
                  </div>
                  <div style={{ width: 1, height: 16, background: "#374151" }} />
                  <div style={{ display: "flex", flexDirection: "column", alignItems: "center" }}>
                    <div className="story-nav-group-label">Design</div>
                    <div style={{ display: "flex", gap: 4 }}>
                      {Array.from({ length: 9 }, (_, i) => (
                        <button key={i + 9} className={`story-dot ${page === i + 9 ? "active" : ""}`} onClick={() => setPage(i + 9)} />
                      ))}
                    </div>
                  </div>
                </div>
                <button className={`story-nav-btn ${page < totalPages - 1 ? "primary" : ""}`} onClick={() => page < totalPages - 1 ? setPage(p => p + 1) : onClose()}>
                  {page === 0 ? "Begin â†’" : page < totalPages - 1 ? "Next â†’" : "Done"}
                </button>
              </div>
            </>
          ) : (
            <FreeBrowse onCellClick={handleCellClick} />
          )}

          {cellDetail && <CellDetail perspKey={cellDetail.perspKey} stepId={cellDetail.stepId} onClose={() => setCellDetail(null)} />}
        </div>
      );
    }

    /* â”€â”€ Story Design Pages (9-17) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    const SECTION_COLORS = {
      DESIGN: { bg: "rgba(124,58,237,0.15)", color: "#A78BFA" },
      EVIDENCE: { bg: "rgba(59,130,246,0.15)", color: "#60A5FA" },
      BUILD: { bg: "rgba(245,158,11,0.15)", color: "#F59E0B" },
      STRATEGY: { bg: "rgba(16,185,129,0.15)", color: "#10B981" },
      VALIDATE: { bg: "rgba(239,68,68,0.15)", color: "#EF4444" },
      CONVERGE: { bg: "rgba(99,102,241,0.15)", color: "#818CF8" },
      SHIP: { bg: "rgba(16,185,129,0.15)", color: "#10B981" },
    };

    function SectionLabel({ label }) {
      const sc = SECTION_COLORS[label] || SECTION_COLORS.BUILD;
      return <span className="story-section-label" style={{ background: sc.bg, color: sc.color }}>{label}</span>;
    }

    function NarrativeIntro({ children }) {
      return <p className="story-subtitle" style={{ marginBottom: 24 }}>{children}</p>;
    }

    function DiscussionPrompt({ children }) {
      return <div className="story-discussion">{children}</div>;
    }

    function InstructorNote({ children }) {
      return <div className="story-instructor">{children}</div>;
    }

    /* Page 9 â€” Scenarios */
    function StoryScenarios() {
      return (
        <div className="story-page" style={{ paddingBottom: 100 }}>
          <SectionLabel label="DESIGN" />
          <h2>"What We're Building For"</h2>
          <NarrativeIntro>Your research revealed 5 real moments in the FCM cycle where a product could make a difference. These aren't hypothetical â€” they came from your own words.</NarrativeIntro>

          <div style={{ width: "100%", maxWidth: 800 }}>
            {PL_SCENARIOS.map((s, i) => (
              <div key={s.id} style={{ background: "#1F2937", borderRadius: 12, padding: 20, marginBottom: 12, border: "1px solid #374151" }}>
                <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 10 }}>
                  <span style={{ fontSize: 28 }}>{s.icon}</span>
                  <div>
                    <div style={{ fontSize: 16, fontWeight: 700, fontFamily: MONO, color: "#F9FAFB" }}>{s.name}</div>
                    <div style={{ display: "flex", gap: 8, marginTop: 4 }}>
                      <span style={{ fontSize: 10, padding: "2px 8px", borderRadius: 10, background: "rgba(59,130,246,0.15)", color: "#60A5FA", fontFamily: MONO, fontWeight: 600 }}>{s.device}</span>
                      <span style={{ fontSize: 10, padding: "2px 8px", borderRadius: 10, background: "rgba(16,185,129,0.15)", color: "#10B981", fontFamily: MONO, fontWeight: 600 }}>{s.timing}</span>
                    </div>
                  </div>
                </div>
                <p style={{ fontSize: 13, color: "#D1D5DB", lineHeight: 1.6, margin: "0 0 10px", fontStyle: "italic" }}>"{s.scene}"</p>
                <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                  {s.featureIds.map(fId => {
                    const f = PL_FEATURES.find(ff => ff.id === fId);
                    return f ? <span key={fId} style={{ fontSize: 10, padding: "2px 8px", borderRadius: 6, background: "rgba(255,255,255,0.06)", color: "#9CA3AF", fontFamily: MONO }}>{f.icon} {f.name}</span> : null;
                  })}
                </div>
              </div>
            ))}
          </div>

          <DiscussionPrompt>Which of these 5 moments feels most broken? Where would you want help first?</DiscussionPrompt>
          <InstructorNote>~5 min. Walk through each scenario aloud. Let students react before moving on.</InstructorNote>
        </div>
      );
    }

    /* Page 10 â€” Evidence Wall */
    function StoryEvidence({ votes, toggleVote, customPainPoints, setCustomPainPoints, newPainPoint, setNewPainPoint, addPainPoint }) {
      const totalVoted = Object.values(votes).filter(Boolean).length;
      return (
        <div className="story-page" style={{ paddingBottom: 100, maxWidth: 1100 }}>
          <SectionLabel label="EVIDENCE" />
          <h2>"What You Told Us"</h2>
          <NarrativeIntro>These pain points and wishes came directly from your journey mapping sessions. Click to prioritize the ones that matter most â€” your votes shape the product.</NarrativeIntro>

          <div style={{ marginBottom: 16, textAlign: "center" }}>
            <span style={{ fontSize: 20, fontWeight: 800, fontFamily: MONO, color: "#10B981" }}>{totalVoted}</span>
            <span style={{ fontSize: 13, color: "#9CA3AF", marginLeft: 8 }}>items prioritized</span>
          </div>

          <ThemeContext.Provider value={BRAND_DARK}>
            <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(280px, 1fr))", gap: 16, width: "100%" }}>
              {Object.entries(PL_EVIDENCE).map(([key, data]) => {
                const sc = { color: key === "student" ? "#10B981" : key === "instructor" ? "#A78BFA" : "#EF4444", bg: key === "student" ? "#064E3B" : key === "instructor" ? "#4C1D95" : "#7F1D1D" };
                return (
                  <div key={key} style={{ background: "#1F2937", border: "1px solid #374151", borderRadius: 10, overflow: "hidden" }}>
                    <div style={{ background: sc.bg, padding: "14px 16px", borderBottom: "1px solid #374151" }}>
                      <div style={{ fontSize: 18, marginBottom: 2 }}>{data.emoji}</div>
                      <div style={{ fontSize: 14, fontWeight: 700, color: sc.color, fontFamily: MONO }}>{data.label}</div>
                    </div>
                    <div style={{ padding: 16 }}>
                      <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: "#6B7280", marginBottom: 10, fontFamily: MONO }}>Pain Points</div>
                      {data.painPoints.map(item => (
                        <button key={item.id} onClick={() => toggleVote(item.id)} style={{ display: "flex", alignItems: "flex-start", gap: 8, width: "100%", padding: "8px 10px", marginBottom: 6, fontSize: 12, fontFamily: SANS, lineHeight: 1.5, textAlign: "left", background: votes[item.id] ? "#78350F" : "#1A1A1A", border: `1px solid ${votes[item.id] ? "#EA580C" : "#374151"}`, borderRadius: 6, cursor: "pointer", color: "#F9FAFB", transition: "all 0.15s" }}>
                          <span style={{ fontSize: 14, flexShrink: 0 }}>{votes[item.id] ? "ğŸ”¥" : "â—‹"}</span>
                          <span>{item.text}</span>
                        </button>
                      ))}
                      {(customPainPoints[key] || []).map(item => (
                        <button key={item.id} onClick={() => toggleVote(item.id)} style={{ display: "flex", alignItems: "flex-start", gap: 8, width: "100%", padding: "8px 10px", marginBottom: 6, fontSize: 12, fontFamily: SANS, lineHeight: 1.5, textAlign: "left", background: votes[item.id] ? "#78350F" : "#1A1A1A", border: `1px solid ${votes[item.id] ? "#EA580C" : "#374151"}`, borderRadius: 6, cursor: "pointer", color: "#F9FAFB", transition: "all 0.15s" }}>
                          <span style={{ fontSize: 14, flexShrink: 0 }}>{votes[item.id] ? "ğŸ”¥" : "â—‹"}</span>
                          <span><span style={{ fontSize: 10, color: "#60A5FA", fontWeight: 600 }}>ADDED </span>{item.text}</span>
                        </button>
                      ))}
                      <div style={{ display: "flex", gap: 6, marginTop: 8, marginBottom: 16 }}>
                        <input type="text" value={newPainPoint[key] || ""} onChange={e => setNewPainPoint(prev => ({ ...prev, [key]: e.target.value }))} onKeyDown={e => e.key === "Enter" && addPainPoint(key)} placeholder="Add pain point..." style={{ flex: 1, padding: "6px 10px", fontSize: 12, fontFamily: MONO, border: "1px solid #374151", borderRadius: 6, background: "#1A1A1A", color: "#F9FAFB", outline: "none" }} />
                        <button onClick={() => addPainPoint(key)} style={{ padding: "6px 12px", fontSize: 12, fontFamily: MONO, fontWeight: 700, background: "#F9FAFB", color: "#1A1A1A", border: "none", borderRadius: 6, cursor: "pointer" }}>+</button>
                      </div>
                      <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: "#6B7280", marginBottom: 10, fontFamily: MONO }}>Wishes</div>
                      {data.wishes.map(item => (
                        <button key={item.id} onClick={() => toggleVote(item.id)} style={{ display: "flex", alignItems: "flex-start", gap: 8, width: "100%", padding: "8px 10px", marginBottom: 6, fontSize: 12, fontFamily: SANS, lineHeight: 1.5, textAlign: "left", background: votes[item.id] ? "#1E3A5F" : "#1A1A1A", border: `1px solid ${votes[item.id] ? "#3B82F6" : "#374151"}`, borderRadius: 6, cursor: "pointer", color: "#F9FAFB", transition: "all 0.15s" }}>
                          <span style={{ fontSize: 14, flexShrink: 0 }}>{votes[item.id] ? "â­" : "â—‹"}</span>
                          <span>{item.text}</span>
                        </button>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
          </ThemeContext.Provider>

          <DiscussionPrompt>Look at what the group prioritized. Any surprises? Anything missing?</DiscussionPrompt>
          <InstructorNote>~5 min. Students click to vote. Watch the counter update. Discuss top picks.</InstructorNote>
        </div>
      );
    }

    /* Page 11 â€” Feature Menu (read-only) */
    function StoryFeatureMenu({ votes }) {
      const costTiers = [
        { cost: 1, label: "1 pt â€” Quick Adds" },
        { cost: 2, label: "2 pts â€” Light Builds" },
        { cost: 3, label: "3 pts â€” Core Features" },
        { cost: 4, label: "4 pts â€” Heavy Lifts" },
      ];
      const votedIds = new Set(Object.keys(votes).filter(k => votes[k]));
      return (
        <div className="story-page" style={{ paddingBottom: 100, maxWidth: 900 }}>
          <SectionLabel label="BUILD" />
          <h2>"11 Ways to Fix This"</h2>
          <NarrativeIntro>Here are all the features your team could build â€” designed to address the evidence you just prioritized. But you can't build them all.</NarrativeIntro>

          <div style={{ width: "100%", marginBottom: 24, padding: "12px 20px", background: "#1F2937", borderRadius: 8, display: "flex", alignItems: "center", gap: 12 }}>
            <div style={{ height: 8, flex: 1, background: "#374151", borderRadius: 4, overflow: "hidden" }}>
              <div style={{ height: "100%", width: "0%", background: "#10B981", borderRadius: 4 }} />
            </div>
            <span style={{ fontFamily: MONO, fontSize: 14, fontWeight: 700, color: "#6B7280" }}>0 / {PL_BUDGET}</span>
          </div>

          {costTiers.map(tier => {
            const features = PL_FEATURES.filter(f => f.cost === tier.cost);
            if (features.length === 0) return null;
            return (
              <div key={tier.cost} style={{ marginBottom: 24, width: "100%" }}>
                <div style={{ fontSize: 12, fontWeight: 700, fontFamily: MONO, color: "#F59E0B", marginBottom: 10 }}>{tier.label}</div>
                <div className="story-feature-grid">
                  {features.map(f => {
                    const hasVotedEvidence = (f.addressesEvidence || []).some(eId => votedIds.has(eId));
                    return (
                      <div key={f.id} style={{ background: "#1F2937", border: `1px solid ${hasVotedEvidence ? "rgba(59,130,246,0.4)" : "#374151"}`, borderRadius: 8, padding: "12px 14px" }}>
                        <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 6 }}>
                          <span style={{ fontSize: 20 }}>{f.icon}</span>
                          <span style={{ fontSize: 13, fontWeight: 700, fontFamily: MONO, color: "#F9FAFB" }}>{f.name}</span>
                          <span style={{ fontSize: 10, fontWeight: 700, padding: "2px 8px", borderRadius: 10, background: "#78350F", color: "#F59E0B", fontFamily: MONO, marginLeft: "auto" }}>{f.cost} pt{f.cost !== 1 ? "s" : ""}</span>
                        </div>
                        <div style={{ fontSize: 11, color: "#9CA3AF", lineHeight: 1.5, marginBottom: 6 }}>{f.description}</div>
                        {hasVotedEvidence && <div style={{ fontSize: 10, color: "#60A5FA", fontFamily: MONO }}>Addresses your prioritized evidence</div>}
                        <div style={{ display: "flex", gap: 4, flexWrap: "wrap", marginTop: 4 }}>
                          {f.stakeholders.map(s => (
                            <span key={s} style={{ fontSize: 9, fontWeight: 600, padding: "1px 6px", borderRadius: 3, color: s === "student" ? "#10B981" : s === "instructor" ? "#A78BFA" : "#EF4444", background: s === "student" ? "#064E3B" : s === "instructor" ? "#4C1D95" : "#7F1D1D", fontFamily: MONO, textTransform: "uppercase" }}>{s}</span>
                          ))}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>
            );
          })}

          <DiscussionPrompt>Look at the menu. What jumps out? Which features feel like must-haves vs. nice-to-haves?</DiscussionPrompt>
          <InstructorNote>~5 min. Read-only view â€” let tension build. They'll get to choose on the next page.</InstructorNote>
        </div>
      );
    }

    /* Page 12 â€” Budget Build (core negotiation) */
    function StoryBudgetBuild({ selectedFeatures, toggleFeature, votes }) {
      const selFeats = PL_FEATURES.filter(f => selectedFeatures.includes(f.id));
      const totalCost = selFeats.reduce((sum, f) => sum + f.cost, 0);
      const overBudget = totalCost > PL_BUDGET;
      const pct = Math.min(100, (totalCost / PL_BUDGET) * 100);
      const votedIds = new Set(Object.keys(votes).filter(k => votes[k]));

      return (
        <div className="story-page" style={{ paddingBottom: 100, maxWidth: 1100 }}>
          <SectionLabel label="BUILD" />
          <h2>"10 Points. Real Tradeoffs."</h2>
          <NarrativeIntro>You have {PL_BUDGET} build points. Every feature has a cost. You can't build everything â€” choose what matters most.</NarrativeIntro>

          <div className="story-two-col">
            <div>
              {PL_FEATURES.map(f => {
                const selected = selectedFeatures.includes(f.id);
                const hasVotedEvidence = (f.addressesEvidence || []).some(eId => votedIds.has(eId));
                return (
                  <button key={f.id} onClick={() => toggleFeature(f.id)} style={{ display: "flex", alignItems: "flex-start", gap: 10, width: "100%", padding: "12px 14px", marginBottom: 8, textAlign: "left", fontFamily: SANS, background: selected ? "rgba(16,185,129,0.12)" : "#1F2937", border: `2px solid ${selected ? "#10B981" : "#374151"}`, borderRadius: 8, cursor: overBudget && !selected ? "not-allowed" : "pointer", opacity: overBudget && !selected ? 0.5 : 1, transition: "all 0.15s", color: "#F9FAFB" }}>
                    <span style={{ fontSize: 22, flexShrink: 0 }}>{f.icon}</span>
                    <div style={{ flex: 1, minWidth: 0 }}>
                      <div style={{ display: "flex", alignItems: "center", gap: 8, flexWrap: "wrap", marginBottom: 4 }}>
                        <span style={{ fontSize: 13, fontWeight: 700, fontFamily: MONO }}>{f.name}</span>
                        <span style={{ fontSize: 10, fontWeight: 700, padding: "2px 8px", borderRadius: 10, background: "#78350F", color: "#F59E0B", fontFamily: MONO }}>{f.cost} pt{f.cost !== 1 ? "s" : ""}</span>
                      </div>
                      <div style={{ fontSize: 11, color: "#9CA3AF", lineHeight: 1.5, marginBottom: 4 }}>{f.description}</div>
                      {hasVotedEvidence && <div style={{ fontSize: 10, color: "#60A5FA", fontFamily: MONO }}>Addresses your prioritized evidence</div>}
                      {f.realityWarning && <div style={{ fontSize: 10, color: "#F59E0B", marginTop: 2 }}>Reality: {f.realityWarning}</div>}
                    </div>
                    <span style={{ fontSize: 16, flexShrink: 0, marginTop: 2 }}>{selected ? "âœ…" : "â—‹"}</span>
                  </button>
                );
              })}
            </div>

            <div style={{ position: "sticky", top: 80, alignSelf: "start" }}>
              <div style={{ background: "#1F2937", borderRadius: 12, padding: 20, border: "1px solid #374151" }}>
                <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: "#6B7280", marginBottom: 16, fontFamily: MONO }}>Budget</div>
                <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 8 }}>
                  <span style={{ fontSize: 28, fontWeight: 800, fontFamily: MONO, color: overBudget ? "#EF4444" : "#10B981" }}>{totalCost}</span>
                  <span style={{ fontSize: 28, fontWeight: 800, fontFamily: MONO, color: "#6B7280" }}>/ {PL_BUDGET}</span>
                </div>
                <div style={{ height: 8, background: "#374151", borderRadius: 4, overflow: "hidden", marginBottom: 8 }}>
                  <div style={{ height: "100%", width: `${pct}%`, background: overBudget ? "#EF4444" : pct > 80 ? "#F59E0B" : "#10B981", borderRadius: 4, transition: "all 0.3s" }} />
                </div>
                {overBudget && <div style={{ fontSize: 12, color: "#EF4444", fontWeight: 600, fontFamily: MONO }}>Over budget by {totalCost - PL_BUDGET} pts! Remove features.</div>}
                {!overBudget && totalCost > 0 && <div style={{ fontSize: 12, color: "#10B981", fontFamily: MONO }}>{PL_BUDGET - totalCost} points remaining</div>}

                {selFeats.length > 0 && (
                  <div style={{ marginTop: 16 }}>
                    <div style={{ fontSize: 11, fontWeight: 700, color: "#6B7280", marginBottom: 8, fontFamily: MONO }}>SELECTED</div>
                    {selFeats.sort((a, b) => b.cost - a.cost).map(f => (
                      <div key={f.id} style={{ display: "flex", justifyContent: "space-between", padding: "6px 0", borderBottom: "1px solid #374151", fontSize: 12 }}>
                        <span style={{ color: "#F9FAFB" }}>{f.icon} {f.name}</span>
                        <span style={{ fontWeight: 700, fontFamily: MONO, color: "#F9FAFB" }}>{f.cost}pt</span>
                      </div>
                    ))}
                  </div>
                )}

                <div style={{ marginTop: 16 }}>
                  <div style={{ fontSize: 11, fontWeight: 700, color: "#6B7280", marginBottom: 8, fontFamily: MONO }}>FCM CYCLE COVERAGE</div>
                  <div style={{ display: "flex", gap: 3, flexWrap: "wrap" }}>
                    {PL_FCM_STEPS.map(step => {
                      const covered = selFeats.some(f => (f.affectsSteps || []).includes(step.id));
                      return <span key={step.id} style={{ fontSize: 9, padding: "3px 6px", borderRadius: 4, background: covered ? "rgba(16,185,129,0.15)" : "rgba(55,65,81,0.3)", color: covered ? "#10B981" : "#4B5563", fontFamily: MONO, fontWeight: 600 }}>{step.short}</span>;
                    })}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <DiscussionPrompt>You're over budget? What gets cut? Defend your choices to the group.</DiscussionPrompt>
          <InstructorNote>~10 min. This is the core negotiation. Let debate happen. Over-budget is intentional â€” force tradeoffs.</InstructorNote>
        </div>
      );
    }

    /* Page 13 â€” Quick Wins vs Full System */
    function StoryQuickWins({ selectedFeatures }) {
      const selFeats = PL_FEATURES.filter(f => selectedFeatures.includes(f.id));
      const quickWins = selFeats.filter(f => f.cost <= 2 && (f.requires || []).length <= 2 && !(f.requires || []).includes("ai-llm") && !(f.requires || []).includes("auth"));
      const fullSystem = selFeats.filter(f => !quickWins.includes(f));

      return (
        <div className="story-page" style={{ paddingBottom: 100 }}>
          <SectionLabel label="STRATEGY" />
          <h2>"What Ships First?"</h2>
          <NarrativeIntro>Not everything ships at once. Some features are quick wins â€” low cost, few dependencies. Others need the full system. Here's how your choices split.</NarrativeIntro>

          {selFeats.length === 0 ? (
            <div style={{ padding: 40, textAlign: "center", color: "#6B7280" }}>
              <p style={{ fontSize: 16 }}>No features selected yet. Go back to the budget page to make your picks.</p>
            </div>
          ) : (
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 24, width: "100%", maxWidth: 800 }}>
              <div>
                <div style={{ fontSize: 14, fontWeight: 700, fontFamily: MONO, color: "#10B981", marginBottom: 12 }}>Quick Wins ({quickWins.length})</div>
                <div style={{ fontSize: 11, color: "#9CA3AF", marginBottom: 16 }}>Low cost, few deps. Ship these first.</div>
                {quickWins.length === 0 && <div style={{ fontSize: 12, color: "#4B5563", fontStyle: "italic" }}>No quick wins in your selection</div>}
                {quickWins.map(f => (
                  <div key={f.id} style={{ background: "rgba(16,185,129,0.08)", border: "1px solid rgba(16,185,129,0.2)", borderRadius: 8, padding: 12, marginBottom: 8 }}>
                    <div style={{ fontSize: 13, fontWeight: 700, fontFamily: MONO, color: "#F9FAFB" }}>{f.icon} {f.name}</div>
                    <div style={{ fontSize: 10, color: "#10B981", fontFamily: MONO, marginTop: 4 }}>{f.cost}pt Â· needs: {(f.requires || []).join(", ") || "nothing"}</div>
                  </div>
                ))}
              </div>
              <div>
                <div style={{ fontSize: 14, fontWeight: 700, fontFamily: MONO, color: "#F59E0B", marginBottom: 12 }}>Full System ({fullSystem.length})</div>
                <div style={{ fontSize: 11, color: "#9CA3AF", marginBottom: 16 }}>Higher cost or heavy deps. Phase 2+.</div>
                {fullSystem.length === 0 && <div style={{ fontSize: 12, color: "#4B5563", fontStyle: "italic" }}>All your picks are quick wins!</div>}
                {fullSystem.map(f => (
                  <div key={f.id} style={{ background: "rgba(245,158,11,0.08)", border: "1px solid rgba(245,158,11,0.2)", borderRadius: 8, padding: 12, marginBottom: 8 }}>
                    <div style={{ fontSize: 13, fontWeight: 700, fontFamily: MONO, color: "#F9FAFB" }}>{f.icon} {f.name}</div>
                    <div style={{ fontSize: 10, color: "#F59E0B", fontFamily: MONO, marginTop: 4 }}>{f.cost}pt Â· needs: {(f.requires || []).join(", ")}</div>
                    {f.realityWarning && <div style={{ fontSize: 10, color: "#9CA3AF", marginTop: 2 }}>{f.realityWarning}</div>}
                    <div style={{ display: "flex", gap: 4, flexWrap: "wrap", marginTop: 4 }}>
                      {(f.requires || []).map(r => {
                        const req = PL_TECH_REQS[r];
                        return req ? <span key={r} style={{ fontSize: 8, padding: "1px 5px", borderRadius: 3, background: "#374151", color: "#9CA3AF", fontFamily: MONO }}>{req.icon} {req.label}</span> : null;
                      })}
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          <DiscussionPrompt>If you could only ship quick wins for v1, would that be enough? What's the minimum viable product?</DiscussionPrompt>
          <InstructorNote>~5 min. Frame the MVP conversation. Quick wins = what you demo next week.</InstructorNote>
        </div>
      );
    }

    /* Page 14 â€” Synergy Loops */
    function StorySynergyLoops({ selectedFeatures }) {
      const selIds = new Set(selectedFeatures);

      return (
        <div className="story-page" style={{ paddingBottom: 100 }}>
          <SectionLabel label="STRATEGY" />
          <h2>"The Loops That Make It Work"</h2>
          <NarrativeIntro>Great products create reinforcing loops â€” features that feed into each other. Here are the three loops in this product space.</NarrativeIntro>

          <div style={{ width: "100%", maxWidth: 800 }}>
            {PL_SYNERGIES.map(syn => {
              const featureStates = syn.features.map(fId => ({
                feature: PL_FEATURES.find(f => f.id === fId),
                selected: selIds.has(fId),
              }));
              const selectedCount = featureStates.filter(fs => fs.selected).length;
              const isComplete = selectedCount === syn.features.length;
              const isPartial = selectedCount > 0 && !isComplete;
              const missingFeatures = featureStates.filter(fs => !fs.selected);

              return (
                <div key={syn.id} style={{ background: "#1F2937", borderRadius: 12, padding: 20, marginBottom: 16, border: `2px solid ${isComplete ? "#10B981" : isPartial ? "#F59E0B" : "#374151"}` }}>
                  <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 10 }}>
                    <span style={{ fontSize: 28 }}>{syn.icon}</span>
                    <div style={{ flex: 1 }}>
                      <div style={{ fontSize: 16, fontWeight: 700, fontFamily: MONO, color: "#F9FAFB" }}>{syn.name}</div>
                      <div style={{ fontSize: 12, color: "#9CA3AF", lineHeight: 1.5 }}>{syn.description}</div>
                    </div>
                    <span style={{ fontSize: 12, fontWeight: 700, fontFamily: MONO, padding: "4px 12px", borderRadius: 8, background: isComplete ? "rgba(16,185,129,0.15)" : isPartial ? "rgba(245,158,11,0.15)" : "rgba(107,114,128,0.15)", color: isComplete ? "#10B981" : isPartial ? "#F59E0B" : "#6B7280" }}>
                      {isComplete ? "Complete" : `${selectedCount}/${syn.features.length}`}
                    </span>
                  </div>

                  <div style={{ display: "flex", gap: 8, flexWrap: "wrap", marginTop: 12 }}>
                    {featureStates.map(({ feature, selected }) => (
                      <div key={feature.id} style={{ display: "flex", alignItems: "center", gap: 6, padding: "6px 12px", borderRadius: 8, background: selected ? "rgba(16,185,129,0.12)" : "rgba(55,65,81,0.3)", border: `1px solid ${selected ? "#10B981" : "#374151"}` }}>
                        <span style={{ fontSize: 14 }}>{feature.icon}</span>
                        <span style={{ fontSize: 11, fontFamily: MONO, color: selected ? "#10B981" : "#6B7280", fontWeight: selected ? 700 : 400 }}>{feature.name}</span>
                        <span style={{ fontSize: 10 }}>{selected ? "âœ…" : "â¬œ"}</span>
                      </div>
                    ))}
                  </div>

                  {isPartial && missingFeatures.length > 0 && (
                    <div style={{ marginTop: 10, fontSize: 12, color: "#F59E0B", fontStyle: "italic" }}>
                      Add {missingFeatures.map(fs => `${fs.feature.name} (${fs.feature.cost}pt)`).join(" + ")} to complete this loop
                    </div>
                  )}
                </div>
              );
            })}
          </div>

          <DiscussionPrompt>Which loops did you complete? Are the incomplete ones worth finishing â€” or is the cost too high?</DiscussionPrompt>
          <InstructorNote>~5 min. Highlight that individual features are good, but loops create defensible products.</InstructorNote>
        </div>
      );
    }

    /* Page 15 â€” Scenario Coverage Check */
    function StoryScenarioCheck({ selectedFeatures, goToPage }) {
      const selIds = new Set(selectedFeatures);

      return (
        <div className="story-page" style={{ paddingBottom: 100 }}>
          <SectionLabel label="VALIDATE" />
          <h2>"Does Your Product Work?"</h2>
          <NarrativeIntro>Let's check your feature selections against the 5 real scenarios. Does your product actually cover the moments that matter?</NarrativeIntro>

          <div style={{ width: "100%", maxWidth: 800 }}>
            {PL_SCENARIOS.map(s => {
              const needed = s.featureIds;
              const covered = needed.filter(fId => selIds.has(fId));
              const missing = needed.filter(fId => !selIds.has(fId));
              const ratio = needed.length > 0 ? covered.length / needed.length : 0;
              const color = ratio >= 1 ? "#10B981" : ratio >= 0.5 ? "#F59E0B" : "#EF4444";

              return (
                <div key={s.id} style={{ background: "#1F2937", borderRadius: 12, padding: 18, marginBottom: 10, border: `1px solid ${ratio >= 1 ? "rgba(16,185,129,0.3)" : "#374151"}` }}>
                  <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 8 }}>
                    <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
                      <span style={{ fontSize: 20 }}>{s.icon}</span>
                      <span style={{ fontSize: 14, fontWeight: 700, fontFamily: MONO, color: "#F9FAFB" }}>{s.name}</span>
                    </div>
                    <span style={{ fontSize: 14, fontWeight: 800, fontFamily: MONO, color }}>{covered.length}/{needed.length}</span>
                  </div>
                  <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                    {needed.map(fId => {
                      const f = PL_FEATURES.find(ff => ff.id === fId);
                      const has = selIds.has(fId);
                      return f ? (
                        <span key={fId} style={{ fontSize: 10, padding: "3px 8px", borderRadius: 6, background: has ? "rgba(16,185,129,0.12)" : "rgba(239,68,68,0.1)", color: has ? "#10B981" : "#EF4444", fontFamily: MONO, fontWeight: 600, border: `1px solid ${has ? "rgba(16,185,129,0.3)" : "rgba(239,68,68,0.2)"}` }}>
                          {has ? "âœ“" : "âœ—"} {f.name}
                        </span>
                      ) : null;
                    })}
                  </div>
                </div>
              );
            })}
          </div>

          <div style={{ marginTop: 24, textAlign: "center" }}>
            <button className="story-nav-btn" onClick={() => goToPage(12)} style={{ fontSize: 14, padding: "10px 24px" }}>
              â† Revise Features
            </button>
          </div>

          <DiscussionPrompt>Any scenarios with red coverage? Is that acceptable, or do you need to revise your feature picks?</DiscussionPrompt>
          <InstructorNote>~5 min. If coverage is poor, encourage them to go back. The "Revise" button takes them to page 12.</InstructorNote>
        </div>
      );
    }

    /* Page 16 â€” Converge */
    function StoryConverge({ selectedFeatures, votes, customPainPoints, visionStatement, setVisionStatement, notBuilding, setNotBuilding, newNotBuilding, setNewNotBuilding, prdNotes, setPrdNotes }) {
      const selFeats = PL_FEATURES.filter(f => selectedFeatures.includes(f.id));
      const totalCost = selFeats.reduce((sum, f) => sum + f.cost, 0);
      const reqSet = new Set();
      selFeats.forEach(f => (f.requires || []).forEach(r => reqSet.add(r)));
      const activeSynergies = PL_SYNERGIES.filter(s => s.features.every(fId => selectedFeatures.includes(fId)));
      const scenarioCoverage = PL_SCENARIOS.map(s => {
        const covered = s.featureIds.filter(fId => selectedFeatures.includes(fId)).length;
        return { name: s.name, covered, total: s.featureIds.length };
      });

      return (
        <div className="story-page" style={{ paddingBottom: 100, maxWidth: 900 }}>
          <SectionLabel label="CONVERGE" />
          <h2>"What You're Building"</h2>
          <NarrativeIntro>Time to crystallize. Write your vision, confirm what you're NOT building, and review the summary.</NarrativeIntro>

          <div style={{ width: "100%", marginBottom: 24 }}>
            <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: "#6B7280", marginBottom: 10, fontFamily: MONO }}>Product Vision</div>
            <textarea value={visionStatement} onChange={e => setVisionStatement(e.target.value)} placeholder="A digital companion for the FCM case cycle that transforms passive preparation into active clinical reasoning practice..." style={{ width: "100%", minHeight: 80, padding: 14, fontSize: 13, fontFamily: SANS, border: "1px solid #374151", borderRadius: 8, background: "#1F2937", color: "#F9FAFB", outline: "none", resize: "vertical", lineHeight: 1.6, boxSizing: "border-box" }} />
          </div>

          <div style={{ width: "100%", marginBottom: 24 }}>
            <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: "#6B7280", marginBottom: 10, fontFamily: MONO }}>What We're NOT Building</div>
            <p style={{ fontSize: 12, color: "#6B7280", margin: "0 0 10px" }}>Scope boundaries. Saying "no" to good ideas keeps your product focused.</p>
            {notBuilding.map((item, idx) => (
              <div key={idx} style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 6 }}>
                <span style={{ fontSize: 12, lineHeight: 1.5, flex: 1, color: "#D1D5DB" }}>â€¢ {item}</span>
                <button onClick={() => setNotBuilding(prev => prev.filter((_, i) => i !== idx))} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 12, color: "#6B7280", padding: "2px 6px" }}>Ã—</button>
              </div>
            ))}
            <div style={{ display: "flex", gap: 6, marginTop: 10 }}>
              <input type="text" value={newNotBuilding} onChange={e => setNewNotBuilding(e.target.value)} onKeyDown={e => { if (e.key === "Enter" && newNotBuilding.trim()) { setNotBuilding(prev => [...prev, newNotBuilding.trim()]); setNewNotBuilding(""); } }} placeholder="Add scope exclusion..." style={{ flex: 1, padding: "6px 10px", fontSize: 12, fontFamily: MONO, border: "1px solid #374151", borderRadius: 6, background: "#1F2937", color: "#F9FAFB", outline: "none" }} />
            </div>
          </div>

          <div style={{ width: "100%", background: "#1F2937", borderRadius: 12, padding: 20, border: "1px solid #374151", marginBottom: 24 }}>
            <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: "#6B7280", marginBottom: 16, fontFamily: MONO }}>Summary</div>
            <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(140px, 1fr))", gap: 16 }}>
              <div style={{ textAlign: "center" }}>
                <div style={{ fontSize: 24, fontWeight: 800, fontFamily: MONO, color: "#10B981" }}>{selFeats.length}</div>
                <div style={{ fontSize: 10, color: "#6B7280", textTransform: "uppercase", fontFamily: MONO }}>features</div>
              </div>
              <div style={{ textAlign: "center" }}>
                <div style={{ fontSize: 24, fontWeight: 800, fontFamily: MONO, color: totalCost > PL_BUDGET ? "#EF4444" : "#10B981" }}>{totalCost}/{PL_BUDGET}</div>
                <div style={{ fontSize: 10, color: "#6B7280", textTransform: "uppercase", fontFamily: MONO }}>build pts</div>
              </div>
              <div style={{ textAlign: "center" }}>
                <div style={{ fontSize: 24, fontWeight: 800, fontFamily: MONO, color: "#10B981" }}>{activeSynergies.length}/{PL_SYNERGIES.length}</div>
                <div style={{ fontSize: 10, color: "#6B7280", textTransform: "uppercase", fontFamily: MONO }}>loops</div>
              </div>
              <div style={{ textAlign: "center" }}>
                <div style={{ fontSize: 24, fontWeight: 800, fontFamily: MONO, color: "#10B981" }}>{reqSet.size}</div>
                <div style={{ fontSize: 10, color: "#6B7280", textTransform: "uppercase", fontFamily: MONO }}>tech reqs</div>
              </div>
            </div>
            <div style={{ marginTop: 16 }}>
              <div style={{ fontSize: 10, fontWeight: 700, color: "#6B7280", marginBottom: 6, fontFamily: MONO }}>SCENARIO COVERAGE</div>
              {scenarioCoverage.map(sc => (
                <div key={sc.name} style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 4 }}>
                  <span style={{ fontSize: 11, color: "#9CA3AF", flex: 1, fontFamily: MONO }}>{sc.name}</span>
                  <span style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: sc.covered === sc.total ? "#10B981" : sc.covered > 0 ? "#F59E0B" : "#EF4444" }}>{sc.covered}/{sc.total}</span>
                </div>
              ))}
            </div>
            <div style={{ marginTop: 16 }}>
              <div style={{ fontSize: 10, fontWeight: 700, color: "#6B7280", marginBottom: 6, fontFamily: MONO }}>TECH STACK</div>
              <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                {[...reqSet].map(rId => {
                  const req = PL_TECH_REQS[rId];
                  return req ? <span key={rId} style={{ fontSize: 10, padding: "3px 8px", borderRadius: 6, background: "#374151", color: "#D1D5DB", fontFamily: MONO }}>{req.icon} {req.label}</span> : null;
                })}
              </div>
            </div>
          </div>

          <div style={{ width: "100%", marginBottom: 24 }}>
            <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: "#6B7280", marginBottom: 10, fontFamily: MONO }}>Additional Notes</div>
            <textarea value={prdNotes} onChange={e => setPrdNotes(e.target.value)} placeholder="Anything else the PRD should capture?" style={{ width: "100%", minHeight: 60, padding: 14, fontSize: 13, fontFamily: SANS, border: "1px solid #374151", borderRadius: 8, background: "#1F2937", color: "#F9FAFB", outline: "none", resize: "vertical", lineHeight: 1.6, boxSizing: "border-box" }} />
          </div>

          <DiscussionPrompt>Read the vision aloud. Does it capture what you're building? Does the "not building" list protect your scope?</DiscussionPrompt>
          <InstructorNote>~5 min. Have one student read the vision. Others validate or refine. This is the final convergence.</InstructorNote>
        </div>
      );
    }

    /* Page 17 â€” Ship It (PRD) */
    function StoryShipIt({ prdMarkdown }) {
      const [showRaw, setShowRaw] = useState(false);
      const [copied, setCopied] = useState(false);

      const handleCopy = () => {
        navigator.clipboard.writeText(prdMarkdown).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); });
      };
      const handleDownload = () => {
        const blob = new Blob([prdMarkdown], { type: "text/markdown" });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `fcm-prd-${new Date().toISOString().slice(0,10)}.md`; a.click();
      };

      return (
        <div className="story-page" style={{ paddingBottom: 100, maxWidth: 900 }}>
          <SectionLabel label="SHIP" />
          <h2>"Your PRD"</h2>
          <NarrativeIntro>Everything you decided â€” assembled into a Product Requirements Document. Copy it, download it, and use it to build.</NarrativeIntro>

          <div style={{ display: "flex", gap: 12, marginBottom: 20, flexWrap: "wrap", justifyContent: "center" }}>
            <button onClick={handleCopy} className="story-nav-btn primary" style={{ fontSize: 13 }}>{copied ? "Copied!" : "Copy to Clipboard"}</button>
            <button onClick={handleDownload} className="story-nav-btn" style={{ fontSize: 13 }}>Download .md</button>
            <button onClick={() => setShowRaw(!showRaw)} className="story-nav-btn" style={{ fontSize: 13 }}>{showRaw ? "Formatted View" : "Raw Markdown"}</button>
          </div>

          <div style={{ width: "100%" }}>
            {showRaw ? (
              <div style={{ padding: 20, background: "#0A0A0A", borderRadius: 8, fontFamily: MONO, fontSize: 11, color: "#e0e0e0", lineHeight: 1.7, whiteSpace: "pre-wrap", overflow: "auto", maxHeight: 500, border: "1px solid #374151" }}>
                {prdMarkdown}
              </div>
            ) : (
              <div className="story-prd-box">
                <div className="rendered-prd" dangerouslySetInnerHTML={{ __html: renderMarkdownToHtml(prdMarkdown) }} />
              </div>
            )}
          </div>

          <div style={{ marginTop: 32, padding: "20px 24px", background: "rgba(16,185,129,0.06)", borderRadius: 12, border: "1px solid rgba(16,185,129,0.2)", width: "100%", textAlign: "center" }}>
            <div style={{ fontSize: 16, fontWeight: 700, fontFamily: MONO, color: "#10B981", marginBottom: 8 }}>What happens next?</div>
            <p style={{ fontSize: 13, color: "#D1D5DB", lineHeight: 1.6, margin: 0 }}>
              Paste this PRD into Claude Code or your AI coding assistant. It has everything needed to start building â€” the domain context, user research, feature decisions, and technical requirements. Your design sprint research becomes a real product.
            </p>
          </div>

          <InstructorNote>~5 min. Walk through the PRD. Celebrate the work. Copy/download for the team.</InstructorNote>
        </div>
      );
    }

    /* â”€â”€ Product Lab: Data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    const PL_EVIDENCE = {
      student: {
        label: "M1 Student", emoji: "ğŸ“",
        painPoints: [
          { id: "s1", text: "Week-long gap between submitting differential and FCM session â€” lose your thinking" },
          { id: "s2", text: "Passive observation when another student interviews â€” no way to actively participate" },
          { id: "s3", text: "No individual feedback on knowledge gaps vs strengths across cases" },
          { id: "s4", text: "Differential list feels like busywork without understanding why you're wrong" },
          { id: "s5", text: "No way to practice illness scripts between sessions" },
          { id: "s6", text: "Group discussion dominated by confident voices â€” quieter students don't get reps" },
          { id: "s7", text: "Walking into session cold â€” forgot what you were thinking a week ago" },
        ],
        wishes: [
          { id: "sw1", text: "Quick pre-session recap that reignites my thinking in 10 minutes" },
          { id: "sw2", text: "See where my reasoning diverged from the actual diagnosis path" },
          { id: "sw3", text: "Gamified confidence calibration â€” am I getting better over time?" },
          { id: "sw4", text: "Signal to instructor what I want to discuss without raising hand in group" },
          { id: "sw5", text: "Practice chief complaint exploration at my own pace" },
        ],
      },
      instructor: {
        label: "FCM Coach", emoji: "ğŸ©º",
        painPoints: [
          { id: "i1", text: "Can't see student prep quality before session â€” flying blind on who's ready" },
          { id: "i2", text: "Hard to tailor discussion to group's actual gaps vs assumed curriculum sequence" },
          { id: "i3", text: "No longitudinal view of individual student progress across cases" },
          { id: "i4", text: "Session time wasted on students who didn't prepare" },
          { id: "i5", text: "Want to focus on clinical reasoning but get pulled into logistics" },
        ],
        wishes: [
          { id: "iw1", text: "Dashboard showing student prep status + areas of confusion before I walk in" },
          { id: "iw2", text: "See aggregated 'what the group got wrong' to target my teaching" },
          { id: "iw3", text: "Quick feedback tool â€” annotate student reasoning in real-time or post-session" },
          { id: "iw4", text: "Student signals: 'I want to discuss this' flags I can see before session" },
        ],
      },
      admin: {
        label: "Curriculum Admin", emoji: "ğŸ›ï¸",
        painPoints: [
          { id: "a1", text: "No standardized data on whether FCM is meeting AAMC competency standards" },
          { id: "a2", text: "Coach quality varies enormously â€” no visibility into session consistency" },
          { id: "a3", text: "Can't identify struggling students until exam performance drops" },
          { id: "a4", text: "FCM compliance logging is manual and incomplete" },
        ],
        wishes: [
          { id: "aw1", text: "Automated competency mapping â€” which skills are each student developing?" },
          { id: "aw2", text: "Early warning system for students falling behind" },
          { id: "aw3", text: "Aggregate analytics across all FCM sections for curriculum improvement" },
        ],
      },
    };

    const PL_FCM_STEPS = [
      { id: "assign", label: "Case\nAssigned", icon: "ğŸ“‹", short: "Assign" },
      { id: "prep", label: "Pre-Session\nPrep", icon: "ğŸ“", short: "Prep" },
      { id: "gap", label: "The Gap", icon: "â³", short: "Gap", isGap: true },
      { id: "walk", label: "Walk to\nFCM", icon: "ğŸš¶", short: "Walk" },
      { id: "session", label: "Small Group\nSession", icon: "ğŸ‘¥", short: "Session" },
      { id: "encounter", label: "Patient\nEncounter", icon: "ğŸ©º", short: "Encounter" },
      { id: "feedback", label: "Coach\nFeedback", icon: "ğŸ’¬", short: "Feedback" },
      { id: "note", label: "Write\nthe Note", icon: "âœï¸", short: "Note" },
      { id: "fade", label: "The Fade", icon: "ğŸ’¨", short: "Fade", isGap: true },
    ];

    const PL_FEATURES = [
      { id: "gap-refresh", name: "Gamified Case Refresh", icon: "ğŸ®", description: "10-15 min mobile experience before FCM. Quick-fire differential review, confidence check, 'here's what to listen for.'", cost: 2, requires: ["mobile-ui", "case-content"], stakeholders: ["student"], affectsSteps: ["walk", "gap"], engagement: "burst", studentOutcome: "Arrive at session with case fresh in mind", addressesEvidence: ["s7", "s1", "sw1"] },
      { id: "reasoning-capture", name: "Reasoning Capture", icon: "ğŸ§ ", description: "Replace VINDICATE worksheet. Capture WHY students think each diagnosis â€” structured reasoning prompts, not checkboxes.", cost: 3, requires: ["database", "case-content"], stakeholders: ["student", "instructor"], affectsSteps: ["prep", "session"], engagement: "task", studentOutcome: "Build deeper reasoning habits; coach sees thinking quality", instructorSupport: "See each student's reasoning chain before session â€” target teaching to actual gaps", addressesEvidence: ["s4", "sw2", "i1", "iw2"] },
      { id: "confidence-cal", name: "Confidence Calibration", icon: "ğŸ¯", description: "Rank differentials by likelihood + confidence. After session, see how calibrated you were. Track improvement over time.", cost: 2, requires: ["database"], stakeholders: ["student"], affectsSteps: ["prep", "feedback"], engagement: "burst", studentOutcome: "Develop metacognition â€” know what you don't know", addressesEvidence: ["s3", "sw3"] },
      { id: "student-signal", name: "Student â†’ Instructor Signal", icon: "ğŸ“¡", description: "Before session: flag confusion areas, discussion topics. Instructor sees aggregate + individual. Quiet students get a voice.", cost: 3, requires: ["database", "auth", "instructor-view"], stakeholders: ["student", "instructor"], affectsSteps: ["prep", "session"], engagement: "task", studentOutcome: "Get help on YOUR questions, not just the curriculum", instructorSupport: "See aggregate confusion areas + individual flags before walking in", addressesEvidence: ["s6", "sw4", "i2", "iw4"] },
      { id: "instructor-dashboard", name: "Instructor Prep Dashboard", icon: "ğŸ‘ï¸", description: "Pre-session view: who prepared, common errors, areas of confusion. Target teaching to actual gaps.", cost: 3, requires: ["database", "auth", "instructor-view"], stakeholders: ["instructor"], affectsSteps: ["session"], engagement: "none", studentOutcome: "Better teaching targeted to your actual gaps", instructorSupport: "Dashboard: who prepared, common errors, confusion areas, individual student goals", addressesEvidence: ["i1", "i4", "iw1"] },
      { id: "ai-patient", name: "AI Patient Encounter", icon: "ğŸ¤–", description: "Voice/chat AI standardized patient. Unlimited history-taking practice. Real-time differential adjustment feedback.", cost: 4, requires: ["ai-llm", "case-content", "mobile-ui"], stakeholders: ["student"], affectsSteps: ["prep", "gap"], engagement: "sustained", studentOutcome: "Unlimited practice reps â€” fail safely before the real encounter", realityWarning: "Requires students to engage between sessions. High value but low adoption risk.", addressesEvidence: ["s2", "s5", "sw5"] },
      { id: "progress-tracker", name: "Longitudinal Progress Tracker", icon: "ğŸ“ˆ", description: "Track reasoning quality across cases over a semester. Growth patterns, persistent gaps. Student + coach view.", cost: 3, requires: ["database", "auth", "analytics"], stakeholders: ["student", "instructor", "admin"], affectsSteps: ["feedback", "fade"], engagement: "passive", studentOutcome: "See your growth over time â€” motivation through visible progress", instructorSupport: "Track student development across cases, spot persistent blind spots", adminConstraint: "Feeds AAMC competency tracking", addressesEvidence: ["s3", "i3", "a3", "aw1"] },
      { id: "spaced-review", name: "Spaced Repetition Review", icon: "ğŸ”", description: "Post-session review cards. 'What would you do differently?' Builds cumulative knowledge case-over-case.", cost: 2, requires: ["database", "case-content"], stakeholders: ["student"], affectsSteps: ["fade", "gap"], engagement: "sustained", studentOutcome: "Actually retain what you learned â€” fight the fade", realityWarning: "Requires between-session engagement. Works best with push notifications + tiny interactions.", addressesEvidence: ["s1", "sw1"] },
      { id: "compliance-dash", name: "Compliance & Analytics", icon: "ğŸ›ï¸", description: "Admin dashboard: AAMC competency mapping, session quality metrics, coach consistency, early warning for struggling students.", cost: 2, requires: ["database", "auth", "admin-view", "analytics"], stakeholders: ["admin"], affectsSteps: ["fade"], engagement: "none", studentOutcome: "Program quality improves over time", adminConstraint: "AAMC/LCME competency mapping, coach quality consistency", addressesEvidence: ["a1", "a2", "aw2", "aw3"] },
      { id: "peer-compare", name: "Anonymous Peer Comparison", icon: "ğŸ‘¥", description: "See how your differential compares to anonymized group. 'Most students identified PE â€” you focused on anxiety.'", cost: 1, requires: ["database"], stakeholders: ["student"], affectsSteps: ["session", "feedback"], engagement: "passive", studentOutcome: "Calibrate against peers â€” am I the only one who missed this?", addressesEvidence: ["s6", "sw3"] },
    ];

    const PL_TECH_REQS = {
      "database": { label: "Database", icon: "ğŸ—„ï¸", description: "Persistent storage â€” Supabase or similar. User data, case content, reasoning logs." },
      "auth": { label: "User Auth", icon: "ğŸ”", description: "Login system with roles (student/instructor/admin). UVA SSO or email." },
      "mobile-ui": { label: "Mobile-First UI", icon: "ğŸ“±", description: "Touch-optimized, works on phone screens. PWA or responsive web." },
      "case-content": { label: "Case Content", icon: "ğŸ“š", description: "Structured clinical cases â€” chief complaints, differentials, findings. Need content pipeline." },
      "ai-llm": { label: "AI / LLM", icon: "ğŸ¤–", description: "Anthropic API for AI patient simulation, reasoning feedback. Usage costs." },
      "instructor-view": { label: "Instructor View", icon: "ğŸ‘ï¸", description: "Separate interface for coaches. Role-based access. Dashboard design." },
      "admin-view": { label: "Admin Portal", icon: "ğŸ›ï¸", description: "Curriculum-level analytics and compliance reporting." },
      "analytics": { label: "Analytics Engine", icon: "ğŸ“Š", description: "Aggregation, trends, cohort comparison. Charts and reports." },
    };

    const PL_SYNERGIES = [
      { id: "reasoning-loop", name: "The Reasoning Loop", icon: "ğŸ”„", description: "Student reasoning â†’ coach visibility â†’ targeted feedback. The core two-sided value.", features: ["reasoning-capture", "student-signal", "instructor-dashboard"] },
      { id: "engagement-loop", name: "The Engagement Loop", icon: "ğŸ”¥", description: "Keep the case alive before and after sessions. Fight the fade.", features: ["gap-refresh", "spaced-review"] },
      { id: "growth-loop", name: "The Growth Loop", icon: "ğŸ“ˆ", description: "Track metacognition and development over time. Make learning visible.", features: ["confidence-cal", "progress-tracker"] },
    ];

    const PL_SCENARIOS = [
      { id: "tuesday-night", name: "Tuesday Night â€” Deep Exploration", scene: "It's 9pm Tuesday. You just got a new chief complaint. You have 45 minutes before switching to studying anatomy.", device: "Desktop", timing: "Steps 1-2 (Case Assignment â†’ Build Differential)", steps: "1-2", featureIds: ["reasoning-capture", "confidence-cal", "ai-patient"], momentLink: "1", icon: "ğŸ–¥ï¸" },
      { id: "walking-to-fcm", name: "Walking to FCM â€” Quick Refresh", scene: "Monday 1:45pm. FCM starts in 15 minutes. You haven't thought about this case since Tuesday. You're walking across Grounds.", device: "Mobile", timing: "Bridging The Gap", steps: "gap1", featureIds: ["gap-refresh", "spaced-review"], momentLink: "gap1", icon: "ğŸ“±" },
      { id: "in-the-room", name: "In the Room â€” Active Session", scene: "You're in the FCM room. The coach is facilitating discussion. You want to contribute but don't want to look unprepared.", device: "Mobile/Tablet", timing: "Step 3 (Small Group Session)", steps: "3", featureIds: ["student-signal", "peer-compare"], momentLink: "3", icon: "ğŸ“±" },
      { id: "coach-prep", name: "Coach Prep â€” Instructor Dashboard", scene: "Dr. Martinez has 6 students in 2 hours. She wants to know who prepared and where common misconceptions are.", device: "Desktop", timing: "Parallel to Steps 1-2", steps: "1-2", featureIds: ["instructor-dashboard", "reasoning-capture"], momentLink: "2", icon: "ğŸ–¥ï¸" },
      { id: "practice-presenting", name: "Practice Presenting â€” Rehearsal", scene: "Farah wants to practice presenting a case in SOAP format before next week's FCM. She's alone in her apartment.", device: "Desktop/Mobile", timing: "Steps 2â†’3 (Prep â†’ Session bridge)", steps: "2-3", featureIds: ["ai-patient", "confidence-cal"], momentLink: "2", icon: "ğŸ™ï¸" },
    ];

    const PL_BUDGET = 10;

    const PL_ARCHETYPES = [
      {
        id: "ai-tutor",
        name: "The AI Tutor",
        quadrant: { xMin: 0, xMax: 0.5, yMin: 0, yMax: 0.5 },
        tagline: "Your personal clinical reasoning coach",
        description: "Deep, AI-powered practice encounters. Simulate patient interviews, get real-time feedback on your reasoning, explore cases at your own pace with unlimited reps.",
        bestFor: "Building clinical reasoning skills through deliberate practice with AI feedback",
        tradeoff: "Expensive to build (needs AI/LLM). Solo experience. Quality depends on case content.",
        color: "#7C3AED",
        bgLight: "#F5F3FF", bgDark: "#1a1a2e",
        referenceApps: [
          { name: "ChatGPT", icon: "ğŸ¤–", trait: "Conversational AI", patterns: [
            { name: "Conversation as Interface", desc: "No buttons or forms â€” just talk. The AI adapts to your level." },
            { name: "Infinite Depth", desc: "Keep asking follow-ups. No preset limit on exploration." },
            { name: "Context Memory", desc: "AI remembers what you said earlier in the session." },
          ]},
          { name: "Amboss", icon: "ğŸ“š", trait: "Clinical depth", patterns: [
            { name: "Knowledge Cards", desc: "Dense, linkable reference cards with clinical pearls." },
            { name: "Highlight & Learn", desc: "Click any term to get a pop-up explanation." },
            { name: "Spaced Repetition Q&A", desc: "Built-in question bank with SRS scheduling." },
          ]},
          { name: "Khan Academy", icon: "ğŸ“", trait: "Guided learning", patterns: [
            { name: "Mastery-Based Progression", desc: "Can't move forward until you demonstrate understanding." },
            { name: "Video + Practice Loop", desc: "Watch, then immediately apply what you learned." },
            { name: "Skill Tree", desc: "Visual map of all topics and your progress through them." },
          ]},
        ],
      },
      {
        id: "two-sided-bridge",
        name: "The Two-Sided Bridge",
        quadrant: { xMin: 0.5, xMax: 1, yMin: 0, yMax: 0.5 },
        tagline: "Student signals up, instructor feedback down",
        description: "A teaching platform that creates a feedback loop. Students share their prep and reasoning; instructors see where the class is before walking in. Both sides get more from every session.",
        bestFor: "Fixing the instructor-student information gap â€” coaches fly blind, students can't signal confusion",
        tradeoff: "Requires adoption from both sides. If instructors don't check it, the loop breaks.",
        color: "#10B981",
        bgLight: "#F0FDF4", bgDark: "#0a2a1a",
        referenceApps: [
          { name: "Piazza", icon: "ğŸ’¬", trait: "Q&A + instructor visibility", patterns: [
            { name: "Anonymous Posting", desc: "Students ask freely without social risk. Instructor sees identity." },
            { name: "Instructor Endorsement", desc: "Best answers get an official stamp. Quality signal." },
            { name: "Follow-Up Threads", desc: "Questions evolve through discussion. Peers refine each other's thinking." },
          ]},
          { name: "Slack", icon: "ğŸ’¡", trait: "Async communication", patterns: [
            { name: "Channels by Topic", desc: "Organize by case, session, or theme. Find what you need." },
            { name: "Reactions & Emoji", desc: "Quick, low-friction engagement. 'I have this question too.'" },
            { name: "Search Everything", desc: "Past conversations become a searchable knowledge base." },
          ]},
          { name: "Canvas", icon: "ğŸ“‹", trait: "Course integration", patterns: [
            { name: "Assignment Pipeline", desc: "Submit â†’ Review â†’ Grade â†’ Feedback. Clear lifecycle." },
            { name: "Gradebook as Dashboard", desc: "One view of all progress. Student and instructor both see it." },
            { name: "Modules & Sequencing", desc: "Content unlocks in order. Structured learning path." },
          ]},
        ],
      },
      {
        id: "practice-coach",
        name: "The Practice Coach",
        quadrant: { xMin: 0, xMax: 0.5, yMin: 0.5, yMax: 1 },
        tagline: "Gamified daily reps that fit in your pocket",
        description: "Like a language learning app for clinical reasoning. Bite-sized practice sessions, spaced repetition, streaks, and instant feedback. The app you open for 5-10 minutes on the walk to class.",
        bestFor: "Solving 'The Gap' and 'The Fade' â€” keeping cases alive between sessions",
        tradeoff: "Solo experience. Doesn't connect students to instructors or create teaching insights.",
        color: "#F59E0B",
        bgLight: "#FFF7ED", bgDark: "#1a2332",
        referenceApps: [
          { name: "Duolingo", icon: "ğŸ¦‰", trait: "Gamified daily practice", patterns: [
            { name: "Daily Streak", desc: "Miss a day, lose your streak. Most powerful retention mechanic in consumer apps." },
            { name: "5-Minute Sessions", desc: "Everything fits in 5 minutes. No guilt, no commitment barrier." },
            { name: "XP & Levels", desc: "Points for every action. Visible progression. Unlockable content." },
            { name: "Push Notification Nudge", desc: "The sad owl. 'You haven't practiced today.' Shame-driven retention." },
          ]},
          { name: "Anki", icon: "ğŸ“‡", trait: "Spaced repetition", patterns: [
            { name: "Spaced Repetition Algorithm", desc: "Show cards just before you'd forget them. Optimized memory." },
            { name: "Self-Rated Confidence", desc: "'Easy / Good / Hard / Again.' You rate your own recall." },
            { name: "User-Created Content", desc: "Students make their own flashcards. Creation = learning." },
          ]},
          { name: "Quizlet", icon: "ğŸƒ", trait: "Quick-fire review", patterns: [
            { name: "Multiple Study Modes", desc: "Same content, different interactions: flashcards, matching, test mode." },
            { name: "Social Decks", desc: "Share and discover study sets from other students." },
            { name: "Timed Challenges", desc: "Race the clock. Gamified pressure without high stakes." },
          ]},
        ],
      },
      {
        id: "growth-tracker",
        name: "The Growth Tracker",
        quadrant: { xMin: 0.5, xMax: 1, yMin: 0.5, yMax: 1 },
        tagline: "Make learning visible â€” to yourself and your peers",
        description: "Quick check-ins with social context. See how your reasoning compares to anonymized peers. Track your calibration and growth over a semester. Light daily engagement with longitudinal value.",
        bestFor: "Metacognition and motivation â€” students don't know if they're improving",
        tradeoff: "Lightweight interactions may not build deep clinical reasoning skills directly.",
        color: "#EF4444",
        bgLight: "#FEF2F2", bgDark: "#2a1a1a",
        referenceApps: [
          { name: "Strava", icon: "ğŸƒ", trait: "Personal + peer tracking", patterns: [
            { name: "Activity Feed", desc: "See what everyone's doing. Social accountability without direct competition." },
            { name: "Personal Records", desc: "'Your best calibration score ever!' Compete with yourself." },
            { name: "Segment Leaderboards", desc: "Compete on specific activities. 'Top differential builder this week.'" },
            { name: "Kudos", desc: "One-tap encouragement. Low-friction social engagement." },
          ]},
          { name: "Kahoot", icon: "ğŸ¯", trait: "Competitive engagement", patterns: [
            { name: "Live Quiz Mode", desc: "Everyone answers at once. Real-time leaderboard. Energy in the room." },
            { name: "Time Pressure", desc: "Faster = more points. Creates urgency and excitement." },
            { name: "Group Play", desc: "Designed for classrooms. The social experience IS the product." },
          ]},
          { name: "Wordle", icon: "ğŸŸ©", trait: "Daily habit, social sharing", patterns: [
            { name: "One Puzzle Per Day", desc: "Scarcity creates habit. Everyone does the same one. Shared experience." },
            { name: "Shareable Results", desc: "Post your colored grid. No spoilers. Social proof of participation." },
            { name: "30-Second Commitment", desc: "So fast there's no reason NOT to do it. Zero friction." },
          ]},
        ],
      },
    ];

    /* â”€â”€ Product Lab: Components â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

    function PLVoteItem({ item, active, onClick, isWish, custom, selectedFeatureIds }) {
      const theme = useTheme();
      const isDark = theme.offWhite === "#1A1A1A";
      const activeBg = isWish ? theme.blueLight : (isDark ? "#78350F" : "#FFF7ED");
      const activeBorder = isWish ? theme.blue : "#EA580C";
      const coveringFeatures = (selectedFeatureIds || []).map(fId => PL_FEATURES.find(f => f.id === fId)).filter(f => f && (f.addressesEvidence || []).includes(item.id));
      return (
        <button onClick={onClick} style={{ display: "flex", alignItems: "flex-start", gap: 8, width: "100%", padding: "8px 10px", marginBottom: 6, fontSize: 12, fontFamily: SANS, lineHeight: 1.5, textAlign: "left", background: active ? activeBg : theme.offWhite, border: `1px solid ${active ? activeBorder : theme.lightGray}`, borderRadius: 6, cursor: "pointer", color: theme.black, transition: "all 0.15s" }}>
          <span style={{ fontSize: 14, flexShrink: 0, marginTop: -1 }}>{active ? (isWish ? "â­" : "ğŸ”¥") : "â—‹"}</span>
          <span>
            {custom && <span style={{ fontSize: 10, color: theme.blue, fontWeight: 600 }}>ADDED </span>}
            {item.text}
            {coveringFeatures.length > 0 && (
              <span style={{ display: "inline-flex", gap: 3, marginLeft: 6 }}>
                {coveringFeatures.map(f => (
                  <span key={f.id} style={{ fontSize: 8, padding: "1px 5px", borderRadius: 3, background: theme.emeraldLight, color: theme.emerald, fontFamily: MONO, fontWeight: 600, whiteSpace: "nowrap" }} title={f.name}>â†’ {f.icon} {f.name.split(" ")[0]}</span>
                ))}
              </span>
            )}
          </span>
        </button>
      );
    }

    function PLStakeholderColumn({ sKey, data, customPoints, newPoint, setNewPoint, votes, toggleVote, addPoint, setCustomPoints, sc, selectedFeatureIds }) {
      const theme = useTheme();
      return (
        <div style={{ background: theme.white, border: `1px solid ${theme.lightGray}`, borderRadius: 10, overflow: "hidden" }}>
          <div style={{ background: sc.bg, padding: "14px 16px", borderBottom: `1px solid ${theme.lightGray}` }}>
            <div style={{ fontSize: 18, marginBottom: 2 }}>{data.emoji}</div>
            <div style={{ fontSize: 14, fontWeight: 700, color: sc.color, fontFamily: MONO }}>{data.label}</div>
          </div>
          <div style={{ padding: 16 }}>
            <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 10, fontFamily: MONO }}>Pain Points</div>
            {data.painPoints.map(item => (
              <PLVoteItem key={item.id} item={item} active={!!votes[item.id]} onClick={() => toggleVote(item.id)} selectedFeatureIds={selectedFeatureIds} />
            ))}
            {customPoints.map(item => (
              <PLVoteItem key={item.id} item={item} active={!!votes[item.id]} onClick={() => toggleVote(item.id)} custom selectedFeatureIds={selectedFeatureIds} />
            ))}
            <div style={{ display: "flex", gap: 6, marginTop: 8, marginBottom: 16 }}>
              <input type="text" value={newPoint} onChange={e => setNewPoint(e.target.value)} onKeyDown={e => e.key === "Enter" && addPoint()} placeholder="Add pain point..." style={{ flex: 1, padding: "6px 10px", fontSize: 12, fontFamily: MONO, border: `1px solid ${theme.lightGray}`, borderRadius: 6, background: theme.offWhite, color: theme.black, outline: "none" }} />
              <button onClick={addPoint} style={{ padding: "6px 12px", fontSize: 12, fontFamily: MONO, fontWeight: 700, background: theme.black, color: theme.white, border: "none", borderRadius: 6, cursor: "pointer" }}>+</button>
            </div>
            <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 10, fontFamily: MONO }}>Wishes</div>
            {data.wishes.map(item => (
              <PLVoteItem key={item.id} item={item} active={!!votes[item.id]} onClick={() => toggleVote(item.id)} isWish selectedFeatureIds={selectedFeatureIds} />
            ))}
          </div>
        </div>
      );
    }

    function PLEvidenceWall({ votes, toggleVote, customPainPoints, setCustomPainPoints, newPainPoint, setNewPainPoint, addPainPoint, stColors, selectedFeatureIds }) {
      const theme = useTheme();
      return (
        <div>
          <p style={{ fontSize: 13, color: theme.medGray, lineHeight: 1.6, margin: "0 0 20px 0" }}>
            Everything your team has surfaced across two days of journey mapping, brainstorming, and building.{" "}
            <strong style={{ color: theme.black }}>Click items to prioritize them</strong> â€” your votes flow directly into the PRD.
          </p>
          <div className="pl-evidence-grid" style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(300px, 1fr))", gap: 16 }}>
            {Object.entries(PL_EVIDENCE).map(([key, data]) => (
              <PLStakeholderColumn key={key} sKey={key} data={data} customPoints={customPainPoints[key]} newPoint={newPainPoint[key]} setNewPoint={val => setNewPainPoint(prev => ({ ...prev, [key]: val }))} votes={votes} toggleVote={toggleVote} addPoint={() => addPainPoint(key)} setCustomPoints={pts => setCustomPainPoints(prev => ({ ...prev, [key]: pts }))} sc={stColors[key]} selectedFeatureIds={selectedFeatureIds} />
            ))}
          </div>
        </div>
      );
    }

    function PLProductDNA({ dnaPosition, setDnaPosition, confirmedArchetype, setConfirmedArchetype }) {
      const theme = useTheme();
      const isDark = theme.offWhite === "#1A1A1A";
      const mapRef = useRef(null);
      const [dragging, setDragging] = useState(false);

      const updatePosition = useCallback((clientX, clientY) => {
        if (!mapRef.current) return;
        const rect = mapRef.current.getBoundingClientRect();
        const x = Math.max(0.02, Math.min(0.98, (clientX - rect.left) / rect.width));
        const y = Math.max(0.02, Math.min(0.98, (clientY - rect.top) / rect.height));
        setDnaPosition({ x, y });
      }, [setDnaPosition]);

      const handleMouseDown = (e) => { e.preventDefault(); setDragging(true); updatePosition(e.clientX, e.clientY); };
      const handleTouchStart = (e) => { setDragging(true); updatePosition(e.touches[0].clientX, e.touches[0].clientY); };

      useEffect(() => {
        if (!dragging) return;
        const onMove = (e) => { e.preventDefault(); const pt = e.touches ? e.touches[0] : e; updatePosition(pt.clientX, pt.clientY); };
        const onUp = () => setDragging(false);
        window.addEventListener("mousemove", onMove);
        window.addEventListener("mouseup", onUp);
        window.addEventListener("touchmove", onMove, { passive: false });
        window.addEventListener("touchend", onUp);
        return () => { window.removeEventListener("mousemove", onMove); window.removeEventListener("mouseup", onUp); window.removeEventListener("touchmove", onMove); window.removeEventListener("touchend", onUp); };
      }, [dragging, updatePosition]);

      const activeArchetype = PL_ARCHETYPES.find(a =>
        dnaPosition.x >= a.quadrant.xMin && dnaPosition.x < a.quadrant.xMax &&
        dnaPosition.y >= a.quadrant.yMin && dnaPosition.y < a.quadrant.yMax
      ) || PL_ARCHETYPES[0];

      return (
        <div>
          <p style={{ fontSize: 13, color: theme.medGray, lineHeight: 1.6, margin: "0 0 20px 0" }}>
            What kind of product are you building? <strong style={{ color: theme.black }}>Drag the pin</strong> on the map to explore four product archetypes.
            Each quadrant shows well-known apps that share that DNA.
            <span style={{ display: "block", marginTop: 8, fontSize: 12, color: theme.blue, lineHeight: 1.5 }}>
              Why consumer apps for medical education? Because the best learning tools steal engagement patterns from products students already love â€” then apply them to clinical reasoning. Duolingo's streak mechanics work for differentials. Strava's social accountability works for case prep.
            </span>
          </p>

          <div style={{ maxWidth: 520, margin: "0 auto 24px" }}>
            <div style={{ display: "flex", justifyContent: "center", marginBottom: 6 }}>
              <span style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: theme.medGray, letterSpacing: "0.05em" }}>DEEP ENGAGEMENT</span>
            </div>
            <div style={{ display: "flex", alignItems: "center", gap: 8 }}>
              <span style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: theme.medGray, writingMode: "vertical-rl", transform: "rotate(180deg)", letterSpacing: "0.05em" }}>SOLO PRACTICE</span>
              <div ref={mapRef} onMouseDown={handleMouseDown} onTouchStart={handleTouchStart}
                style={{ flex: 1, position: "relative", aspectRatio: "1", borderRadius: 12, overflow: "hidden", cursor: "crosshair", border: `2px solid ${theme.lightGray}`, touchAction: "none", userSelect: "none" }}>
                {PL_ARCHETYPES.map(arch => {
                  const isActive = activeArchetype.id === arch.id;
                  return (
                    <div key={arch.id} style={{
                      position: "absolute",
                      left: `${arch.quadrant.xMin * 100}%`, top: `${arch.quadrant.yMin * 100}%`,
                      width: "50%", height: "50%",
                      background: isDark ? arch.bgDark : arch.bgLight,
                      display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center",
                      padding: 10, boxSizing: "border-box",
                      outline: isActive ? `2px solid ${arch.color}` : "none", outlineOffset: -2,
                      transition: "outline 0.15s",
                    }}>
                      <div style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: isActive ? arch.color : theme.medGray, marginBottom: 8, textAlign: "center", transition: "color 0.15s" }}>{arch.name}</div>
                      <div style={{ display: "flex", gap: 4, flexWrap: "wrap", justifyContent: "center" }}>
                        {arch.referenceApps.map(app => (
                          <div key={app.name} style={{
                            display: "flex", alignItems: "center", gap: 3, padding: "2px 7px", borderRadius: 10,
                            background: isDark ? "rgba(255,255,255,0.08)" : "rgba(255,255,255,0.85)",
                            border: `1px solid ${isActive ? arch.color + "44" : theme.lightGray}`,
                            fontSize: 9, fontFamily: MONO, color: theme.black, whiteSpace: "nowrap",
                          }}>
                            <span style={{ fontSize: 11 }}>{app.icon}</span> {app.name}
                          </div>
                        ))}
                      </div>
                    </div>
                  );
                })}
                <div style={{ position: "absolute", left: "50%", top: 0, bottom: 0, width: 1, background: theme.lightGray, pointerEvents: "none", opacity: 0.6 }} />
                <div style={{ position: "absolute", top: "50%", left: 0, right: 0, height: 1, background: theme.lightGray, pointerEvents: "none", opacity: 0.6 }} />
                <div style={{
                  position: "absolute",
                  left: `${dnaPosition.x * 100}%`, top: `${dnaPosition.y * 100}%`,
                  width: 28, height: 28, borderRadius: "50%",
                  background: activeArchetype.color, border: `3px solid ${theme.white}`,
                  boxShadow: "0 2px 10px rgba(0,0,0,0.3)",
                  transform: "translate(-50%, -50%)",
                  pointerEvents: "none",
                  transition: dragging ? "none" : "left 0.15s, top 0.15s",
                  zIndex: 10,
                }} />
              </div>
              <span style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: theme.medGray, writingMode: "vertical-rl", letterSpacing: "0.05em" }}>SOCIAL LEARNING</span>
            </div>
            <div style={{ display: "flex", justifyContent: "center", marginTop: 6 }}>
              <span style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: theme.medGray, letterSpacing: "0.05em" }}>QUICK & LIGHT</span>
            </div>
          </div>

          <div style={{ background: isDark ? activeArchetype.bgDark : activeArchetype.bgLight, border: `2px solid ${activeArchetype.color}`, borderRadius: 12, padding: 20, marginBottom: 16, transition: "all 0.2s" }}>
            <div style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 8 }}>
              <div style={{ width: 8, height: 8, borderRadius: "50%", background: activeArchetype.color, flexShrink: 0 }} />
              <div style={{ fontSize: 18, fontWeight: 700, fontFamily: MONO, color: theme.black }}>{activeArchetype.name}</div>
            </div>
            <div style={{ fontSize: 13, fontStyle: "italic", color: theme.medGray, marginBottom: 12, fontFamily: SANS }}>{activeArchetype.tagline}</div>
            <div style={{ fontSize: 12, color: theme.black, lineHeight: 1.6, marginBottom: 16 }}>{activeArchetype.description}</div>
            <div style={{ display: "flex", gap: 6, flexWrap: "wrap", marginBottom: 16 }}>
              {activeArchetype.referenceApps.map(app => (
                <div key={app.name} style={{ display: "flex", alignItems: "center", gap: 6, padding: "6px 12px", borderRadius: 8, background: theme.white, border: `1px solid ${theme.lightGray}`, fontSize: 12, fontFamily: MONO }}>
                  <span style={{ fontSize: 16 }}>{app.icon}</span>
                  <div>
                    <div style={{ fontWeight: 700, color: theme.black }}>{app.name}</div>
                    <div style={{ fontSize: 10, color: theme.medGray }}>{app.trait}</div>
                  </div>
                </div>
              ))}
            </div>
            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
              <div style={{ padding: 12, borderRadius: 8, background: isDark ? "rgba(255,255,255,0.05)" : "rgba(0,0,0,0.02)" }}>
                <div style={{ fontSize: 10, fontWeight: 700, fontFamily: MONO, color: theme.emerald, marginBottom: 4 }}>BEST FOR</div>
                <div style={{ fontSize: 11, color: theme.black, lineHeight: 1.5 }}>{activeArchetype.bestFor}</div>
              </div>
              <div style={{ padding: 12, borderRadius: 8, background: isDark ? "rgba(255,255,255,0.05)" : "rgba(0,0,0,0.02)" }}>
                <div style={{ fontSize: 10, fontWeight: 700, fontFamily: MONO, color: theme.amber, marginBottom: 4 }}>TRADEOFF</div>
                <div style={{ fontSize: 11, color: theme.black, lineHeight: 1.5 }}>{activeArchetype.tradeoff}</div>
              </div>
            </div>
          </div>

          <div style={{ background: theme.white, border: `1px solid ${theme.lightGray}`, borderRadius: 10, padding: 18, marginBottom: 16 }}>
            <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 14, fontFamily: MONO }}>Design Patterns to Steal</div>
            <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
              {activeArchetype.referenceApps.map(app => (
                <div key={app.name}>
                  <div style={{ display: "flex", alignItems: "center", gap: 6, marginBottom: 8 }}>
                    <span style={{ fontSize: 16 }}>{app.icon}</span>
                    <span style={{ fontSize: 13, fontWeight: 700, fontFamily: MONO, color: theme.black }}>{app.name}</span>
                    <span style={{ fontSize: 10, color: theme.medGray }}>{app.trait}</span>
                  </div>
                  <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(200px, 1fr))", gap: 6, paddingLeft: 26 }}>
                    {(app.patterns || []).map(p => (
                      <div key={p.name} style={{ padding: "8px 10px", borderRadius: 6, background: theme.offWhite, border: `1px solid ${theme.lightGray}` }}>
                        <div style={{ fontSize: 11, fontWeight: 700, color: theme.black, fontFamily: MONO, marginBottom: 2 }}>{p.name}</div>
                        <div style={{ fontSize: 10, color: theme.medGray, lineHeight: 1.4 }}>{p.desc}</div>
                      </div>
                    ))}
                  </div>
                </div>
              ))}
            </div>
          </div>

          <button onClick={() => setConfirmedArchetype(activeArchetype.id)} style={{
            width: "100%", maxWidth: 520, display: "block", margin: "0 auto",
            padding: "14px 24px", borderRadius: 10, border: "none", fontSize: 14, fontWeight: 700, fontFamily: MONO, cursor: "pointer", transition: "all 0.15s",
            background: confirmedArchetype === activeArchetype.id ? theme.emerald : theme.black,
            color: theme.white,
          }}>
            {confirmedArchetype === activeArchetype.id ? "Locked In" : `Lock In: ${activeArchetype.name}`}
          </button>
          {confirmedArchetype && confirmedArchetype !== activeArchetype.id && (
            <div style={{ textAlign: "center", fontSize: 11, color: theme.amber, fontFamily: MONO, marginTop: 8 }}>
              Currently locked: {PL_ARCHETYPES.find(a => a.id === confirmedArchetype)?.name} â€” click to switch
            </div>
          )}
        </div>
      );
    }

    function PLFeatureCard({ feature, selected, onToggle, overBudget, selectedFeatureIds }) {
      const theme = useTheme();
      const isDark = theme.offWhite === "#1A1A1A";
      const stColors = { student: theme.emerald, instructor: isDark ? "#A78BFA" : "#7C3AED", admin: theme.red };
      // Build evidence label lookup
      const getEvidenceLabel = (id) => {
        for (const [, data] of Object.entries(PL_EVIDENCE)) {
          const pp = data.painPoints.find(p => p.id === id);
          if (pp) return pp.text.slice(0, 40) + (pp.text.length > 40 ? "..." : "");
          const w = data.wishes.find(p => p.id === id);
          if (w) return w.text.slice(0, 40) + (w.text.length > 40 ? "..." : "");
        }
        return id;
      };
      return (
        <button onClick={onToggle} style={{ display: "flex", alignItems: "flex-start", gap: 10, width: "100%", padding: "12px 14px", marginBottom: 8, textAlign: "left", fontFamily: SANS, background: selected ? (isDark ? "#374151" : "#F0FDF4") : theme.white, border: `2px solid ${selected ? theme.emerald : theme.lightGray}`, borderRadius: 8, cursor: overBudget && !selected ? "not-allowed" : "pointer", opacity: overBudget && !selected ? 0.5 : 1, transition: "all 0.15s" }}>
          <span style={{ fontSize: 22, flexShrink: 0 }}>{feature.icon}</span>
          <div style={{ flex: 1, minWidth: 0 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 4, flexWrap: "wrap" }}>
              <span style={{ fontSize: 13, fontWeight: 700, color: theme.black, fontFamily: MONO }}>{feature.name}</span>
              <span style={{ fontSize: 10, fontWeight: 700, padding: "2px 8px", borderRadius: 10, background: isDark ? "#78350F" : "#FFF7ED", color: isDark ? "#F59E0B" : "#EA580C", fontFamily: MONO }}>{feature.cost} pt{feature.cost !== 1 ? "s" : ""}</span>
            </div>
            <div style={{ fontSize: 11, color: theme.medGray, lineHeight: 1.5, marginBottom: 4 }}>{feature.description}</div>
            {feature.addressesEvidence && feature.addressesEvidence.length > 0 && (
              <div style={{ display: "flex", gap: 4, flexWrap: "wrap", marginBottom: 4 }}>
                {feature.addressesEvidence.slice(0, 3).map(eId => (
                  <span key={eId} style={{ fontSize: 8, padding: "1px 6px", borderRadius: 3, background: isDark ? "#1E3A5F" : "#EFF6FF", color: theme.blue, fontFamily: MONO }} title={getEvidenceLabel(eId)}>Addresses: {eId}</span>
                ))}
                {feature.addressesEvidence.length > 3 && <span style={{ fontSize: 8, color: theme.medGray, fontFamily: MONO }}>+{feature.addressesEvidence.length - 3}</span>}
              </div>
            )}
            {feature.studentOutcome && (
              <div style={{ fontSize: 10, color: theme.emerald, lineHeight: 1.4, marginBottom: 4 }}>
                <strong>Student outcome:</strong> {feature.studentOutcome}
              </div>
            )}
            {feature.instructorSupport && (
              <div style={{ fontSize: 10, color: isDark ? "#A78BFA" : "#7C3AED", lineHeight: 1.4, marginBottom: 4 }}>
                <strong>Supports teaching:</strong> {feature.instructorSupport}
              </div>
            )}
            {feature.realityWarning && (
              <div style={{ fontSize: 10, color: theme.amber, lineHeight: 1.4, marginBottom: 4 }}>
                <strong>Reality:</strong> {feature.realityWarning}
              </div>
            )}
            <div style={{ display: "flex", gap: 4, flexWrap: "wrap" }}>
              {feature.stakeholders.map(s => (
                <span key={s} style={{ fontSize: 9, fontWeight: 600, padding: "1px 6px", borderRadius: 3, color: stColors[s], background: s === "student" ? theme.emeraldLight : s === "instructor" ? (isDark ? "#4C1D95" : "#F5F3FF") : theme.redLight, fontFamily: MONO, textTransform: "uppercase" }}>{s}</span>
              ))}
              {feature.engagement === "sustained" && (
                <span style={{ fontSize: 9, fontWeight: 600, padding: "1px 6px", borderRadius: 3, color: theme.amber, background: isDark ? "#78350F" : "#FEF3C7", fontFamily: MONO }}>BETWEEN-SESSION</span>
              )}
            </div>
          </div>
          <span style={{ fontSize: 16, flexShrink: 0, marginTop: 2 }}>{selected ? "âœ…" : "â—‹"}</span>
        </button>
      );
    }

    function PLBudgetLens({ selectedFeatures }) {
      const theme = useTheme();
      const totalCost = selectedFeatures.reduce((sum, f) => sum + f.cost, 0);
      const overBudget = totalCost > PL_BUDGET;
      const pct = Math.min(100, (totalCost / PL_BUDGET) * 100);
      return (
        <div>
          <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 16, fontFamily: MONO }}>Budget Lens</div>
          <div style={{ background: theme.offWhite, borderRadius: 8, padding: 16, marginBottom: 16 }}>
            <div style={{ display: "flex", justifyContent: "space-between", marginBottom: 8 }}>
              <span style={{ fontSize: 28, fontWeight: 800, fontFamily: MONO, color: overBudget ? theme.red : theme.emerald }}>{totalCost}</span>
              <span style={{ fontSize: 28, fontWeight: 800, fontFamily: MONO, color: theme.medGray }}>/ {PL_BUDGET}</span>
            </div>
            <div style={{ height: 8, background: theme.lightGray, borderRadius: 4, overflow: "hidden", marginBottom: 8 }}>
              <div style={{ height: "100%", width: `${pct}%`, background: overBudget ? theme.red : pct > 80 ? theme.amber : theme.emerald, borderRadius: 4, transition: "all 0.3s" }} />
            </div>
            {overBudget && <div style={{ fontSize: 12, color: theme.red, fontWeight: 600, fontFamily: MONO }}>Over budget by {totalCost - PL_BUDGET} points! Remove features to ship.</div>}
            {!overBudget && totalCost > 0 && <div style={{ fontSize: 12, color: theme.emerald, fontFamily: MONO }}>{PL_BUDGET - totalCost} points remaining</div>}
          </div>
          {selectedFeatures.length > 0 && (
            <div>
              <div style={{ fontSize: 11, fontWeight: 700, color: theme.medGray, marginBottom: 8, fontFamily: MONO }}>COST BREAKDOWN</div>
              {[...selectedFeatures].sort((a, b) => b.cost - a.cost).map(f => (
                <div key={f.id} style={{ display: "flex", justifyContent: "space-between", alignItems: "center", padding: "6px 0", borderBottom: `1px solid ${theme.lightGray}` }}>
                  <span style={{ fontSize: 12, color: theme.black }}>{f.icon} {f.name}</span>
                  <span style={{ fontSize: 12, fontWeight: 700, fontFamily: MONO, color: theme.black }}>{f.cost} pt{f.cost !== 1 ? "s" : ""}</span>
                </div>
              ))}
            </div>
          )}
          {selectedFeatures.length === 0 && <div style={{ fontSize: 12, color: theme.medGray, fontStyle: "italic", textAlign: "center", padding: 20 }}>Select features on the left to see budget impact</div>}
        </div>
      );
    }

    function PLTechLens({ selectedFeatures }) {
      const theme = useTheme();
      const isDark = theme.offWhite === "#1A1A1A";
      const reqCounts = {};
      selectedFeatures.forEach(f => { (f.requires || []).forEach(r => { reqCounts[r] = (reqCounts[r] || 0) + 1; }); });
      const activeReqs = Object.entries(reqCounts).sort((a, b) => b[1] - a[1]);
      return (
        <div>
          <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 16, fontFamily: MONO }}>Tech Stack Lens</div>
          {activeReqs.length > 0 ? (
            <div style={{ display: "flex", flexDirection: "column", gap: 10 }}>
              {activeReqs.map(([reqId, count]) => {
                const req = PL_TECH_REQS[reqId];
                if (!req) return null;
                const featsUsing = selectedFeatures.filter(f => (f.requires || []).includes(reqId));
                return (
                  <div key={reqId} style={{ background: theme.offWhite, borderRadius: 8, padding: 14, border: `1px solid ${theme.lightGray}` }}>
                    <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 6 }}>
                      <span style={{ fontSize: 13, fontWeight: 700, fontFamily: MONO, color: theme.black }}>{req.icon} {req.label}</span>
                      <span style={{ fontSize: 10, fontWeight: 700, padding: "2px 8px", borderRadius: 10, background: count >= 3 ? theme.emeraldLight : (isDark ? "#1E3A5F" : theme.blueLight), color: count >= 3 ? theme.emerald : theme.blue, fontFamily: MONO }}>used by {count}</span>
                    </div>
                    <div style={{ fontSize: 11, color: theme.medGray, lineHeight: 1.5, marginBottom: 6 }}>{req.description}</div>
                    <div style={{ display: "flex", gap: 4, flexWrap: "wrap" }}>
                      {featsUsing.map(f => (
                        <span key={f.id} style={{ fontSize: 9, padding: "2px 6px", borderRadius: 3, background: theme.white, border: `1px solid ${theme.lightGray}`, color: theme.black, fontFamily: MONO }}>{f.icon} {f.name}</span>
                      ))}
                    </div>
                  </div>
                );
              })}
            </div>
          ) : (
            <div style={{ fontSize: 12, color: theme.medGray, fontStyle: "italic", textAlign: "center", padding: 20 }}>Select features on the left to see tech requirements</div>
          )}
        </div>
      );
    }

    function PLProductLens({ selectedFeatures }) {
      const theme = useTheme();
      const isDark = theme.offWhite === "#1A1A1A";
      const activeSynergies = PL_SYNERGIES.filter(s => s.features.filter(fId => selectedFeatures.some(f => f.id === fId)).length >= 2);
      const completeSynergies = activeSynergies.filter(s => s.features.every(fId => selectedFeatures.some(f => f.id === fId)));

      const hasInstructor = selectedFeatures.some(f => f.stakeholders.includes("instructor"));
      const hasAdmin = selectedFeatures.some(f => f.stakeholders.includes("admin"));
      const hasAI = selectedFeatures.some(f => f.requires.includes("ai-llm"));
      const studentCount = selectedFeatures.filter(f => f.stakeholders.includes("student")).length;

      let archetype = "Select features to see your product take shape";
      let archetypeDesc = "";
      if (selectedFeatures.length >= 2) {
        if (hasAI && studentCount >= 3) { archetype = "AI-Powered Learning Companion"; archetypeDesc = "A technology-forward tool that uses AI to create practice opportunities and personalized feedback at scale."; }
        else if (hasInstructor && studentCount >= 2) { archetype = "Two-Sided Teaching Platform"; archetypeDesc = "A system that creates a feedback loop between student preparation and instructor teaching. Value multiplies when both sides engage."; }
        else if (hasAdmin) { archetype = "Institutional Learning System"; archetypeDesc = "An enterprise tool with compliance tracking and institutional analytics. More complex to build, but addresses program-level needs."; }
        else if (studentCount >= 3) { archetype = "Student Practice Tool"; archetypeDesc = "A focused student-facing app for clinical reasoning practice. Simpler to build, highest adoption potential, but misses the instructor feedback loop."; }
        else { archetype = "Focused Experiment"; archetypeDesc = "A lightweight tool testing a specific hypothesis about the FCM experience."; }
      }

      return (
        <div>
          <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 16, fontFamily: MONO }}>Product Shape Lens</div>
          <div style={{ background: isDark ? "#064E3B" : "#F0FDF4", border: `1px solid ${theme.emerald}`, borderRadius: 10, padding: 18, marginBottom: 16 }}>
            <div style={{ fontSize: 16, fontWeight: 700, fontFamily: MONO, color: theme.black, marginBottom: 6 }}>{archetype}</div>
            {archetypeDesc && <div style={{ fontSize: 12, color: theme.medGray, lineHeight: 1.6 }}>{archetypeDesc}</div>}
          </div>
          {activeSynergies.length > 0 && (
            <div style={{ marginBottom: 16 }}>
              <div style={{ fontSize: 11, fontWeight: 700, color: theme.medGray, marginBottom: 8, fontFamily: MONO }}>DETECTED SYNERGIES</div>
              {activeSynergies.map(s => {
                const complete = completeSynergies.includes(s);
                const matched = s.features.filter(fId => selectedFeatures.some(f => f.id === fId));
                return (
                  <div key={s.id} style={{ background: complete ? (isDark ? "#064E3B" : "#F0FDF4") : theme.offWhite, border: `1px solid ${complete ? theme.emerald : theme.lightGray}`, borderRadius: 8, padding: 14, marginBottom: 8 }}>
                    <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 4 }}>
                      <span style={{ fontSize: 13, fontWeight: 700, fontFamily: MONO, color: theme.black }}>{s.icon} {s.name}</span>
                      <span style={{ fontSize: 10, fontWeight: 700, fontFamily: MONO, color: complete ? theme.emerald : theme.amber }}>{complete ? "Complete" : `${matched.length}/${s.features.length}`}</span>
                    </div>
                    <div style={{ fontSize: 11, color: theme.medGray, lineHeight: 1.5, marginBottom: 6 }}>{s.description}</div>
                    <div style={{ display: "flex", gap: 4, flexWrap: "wrap" }}>
                      {s.features.map(fId => {
                        const feat = PL_FEATURES.find(f => f.id === fId);
                        const has = selectedFeatures.some(f => f.id === fId);
                        return feat ? (
                          <span key={fId} style={{ fontSize: 9, padding: "2px 6px", borderRadius: 3, background: has ? theme.emeraldLight : theme.white, border: `1px solid ${has ? theme.emerald : theme.lightGray}`, color: has ? theme.emerald : theme.medGray, fontFamily: MONO }}>{has ? "âœ“" : "â—‹"} {feat.name}</span>
                        ) : null;
                      })}
                    </div>
                  </div>
                );
              })}
            </div>
          )}
          {selectedFeatures.length >= 2 && (
            <div>
              <div style={{ fontSize: 11, fontWeight: 700, color: theme.medGray, marginBottom: 8, fontFamily: MONO }}>SUGGESTED BUILD ORDER</div>
              {[...selectedFeatures].sort((a, b) => {
                const aShared = selectedFeatures.filter(f => f.id !== a.id && f.requires.some(r => a.requires.includes(r))).length;
                const bShared = selectedFeatures.filter(f => f.id !== b.id && f.requires.some(r => b.requires.includes(r))).length;
                return bShared - aShared || a.cost - b.cost;
              }).map((f, i) => (
                <div key={f.id} style={{ display: "flex", alignItems: "center", gap: 10, padding: "8px 0", borderBottom: `1px solid ${theme.lightGray}` }}>
                  <span style={{ fontSize: 12, fontWeight: 700, fontFamily: MONO, color: theme.medGray, width: 24 }}>#{i + 1}</span>
                  <span style={{ fontSize: 12, color: theme.black }}>{f.icon} {f.name}</span>
                  <span style={{ fontSize: 10, color: theme.medGray, fontFamily: MONO, marginLeft: "auto" }}>{f.cost}pt</span>
                </div>
              ))}
            </div>
          )}
          {selectedFeatures.length === 0 && <div style={{ fontSize: 12, color: theme.medGray, fontStyle: "italic", textAlign: "center", padding: 20 }}>Select features on the left to see your product take shape</div>}
        </div>
      );
    }

    function PLCycleOverlay({ selectedFeatures }) {
      const theme = useTheme();
      const isDark = theme.offWhite === "#1A1A1A";
      const stepCoverage = {};
      PL_FCM_STEPS.forEach(s => { stepCoverage[s.id] = []; });
      selectedFeatures.forEach(f => {
        (f.affectsSteps || []).forEach(sId => { if (stepCoverage[sId]) stepCoverage[sId].push(f); });
      });
      const coveredCount = Object.values(stepCoverage).filter(v => v.length > 0).length;
      const darkCount = PL_FCM_STEPS.length - coveredCount;

      return (
        <div style={{ background: theme.white, border: `1px solid ${theme.lightGray}`, borderRadius: 10, padding: 16, marginBottom: 20 }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "center", marginBottom: 12 }}>
            <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, fontFamily: MONO }}>FCM Case Cycle Coverage</div>
            {selectedFeatures.length > 0 && (
              <div style={{ fontSize: 10, fontFamily: MONO, color: darkCount > 0 ? theme.amber : theme.emerald }}>
                {coveredCount}/{PL_FCM_STEPS.length} steps covered{darkCount > 0 ? ` Â· ${darkCount} dark zone${darkCount > 1 ? "s" : ""}` : " â€” full coverage"}
              </div>
            )}
          </div>
          <div style={{ display: "flex", gap: 3, alignItems: "stretch" }}>
            {PL_FCM_STEPS.map((step, i) => {
              const feats = stepCoverage[step.id];
              const covered = feats.length > 0;
              const isGap = step.isGap;
              return (
                <div key={step.id} style={{ flex: 1, display: "flex", flexDirection: "column", alignItems: "center", position: "relative" }}>
                  <div style={{
                    width: "100%", padding: "10px 4px", borderRadius: 6, textAlign: "center",
                    background: covered ? (isDark ? "#064E3B" : "#F0FDF4") : isGap ? (isDark ? "#7F1D1D" : "#FEF2F2") : theme.offWhite,
                    border: `1px solid ${covered ? theme.emerald : isGap ? (isDark ? "#991B1B" : "#FECACA") : theme.lightGray}`,
                    minHeight: 64, display: "flex", flexDirection: "column", alignItems: "center", justifyContent: "center",
                    transition: "all 0.2s", cursor: covered ? "pointer" : "default",
                  }} title={covered ? feats.map(f => f.name).join(", ") : ""}>
                    <div style={{ fontSize: 9, fontWeight: 800, fontFamily: MONO, color: theme.medGray, marginBottom: 2, width: 18, height: 18, borderRadius: "50%", background: isDark ? "#374151" : "#E5E7EB", display: "flex", alignItems: "center", justifyContent: "center" }}>{i + 1}</div>
                    <div style={{ fontSize: 16, marginBottom: 2 }}>{step.icon}</div>
                    <div style={{ fontSize: 11, fontWeight: 600, fontFamily: MONO, color: covered ? theme.emerald : isGap ? theme.red : theme.medGray, lineHeight: 1.2, whiteSpace: "pre-line" }}>{step.short}</div>
                  </div>
                  {covered && (
                    <div style={{ display: "flex", gap: 3, marginTop: 4, flexWrap: "wrap", justifyContent: "center" }}>
                      {feats.map(f => (
                        <span key={f.id} title={f.name} style={{ fontSize: 12, cursor: "default" }}>{f.icon}</span>
                      ))}
                    </div>
                  )}
                  {isGap && !covered && (
                    <div style={{ fontSize: 9, color: theme.red, fontFamily: MONO, marginTop: 4, textAlign: "center", fontWeight: 600 }}>DARK ZONE</div>
                  )}
                  {i < PL_FCM_STEPS.length - 1 && (
                    <div style={{ position: "absolute", right: -4, top: 30, fontSize: 10, color: theme.lightGray }}>â€º</div>
                  )}
                </div>
              );
            })}
          </div>
          {selectedFeatures.length > 0 && selectedFeatures.some(f => f.realityWarning) && (
            <div style={{ marginTop: 12, padding: "8px 12px", borderRadius: 6, background: isDark ? "#78350F" : "#FFF7ED", border: `1px solid ${isDark ? "#92400E" : "#FDE68A"}`, fontSize: 11, color: isDark ? "#F59E0B" : "#92400E", lineHeight: 1.5, fontFamily: MONO }}>
              Reality check: {selectedFeatures.filter(f => f.realityWarning).map(f => `${f.icon} ${f.name}`).join(", ")} require between-session engagement. Students don't think about FCM between sessions â€” plan for that.
            </div>
          )}
        </div>
      );
    }

    function PLDesignPhilosophy({ selectedFeatures, confirmedPhilosophy, setConfirmedPhilosophy }) {
      const theme = useTheme();
      const isDark = theme.offWhite === "#1A1A1A";
      const [activeApp, setActiveApp] = useState(confirmedPhilosophy || "duolingo");

      const philosophies = [
        {
          id: "duolingo", name: "Duolingo", icon: "ğŸ¦‰", color: "#58CC02",
          philosophy: "Everything in 5 minutes. Gamify everything. Streaks for retention. No instructor â€” the app IS the teacher.",
          rules: ["Every interaction under 5 min", "Points for every action", "Daily streak = core retention mechanic", "No instructor-facing features", "Mobile-only design"],
          reinterpret: (feats) => feats.map(f => {
            const map = {
              "gap-refresh": { verdict: "PERFECT FIT", note: "This IS Duolingo's core. Quick-fire differential quiz on the walk to FCM. Streak counter. XP for accuracy." },
              "reasoning-capture": { verdict: "SIMPLIFY", note: "Too deep for 5-min sessions. Reduce to: 3 structured prompts, tap-to-rank differentials, 30-second reasoning voice memo." },
              "confidence-cal": { verdict: "GAMIFY IT", note: "Prediction game: rate your confidence â†’ see result after session â†’ earn 'Calibration Score' XP. Leaderboard potential." },
              "student-signal": { verdict: "CUT IT", note: "Duolingo has no teachers. This feature doesn't exist in this philosophy. Student learns from the app, not from signaling." },
              "instructor-dashboard": { verdict: "CUT IT", note: "No instructor-facing features. The app teaches autonomously." },
              "ai-patient": { verdict: "CORE FEATURE", note: "This IS the Duolingo lesson â€” conversational AI patient as the practice exercise. 5-min encounters. Daily practice." },
              "progress-tracker": { verdict: "LEVEL SYSTEM", note: "XP, levels, badges. 'You've completed 12 cases. You're a Level 3 Diagnostician.' Visual skill tree." },
              "spaced-review": { verdict: "PERFECT FIT", note: "Duolingo's spaced repetition is core. Push notifications: 'You haven't reviewed the SOB case in 5 days.'" },
              "compliance-dash": { verdict: "CUT IT", note: "No admin view. The app is purely student-facing." },
              "peer-compare": { verdict: "LEADERBOARD", note: "Anonymous weekly leaderboard: 'You're in the top 20% for diagnostic accuracy this week.'" },
            };
            return { feature: f, ...(map[f.id] || { verdict: "ADAPT", note: "Reframe as a gamified, 5-minute mobile interaction." }) };
          }),
        },
        {
          id: "piazza", name: "Piazza", icon: "ğŸ’¬", color: "#3158A3",
          philosophy: "Every question gets answered. Instructor sees everything. Anonymous participation lowers the bar. The class learns together.",
          rules: ["Two-sided: students post, instructors respond", "Anonymous option for every interaction", "Instructor endorsement = quality signal", "Threaded discussions", "Desktop-first, content-heavy"],
          reinterpret: (feats) => feats.map(f => {
            const map = {
              "gap-refresh": { verdict: "DISCUSSION", note: "Replace quiz with: 'Post your top differential and why.' Peers comment. Instructor endorses best reasoning." },
              "reasoning-capture": { verdict: "CORE FEATURE", note: "Students post reasoning threads. Instructor annotates inline. Best reasoning gets 'Instructor Endorsed' badge." },
              "confidence-cal": { verdict: "CLASS POLL", note: "Anonymous poll: 'What's your top diagnosis?' See class distribution before session. Instructor sees who's divergent." },
              "student-signal": { verdict: "PERFECT FIT", note: "This IS Piazza. Anonymous Q&A before session. Instructor sees aggregate confusion. Students feel safe asking." },
              "instructor-dashboard": { verdict: "PERFECT FIT", note: "Piazza's instructor view: unanswered questions, participation stats, trending confusion areas." },
              "ai-patient": { verdict: "DOESN'T FIT", note: "Piazza is human-to-human. AI patient is a solo experience. Could add: 'Share your AI encounter transcript with the class.'" },
              "progress-tracker": { verdict: "PARTICIPATION", note: "Track contribution quality over time. 'You've posted 15 times, 3 instructor-endorsed answers.'" },
              "spaced-review": { verdict: "ADAPT", note: "Post-session thread: 'Now that we know the diagnosis, what would you do differently?' Peer discussion." },
              "compliance-dash": { verdict: "ANALYTICS", note: "Engagement metrics: who participates, quality of reasoning, coach response time." },
              "peer-compare": { verdict: "BUILT IN", note: "Seeing peers' posts IS peer comparison. Add anonymous differential distribution chart." },
            };
            return { feature: f, ...(map[f.id] || { verdict: "ADAPT", note: "Reframe as a collaborative, discussion-based feature." }) };
          }),
        },
        {
          id: "strava", name: "Strava", icon: "ğŸƒ", color: "#FC4C02",
          philosophy: "Track everything. Compare with peers. Personal records matter. The social feed IS the product. Data makes effort visible.",
          rules: ["Activity feed is the home screen", "Everything generates data", "Peer comparison is motivating", "Personal records and trends", "Passive tracking where possible"],
          reinterpret: (feats) => feats.map(f => {
            const map = {
              "gap-refresh": { verdict: "WARM-UP", note: "Pre-session warm-up that logs to your activity feed. 'Alex completed a 7-min case refresh.' Peers see it." },
              "reasoning-capture": { verdict: "LOG IT", note: "Every reasoning session is an 'activity.' Logged with time, quality score, complexity. Visible on your profile." },
              "confidence-cal": { verdict: "PERSONAL RECORD", note: "Track calibration score like a running pace. 'Your best calibration: 85% on the cardiology case.' PR notifications." },
              "student-signal": { verdict: "DOESN'T FIT", note: "Strava doesn't have coaches giving real-time feedback. Could adapt: instructor 'kudos' on student activities." },
              "instructor-dashboard": { verdict: "COACH VIEW", note: "Like Strava's coach dashboard: see all athletes' activities, training load, trends. No direct intervention." },
              "ai-patient": { verdict: "WORKOUT", note: "AI encounter = a 'workout.' Logged with difficulty, duration, performance. Compare times with peers." },
              "progress-tracker": { verdict: "CORE FEATURE", note: "This IS Strava. Graphs, trends, year-over-year comparison. 'You've improved 23% in diagnostic accuracy since September.'" },
              "spaced-review": { verdict: "STREAK", note: "Review streak. 'You've reviewed cases 5 days in a row.' Activity calendar (green squares like GitHub)." },
              "compliance-dash": { verdict: "LEADERBOARD", note: "Program-level leaderboards and stats. 'Your section averages 4.2 activities/week.'" },
              "peer-compare": { verdict: "PERFECT FIT", note: "Segment leaderboards: 'On this case, you ranked #3 in diagnostic accuracy among 180 students.'" },
            };
            return { feature: f, ...(map[f.id] || { verdict: "ADAPT", note: "Reframe as a trackable, shareable activity." }) };
          }),
        },
        {
          id: "chatgpt", name: "ChatGPT", icon: "ğŸ¤–", color: "#10A37F",
          philosophy: "Conversational AI that adapts to you. No structure â€” you drive the interaction. Infinite depth. Every session is different.",
          rules: ["Conversation is the interface", "AI adapts to student level", "No fixed curriculum path", "Infinite practice depth", "Solo experience, always available"],
          reinterpret: (feats) => feats.map(f => {
            const map = {
              "gap-refresh": { verdict: "SIMPLIFY", note: "Instead of a quiz, just open a chat: 'Remind me about the SOB case.' AI gives a conversational recap tailored to what you forgot." },
              "reasoning-capture": { verdict: "CONVERSATION", note: "Don't fill out forms. Talk through your reasoning with AI. It asks Socratic questions. Probes weak spots. Captures reasoning naturally." },
              "confidence-cal": { verdict: "AI ASKS YOU", note: "AI: 'You said PE is most likely. How confident are you? What would change your mind?' Conversational calibration." },
              "student-signal": { verdict: "AI SUMMARY", note: "AI generates a summary of each student's conversation for the instructor. Student doesn't have to 'signal' â€” AI extracts confusion automatically." },
              "instructor-dashboard": { verdict: "AI INSIGHTS", note: "AI analyzes all student conversations: 'Common blind spot: 4 of 6 students missed pulmonary embolism as a differential.'" },
              "ai-patient": { verdict: "CORE FEATURE", note: "This IS ChatGPT's strength. Conversational AI patient. Infinitely patient, always available, adapts to your level." },
              "progress-tracker": { verdict: "AI REFLECTION", note: "AI: 'Compared to your first case in September, your reasoning is more structured. Here's what I notice...' Personalized growth insights." },
              "spaced-review": { verdict: "AI PROMPTS", note: "AI texts you: 'Remember the SOB case? A new finding just came in. What do you think now?' Conversational spaced repetition." },
              "compliance-dash": { verdict: "AUTO-GENERATE", note: "AI auto-generates competency reports from conversation analysis. No manual tracking needed." },
              "peer-compare": { verdict: "DOESN'T FIT", note: "ChatGPT is solo. No peer visibility. Could add: 'Other students commonly identified X â€” want to explore that?'" },
            };
            return { feature: f, ...(map[f.id] || { verdict: "ADAPT", note: "Reframe as a conversational AI interaction." }) };
          }),
        },
      ];

      const activePhil = philosophies.find(p => p.id === activeApp);
      const interpretations = activePhil.reinterpret(selectedFeatures);
      const verdictColors = {
        "PERFECT FIT": { bg: isDark ? "#064E3B" : "#F0FDF4", color: theme.emerald },
        "CORE FEATURE": { bg: isDark ? "#064E3B" : "#F0FDF4", color: theme.emerald },
        "BUILT IN": { bg: isDark ? "#064E3B" : "#F0FDF4", color: theme.emerald },
        "GAMIFY IT": { bg: isDark ? "#1E3A5F" : "#EFF6FF", color: theme.blue },
        "LEADERBOARD": { bg: isDark ? "#1E3A5F" : "#EFF6FF", color: theme.blue },
        "LEVEL SYSTEM": { bg: isDark ? "#1E3A5F" : "#EFF6FF", color: theme.blue },
        "CONVERSATION": { bg: isDark ? "#1E3A5F" : "#EFF6FF", color: theme.blue },
        "WARM-UP": { bg: isDark ? "#1E3A5F" : "#EFF6FF", color: theme.blue },
        "LOG IT": { bg: isDark ? "#1E3A5F" : "#EFF6FF", color: theme.blue },
        "CLASS POLL": { bg: isDark ? "#1E3A5F" : "#EFF6FF", color: theme.blue },
        "DISCUSSION": { bg: isDark ? "#1E3A5F" : "#EFF6FF", color: theme.blue },
        "WORKOUT": { bg: isDark ? "#1E3A5F" : "#EFF6FF", color: theme.blue },
        "PERSONAL RECORD": { bg: isDark ? "#1E3A5F" : "#EFF6FF", color: theme.blue },
        "COACH VIEW": { bg: isDark ? "#1E3A5F" : "#EFF6FF", color: theme.blue },
        "STREAK": { bg: isDark ? "#1E3A5F" : "#EFF6FF", color: theme.blue },
        "AI ASKS YOU": { bg: isDark ? "#1E3A5F" : "#EFF6FF", color: theme.blue },
        "AI SUMMARY": { bg: isDark ? "#1E3A5F" : "#EFF6FF", color: theme.blue },
        "AI INSIGHTS": { bg: isDark ? "#1E3A5F" : "#EFF6FF", color: theme.blue },
        "AI REFLECTION": { bg: isDark ? "#1E3A5F" : "#EFF6FF", color: theme.blue },
        "AI PROMPTS": { bg: isDark ? "#1E3A5F" : "#EFF6FF", color: theme.blue },
        "AUTO-GENERATE": { bg: isDark ? "#1E3A5F" : "#EFF6FF", color: theme.blue },
        "PARTICIPATION": { bg: isDark ? "#1E3A5F" : "#EFF6FF", color: theme.blue },
        "ANALYTICS": { bg: isDark ? "#1E3A5F" : "#EFF6FF", color: theme.blue },
        "SIMPLIFY": { bg: isDark ? "#78350F" : "#FFF7ED", color: theme.amber },
        "ADAPT": { bg: isDark ? "#78350F" : "#FFF7ED", color: theme.amber },
        "CUT IT": { bg: isDark ? "#7F1D1D" : "#FEF2F2", color: theme.red },
        "DOESN'T FIT": { bg: isDark ? "#7F1D1D" : "#FEF2F2", color: theme.red },
      };

      return (
        <div>
          <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 12, fontFamily: MONO }}>What Would They Build?</div>
          <div style={{ display: "flex", gap: 6, marginBottom: 16, flexWrap: "wrap" }}>
            {philosophies.map(p => (
              <button key={p.id} onClick={() => setActiveApp(p.id)} style={{
                padding: "6px 14px", borderRadius: 20, fontSize: 12, fontFamily: MONO, fontWeight: activeApp === p.id ? 700 : 500, cursor: "pointer", transition: "all 0.15s",
                background: activeApp === p.id ? p.color + "18" : "transparent",
                border: `1.5px solid ${activeApp === p.id ? p.color : theme.lightGray}`,
                color: activeApp === p.id ? p.color : theme.medGray,
              }}>
                {p.icon} {p.name}
              </button>
            ))}
          </div>
          <div style={{ padding: "12px 14px", borderRadius: 8, background: theme.offWhite, marginBottom: 16, borderLeft: `3px solid ${activePhil.color}` }}>
            <div style={{ fontSize: 12, fontWeight: 700, color: theme.black, marginBottom: 4, fontFamily: MONO }}>If {activePhil.name} built your app...</div>
            <div style={{ fontSize: 11, color: theme.medGray, lineHeight: 1.5, marginBottom: 8 }}>{activePhil.philosophy}</div>
            <div style={{ display: "flex", gap: 4, flexWrap: "wrap" }}>
              {activePhil.rules.map((r, i) => (
                <span key={i} style={{ fontSize: 9, padding: "2px 8px", borderRadius: 10, background: theme.white, border: `1px solid ${theme.lightGray}`, color: theme.black, fontFamily: MONO }}>{r}</span>
              ))}
            </div>
          </div>
          {selectedFeatures.length === 0 ? (
            <div style={{ fontSize: 12, color: theme.medGray, fontStyle: "italic", textAlign: "center", padding: 20 }}>Select features on the left to see how {activePhil.name} would reinterpret them</div>
          ) : (
            <div style={{ display: "flex", flexDirection: "column", gap: 8 }}>
              {interpretations.map(({ feature, verdict, note }) => {
                const vc = verdictColors[verdict] || { bg: theme.offWhite, color: theme.medGray };
                return (
                  <div key={feature.id} style={{ padding: "10px 14px", borderRadius: 8, background: vc.bg, border: `1px solid ${vc.color}22` }}>
                    <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 4 }}>
                      <span style={{ fontSize: 12, fontWeight: 600, color: theme.black }}>{feature.icon} {feature.name}</span>
                      <span style={{ fontSize: 9, fontWeight: 700, padding: "2px 8px", borderRadius: 10, background: vc.color + "22", color: vc.color, fontFamily: MONO }}>{verdict}</span>
                    </div>
                    <div style={{ fontSize: 11, color: theme.medGray, lineHeight: 1.5 }}>{note}</div>
                  </div>
                );
              })}
            </div>
          )}
          {selectedFeatures.length > 0 && (
            <button onClick={() => setConfirmedPhilosophy(confirmedPhilosophy === activeApp ? null : activeApp)} style={{
              marginTop: 16, width: "100%", padding: "12px 20px", borderRadius: 8, border: "none", fontSize: 13, fontWeight: 700, fontFamily: MONO, cursor: "pointer",
              background: confirmedPhilosophy === activeApp ? theme.emerald : theme.black, color: theme.white, transition: "all 0.15s",
            }}>
              {confirmedPhilosophy === activeApp ? `Locked In: ${activePhil.name} Philosophy` : `Lock In: ${activePhil.name} Philosophy`}
            </button>
          )}
        </div>
      );
    }

    function PLScenarios({ selectedFeatureIds }) {
      const theme = useTheme();
      const isDark = theme.offWhite === "#1A1A1A";
      const selFeats = PL_FEATURES.filter(f => selectedFeatureIds.includes(f.id));
      return (
        <div>
          <p style={{ fontSize: 13, color: theme.medGray, lineHeight: 1.6, margin: "0 0 20px 0" }}>
            Imagine real students using your product. Each scenario maps features to a specific moment in the FCM week. <strong style={{ color: theme.black }}>Gaps mean uncovered scenarios.</strong>
          </p>
          <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(280px, 1fr))", gap: 16 }}>
            {PL_SCENARIOS.map(s => {
              const mappedFeats = selFeats.filter(f => (s.featureIds || []).includes(f.id));
              const coverage = s.featureIds.length > 0 ? mappedFeats.length / s.featureIds.length : 0;
              return (
                <div key={s.id} style={{ background: theme.white, border: `1px solid ${coverage > 0 ? theme.emerald : theme.lightGray}`, borderRadius: 10, overflow: "hidden" }}>
                  <div style={{ padding: "14px 16px", background: coverage >= 1 ? (isDark ? "#064E3B" : "#F0FDF4") : theme.offWhite, borderBottom: `1px solid ${theme.lightGray}` }}>
                    <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 4 }}>
                      <span style={{ fontSize: 20 }}>{s.icon}</span>
                      <span style={{ fontSize: 13, fontWeight: 700, fontFamily: MONO, color: theme.black }}>{s.name}</span>
                    </div>
                    <div style={{ fontSize: 11, color: theme.medGray, lineHeight: 1.5, fontStyle: "italic" }}>{s.scene}</div>
                  </div>
                  <div style={{ padding: 16 }}>
                    <div style={{ fontSize: 10, fontWeight: 700, fontFamily: MONO, color: theme.medGray, marginBottom: 6 }}>DEVICE: {s.device} Â· FCM STEPS: {s.steps}</div>
                    <div style={{ fontSize: 11, fontWeight: 700, fontFamily: MONO, color: theme.medGray, marginBottom: 8, textTransform: "uppercase" }}>Mapped Features</div>
                    {mappedFeats.length > 0 ? (
                      <div style={{ display: "flex", gap: 4, flexWrap: "wrap", marginBottom: 8 }}>
                        {mappedFeats.map(f => (
                          <span key={f.id} style={{ fontSize: 10, padding: "2px 8px", borderRadius: 4, background: theme.emeraldLight, color: theme.emerald, fontFamily: MONO, fontWeight: 600 }}>{f.icon} {f.name}</span>
                        ))}
                      </div>
                    ) : (
                      <div style={{ fontSize: 11, color: theme.red, fontFamily: MONO, marginBottom: 8 }}>No features selected for this scenario</div>
                    )}
                    <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between" }}>
                      <span style={{ fontSize: 10, fontFamily: MONO, color: coverage >= 1 ? theme.emerald : coverage > 0 ? theme.amber : theme.red }}>
                        {coverage >= 1 ? "Full coverage" : coverage > 0 ? `${mappedFeats.length}/${s.featureIds.length} covered` : "Gap"}
                      </span>
                      <span style={{ fontSize: 10, fontFamily: MONO, color: theme.medGray }}>Links to: Step {s.momentLink}</span>
                    </div>
                  </div>
                </div>
              );
            })}
          </div>
        </div>
      );
    }

    function PLProductBuilder({ selectedIds, toggleFeature, confirmedPhilosophy, setConfirmedPhilosophy }) {
      const theme = useTheme();
      const [activeLens, setActiveLens] = useState("budget");
      const selectedFeatures = PL_FEATURES.filter(f => selectedIds.includes(f.id));
      const totalCost = selectedFeatures.reduce((sum, f) => sum + f.cost, 0);
      const overBudget = totalCost > PL_BUDGET;

      const lenses = [
        { id: "budget", label: "Budget", icon: "ğŸ’°" },
        { id: "tech", label: "Tech Stack", icon: "ğŸ”§" },
        { id: "product", label: "Product Shape", icon: "ğŸ—ï¸" },
        { id: "wwxd", label: "What Would X Do?", icon: "ğŸª" },
        { id: "scenarios", label: "Scenarios", icon: "ğŸ¬" },
      ];

      return (
        <div>
          <p style={{ fontSize: 13, color: theme.medGray, lineHeight: 1.6, margin: "0 0 16px 0" }}>
            You have <strong style={{ color: theme.black }}>{PL_BUDGET} build points</strong>. Choose features that address the pain points you prioritized.{" "}
            <strong style={{ color: theme.black }}>Toggle lenses on the right</strong> to see how your choices shape the product.
          </p>
          <PLCycleOverlay selectedFeatures={selectedFeatures} />
          <div className="pl-builder-grid" style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 20 }}>
            <div>
              <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 12, fontFamily: MONO }}>
                Feature Wishlist â€” {totalCost}/{PL_BUDGET} pts used
              </div>
              {PL_FEATURES.map(f => (
                <PLFeatureCard key={f.id} feature={f} selected={selectedIds.includes(f.id)} onToggle={() => toggleFeature(f.id)} overBudget={overBudget} />
              ))}
            </div>
            <div>
              <div style={{ display: "flex", gap: 0, borderBottom: `1px solid ${theme.lightGray}`, marginBottom: 16, flexWrap: "wrap" }}>
                {lenses.map(lens => (
                  <button key={lens.id} onClick={() => setActiveLens(lens.id)} style={{ padding: "6px 10px", fontSize: 10, fontWeight: activeLens === lens.id ? 700 : 500, fontFamily: MONO, color: activeLens === lens.id ? theme.black : theme.medGray, background: "none", border: "none", borderBottom: activeLens === lens.id ? `2px solid ${theme.blue}` : "2px solid transparent", cursor: "pointer", marginBottom: -1 }}>
                    {lens.icon} {lens.label}
                  </button>
                ))}
              </div>
              <div style={{ background: theme.white, border: `1px solid ${theme.lightGray}`, borderRadius: 10, padding: 18, minHeight: 300, position: "sticky", top: 20 }}>
                {activeLens === "budget" && <PLBudgetLens selectedFeatures={selectedFeatures} />}
                {activeLens === "tech" && <PLTechLens selectedFeatures={selectedFeatures} />}
                {activeLens === "product" && <PLProductLens selectedFeatures={selectedFeatures} />}
                {activeLens === "wwxd" && <PLDesignPhilosophy selectedFeatures={selectedFeatures} confirmedPhilosophy={confirmedPhilosophy} setConfirmedPhilosophy={setConfirmedPhilosophy} />}
                {activeLens === "scenarios" && <PLScenarios selectedFeatureIds={selectedIds} />}
              </div>
            </div>
          </div>
        </div>
      );
    }

    /* â”€â”€ Simple Markdownâ†’HTML renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function renderMarkdownToHtml(md) {
      return md
        .replace(/^# (.+)$/gm, '<h1>$1</h1>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^\*\*(.+?)\*\*/gm, '<strong>$1</strong>')
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/(<li>.*<\/li>\n?)+/g, (m) => `<ul>${m}</ul>`)
        .replace(/^---$/gm, '<hr/>')
        .replace(/\|(.+)\|/g, (m) => {
          const cells = m.split('|').filter(c => c.trim());
          if (cells.every(c => c.trim().match(/^-+$/))) return '';
          const tag = cells[0]?.trim().startsWith('**') ? 'th' : 'td';
          return `<tr>${cells.map(c => `<${tag}>${c.trim().replace(/\*\*/g, '')}</${tag}>`).join('')}</tr>`;
        })
        .replace(/(<tr>.*<\/tr>\n?)+/g, (m) => `<table>${m}</table>`)
        .replace(/~~(.+?)~~/g, '<del>$1</del>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/^(?!<[hultdp])(.+)$/gm, '<p>$1</p>')
        .replace(/<p><\/p>/g, '')
        .replace(/<p>(<[hultdr])/g, '$1')
        .replace(/(<\/[hultdr][^>]*>)<\/p>/g, '$1');
    }

    function PLPRDDraft({ voted, selectedFeatureIds, confirmedArchetype, notBuilding, setNotBuilding, newNotBuilding, setNewNotBuilding, prdNotes, setPrdNotes, generatePRDMarkdown, stColors, confirmedPhilosophy, visionStatement, setVisionStatement }) {
      const theme = useTheme();
      const isDark = theme.offWhite === "#1A1A1A";
      const [copied, setCopied] = useState(false);
      const [showPreview, setShowPreview] = useState(false);
      const selectedFeatures = PL_FEATURES.filter(f => selectedFeatureIds.includes(f.id));
      const totalCost = selectedFeatures.reduce((sum, f) => sum + f.cost, 0);
      const overBudget = totalCost > PL_BUDGET;
      const reqSet = new Set();
      selectedFeatures.forEach(f => (f.requires || []).forEach(r => reqSet.add(r)));
      const activeSynergies = PL_SYNERGIES.filter(s => s.features.every(fId => selectedFeatures.some(f => f.id === fId)));
      const handleCopy = () => {
        navigator.clipboard.writeText(generatePRDMarkdown()).then(() => { setCopied(true); setTimeout(() => setCopied(false), 2000); });
      };
      const handleDownload = () => {
        const blob = new Blob([generatePRDMarkdown()], { type: "text/markdown" });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `fcm-prd-draft-${new Date().toISOString().slice(0,10)}.md`; a.click();
      };
      return (
        <div>
          <p style={{ fontSize: 13, color: theme.medGray, lineHeight: 1.6, margin: "0 0 20px 0" }}>
            Your feature selections and priorities assembled into a draft PRD.{" "}
            <strong style={{ color: theme.black }}>Copy to Claude</strong> for refinement, or export as markdown for your repo.
          </p>
          <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fit, minmax(300px, 1fr))", gap: 16, marginBottom: 20 }}>
            <div style={{ background: theme.white, border: `1px solid ${theme.lightGray}`, borderRadius: 10, padding: 18 }}>
              <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 12, fontFamily: MONO }}>Prioritized Pain Points ({voted.painPoints.length})</div>
              {voted.painPoints.length === 0 ? (
                <div style={{ fontSize: 12, color: theme.medGray, fontStyle: "italic" }}>Go to Evidence Wall and click items to prioritize</div>
              ) : voted.painPoints.map(p => (
                <div key={p.id} style={{ fontSize: 12, lineHeight: 1.5, marginBottom: 6, display: "flex", gap: 8 }}>
                  <span style={{ fontSize: 10, fontWeight: 600, padding: "1px 6px", borderRadius: 3, flexShrink: 0, background: stColors[p.stakeholder]?.bg, color: stColors[p.stakeholder]?.color, fontFamily: MONO }}>{p.stakeholderLabel}</span>
                  <span style={{ color: theme.black }}>{p.text}</span>
                </div>
              ))}
            </div>
            <div style={{ background: theme.white, border: `1px solid ${theme.lightGray}`, borderRadius: 10, padding: 18 }}>
              <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 12, fontFamily: MONO }}>Prioritized Wishes ({voted.wishes.length})</div>
              {voted.wishes.length === 0 ? (
                <div style={{ fontSize: 12, color: theme.medGray, fontStyle: "italic" }}>Go to Evidence Wall and click wish items to prioritize</div>
              ) : voted.wishes.map(w => (
                <div key={w.id} style={{ fontSize: 12, lineHeight: 1.5, marginBottom: 6, display: "flex", gap: 8 }}>
                  <span style={{ fontSize: 10, fontWeight: 600, padding: "1px 6px", borderRadius: 3, flexShrink: 0, background: stColors[w.stakeholder]?.bg, color: stColors[w.stakeholder]?.color, fontFamily: MONO }}>{w.stakeholderLabel}</span>
                  <span style={{ color: theme.black }}>{w.text}</span>
                </div>
              ))}
            </div>
          </div>
          {confirmedArchetype && (() => {
            const arch = PL_ARCHETYPES.find(a => a.id === confirmedArchetype);
            return arch ? (
              <div style={{ background: isDark ? arch.bgDark : arch.bgLight, border: `2px solid ${arch.color}`, borderRadius: 10, padding: 18, marginBottom: 20 }}>
                <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: arch.color, marginBottom: 8, fontFamily: MONO }}>Product Archetype</div>
                <div style={{ fontSize: 16, fontWeight: 700, fontFamily: MONO, color: theme.black, marginBottom: 4 }}>{arch.name}</div>
                <div style={{ fontSize: 12, color: theme.medGray, lineHeight: 1.5, marginBottom: 8 }}>{arch.tagline} â€” {arch.description}</div>
                <div style={{ display: "flex", gap: 6, flexWrap: "wrap" }}>
                  {arch.referenceApps.map(app => (
                    <span key={app.name} style={{ fontSize: 11, padding: "3px 8px", borderRadius: 6, background: theme.white, border: `1px solid ${theme.lightGray}`, fontFamily: MONO, color: theme.black }}>{app.icon} {app.name}</span>
                  ))}
                </div>
              </div>
            ) : null;
          })()}
          <div style={{ background: theme.white, border: `1px solid ${theme.lightGray}`, borderRadius: 10, padding: 18, marginBottom: 20 }}>
            <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 12, fontFamily: MONO }}>Selected Features ({selectedFeatures.length}) â€” {totalCost}/{PL_BUDGET} pts</div>
            {selectedFeatures.length === 0 ? (
              <div style={{ fontSize: 12, color: theme.medGray, fontStyle: "italic" }}>Go to Product Builder and select features</div>
            ) : (
              <div>
                {overBudget && <div style={{ fontSize: 12, color: theme.red, fontWeight: 600, fontFamily: MONO, marginBottom: 12, padding: "8px 12px", background: theme.redLight, borderRadius: 6 }}>Over budget by {totalCost - PL_BUDGET} points â€” trim features before building</div>}
                <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(200px, 1fr))", gap: 10 }}>
                  {selectedFeatures.map(f => (
                    <div key={f.id} style={{ padding: "10px 12px", borderRadius: 6, background: theme.offWhite, border: `1px solid ${theme.lightGray}` }}>
                      <div style={{ fontSize: 13, fontWeight: 700, color: theme.black, fontFamily: MONO, marginBottom: 2 }}>{f.icon} {f.name}</div>
                      <div style={{ fontSize: 10, color: theme.medGray, fontFamily: MONO }}>{f.cost} pt{f.cost !== 1 ? "s" : ""} Â· {f.stakeholders.join(", ")}</div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
          {reqSet.size > 0 && (
            <div style={{ background: theme.white, border: `1px solid ${theme.lightGray}`, borderRadius: 10, padding: 18, marginBottom: 20 }}>
              <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 12, fontFamily: MONO }}>Required Tech Stack ({reqSet.size})</div>
              <div style={{ display: "flex", gap: 8, flexWrap: "wrap" }}>
                {[...reqSet].map(rId => {
                  const req = PL_TECH_REQS[rId];
                  return req ? <span key={rId} style={{ fontSize: 11, padding: "4px 10px", borderRadius: 6, background: theme.offWhite, border: `1px solid ${theme.lightGray}`, color: theme.black, fontFamily: MONO }}>{req.icon} {req.label}</span> : null;
                })}
              </div>
            </div>
          )}
          {activeSynergies.length > 0 && (
            <div style={{ background: isDark ? "#064E3B" : "#F0FDF4", border: `1px solid ${theme.emerald}`, borderRadius: 10, padding: 18, marginBottom: 20 }}>
              <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.emerald, marginBottom: 8, fontFamily: MONO }}>Active Synergy Loops ({activeSynergies.length})</div>
              {activeSynergies.map(s => (
                <div key={s.id} style={{ fontSize: 12, color: theme.black, marginBottom: 4 }}>{s.icon} <strong>{s.name}</strong> â€” {s.description}</div>
              ))}
            </div>
          )}
          <div style={{ background: theme.white, border: `1px solid ${theme.lightGray}`, borderRadius: 10, padding: 18, marginBottom: 20 }}>
            <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 10, fontFamily: MONO }}>What We're NOT Building</div>
            <p style={{ fontSize: 12, color: theme.medGray, lineHeight: 1.5, margin: "0 0 10px 0" }}>Just as important as what you build. Saying "no" to good ideas keeps scope tight.</p>
            {notBuilding.map((item, idx) => (
              <div key={idx} style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 6 }}>
                <span style={{ fontSize: 12, lineHeight: 1.5, flex: 1, color: theme.black }}>â€¢ {item}</span>
                <button onClick={() => setNotBuilding(prev => prev.filter((_, i) => i !== idx))} style={{ background: "none", border: "none", cursor: "pointer", fontSize: 12, color: theme.medGray, padding: "2px 6px" }}>Ã—</button>
              </div>
            ))}
            <div style={{ display: "flex", gap: 6, marginTop: 10 }}>
              <input type="text" value={newNotBuilding} onChange={e => setNewNotBuilding(e.target.value)} onKeyDown={e => { if (e.key === "Enter" && newNotBuilding.trim()) { setNotBuilding(prev => [...prev, newNotBuilding.trim()]); setNewNotBuilding(""); } }} placeholder="Add scope exclusion..." style={{ flex: 1, padding: "6px 10px", fontSize: 12, fontFamily: MONO, border: `1px solid ${theme.lightGray}`, borderRadius: 6, background: theme.offWhite, color: theme.black, outline: "none" }} />
            </div>
          </div>
          <div style={{ background: theme.white, border: `1px solid ${theme.lightGray}`, borderRadius: 10, padding: 18, marginBottom: 20 }}>
            <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 10, fontFamily: MONO }}>Product Vision Statement</div>
            <textarea value={visionStatement} onChange={e => setVisionStatement(e.target.value)} placeholder="A digital companion for the FCM case cycle that transforms passive preparation into active clinical reasoning practice, makes student thinking visible to instructors, and creates feedback loops that close the gap between preparation and learning." style={{ width: "100%", minHeight: 60, padding: 12, fontSize: 12, fontFamily: SANS, border: `1px solid ${theme.lightGray}`, borderRadius: 6, background: theme.offWhite, color: theme.black, outline: "none", resize: "vertical", lineHeight: 1.6, boxSizing: "border-box" }} />
            <div style={{ fontSize: 10, color: theme.medGray, marginTop: 4 }}>Edit to make it yours. This becomes Section 4 of the PRD.</div>
          </div>
          <div style={{ background: theme.white, border: `1px solid ${theme.lightGray}`, borderRadius: 10, padding: 18, marginBottom: 20 }}>
            <div style={{ fontSize: 11, fontWeight: 700, textTransform: "uppercase", letterSpacing: "0.1em", color: theme.medGray, marginBottom: 10, fontFamily: MONO }}>Additional Notes</div>
            <textarea value={prdNotes} onChange={e => setPrdNotes(e.target.value)} placeholder="Anything else the PRD should capture? Design preferences, technical constraints, questions for the team..." style={{ width: "100%", minHeight: 80, padding: 12, fontSize: 12, fontFamily: SANS, border: `1px solid ${theme.lightGray}`, borderRadius: 6, background: theme.offWhite, color: theme.black, outline: "none", resize: "vertical", lineHeight: 1.6, boxSizing: "border-box" }} />
          </div>
          <div style={{ display: "flex", gap: 12, flexWrap: "wrap" }}>
            <button onClick={handleCopy} style={{ padding: "12px 24px", borderRadius: 8, border: "none", background: theme.black, color: theme.white, cursor: "pointer", fontWeight: 700, fontSize: 13, fontFamily: MONO }}>{copied ? "Copied!" : "Copy PRD to Clipboard"}</button>
            <button onClick={() => setShowPreview(showPreview === "raw" ? false : "raw")} style={{ padding: "12px 24px", borderRadius: 8, border: `1px solid ${theme.lightGray}`, background: showPreview === "raw" ? theme.offWhite : theme.white, color: theme.black, cursor: "pointer", fontWeight: 600, fontSize: 13, fontFamily: MONO }}>Raw Markdown</button>
            <button onClick={() => setShowPreview(showPreview === "formatted" ? false : "formatted")} style={{ padding: "12px 24px", borderRadius: 8, border: `1px solid ${theme.emerald}`, background: showPreview === "formatted" ? theme.emeraldLight : theme.white, color: theme.black, cursor: "pointer", fontWeight: 600, fontSize: 13, fontFamily: MONO }}>Formatted Preview</button>
            <button onClick={handleDownload} style={{ padding: "12px 24px", borderRadius: 8, border: `1px solid ${theme.lightGray}`, background: theme.white, color: theme.black, cursor: "pointer", fontWeight: 600, fontSize: 13, fontFamily: MONO }}>Download .md</button>
          </div>
          {showPreview === "raw" && (
            <div style={{ marginTop: 16, padding: 20, background: isDark ? "#111" : "#1a1a1a", borderRadius: 8, fontFamily: MONO, fontSize: 11, color: "#e0e0e0", lineHeight: 1.7, whiteSpace: "pre-wrap", overflow: "auto", maxHeight: 500 }}>
              {generatePRDMarkdown()}
            </div>
          )}
          {showPreview === "formatted" && (
            <div style={{ marginTop: 16, border: `1px solid ${theme.lightGray}`, borderRadius: 8, overflow: "auto", maxHeight: 600, background: theme.white }}>
              <div className="rendered-prd" dangerouslySetInnerHTML={{ __html: renderMarkdownToHtml(generatePRDMarkdown()) }} />
            </div>
          )}
        </div>
      );
    }

    /* â”€â”€ Shared PRD Generator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function getVotedItemsFromState(votes, customPainPoints) {
      const result = { painPoints: [], wishes: [] };
      Object.entries(PL_EVIDENCE).forEach(([key, data]) => {
        data.painPoints.filter(p => votes[p.id]).forEach(p => result.painPoints.push({ ...p, stakeholder: key, stakeholderLabel: data.label }));
        data.wishes.filter(w => votes[w.id]).forEach(w => result.wishes.push({ ...w, stakeholder: key, stakeholderLabel: data.label }));
      });
      Object.entries(customPainPoints).forEach(([key, points]) => {
        points.filter(p => votes[p.id]).forEach(p => result.painPoints.push({ ...p, stakeholder: key, stakeholderLabel: PL_EVIDENCE[key].label }));
      });
      return result;
    }

    function generatePRDMarkdownShared({ selectedFeatures, votes, customPainPoints, confirmedArchetype, confirmedPhilosophy, visionStatement, notBuilding, prdNotes }) {
      const v = getVotedItemsFromState(votes, customPainPoints);
      const selFeats = PL_FEATURES.filter(f => selectedFeatures.includes(f.id));
      const notSelFeats = PL_FEATURES.filter(f => !selectedFeatures.includes(f.id));
      const totalCost = selFeats.reduce((sum, f) => sum + f.cost, 0);
      const reqSet = new Set();
      selFeats.forEach(f => (f.requires || []).forEach(r => reqSet.add(r)));
      const synergies = PL_SYNERGIES.filter(s => s.features.every(fId => selFeats.some(f => f.id === fId)));
      const arch = confirmedArchetype ? PL_ARCHETYPES.find(a => a.id === confirmedArchetype) : null;

      const featMd = selFeats.length > 0
        ? selFeats.map(f => `- **${f.name}** ${f.icon} (${f.cost}pt) â€” ${f.description}\n  - Stakeholders: ${f.stakeholders.join(", ")}\n  - Requires: ${f.requires.join(", ")}`).join("\n")
        : "*No features selected yet*";
      const notFeatMd = notSelFeats.map(f => `- ~~${f.name}~~ (${f.cost}pt) â€” ${f.description}`).join("\n");
      const techMd = reqSet.size > 0
        ? [...reqSet].map(rId => { const r = PL_TECH_REQS[rId]; return r ? `- ${r.icon} **${r.label}** â€” ${r.description}` : null; }).filter(Boolean).join("\n")
        : "*No tech requirements (select features first)*";
      const synMd = synergies.length > 0
        ? synergies.map(s => `- ${s.icon} **${s.name}** â€” ${s.description}\n  - Features: ${s.features.map(fId => PL_FEATURES.find(f => f.id === fId)?.name || fId).join(", ")}`).join("\n")
        : "";
      const painMd = v.painPoints.length > 0 ? v.painPoints.map(p => `- [${p.stakeholderLabel}] ${p.text}`).join("\n") : "*No pain points prioritized yet*";
      const wishMd = v.wishes.length > 0 ? v.wishes.map(w => `- [${w.stakeholderLabel}] ${w.text}`).join("\n") : "*No wishes prioritized yet*";

      const archMd = arch
        ? `## 5. Product Archetype: ${arch.name}\n*"${arch.tagline}"*\n\n${arch.description}\n\n**Reference products:** ${arch.referenceApps.map(a => `${a.name} (${a.trait})`).join(", ")}\n\n**Best for:** ${arch.bestFor}\n\n**Key tradeoff:** ${arch.tradeoff}\n`
        : "## 5. Product Archetype\n*Not yet selected â€” go to Product DNA tab*\n";

      let sec = 6;
      let md = `# FCM Companion App â€” Product Requirements Document\n\n`;
      md += `*Generated by Product Lab â€” Health Design Sprint 2026*\n`;
      md += `*University of Virginia School of Medicine*\n`;
      md += `*Date: ${new Date().toLocaleDateString()}*\n\n`;
      md += `---\n\n`;

      md += `## 1. Background & Context\n\n`;
      md += `### What is FCM?\n`;
      md += `Foundations of Clinical Medicine (FCM) is a longitudinal first-year course at the University of Virginia School of Medicine. Students learn clinical reasoning â€” how to take a patient history, build a differential diagnosis, perform a physical exam, and synthesize findings into a clinical assessment.\n\n`;
      md += `### The FCM Case Cycle\n`;
      md += `Each week, students go through a repeating cycle:\n\n`;
      md += `1. **Case Assignment** â€” Receive a one-line chief concern (e.g., "43 y/o male, 1-week worsening SOB") posted to the LMS\n`;
      md += `2. **Pre-Session Prep** â€” Build a broad differential diagnosis. Select history questions and PE maneuvers. Complete a pre-class worksheet (VINDICATE framework)\n`;
      md += `3. **The Gap** â€” Days pass between receiving the case and the session. Students study other subjects. The case goes cold in memory\n`;
      md += `4. **Small Group Session** â€” 4-hour in-person session with a clinical coach and ~6 students. Students present cases, discuss reasoning, observe peers\n`;
      md += `5. **Patient Encounter** â€” Interview a standardized patient. Full history, targeted physical exam, present assessment and plan\n`;
      md += `6. **Coach Feedback** â€” Verbal feedback during/after encounter. Quality and depth vary significantly by coach\n`;
      md += `7. **Write the Note** â€” Synthesize encounter into an illness script with ranked diagnoses and supporting evidence\n`;
      md += `8. **Written Feedback** â€” Coach reviews illness script in LMS. Often delayed, sometimes cursory\n`;
      md += `9. **The Fade** â€” No structured follow-up. Student may never revisit this case. Learning is entirely self-directed\n\n`;
      md += `### The Core Problems\n`;
      md += `- Students prepare in isolation with no feedback on whether their reasoning is sound\n`;
      md += `- Instructors walk into sessions "flying blind" â€” they don't know what students prepared or where they're confused\n`;
      md += `- The gap between case assignment and session causes knowledge decay\n`;
      md += `- After sessions, there is no structured mechanism to close the learning loop\n`;
      md += `- The current cycle rewards completion over quality of reasoning\n\n`;

      md += `## 2. Users & Stakeholders\n\n`;
      md += `| Role | Count | Description |\n`;
      md += `|------|-------|-------------|\n`;
      md += `| **M1 Students** | ~180/year (groups of ~6) | Primary users. Cycle through weekly cases. Need better prep tools and feedback loops |\n`;
      md += `| **FCM Coaches** | ~30 instructors | Lead small group sessions. Want visibility into student readiness. Need fast, lightweight tools |\n`;
      md += `| **Curriculum Admins** | 3-5 | Track AAMC competency alignment, student progress at scale, coach consistency |\n\n`;

      md += `## 3. User Research Findings\n\n`;
      md += `This PRD is based on structured user research conducted during the Health Design Sprint at UVA (February 2026), including journey mapping of the FCM case cycle, stakeholder interviews, pain point prioritization, and feature tradeoff analysis with medical students.\n\n`;
      md += `### Prioritized Pain Points\n${painMd}\n\n`;
      md += `### Prioritized Wishes\n${wishMd}\n\n`;

      md += `## 4. Vision\n\n`;
      md += visionStatement
        ? `${visionStatement}\n\n`
        : `A digital companion for the FCM case cycle that transforms passive preparation into active clinical reasoning practice, makes student thinking visible to instructors before sessions, and creates structured feedback loops that close the gap between preparation and learning.\n\n`;

      md += `${archMd}\n`;

      if (confirmedPhilosophy) {
        const philData = [
          { id: "duolingo", name: "Duolingo", phil: "Everything in 5 minutes. Gamify everything. Streaks for retention. Mobile-only." },
          { id: "piazza", name: "Piazza", phil: "Two-sided: students post, instructors respond. Anonymous participation. Threaded discussions." },
          { id: "strava", name: "Strava", phil: "Track everything. Peer comparison. Personal records. Social feed. Data makes effort visible." },
          { id: "chatgpt", name: "ChatGPT", phil: "Conversational AI. Adapts to student level. Infinite depth. Always available." },
        ].find(p => p.id === confirmedPhilosophy);
        if (philData) {
          md += `## ${sec}. Design Philosophy: ${philData.name}\n*Locked in during Product Lab*\n\n${philData.phil}\n\nThis philosophy should guide all UX and feature decisions. When in doubt, ask: "What would ${philData.name} do?"\n\n`;
          sec++;
        }
      }

      const scenarios = PL_SCENARIOS || [];
      if (scenarios.length > 0) {
        md += `## ${sec}. Usage Scenarios\n\n`;
        scenarios.forEach(s => {
          md += `### ${s.name}\n*${s.scene}*\n\n- **Device:** ${s.device}\n- **When:** ${s.timing}\n- **FCM Steps:** ${s.steps}\n`;
          const mappedFeats = selFeats.filter(f => (s.featureIds || []).includes(f.id));
          if (mappedFeats.length > 0) md += `- **Features:** ${mappedFeats.map(f => `${f.icon} ${f.name}`).join(", ")}\n`;
          md += `\n`;
        });
        sec++;
      }

      md += `## ${sec}. Selected Features (${totalCost}/${PL_BUDGET} build points)\n${featMd}\n\n`;
      sec++;

      if (notSelFeats.length > 0) {
        md += `## ${sec}. Features Considered but Not Selected\nThese were evaluated during the design sprint but cut due to budget constraints:\n${notFeatMd}\n\n`;
        sec++;
      }

      md += `## ${sec}. Required Tech Stack\n${techMd}\n\n`;
      sec++;

      if (synMd) {
        md += `## ${sec}. Synergy Loops\nThese feature combinations create reinforcing product loops:\n${synMd}\n\n`;
        sec++;
      }

      md += `## ${sec}. What We're NOT Building\n${notBuilding.map(n => `- ${n}`).join("\n")}\n\n`;
      sec++;

      md += `## ${sec}. Additional Notes\n${prdNotes || "*None yet*"}\n\n`;
      sec++;

      md += `---\n\n`;
      md += `## Build Instructions\n\n`;
      md += `This app should be built as a responsive web application (mobile-friendly, works on phones and laptops). The target users are medical students and clinical instructors at UVA School of Medicine.\n\n`;
      md += `**Recommended stack:** Next.js or similar React framework, Supabase for database/auth, Tailwind CSS for styling, deployed to Vercel or similar.\n\n`;
      md += `**MVP scope:** Focus on the selected features above within the ${PL_BUDGET}-point build budget. Start with features that share the most tech requirements (to maximize infrastructure reuse) and build outward.\n\n`;
      md += `**To start building:** Paste this entire PRD into Claude Code or your preferred AI coding assistant. All context needed to understand the domain, users, and product decisions is included above.\n`;

      return md;
    }

    function ProductLab() {
      const theme = useTheme();
      const isDark = theme.offWhite === "#1A1A1A";
      const stColors = useMemo(() => ({
        student: { color: theme.emerald, bg: theme.emeraldLight },
        instructor: { color: isDark ? "#A78BFA" : "#7C3AED", bg: isDark ? "#4C1D95" : "#F5F3FF" },
        admin: { color: theme.red, bg: theme.redLight },
      }), [theme, isDark]);

      const saved = useMemo(() => {
        try { return JSON.parse(localStorage.getItem("fcm-product-lab")) || {}; } catch { return {}; }
      }, []);

      const [plTab, setPlTab] = useState("evidence");
      const [votes, setVotes] = useState(saved.votes || {});
      const [selectedFeatures, setSelectedFeatures] = useState(saved.selectedFeatures || []);
      const [dnaPosition, setDnaPosition] = useState(saved.dnaPosition || { x: 0.5, y: 0.5 });
      const [confirmedArchetype, setConfirmedArchetype] = useState(saved.confirmedArchetype || null);
      const [customPainPoints, setCustomPainPoints] = useState(saved.customPainPoints || { student: [], instructor: [], admin: [] });
      const [confirmedPhilosophy, setConfirmedPhilosophy] = useState(saved.confirmedPhilosophy || null);
      const [visionStatement, setVisionStatement] = useState(saved.visionStatement || "");
      const [notBuilding, setNotBuilding] = useState(saved.notBuilding || ["Full EMR integration", "Graded assessments (this is practice, not evaluation)", "Replacing FCM sessions entirely"]);
      const [prdNotes, setPrdNotes] = useState(saved.prdNotes || "");
      const [newPainPoint, setNewPainPoint] = useState({ student: "", instructor: "", admin: "" });
      const [newNotBuilding, setNewNotBuilding] = useState("");

      useEffect(() => {
        try { localStorage.setItem("fcm-product-lab", JSON.stringify({ votes, selectedFeatures, dnaPosition, confirmedArchetype, customPainPoints, notBuilding, prdNotes, confirmedPhilosophy, visionStatement })); } catch {}
      }, [votes, selectedFeatures, dnaPosition, confirmedArchetype, customPainPoints, notBuilding, prdNotes, confirmedPhilosophy, visionStatement]);

      const toggleVote = useCallback((id) => { setVotes(prev => ({ ...prev, [id]: prev[id] ? 0 : 1 })); }, []);

      const toggleFeature = useCallback((id) => {
        setSelectedFeatures(prev => prev.includes(id) ? prev.filter(f => f !== id) : [...prev, id]);
      }, []);

      const addPainPoint = useCallback((stakeholder) => {
        if (!newPainPoint[stakeholder].trim()) return;
        setCustomPainPoints(prev => ({ ...prev, [stakeholder]: [...prev[stakeholder], { id: `custom-${Date.now()}`, text: newPainPoint[stakeholder].trim(), custom: true }] }));
        setNewPainPoint(prev => ({ ...prev, [stakeholder]: "" }));
      }, [newPainPoint]);

      const getVotedItems = useCallback(() => {
        return getVotedItemsFromState(votes, customPainPoints);
      }, [votes, customPainPoints]);

      const generatePRDMarkdown = useCallback(() => {
        return generatePRDMarkdownShared({ selectedFeatures, votes, customPainPoints, confirmedArchetype, confirmedPhilosophy, visionStatement, notBuilding, prdNotes });
      }, [selectedFeatures, votes, customPainPoints, confirmedArchetype, confirmedPhilosophy, visionStatement, notBuilding, prdNotes]);

      const voted = getVotedItems();
      const totalVoted = voted.painPoints.length + voted.wishes.length;
      const featCost = PL_FEATURES.filter(f => selectedFeatures.includes(f.id)).reduce((s, f) => s + f.cost, 0);
      const overBudget = featCost > PL_BUDGET;
      const plTabs = [
        { id: "evidence", label: "Evidence Wall", icon: "ğŸ“Œ" },
        { id: "dna", label: "Product DNA", icon: "ğŸ§¬" },
        { id: "builder", label: "Product Builder", icon: "ğŸ”§" },
        { id: "prd", label: "PRD Draft", icon: "ğŸ“„" },
      ];

      return (
        <div>
          <div style={{ display: "flex", alignItems: "center", justifyContent: "space-between", marginBottom: 20, flexWrap: "wrap", gap: 12 }}>
            <div style={{ display: "flex", gap: 0, borderBottom: `1px solid ${theme.lightGray}` }}>
              {plTabs.map(tab => (
                <button key={tab.id} onClick={() => setPlTab(tab.id)} style={{ padding: "8px 16px", fontSize: 13, fontWeight: plTab === tab.id ? 700 : 500, fontFamily: MONO, color: plTab === tab.id ? theme.black : theme.medGray, background: "none", border: "none", borderBottom: plTab === tab.id ? `2px solid ${theme.blue}` : "2px solid transparent", cursor: "pointer", marginBottom: -1 }}>
                  {tab.icon} {tab.label}
                </button>
              ))}
            </div>
            <div style={{ display: "flex", gap: 16, alignItems: "center" }}>
              <div style={{ textAlign: "center" }}>
                <div style={{ fontSize: 20, fontWeight: 700, fontFamily: MONO, color: theme.black }}>{totalVoted}</div>
                <div style={{ fontSize: 10, color: theme.medGray, textTransform: "uppercase", letterSpacing: "0.08em", fontFamily: MONO }}>prioritized</div>
              </div>
              <div style={{ width: 1, height: 28, background: theme.lightGray }} />
              <div style={{ textAlign: "center" }}>
                <div style={{ fontSize: 20, fontWeight: 700, fontFamily: MONO, color: overBudget ? theme.red : theme.black }}>{featCost}/{PL_BUDGET}</div>
                <div style={{ fontSize: 10, color: theme.medGray, textTransform: "uppercase", letterSpacing: "0.08em", fontFamily: MONO }}>build pts</div>
              </div>
            </div>
          </div>
          {plTab === "evidence" && <PLEvidenceWall votes={votes} toggleVote={toggleVote} customPainPoints={customPainPoints} setCustomPainPoints={setCustomPainPoints} newPainPoint={newPainPoint} setNewPainPoint={setNewPainPoint} addPainPoint={addPainPoint} stColors={stColors} selectedFeatureIds={selectedFeatures} />}
          {plTab === "dna" && <PLProductDNA dnaPosition={dnaPosition} setDnaPosition={setDnaPosition} confirmedArchetype={confirmedArchetype} setConfirmedArchetype={setConfirmedArchetype} />}
          {plTab === "builder" && <PLProductBuilder selectedIds={selectedFeatures} toggleFeature={toggleFeature} confirmedPhilosophy={confirmedPhilosophy} setConfirmedPhilosophy={setConfirmedPhilosophy} />}
          {plTab === "prd" && <PLPRDDraft voted={voted} selectedFeatureIds={selectedFeatures} confirmedArchetype={confirmedArchetype} notBuilding={notBuilding} setNotBuilding={setNotBuilding} newNotBuilding={newNotBuilding} setNewNotBuilding={setNewNotBuilding} prdNotes={prdNotes} setPrdNotes={setPrdNotes} generatePRDMarkdown={generatePRDMarkdown} stColors={stColors} confirmedPhilosophy={confirmedPhilosophy} visionStatement={visionStatement} setVisionStatement={setVisionStatement} />}
        </div>
      );
    }

    /* â”€â”€ FCMJourneyMapper (main) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    function getDefaultSession() {
      if (!SESSION_DATA || !SESSION_DATA.sessions.length) return null;
      return SESSION_DATA.sessions[SESSION_DATA.sessions.length - 1].id;
    }

    function FCMJourneyMapper() {
      const [selectedSession, setSelectedSession] = useState(getDefaultSession);
      const [steps, setSteps] = useState(DEFAULT_STEPS);
      const [perspective, setPerspective] = useState("Student");
      const [showIntro, setShowIntro] = useState(true);
      const [yieldApprovals, setYieldApprovals] = useState({});
      const [expandSignal, setExpandSignal] = useState(0);
      const [showDiff, setShowDiff] = useState(false);
      const [darkMode, setDarkMode] = useState(() => {
        try { return localStorage.getItem("fcm-dark-mode") === "true"; } catch { return false; }
      });
      const [mainTab, setMainTab] = useState("journey");
      const [presentMode, setPresentMode] = useState(() => {
        try {
          const href = window.location.href;
          if (href.includes("?review") || href.includes("#review") || href.includes("&review")) return "review";
          if (href.includes("?present") || href.includes("#present") || href.includes("&present")) return "external";
          return null;
        } catch { return null; }
      });
      const theme = darkMode ? BRAND_DARK : BRAND;
      useEffect(() => { document.body.style.background = theme.offWhite; }, [theme.offWhite]);
      const toggleDarkMode = () => {
        setDarkMode(prev => {
          const next = !prev;
          try { localStorage.setItem("fcm-dark-mode", String(next)); } catch {}
          return next;
        });
      };

      const session = useMemo(() => getSessionById(selectedSession), [selectedSession]);
      const pKey = perspectiveKey(perspective);
      const isAdmin = perspective === "Administrator";
      const allSessions = SESSION_DATA ? SESSION_DATA.sessions : [];

      // Load session data into steps when session or perspective changes
      useEffect(() => {
        if (!selectedSession || !session) {
          // Blank template â€” restore annotations from localStorage
          const saved = loadAnnotations(null);
          const fresh = DEFAULT_STEPS.map(s => {
            const ann = saved[s.id];
            return ann ? { ...s, ...ann } : { ...s };
          });
          setSteps(fresh);
          setYieldApprovals(loadYieldApprovals(null));
          return;
        }

        const perspData = session.perspectives?.[pKey];
        const stepsData = perspData?.steps;
        const saved = loadAnnotations(selectedSession);

        const merged = DEFAULT_STEPS.map(s => {
          const sd = stepsData?.[s.id];
          const ann = saved[s.id] || {};
          if (!sd) return { ...s, ...ann };
          return {
            ...s,
            actual: ann.actual ?? sd.suggestedActual ?? s.actual,
            emotion: ann.emotion !== undefined ? ann.emotion : (sd.suggestedEmotion !== undefined ? sd.suggestedEmotion : s.emotion),
            friction: ann.friction ?? sd.suggestedFriction ?? s.friction,
            wish: ann.wish ?? sd.suggestedWish ?? s.wish,
            thinking: ann.thinking ?? s.thinking,
            starred: ann.starred !== undefined ? ann.starred : s.starred,
          };
        });
        setSteps(merged);
        setYieldApprovals(loadYieldApprovals(selectedSession));
      }, [selectedSession, pKey]);

      // Persist annotations on change
      const updateStep = useCallback((id, updates) => {
        setSteps(prev => {
          const next = prev.map(s => (s.id === id ? { ...s, ...updates } : s));
          // Save annotations
          const annotations = {};
          next.forEach(s => {
            const def = DEFAULT_STEPS.find(d => d.id === s.id);
            if (!def) return;
            const ann = {};
            if (s.actual !== def.actual) ann.actual = s.actual;
            if (s.thinking !== def.thinking) ann.thinking = s.thinking;
            if (s.emotion !== def.emotion) ann.emotion = s.emotion;
            if (s.friction !== def.friction) ann.friction = s.friction;
            if (s.wish !== def.wish) ann.wish = s.wish;
            if (s.starred !== def.starred) ann.starred = s.starred;
            if (Object.keys(ann).length > 0) annotations[s.id] = ann;
          });
          saveAnnotations(selectedSession, annotations);
          return next;
        });
      }, [selectedSession]);

      const addInvisibleAfter = useCallback((afterId) => {
        setSteps((prev) => {
          const idx = prev.findIndex((s) => s.id === afterId);
          const newStep = { id: `inv-${Date.now()}`, title: "ğŸ‘» [Name this step]", official: "You discovered this â€” it's not in any official document.", artifact: "None", actual: "", thinking: "", emotion: null, friction: "", wish: "", starred: false, isInvisible: true };
          const next = [...prev];
          next.splice(idx + 1, 0, newStep);
          return next;
        });
      }, []);

      const handleYieldApproval = useCallback((key, value) => {
        setYieldApprovals(prev => {
          const next = { ...prev };
          if (value === null) { delete next[key]; } else { next[key] = value; }
          saveYieldApprovals(selectedSession, next);
          return next;
        });
      }, [selectedSession]);

      const getStepSessionData = (stepId) => {
        if (!session) return null;
        return session.perspectives?.[pKey]?.steps?.[stepId] || null;
      };

      const getStability = (stepId) => {
        if (!session) return null;
        return session.analysis?.stability?.[stepId] || null;
      };

      const getYieldOpps = () => {
        if (!session) return null;
        return session.analysis?.yieldOpportunities || null;
      };

      // Diff computation
      const prevSession = useMemo(() => {
        if (!selectedSession || !SESSION_DATA) return null;
        const idx = allSessions.findIndex(s => s.id === selectedSession);
        if (idx <= 0) return null;
        return getSessionById(allSessions[idx - 1].id);
      }, [selectedSession]);

      const canShowDiff = prevSession !== null;

      const getDiffData = (stepId) => {
        if (!showDiff || !prevSession || !session) return null;
        const currStepData = session.perspectives?.[pKey]?.steps?.[stepId];
        const prevStepData = prevSession.perspectives?.[pKey]?.steps?.[stepId];
        if (!currStepData) return null;

        const diff = {};
        // New themes
        const prevThemes = prevStepData?.themes || [];
        const currThemes = currStepData.themes || [];
        diff.newThemes = currThemes.filter(t => !prevThemes.includes(t));
        // New quotes
        const prevQuoteTexts = (prevStepData?.keyQuotes || []).map(q => q.text);
        const currQuotes = currStepData.keyQuotes || [];
        diff.newQuotes = currQuotes.filter(q => !prevQuoteTexts.includes(q.text)).map(q => q.text);
        // Emotion change
        if (prevStepData && currStepData.suggestedEmotion !== undefined && prevStepData.suggestedEmotion !== undefined && currStepData.suggestedEmotion !== prevStepData.suggestedEmotion) {
          diff.emotionChanged = true;
        }
        return diff;
      };

      const getPrevStability = (stepId) => {
        if (!showDiff || !prevSession) return null;
        return prevSession.analysis?.stability?.[stepId] || null;
      };

      const getDiffYieldOpps = () => {
        if (!showDiff || !prevSession || !session) return null;
        const currOpps = session.analysis?.yieldOpportunities || [];
        const prevOpps = prevSession.analysis?.yieldOpportunities || [];
        const prevTitles = prevOpps.map(o => o.title);
        const prevScores = {};
        prevOpps.forEach(o => { prevScores[o.title] = o.yieldScore; });
        return {
          newTitles: currOpps.filter(o => !prevTitles.includes(o.title)).map(o => o.title),
          scoreChanges: currOpps.reduce((acc, o) => {
            if (prevScores[o.title] !== undefined && prevScores[o.title] !== o.yieldScore) {
              acc[o.title] = o.yieldScore - prevScores[o.title];
            }
            return acc;
          }, {}),
        };
      };

      const handleExport = () => {
        const starred = steps.filter((s) => s.starred && s.wish);
        let md = `# FCM Journey Map â€” ${perspective} Perspective\n`;
        md += `*Generated ${new Date().toLocaleDateString()} Â· HDS 2026*\n`;
        if (session) {
          md += `*Session: ${session.label} (${session.date}) Â· ${session.participantCount} participants*\n`;
        }
        md += `\n`;
        md += `## Context\n\n`;
        md += `This journey map was produced as part of the UVA Health Design Sprint (HDS) 2026, where medical students are designing an AI-native tool to improve the Foundations of Clinical Medicine (FCM) case cycle. `;
        md += `FCM is a multi-year pre-clerkship program where students receive clinical cases, build differentials, attend small-group sessions with standardized patients, and receive coach feedback.\n\n`;
        md += `**How to use this document:** This journey map captures real student/coach/administrator experiences and friction points from group discussion sessions. `;
        md += `It should be integrated with the team's Product Requirements Document (PRD) and other design artifacts. `;
        md += `When used with Claude or another AI assistant, combine this with the PRD to ground feature decisions in actual user evidence. `;
        md += `The friction points and wishes below are direct inputs for user stories, job stories, and feature specifications.\n\n`;
        md += `---\n\n`;
        md += `## Journey Steps\n\n`;
        md += `| # | Step | Emotion | What Actually Happens | Friction | Wish |\n|---|------|---------|----------------------|---------|------|\n`;
        let vi = 0;
        steps.forEach((s) => {
          if (!s.isInvisible) vi++;
          const em = s.emotion !== null ? EMOTIONS[s.emotion].emoji + " " + EMOTIONS[s.emotion].label : "â€”";
          md += `| ${s.isInvisible ? "ğŸ‘»" : vi} | ${s.title} | ${em} | ${s.actual || "â€”"} | ${s.friction || "â€”"} | ${s.wish || "â€”"} |\n`;
        });
        if (session) {
          const yieldOpps = getYieldOpps();
          if (yieldOpps && yieldOpps.length > 0) {
            md += `\n## Yield Analysis\n\n`;
            md += `Ranked improvement opportunities from session data, scored 1â€“10.\n\n`;
            yieldOpps.forEach((opp, i) => {
              const status = yieldApprovals[`${opp.stepId}-${i}`] || "pending";
              md += `- **${opp.yieldScore}/10** ${opp.title} [${status}]: ${opp.rationale}\n`;
            });
          }
        }
        if (starred.length > 0) {
          md += `\n## â­ Feature Seeds\n\n`;
          starred.forEach((s, i) => { md += `${i + 1}. **"${s.title}":** ${s.wish}\n`; });
          md += `\n## PRD User Perspective Block\n\`\`\`\n### Job Stories (fill in outcomes)\n`;
          starred.forEach((s) => { md += `- When [at "${s.title}"], I want to [${s.wish}], so I can [___].\n`; });
          md += `\`\`\`\n`;
        }
        md += `\n---\n\n`;
        md += `## Instructions for Claude\n\n`;
        md += `When a student pastes this journey map into a conversation, use the Socratic method to deepen their thinking. Do not immediately generate PRD text or solutions. Instead:\n\n`;
        md += `1. **Acknowledge what they've captured.** Briefly reflect back the 2â€“3 strongest friction points and wishes you see in their data.\n`;
        md += `2. **Ask probing questions.** For each high-yield friction point, ask one question that pushes the student to think more specifically:\n`;
        md += `   - "You noted [friction]. Walk me through the last time that happened â€” what was the exact moment it broke down?"\n`;
        md += `   - "Your wish for [wish] is interesting. Who else besides you would benefit from that? How would a coach use it differently than a student?"\n`;
        md += `   - "I see [step] scored high on friction but you didn't star it. Is that a pain you've accepted, or one worth solving?"\n`;
        md += `3. **Surface hidden assumptions.** If a wish implies a specific technical solution, ask whether the underlying *need* could be met differently: "You wished for [X]. What if instead of [X], you could [alternative framing]?"\n`;
        md += `4. **Connect to the PRD.** Once the student has refined their thinking through 2â€“3 rounds of questions, help them translate frictionâ†’job storiesâ†’features. Use the format: *When [situation], I want to [action], so I can [outcome].*\n`;
        md += `5. **Challenge scope.** Ask: "If you could only ship ONE feature from this journey map for the first version, which friction point would you attack? Why that one over the others?"\n\n`;
        md += `The goal is to help the student develop design judgment, not just generate a feature list. Push them to prioritize ruthlessly and justify their choices with evidence from the journey map.\n`;
        const blob = new Blob([md], { type: "text/markdown" });
        const a = document.createElement("a"); a.href = URL.createObjectURL(blob);
        a.download = `fcm-journey-${perspective.toLowerCase().replace(/\s/g, "-")}${session ? `-${session.id}` : ""}.md`; a.click();
      };

      const handleCopy = () => {
        const starred = steps.filter((s) => s.starred && s.wish);
        let t = `FCM Journey â€” ${perspective} Perspective (HDS 2026)\n`;
        if (session) t += `Session: ${session.label} (${session.date})\n`;
        t += "\n";
        t += "CONTEXT: This journey map captures real experiences from group discussions in the UVA Health Design Sprint. ";
        t += "Students are designing an AI-native tool to improve the FCM (Foundations of Clinical Medicine) case cycle. ";
        t += "Use this alongside the team PRD to ground feature decisions in user evidence.\n\n";
        let vi = 0;
        steps.forEach((s) => {
          if (!s.isInvisible) vi++;
          if (s.actual || s.emotion !== null || s.friction || s.wish) {
            const em = s.emotion !== null ? EMOTIONS[s.emotion].emoji : "";
            t += `${s.isInvisible ? "ğŸ‘»" : vi}. ${s.title} ${em}\n`;
            if (s.actual) t += `  What happens: ${s.actual}\n`;
            if (s.thinking) t += `  Thinking: ${s.thinking}\n`;
            if (s.friction) t += `  Friction: ${s.friction}\n`;
            if (s.wish) t += `  Wish: ${s.wish}${s.starred ? " â­" : ""}\n`;
            t += "\n";
          }
        });
        if (starred.length > 0) { t += "FEATURE SEEDS:\n"; starred.forEach((s, i) => { t += `${i + 1}. "${s.title}": ${s.wish}\n`; }); t += "\n"; }
        t += "---\nINSTRUCTIONS FOR CLAUDE: Do not jump to solutions. Use the Socratic method:\n";
        t += "1. Reflect back the 2-3 strongest friction points you see.\n";
        t += "2. Ask probing questions: 'Walk me through the last time [friction] happened. What was the exact moment it broke down?'\n";
        t += "3. Challenge wishes: 'Who else besides you would benefit? How would a coach use this differently?'\n";
        t += "4. Surface hidden assumptions: 'What if instead of [wish], you could [alternative]?'\n";
        t += "5. After 2-3 rounds of questions, help translate friction into job stories: When [situation], I want to [action], so I can [outcome].\n";
        t += "6. Push for ruthless prioritization: 'If you ship ONE feature, which friction point do you attack? Why?'\n";
        navigator.clipboard.writeText(t).then(() => {
          alert("Copied to clipboard! Paste into Claude.");
        });
      };

      const handleExportAnnotations = () => {
        const annotations = {};
        const yieldApprovalData = {};
        // Gather all localStorage keys for annotations and yield approvals
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith("fcm-annotations-")) {
            const sessionKey = key.replace("fcm-annotations-", "");
            try { annotations[sessionKey] = JSON.parse(localStorage.getItem(key)); } catch {}
          }
          if (key.startsWith("fcm-yield-")) {
            const sessionKey = key.replace("fcm-yield-", "");
            try { yieldApprovalData[sessionKey] = JSON.parse(localStorage.getItem(key)); } catch {}
          }
        }
        const payload = {
          meta: { exportedAt: new Date().toISOString(), tool: "FCM Journey Mapper" },
          annotations,
          yieldApprovals: yieldApprovalData,
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `fcm-annotations-${new Date().toISOString().slice(0, 10)}.json`;
        a.click();
      };

      const fileInputRef = useRef(null);
      const handleImportAnnotations = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const data = JSON.parse(ev.target.result);
            if (!data.meta || data.meta.tool !== "FCM Journey Mapper") {
              alert("Invalid file â€” not an FCM Journey Mapper export.");
              return;
            }
            let count = 0;
            if (data.annotations) {
              Object.entries(data.annotations).forEach(([sessionKey, ann]) => {
                localStorage.setItem(`fcm-annotations-${sessionKey}`, JSON.stringify(ann));
                count += Object.keys(ann).length;
              });
            }
            if (data.yieldApprovals) {
              Object.entries(data.yieldApprovals).forEach(([sessionKey, approvals]) => {
                localStorage.setItem(`fcm-yield-${sessionKey}`, JSON.stringify(approvals));
              });
            }
            // Reload current session state from localStorage
            const saved = loadAnnotations(selectedSession);
            const perspData = session?.perspectives?.[pKey];
            const stepsData = perspData?.steps;
            const merged = DEFAULT_STEPS.map(s => {
              const sd = stepsData?.[s.id];
              const ann = saved[s.id] || {};
              if (!sd) return { ...s, ...ann };
              return {
                ...s,
                actual: ann.actual ?? sd.suggestedActual ?? s.actual,
                emotion: ann.emotion !== undefined ? ann.emotion : (sd.suggestedEmotion !== undefined ? sd.suggestedEmotion : s.emotion),
                friction: ann.friction ?? sd.suggestedFriction ?? s.friction,
                wish: ann.wish ?? sd.suggestedWish ?? s.wish,
                thinking: ann.thinking ?? s.thinking,
                starred: ann.starred !== undefined ? ann.starred : s.starred,
              };
            });
            setSteps(merged);
            setYieldApprovals(loadYieldApprovals(selectedSession));
            alert(`Imported ${count} annotations successfully.`);
          } catch (err) {
            alert("Failed to parse import file: " + err.message);
          }
          // Reset file input so the same file can be re-imported
          e.target.value = "";
        };
        reader.readAsText(file);
      };

      const filledCount = steps.filter((s) => s.actual || s.emotion !== null || s.friction || s.wish).length;
      const starredCount = steps.filter((s) => s.starred).length;
      let visibleIdx = 0;
      const yieldOpps = getYieldOpps();

      return (
        <ThemeContext.Provider value={theme}>
        {presentMode === "review" && SESSION_DATA && (
          <ReviewMode
            onClose={() => setPresentMode(null)}
          />
        )}
        {presentMode === "external" && (
          <ExternalPresent
            onClose={() => setPresentMode(null)}
          />
        )}
        <div style={{ maxWidth: mainTab === "productlab" ? 1100 : 720, margin: "0 auto", padding: "24px 16px", fontFamily: SANS, background: theme.offWhite, minHeight: "100vh", transition: "max-width 0.3s" }}>
          <div style={{ textAlign: "center", marginBottom: 32, position: "relative" }}>
            <div style={{ position: "absolute", top: 0, right: 0, display: "flex", gap: 8 }}>
              {SESSION_DATA && (
                <>
                  <button onClick={() => setPresentMode("review")} style={{ background: "transparent", border: `1px solid ${theme.emerald}`, borderRadius: 8, padding: "6px 16px", cursor: "pointer", fontSize: 13, fontWeight: 700, fontFamily: MONO, color: theme.emerald }}>Team Review</button>
                  <button onClick={() => setPresentMode("external")} style={{ background: theme.emerald, border: "none", borderRadius: 8, padding: "6px 16px", cursor: "pointer", fontSize: 13, fontWeight: 700, fontFamily: MONO, color: "#fff" }}>Present</button>
                </>
              )}
              <button onClick={toggleDarkMode} style={{ background: theme.white, border: `1px solid ${theme.lightGray}`, borderRadius: 8, padding: "6px 12px", cursor: "pointer", fontSize: 18, lineHeight: 1 }} title={darkMode ? "Switch to light mode" : "Switch to dark mode"}>{darkMode ? "â˜€ï¸" : "ğŸŒ™"}</button>
            </div>
            <div style={{ fontFamily: MONO, fontSize: 13, color: theme.emerald, fontWeight: 700, letterSpacing: 1 }}>&lt;mdp&gt; {PROJECT_CONFIG.sprintShort.toUpperCase()}</div>
            <h1 style={{ margin: "8px 0", fontSize: 28, fontWeight: 800, color: theme.black, fontFamily: MONO }}>{PROJECT_CONFIG.courseShort} Journey Mapper</h1>
            <p style={{ color: theme.medGray, fontSize: 15, margin: 0 }}>
              {mainTab === "productlab"
                ? "Evidence â†’ Build Points â†’ PRD. Choose what ships."
                : <>Map the <em>real</em> experience &mdash; not the official version.</>}
            </p>
          </div>

          <div style={{ display: "flex", gap: 0, marginBottom: 24, borderBottom: `1px solid ${theme.lightGray}` }}>
            {[{ id: "journey", label: "Journey Map", icon: "ğŸ—ºï¸" }, { id: "productlab", label: "Product Lab", icon: "âš—ï¸" }].map(tab => (
              <button key={tab.id} onClick={() => setMainTab(tab.id)} style={{ padding: "10px 20px", fontSize: 14, fontWeight: mainTab === tab.id ? 700 : 500, fontFamily: MONO, color: mainTab === tab.id ? theme.black : theme.medGray, background: "none", border: "none", borderBottom: mainTab === tab.id ? `2px solid ${theme.emerald}` : "2px solid transparent", cursor: "pointer", marginBottom: -1 }}>
                {tab.icon} {tab.label}
              </button>
            ))}
          </div>

          {mainTab === "journey" && <>
          {showIntro && (
            <div style={{ background: theme.blueLight, borderRadius: 12, padding: 20, marginBottom: 24, border: `1px solid ${theme.blue}`, position: "relative" }}>
              <button onClick={() => setShowIntro(false)} style={{ position: "absolute", top: 8, right: 12, border: "none", background: "none", fontSize: 18, cursor: "pointer", color: theme.medGray }}>âœ•</button>
              <h3 style={{ margin: "0 0 8px 0", fontFamily: MONO, fontSize: 15, color: theme.black }}>How this works</h3>
              <p style={{ fontSize: 14, color: theme.darkGray, margin: 0, lineHeight: 1.6 }}>
                We synthesized your Day 1 and Day 2 group discussions into a step-by-step FCM journey map. Each step is pre-populated with real insights from the cohort. Your job: review each step, rate the emotional experience, note friction points, and â­ star the wishes that matter most â€” those become your app's features. See a gap the official process misses? Hit ğŸ‘» to add invisible steps that nobody documents. When done, export and paste into Claude for job stories and PRD specs.
              </p>
            </div>
          )}

          {SESSION_DATA && <SessionSelector selectedSession={selectedSession} onSelect={setSelectedSession} />}

          {canShowDiff && (
            <div style={{ marginBottom: 12, display: "flex", alignItems: "center", gap: 10 }}>
              <label style={{ fontSize: 12, fontWeight: 600, color: theme.medGray, fontFamily: MONO, cursor: "pointer", display: "flex", alignItems: "center", gap: 6 }}>
                <span onClick={() => setShowDiff(!showDiff)} style={{ display: "inline-block", width: 36, height: 20, borderRadius: 10, background: showDiff ? theme.emerald : theme.lightGray, position: "relative", cursor: "pointer", transition: "background 0.2s" }}>
                  <span style={{ display: "inline-block", width: 16, height: 16, borderRadius: 8, background: theme.white, position: "absolute", top: 2, left: showDiff ? 18 : 2, transition: "left 0.2s", boxShadow: "0 1px 3px rgba(0,0,0,0.2)" }} />
                </span>
                Show changes from {prevSession?.label?.replace(/â€”.*/, "").trim() || "previous session"}
              </label>
            </div>
          )}

          {SESSION_DATA && allSessions.length >= 2 && <LeadingOpportunities />}

          <div className="perspective-tabs" style={{ display: "flex", gap: 8, marginBottom: 24, flexWrap: "wrap" }}>
            {["Student", "Coach / Faculty", "Administrator"].map((p) => (
              <button key={p} onClick={() => setPerspective(p)} style={{ padding: "8px 20px", borderRadius: 8, border: perspective === p ? `2px solid ${theme.emerald}` : `1px solid ${theme.lightGray}`, background: perspective === p ? theme.emeraldLight : theme.white, color: theme.darkGray, cursor: "pointer", fontWeight: perspective === p ? 700 : 500, fontSize: 14, fontFamily: MONO }}>
                {p}
              </button>
            ))}
          </div>

          {!isAdmin && (
            <>
              <div style={{ display: "flex", gap: 16, marginBottom: 24, flexWrap: "wrap", alignItems: "center" }}>
                <div style={{ background: theme.offWhite, borderRadius: 8, padding: "8px 16px", fontSize: 13, fontFamily: MONO, color: theme.darkGray }}>ğŸ“ {filledCount}/{steps.length} annotated</div>
                <div style={{ background: starredCount > 0 ? theme.emeraldLight : theme.offWhite, borderRadius: 8, padding: "8px 16px", fontSize: 13, fontFamily: MONO, color: theme.darkGray }}>â­ {starredCount} seeds</div>
                <div style={{ background: theme.amberLight, borderRadius: 8, padding: "8px 16px", fontSize: 13, fontFamily: MONO, color: theme.darkGray }}>ğŸ‘» {steps.filter((s) => s.isInvisible).length} invisible</div>
                {selectedSession && session && <div style={{ background: theme.blueLight, borderRadius: 8, padding: "8px 16px", fontSize: 13, fontFamily: MONO, color: theme.darkGray }}>ğŸ“ Viewing: {session.label.replace(/â€”.*/, "").trim()} ({new Date(session.date + "T12:00:00").toLocaleDateString("en-US", { month: "short", day: "numeric" })})</div>}
                <button onClick={() => setExpandSignal(s => s + 1)} style={{ background: theme.offWhite, borderRadius: 8, padding: "8px 16px", fontSize: 13, fontFamily: MONO, border: `1px solid ${theme.lightGray}`, cursor: "pointer", fontWeight: 600, color: theme.darkGray }}>{expandSignal % 2 === 1 ? "â–² Collapse All" : "â–¼ Expand All"}</button>
              </div>

              {steps.map((step) => {
                if (!step.isInvisible) visibleIdx++;
                return (
                  <StepCard
                    key={step.id}
                    step={step}
                    index={visibleIdx}
                    onUpdate={(u) => updateStep(step.id, u)}
                    onAddInvisibleAfter={() => addInvisibleAfter(step.id)}
                    sessionStepData={getStepSessionData(step.id)}
                    stability={getStability(step.id)}
                    yieldOpps={yieldOpps}
                    expandSignal={expandSignal}
                    diffData={getDiffData(step.id)}
                    prevStability={getPrevStability(step.id)}
                  />
                );
              })}

              <EmotionalArc steps={steps} />
              <WishlistSummary steps={steps} />

              {yieldOpps && (
                <YieldAnalysis
                  opportunities={yieldOpps}
                  approvals={yieldApprovals}
                  onApprovalChange={handleYieldApproval}
                  steps={steps}
                  diffYield={getDiffYieldOpps()}
                />
              )}

              {allSessions.length >= 2 && <CumulativeAnalysis sessionCount={allSessions.length} />}
            </>
          )}

          {isAdmin && (
            <AdminDashboard session={session} allSessions={allSessions} />
          )}

          <div style={{ display: "flex", gap: 12, marginTop: 24, flexWrap: "wrap" }}>
            <button onClick={handleExport} style={{ padding: "12px 24px", borderRadius: 10, border: "none", background: theme.black, color: theme.white, cursor: "pointer", fontWeight: 700, fontSize: 14, fontFamily: MONO }}>ğŸ“‹ Export Markdown</button>
            <button onClick={handleCopy} style={{ padding: "12px 24px", borderRadius: 10, border: `1px solid ${theme.lightGray}`, background: theme.white, color: theme.darkGray, cursor: "pointer", fontWeight: 600, fontSize: 14, fontFamily: MONO }}>ğŸ“ Copy for Claude</button>
            <button onClick={handleExportAnnotations} style={{ padding: "12px 24px", borderRadius: 10, border: `1px solid ${theme.emerald}`, background: theme.emeraldLight, color: theme.darkGray, cursor: "pointer", fontWeight: 600, fontSize: 14, fontFamily: MONO }}>ğŸ’¾ Export Annotations</button>
            <button onClick={() => fileInputRef.current?.click()} style={{ padding: "12px 24px", borderRadius: 10, border: `1px solid ${theme.blue}`, background: theme.blueLight, color: theme.darkGray, cursor: "pointer", fontWeight: 600, fontSize: 14, fontFamily: MONO }}>ğŸ“‚ Import Annotations</button>
            <input ref={fileInputRef} type="file" accept=".json" onChange={handleImportAnnotations} style={{ display: "none" }} />
          </div>
          </>}

          {mainTab === "productlab" && <ProductLab />}

          <div style={{ textAlign: "center", marginTop: 32, padding: "16px 0", borderTop: `1px solid ${theme.lightGray}` }}>
            <p style={{ fontSize: 12, color: theme.medGray, fontFamily: MONO }}>&lt;mdp&gt; {PROJECT_CONFIG.institution} &middot; {PROJECT_CONFIG.sprintShort}</p>
          </div>
        </div>
        </ThemeContext.Provider>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById("root"));
    root.render(<FCMJourneyMapper />);
  </script>
</body>
</html>
